---
title: Принудительный переход на другой ресурс в SQL Server для группы доступности
description: Принудительный переход на другой ресурс для группы доступности с типом кластера NONE
services: ''
author: MikeRayMSFT
ms.topic: include
ms.date: 02/05/2018
ms.author: mikeray
ms.custom: include file
ms.openlocfilehash: f5655e73481d830c848aea34c4a4f49613be0913
ms.sourcegitcommit: 1740f3090b168c0e809611a7aa6fd514075616bf
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
---
У каждой группы доступности есть только одна первичная реплика. Первичная реплика позволяет выполнять операции чтения и записи. Чтобы изменить первичную реплику, можно выполнить переход на другой ресурс. В группе доступности для обеспечения высокой доступности диспетчер кластеров автоматизирует процесс перехода на другой ресурс. В группе доступности с типом кластера NONE переход на другой ресурс выполняется автоматически. 

Существует два способа перехода на другой ресурс для первичной реплики в группе доступности с типом кластера NONE:

- Принудительный переход на другой ресурс вручную с потерей данных
- Переход на другой ресурс вручную без потери данных

### <a name="forced-manual-failover-with-data-loss"></a>Принудительный переход на другой ресурс вручную с потерей данных

Это метод можно использовать, если первичная реплика недоступна и не может быть восстановлена. 

Для принудительного перехода на другой ресурс с потерей данных подключитесь к экземпляру SQL Server, в котором размещена целевая вторичная реплика, и выполните следующие команды:

```SQL
ALTER AVAILABILITY GROUP [ag1] FORCE_FAILOVER_ALLOW_DATA_LOSS;
```

### <a name="manual-failover-without-data-loss"></a>Переход на другой ресурс вручную без потери данных

Это метод можно использовать, если первичная реплика доступна, но необходимо временно или навсегда изменить конфигурацию и изменить экземпляр SQL Server, на котором размещена первичная реплика. Перед началом перехода на другой ресурс вручную убедитесь, что целевая вторичная реплика находится в актуальном состоянии, чтобы избежать возможной потери данных. 

Чтобы перейти на другой ресурс вручную без потери данных, выполните следующие действия.

1. Выполните для целевой вторичной реплики `SYNCHRONOUS_COMMIT`.

   ```SQL
   ALTER AVAILABILITY GROUP [ag1] 
        MODIFY REPLICA ON N'<node2>' 
        WITH (AVAILABILITY_MODE = SYNCHRONOUS_COMMIT);
   ```

2. Выполните следующий запрос, чтобы определить, что активные транзакции фиксируются на первичной реплике и по меньшей мере на одной синхронной вторичной реплике: 

   ```SQL
   SELECT ag.name, 
      drs.database_id, 
      drs.group_id, 
      drs.replica_id, 
      drs.synchronization_state_desc, 
      ag.sequence_number
   FROM sys.dm_hadr_database_replica_states drs, sys.availability_groups ag
   WHERE drs.group_id = ag.group_id; 
   ```

   Вторичная реплика синхронизируется, если `synchronization_state_desc` имеет значение `SYNCHRONIZED`.

3. Обновите `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` до 1.

   Следующий сценарий задает для `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` значение 1 в группе доступности `ag1`. Перед запуском следующего сценария замените `ag1` на имя группы доступности:

   ```SQL
   ALTER AVAILABILITY GROUP [ag1] 
        SET REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT = 1;
   ```

   Этот параметр означает, что все активные транзакции фиксируются на первичной реплике и по меньшей мере на одной синхронной вторичной реплике. 

4. Понизьте роль первичной реплики до вторичной. После понижения роли первичная реплика становится доступной только для чтения. Выполните следующую команду на экземпляре SQL Server, где размещена первичная реплика, чтобы изменить ее роль на `SECONDARY`:

   ```SQL
   ALTER AVAILABILITY GROUP [ag1] 
        SET (ROLE = SECONDARY); 
   ```

5. Повысьте уровень целевой вторичной реплики до первичной. 

   ```SQL
   ALTER AVAILABILITY GROUP ag1 FORCE_FAILOVER_ALLOW_DATA_LOSS; 
   ```  

   > [!NOTE] 
   > Чтобы удалить группу доступности, выполните команду [DROP AVAILABILITY GROUP](https://docs.microsoft.com/en-us/sql/t-sql/statements/drop-availability-group-transact-sql). Для групп доступности, созданных с типом кластера NONE или EXTERNAL, команду необходимо выполнить на всех репликах, которые входят в группу доступности.