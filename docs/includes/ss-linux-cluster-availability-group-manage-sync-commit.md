## <a name="managing-synchronous-commit-mode"></a>Управление синхронным режимом фиксации

>[!WARNING]
>В некоторых случаях группы доступности SQL Server в синхронном режиме фиксации в Linux могут быть подвержены потере данных. Просмотрите приведенные ниже сведения о причинах ошибок и решениях, чтобы гарантировать защиту данных. Эта проблема будет устранена в следующих выпусках.

###<a name="pacemaker-notification-for-availability-group-resource-promotion"></a>Уведомление Pacemaker для обновления ресурсов группы доступности

До выхода версии CTP 1.4 агент ресурсов Pacemaker для групп доступности не мог определить, является ли реплика, помеченная как `SYNCHRONOUS_COMMIT`, актуальной. Синхронизация с первичной репликой могла быть прервана, но уведомления об этом не поступали. Таким образом, с помощью агента можно было обновить реплику до первичной, но это могло привести к потере данных. 

Чтобы устранить эту проблему, в SQL Server 2017 с CTP 1.4 к `sys.availability_groups` добавляется `sequence_number`. `sequence_number` является монотонно возрастающим значением типа bigint, показывающим, насколько актуальна локальная реплика группы доступности по отношению к остальной части системы. Это число обновляется при выполнении отработок отказа, добавлении или удалении реплик, а также выполнении других операций в группах доступности. Сначала оно обновляется в первичной реплике, а затем во вторичных. Таким образом вторичная актуальная реплика и первичная реплика будут иметь одинаковый номер.

Когда появляется необходимость в обновлении реплики до первичной, Pacemaker отправляет уведомления во все реплики, чтобы извлечь порядковый номер и сохранить его. Затем, когда Pacemaker пытается обновить реплику до первичной, она обновляется, только если ее порядковый номер выше номеров всех остальных реплик. В противном случае операция обновления реплики отклоняется. Таким образом, до первичной реплики может быть обновлена только реплика с наибольшим значением порядкового номера, что позволяет избежать потери данных.

Стоит заметить, что это работает, только если порядковый номер хотя бы одной реплики, доступной для обновления, совпадает с номером прежней первичной реплики. Так как Pacemaker под управлением агента ресурсов отправляет уведомления всем репликам, для ресурса необходимо настроить `notify=true`. Для каждого существующего ресурса `ocf:mssql:ag` пользователю необходимо задать в конфигурации `notify=true` перед обновлением пакета `mssql-server-ha` до версии CTP 1.4. В противном случае обновление завершится ошибкой. 

### <a name="how-to-avoid-potential-for-data-loss"></a>Как избежать потери данных 

В приведенном ниже примере для группы доступности все еще существует угроза потери данных. Если в кластере из пяти узлов есть группа доступности с репликами на трех экземплярах SQL Server, первичная и одна вторичная реплики могут предшествовать другим вторичным репликам. В этом случае значение `sequence_number` в `sys.availability_groups` будет выше, чем в других репликах. Если обе реплики потеряют соединение с остальными частями кластера, Pacemaker определит оставшиеся три узла в качестве кворума и разрешит скрытой реплике обновиться до первичной. В этой ситуации существует угроза потери данных.

sql2017 представляет новую функцию, которая разрешает выполнить фиксацию последующих транзакций в первичной реплике только при наличии определенного числа доступных вторичных реплик. С помощью `REQUIRED_COPIES_TO_COMMIT` можно задать число реплик, которые должны быть зафиксированы в журналах транзакций базы данных вторичной реплики, чтобы можно было продолжить транзакцию. Вы можете использовать этот параметр вместе с `CREATE AVAILABILITY GROUP` или `ALTER AVAILABILITY GROUP`. Дополнительные сведения см. в статье об [инструкции CREATE AVAILABILITY GROUP](http://msdn.microsoft.com/library/ff878399.aspx).

Чтобы избежать потери данных, о чем было сказано выше, задайте для `REQUIRED_COPIES_TO_COMMIT` максимальное число синхронизированных реплик. В будущих выпусках будет доступна встроенная логика для автоматического заполнения параметра `REQUIRED_COPIES_TO_COMMIT`.
Когда параметр `REQUIRED_COPIES_TO_COMMIT` будет настроен, транзакции в базах данных первичной реплики будут ожидать фиксации транзакции в необходимом количестве журналов транзакций базы данных синхронных вторичных реплик. В случае недостаточного количества синхронных вторичных реплик выполнение транзакций прекратится, пока не будет возобновлена связь с необходимым количеством вторичных реплик.

В примере ниже имени группы доступности [ag1] присваивается значение `REQUIRED_COPIES_TO_COMMIT = 2`. 

```Transact-SQL
ALTER AVAILABILITY GROUP [ag1]
SET (REQUIRED_COPIES_TO_COMMIT = 2)
```

В примере выше в группе доступности с двумя вторичными репликами должна быть подтверждена фиксация в обоих. В противном случае транзакции будут заблокированы.
