## <a name="pacemakerNotify"></a>Понимать ресурс агента SQL Server для pacemaker

Перед выпуском CTP-версии 1.4 Pacemaker ресурсов агента для группы доступности может не знаете, если реплика помечается как `SYNCHRONOUS_COMMIT` были действительно актуальными или нет. Синхронизация с первичной репликой могла быть прервана, но уведомления об этом не поступали. Таким образом агент может повысить уровень устаревшей реплики на основной -, который в случае успешного выполнения, могут привести к потере данных. 

SQL Server 2017 г CTP-версии 1.4 добавлена `sequence_number` для `sys.availability_groups` для решения этой проблемы. `sequence_number`Это монотонно возрастающей BIGINT, которое представляет порядок обновления реплики группы доступности локальной по отношению к остальной части реплик в группе доступности. Этот номер обновления выполняет переход на другой ресурс, добавление или удаление реплики и другие операции с группой доступности. Номер обновлены на сервере-источнике, то передаваемые вторичных реплик. Таким образом вторичную реплику, которая соответствует последней версии будет sequence_number же, что и первичная. 

Если Pacemaker решит promote реплика-источник, он сначала отправляет уведомление всех реплик для извлечения порядковый номер и сохранить ее (мы называем это предварительно promote уведомлений). Далее когда Pacemaker фактически пытается повысить уровень реплики на основной, реплики только повышает уровень сам если его порядковый номер — самым высоким все порядковые номера всех реплик и отклоняет операции повысить уровень, в противном случае. Таким образом, до первичной реплики может быть обновлена только реплика с наибольшим значением порядкового номера, что позволяет избежать потери данных. 

Стоит заметить, что это работает, только если порядковый номер хотя бы одной реплики, доступной для обновления, совпадает с номером прежней первичной реплики. Чтобы обеспечить это, по умолчанию выполняется для ресурса агента Pacemaker для автоматической установки `REQUIRED_COPIES_TO_COMMIT` таким образом, что по крайней мере один синхронной фиксации вторичная реплика находится в актуальном состоянии и может быть целью автоматического перехода на другой ресурс. С каждой действие мониторинга значение `REQUIRED_COPIES_TO_COMMIT` вычисляется (и обновление при необходимости) как («число реплик синхронной фиксации» / 2). Затем, во время перехода на другой ресурс, ресурс агента требуется (`total number of replicas`  -  `required_copies_to_commit` реплик) реагировать на предварительно promote уведомление, чтобы иметь возможность сделать один из них-источник. Реплика с самым высоким `sequence_number` будет повышен до основного. 

Например рассмотрим случай группы доступности с тремя синхронными репликами - одна первичная реплика и две вторичные реплики с синхронной фиксацией.

- `REQUIRED_COPIES_TO_COMMIT`3-2 = 1

- Требуемое количество реплик реагировать на предварительно преобразовать действие-3-1 = 2. Поэтому 2 реплики должны быть для перехода на другой ресурс, чтобы оно запускалось. Это означает, что в случае сбоя первичной, если одна из вторичных реплик не отвечает, и только одна из баз данных-получателей отвечает на предварительно преобразовать действие, не может гарантировать ресурсов агента, сервер-получатель, ответившего имеет наивысший sequence_number и отработки отказа не происходит.

Пользователь может выбрать для переопределения поведения по умолчанию и настройки группы доступности не задано `REQUIRED_COPIES_TO_COMMIT` автоматически как описано выше.

>[!IMPORTANT]
>Если `REQUIRED_COPIES_TO_COMMIT` является 0, отсутствует риск потери данных. В случае сбоя основного агент ресурсов не будет вызывать автоматически отработки отказа. Пользователь должен решить, следует ли ожидать первичного сайта на восстановление или отработка отказа вручную.

Чтобы задать `REQUIRED_COPIES_TO_COMMIT` для 0, выполните:

```bash
sudo pcs resource update <**ag_cluster**> required_copies_to_commit=0
```

Эквивалентная команда с использованием crm (в SLES):

```bash
sudo crm resource param <**ag_cluster**> set required_synchronized_secondaries_to_commit 0
```

Чтобы восстановить значения по умолчанию вычисленное значение, запустите:

```bash
sudo pcs resource update <**ag_cluster**> required_copies_to_commit=
```

>[!NOTE]
>Обновление свойств ресурсов вызывает все реплики остановить и перезапустить. Это означает, что основной будет временно быть пониженных до получателя, а затем снова повышается которого будет casue временные написать недоступности. Новое значение REQUIRED_COPIES_TO_COMMIT будет устанавливаться только после перезапуска реплики, он не будет мгновенно при выполнении команды ПК.

## <a name="balancing-high-availability-and-data-protection"></a>Балансировка высокого уровня доступности и защиты данных 

Описанное выше поведение по умолчанию также применяется к регистр 2 синхронные реплики (основной + получателей). По умолчанию будет pacemaker `REQUIRED_COPIES_TO_COMMIT = 1` для обеспечения дополнительной реплики всегда является актуальным для максимальной защиты данных.  

>[!WARNING]
>Это сообщение появляется с высоким риском недоступности первичной реплики из-за запланированных и незапланированных простоев на сервере-получателе. Пользователь может выбрать для изменения поведения по умолчанию ресурсов агента и переопределения `REQUIRED_COPIES_TO_COMMIT` 0:

```bash
sudo pcs resource update <**ag1**> required_copies_to_commit=0
```

После переопределения, агент ресурсов будет использовать новый параметр `REQUIRED_COPIES_TO_COMMIT` и остановите его вычисление. Это означает, что пользователям необходимо вручную обновить его соответствующим образом (например, если они увеличить число реплик).

В приведенных ниже таблицах описываются результат отключения для первичной или вторичной реплики в конфигурации ресурсов группы доступности на другой.

### <a name="availability-group---2-sync-replicas"></a>Группа доступности — 2 синхронизации реплики

| |Основной сбоя |Сбой одной вторичной реплики
|:---|:--- |:--- |
|`REQUIRED_COPIES_TO_COMMIT=0`|Пользователь должен выдавать на другой РЕСУРС вручную. <br>Возможно, потери данных.<br> Новый сервер-источник — для чтения и записи |Основной для чтения и записи, работой в незащищенном режиме к потере данных
|`REQUIRED_COPIES_TO_COMMIT=1` * |Автоматически выдающим ОТКАЗОУСТОЙЧИВОГО кластера <br>Без потери данных. <br> Новый основной отклонит все соединения до бывшей первичной восстанавливает и соединяет группе доступности как Вторичная. |Основной отклонит все соединения до получателя выполнено восстановление.

\*Ресурс агента SQL Server по умолчанию Pacemaker.

### <a name="availability-group---3-sync-replicas"></a>Группа доступности — 3 реплик с синхронизацией

| |Основной сбоя |Сбой одной вторичной реплики
|:---|:--- |:--- |
|`REQUIRED_COPIES_TO_COMMIT=0`|Пользователь должен выдавать на другой РЕСУРС вручную. <br>Возможно, потери данных. <br>Новый сервер-источник — для чтения и записи |Первичный — для чтения и записи
|`REQUIRED_COPIES_TO_COMMIT=1` * |Кластер автоматически будет выдавать отработки ОТКАЗА. <br>Без потери данных. <br>Новый сервер-источник является RW |Первичный — для чтения и записи 

\*Ресурс агента SQL Server по умолчанию Pacemaker.