---
title: "ALTER зеркального отображения базы данных (Transact-SQL) | Документы Microsoft"
ms.custom: 
ms.date: 08/17/2017
ms.prod: sql-non-specified
ms.reviewer: 
ms.suite: 
ms.technology:
- database-engine
ms.tgt_pltfrm: 
ms.topic: language-reference
dev_langs:
- TSQL
helpviewer_keywords:
- witness [SQL Server], establishing
- manual failover [SQL Server]
- ALTER DATABASE statement, database mirroring
- database mirroring [SQL Server], Transact-SQL
ms.assetid: 27a032ef-1cf6-4959-8e67-03d28c4b3465
caps.latest.revision: 22
author: JennieHubbard
ms.author: jhubbard
manager: jhubbard
ms.workload: On Demand
ms.translationtype: MT
ms.sourcegitcommit: 876522142756bca05416a1afff3cf10467f4c7f1
ms.openlocfilehash: 96ac469df9660e29c0394226cf7199e451df9d8c
ms.contentlocale: ru-ru
ms.lasthandoff: 09/01/2017

---
# <a name="alter-database-transact-sql-database-mirroring"></a>Базы данных ALTER DATABASE (Transact-SQL) зеркального отображения 
[!INCLUDE[tsql-appliesto-ss2008-xxxx-xxxx-xxx_md](../../includes/tsql-appliesto-ss2008-xxxx-xxxx-xxx-md.md)]

    
> [!NOTE]  
>  [!INCLUDE[ssNoteDepFutureAvoid](../../includes/ssnotedepfutureavoid-md.md)] Вместо этого используйте [!INCLUDE[ssHADR](../../includes/sshadr-md.md)].  
  
 Управляет зеркальным отображением базы данных. Значения, указанные с параметрами зеркального отображения базы данных, применяются к обеим копиям базы данных и к сеансу зеркального отображения базы данных в целом. Только один \<database_mirroring_option > разрешенных в инструкции ALTER DATABASE.  
  
> [!NOTE]  
>  Конфигурацию зеркального отображения базы данных рекомендуется выполнять в часы с наименьшей загрузкой, поскольку этот процесс может повлиять на производительность.  
  
 Параметры ALTER DATABASE см. в разделе [инструкции ALTER DATABASE &#40; Transact-SQL &#41; ](../../t-sql/statements/alter-database-transact-sql.md). Параметры ALTER DATABASE SET см. в разделе [параметры ALTER DATABASE SET &#40; Transact-SQL &#41; ](../../t-sql/statements/alter-database-transact-sql-set-options.md).  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
  
ALTER DATABASE database_name   
SET { <partner_option> | <witness_option> }  
  <partner_option> ::=  
    PARTNER { = 'partner_server'   
            | FAILOVER   
            | FORCE_SERVICE_ALLOW_DATA_LOSS  
            | OFF  
            | RESUME   
            | SAFETY { FULL | OFF }  
            | SUSPEND   
            | TIMEOUT integer  
            }  
  <witness_option> ::=  
    WITNESS { = 'witness_server'   
            | OFF   
            }  
  
```  
  
## <a name="arguments"></a>Аргументы  
  
> [!IMPORTANT]  
>  Команда SET PARTNER или SET WITNESS может быть завершена успешно, но позднее — привести к ошибке.  
  
> [!NOTE]  
>  Параметры зеркального отображения базы данных ALTER DATABASE недоступны в автономной базе данных.  
  
 *database_name*  
 Имя изменяемой базы данных.  
  
 ПАРТНЕР \<partner_option >  
 Управляет свойствами базы данных, которые определяют партнеров по обеспечению отработки отказа при сбоях сеанса зеркального отображения базы данных и их поведение. Некоторые параметры инструкции SET PARTNER могут быть установлены на любом участнике; другие — разграничены для основного или для зеркального сервера. Дополнительные сведения см. в следующем описании индивидуальных параметров PARTNER. Предложение SET PARTNER влияет на обе копии базы данных независимо от участника, на которого оно указывает.  
  
 Для выполнения инструкции SET PARTNER требуется, чтобы параметры STATE конечных точек обоих участников имели значение STARTED. Также учтите, что параметр ROLE конечной точки зеркального отображения базы данных каждого экземпляра сервера-участника должен быть установлен в состояние PARTNER или ALL. Сведения о том, как указать конечную точку, см. в разделе [создать базу данных зеркального отображения конечной точки для проверки подлинности Windows &#40; Transact-SQL &#41; ](../../database-engine/database-mirroring/create-a-database-mirroring-endpoint-for-windows-authentication-transact-sql.md). Чтобы узнать роль и состояние базы данных конечной точки зеркального отображения экземпляра сервера, выполните на этом экземпляре следующую инструкцию языка [!INCLUDE[tsql](../../includes/tsql-md.md)]:  
  
```  
SELECT role_desc, state_desc FROM sys.database_mirroring_endpoints  
```  
  
 **\<partner_option >:: =**  
  
> [!NOTE]  
>  Только один \<partner_option > предложении SET PARTNER.  
  
 **"** *сервер_участник* **"**  
 Указывает сетевой адрес сервера экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], чтобы задействовать его как партнера по обеспечению отработки отказа в новом сеансе зеркального отображения базы данных. Для каждого сеанса необходимы два участника: один запускается как основной сервер, второй — как зеркальный сервер. Рекомендуется, чтобы эти партнеры находились на разных компьютерах.  
  
 Этот параметр указывается один раз для сеанса на каждом участнике. Запуск сеанса зеркального отображения базы данных требуется два ALTER DATABASE *базы данных* SET PARTNER **= "***сервер_участник***"** инструкций . Их порядок важен. Во-первых, подключитесь к зеркальному серверу и укажите экземпляр основного сервера, как *сервер_участник* (SET PARTNER **= "***основной_сервер***"**). Во-вторых, подключитесь к основному серверу и укажите зеркальный экземпляр сервера как *сервер_участник* (SET PARTNER **= "***mirror_server***"**); команда запускает сеанс между этими двумя партнерами зеркального отображения базы данных. Дополнительные сведения см. в подразделе [Настройка зеркального отображения базы данных (SQL Server)](../../database-engine/database-mirroring/setting-up-database-mirroring-sql-server.md).  
  
 Значение *сервер_участник* является сетевого адреса сервера. Оно имеет следующий синтаксис:  
  
 TCP**://***\<системный_адрес>***:***\<порт>*  
  
 где  
  
-   *\<системный адрес >* представляет собой строку, например имя системы, полное доменное имя или IP-адрес, однозначно идентифицирующий целевую компьютерную систему.  
  
-   *\<порт >* — номер порта, который связан с конечной точкой зеркального отображения экземпляра сервера-участника.  
  
 Дополнительные сведения см. в разделе [Указание сетевого адреса сервера (зеркальное отображение базы данных)](../../database-engine/database-mirroring/specify-a-server-network-address-database-mirroring.md).  
  
 В следующем примере демонстрируется SET PARTNER **= "***сервер_участник***"** предложения:  
  
```  
'TCP://MYSERVER.mydomain.Adventure-Works.com:7777'  
```  
  
> [!IMPORTANT]  
>  Если сеанс установлен с помощью инструкции ALTER DATABASE, а не с помощью среды [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], он будет установлен с полной безопасностью транзакций по умолчанию (параметр SAFETY установлен в состояние FULL) и будет работать в режиме повышенной безопасности без возможности автоматической отработки отказа. Чтобы разрешить автоматическую отработку отказа, настройте следящий сервер для работы в режиме высокой производительности и отключите безопасность транзакций (SAFETY OFF).  
  
 FAILOVER  
 Ручное переключение при сбое с основного сервера на зеркальный. Параметр FAILOVER можно указать только на основном сервере. Этот параметр допустим только в том случае, если параметр SAFETY установлен в состояние FULL (значение по умолчанию).  
  
 Переход на другой РЕСУРС требуется **master** как контекст базы данных.  
  
 FORCE_SERVICE_ALLOW_DATA_LOSS  
 Переключает обслуживание базы данных на зеркальный сервер при сбое синхронизации основного сервера с базой данных или в синхронизированном состоянии, когда автоматическая отработка отказа не происходит.  
  
 Рекомендуется включать вынужденное обслуживание только в том случае, если основной сервер больше не работает. Иначе некоторые клиенты могут продолжить обращаться к оригинальной основной базе данных вместо новой основной базы данных.  
  
 Параметр FORCE_SERVICE_ALLOW_DATA_LOSS доступен только на зеркальном сервере и только при соблюдении всех следующих условий:  
  
-   основной сервер недоступен;  
  
-   параметр WITNESS установлен в состояние OFF или свидетель подключен к зеркальному серверу.  
  
 Переключайте обслуживание только в случае готовности рискнуть потерей некоторых данных для немедленного восстановления обслуживания базы данных.  
  
 При переключении обслуживания сеанс приостанавливается, сохраняя все данные в базе данных оригинального главного сервера. Как только оригинальная основная база данных начала обслуживаться и стала доступна для связи с новым основным сервером, администратор базы данных может возобновить обслуживание. При возобновлении сеанса любые неотправленные записи журнала и соответствующие обновления будут утеряны.  
  
 OFF  
 Прекращает сеанс зеркального отображения базы данных и отключает зеркальное отображение базы данных. Значение OFF можно указать для любого из участников. Подробнее о последствиях удаления зеркального отображения см. в разделе [удаление зеркального отображения базы данных &#40; SQL Server &#41; ](../../database-engine/database-mirroring/removing-database-mirroring-sql-server.md).  
  
 RESUME  
 Возобновляет приостановленный сеанс зеркального отображения базы данных. Параметр RESUME можно указать только на основном сервере.  
  
 SAFETY { FULL | OFF }  
 Устанавливает уровень безопасности транзакций. Параметр SAFETY можно указать только на основном сервере.  
  
 Значение по умолчанию FULL. При полном уровне безопасности сеанс зеркального отображения базы данных выполняется синхронно (в *режим высокого уровня безопасности*). Если уровень безопасности установлен в OFF, сеанс зеркального отображения базы данных выполняется асинхронно (в *режим высокой производительности*).  
  
 Поведение режима высокой безопасности частично зависит от следящего сервера, как показано далее.  
  
-   Если безопасность установлена в состояние FULL и для сеанса установлен следящий сервер, то сеанс выполняется в режиме повышенной безопасности с автоматической отработкой отказа. Когда основной сервер становится недоступным, сеанс автоматически переключается на другой ресурс при условии, что база данных находится в синхронном состоянии, а экземпляры зеркального и следящего серверов остаются подключенными друг к другу (имеют кворум). Дополнительные сведения см. в разделе [Кворум: как следящий сервер влияет на доступность базы данных (зеркальное отображение базы данных)](../../database-engine/database-mirroring/quorum-how-a-witness-affects-database-availability-database-mirroring.md).  
  
     Если свидетель установлен для сеанса, но в настоящее время не подключен, потеря зеркального сервера вынудит основной сервер выключиться.  
  
-   Если безопасность установлена в состояние FULL, а следящий сервер находится в состоянии OFF, сеанс выполняется в режиме повышенной безопасности без возможности автоматической отработки отказа. При отказе экземпляра зеркального сервера экземпляр основного сервера остается незатронутым. При отказе экземпляра основного сервера можно переключить обслуживание на экземпляр зеркального сервера (с возможной потерей данных).  
  
 Если параметр SAFETY установлен в состояние OFF, сеанс выполняется в высокопроизводительном режиме, в котором ни автоматическая отработка отказа, ни отработка отказа вручную не поддерживаются. Однако проблемы на зеркальном сервере не затрагивают основной сервер, и, если экземпляр основного сервера отключается, при необходимости можно переключить обслуживание (с возможной потерей данных) на экземпляр зеркального сервера, если параметр WITNESS установлен в состояние OFF или если следящий сервер в настоящее время подключен к зеркальному серверу. Дополнительные сведения о переключении обслуживания см. в подразделе «FORCE_SERVICE_ALLOW_DATA_LOSS», расположенном выше в этом разделе.  
  
> [!IMPORTANT]  
>  Режим высокой производительности не предназначен для использования свидетеля. Однако всякий раз, когда параметру SAFETY присваивается значение OFF, настоятельно рекомендуется проверить, что параметр WITNESS находится в состоянии OFF.  
  
 SUSPEND  
 Приостанавливает сеанс зеркального отображения базы данных.  
  
 Значение SUSPEND можно указать на любом участнике.  
  
 Время ОЖИДАНИЯ *целое число со знаком*  
 Указывает интервал времени ожидания в секундах. Интервал времени ожидания — это максимальное время, в течение которого экземпляр сервера ожидает получения сообщения PING от другого экземпляра в сеансе зеркального отображения перед тем, как сделать вывод о том, что другой экземпляр отключен.  
  
 Параметр TIMEOUT можно указать только на основном сервере. Если этот параметр не определить, интервал времени по умолчанию — 10 секунд. При указании числа 5 или больше интервал времени ожидания будет установлен в указанное количество секунд. При указании значения интервала времени ожидания от 0 до 4 секунд интервал времени ожидания автоматически будет установлен в 5 секунд.  
  
> [!IMPORTANT]  
>  Рекомендуется установить интервал времени ожидания в 10 секунд или более. При установке значения меньше 10 секунд возникает вероятность пропуска команды PING в сильно загруженной системе и вероятность ошибочного сообщения об ошибке.  
  
 Дополнительные сведения см. в статье [Possible Failures During Database Mirroring](../../database-engine/database-mirroring/possible-failures-during-database-mirroring.md).  
  
 Следящий сервер \<witness_option >  
 Управляет свойствами базы данных, которые определяют свидетеля зеркального отображения базы данных. Предложение SET WITNESS влияет на обе копии базы данных, указать его можно только на основном сервере. Если следящий сервер установлен для сеанса, кворум необходим для обслуживать базу данных, независимо от настройки параметра SAFETY; Дополнительные сведения см. в разделе [кворум: как следящий сервер влияет на доступность базы данных &#40; зеркального отображения базы данных &#41;](../../database-engine/database-mirroring/quorum-how-a-witness-affects-database-availability-database-mirroring.md).  
  
 Рекомендуется, чтобы следящий сервер и партнеры по обеспечению отработки отказа находились на отдельных компьютерах. Сведения о следящем сервере см. в разделе [следящий сервер зеркального отображения базы данных](../../database-engine/database-mirroring/database-mirroring-witness.md).  
  
 Для выполнения инструкции SET WITNESS параметр STATE конечных точек экземпляров основного и следящего сервера должен быть установлен в состояние STARTED. Также учтите, что параметр ROLE конечной точки зеркального отображения базы данных экземпляра следящего сервера должен быть установлен в состояние PARTNER или ALL. Сведения об определении конечной точки см. в разделе [конечная точка зеркального отображения базы данных &#40; SQL Server &#41; ](../../database-engine/database-mirroring/the-database-mirroring-endpoint-sql-server.md).  
  
 Чтобы узнать роль и состояние базы данных конечной точки зеркального отображения экземпляра сервера, выполните на этом экземпляре следующую инструкцию языка [!INCLUDE[tsql](../../includes/tsql-md.md)]:  
  
```  
SELECT role_desc, state_desc FROM sys.database_mirroring_endpoints  
```  
  
> [!NOTE]  
>  Свойства базы данных не могут быть установлены на свидетеле.  
  
 **\<witness_option >:: =**  
  
> [!NOTE]  
>  Только один \<witness_option > предложении SET WITNESS.  
  
 **"** *witness_server* **"**  
 Указывает экземпляр компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)], чтобы задействовать его в качестве следящего сервера для сеанса зеркального отображения базы данных. Инструкции SET WITNESS можно указывать только на основном сервере.  
  
 В SET WITNESS **= "***witness_server***"** оператор, синтаксис *witness_server* является таким же, как синтаксис  *partner_server*.  
  
 OFF  
 Удаляет свидетеля из сеанса зеркального отображения базы данных. При установке свидетеля в состояние OFF отключается автоматическая отработка отказа. Если база данных установлена в состояние FULL SAFETY, а свидетель установлен в состояние OFF, отказ зеркального сервера заставит основной сервер сделать базу данных недоступной.  
  
## <a name="remarks"></a>Замечания  
  
## <a name="examples"></a>Примеры  
  
### <a name="a-creating-a-database-mirroring-session-with-a-witness"></a>A. Создание сеанса зеркального отображения базы данных со свидетелем  
 Установка зеркального отображения базы данных со следящим сервером требует настройки безопасности и подготовки зеркальной базы данных, а также использует инструкцию ALTER DATABASE, чтобы установить участников. Пример полностью законченного процесса установки см. в разделе [параметр Настройка зеркального отображения базы данных &#40; SQL Server &#41; ](../../database-engine/database-mirroring/setting-up-database-mirroring-sql-server.md).  
  
### <a name="b-manually-failing-over-a-database-mirroring-session"></a>Б. Ручной переход на другой ресурс в сеансе зеркального отображения базы данных  
 Отработка отказа вручную может быть инициализирована любым участником зеркального отображения базы данных. Перед переходом на другой ресурс необходимо проверить, что сервер, который считается текущим основным сервером, действительно является основным сервером. Например, для базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] на экземпляре сервера, который предположительно является основным сервером в настоящий момент, выполните следующий запрос:  
  
```  
SELECT db.name, m.mirroring_role_desc   
FROM sys.database_mirroring m   
JOIN sys.databases db  
ON db.database_id = m.database_id  
WHERE db.name = N'AdventureWorks2012';   
GO  
```  
  
 Если экземпляр сервера действительно является основным, значением `mirroring_role_desc` будет `Principal`. Если этот экземпляр сервера был зеркальным сервером, инструкция `SELECT` возвратит `Mirror`.  
  
 В следующем примере предполагается, что сервер является текущим основным сервером.  
  
1.  Ручной переход на другой ресурс участника зеркального отображения базы данных:  
  
    ```  
    ALTER DATABASE AdventureWorks2012 SET PARTNER FAILOVER;  
    GO  
    ```  
  
2.  Чтобы проверить результаты отработки отказа на новое зеркало, выполните следующий запрос:  
  
    ```  
    SELECT db.name, m.mirroring_role_desc   
    FROM sys.database_mirroring m   
    JOIN sys.databases db  
    ON db.database_id = m.database_id  
    WHERE db.name = N'AdventureWorks2012';   
    GO  
    ```  
  
     Текущее значение параметра `mirroring_role_desc` теперь `Mirror`.  
  
## <a name="see-also"></a>См. также:  
 [CREATE DATABASE (SQL Server Transact-SQL)](../../t-sql/statements/create-database-sql-server-transact-sql.md)   
 [DATABASEPROPERTYEX (Transact-SQL)](../../t-sql/functions/databasepropertyex-transact-sql.md)   
 [sys.database_mirroring_witnesses &#40; Transact-SQL &#41;](../../relational-databases/system-catalog-views/database-mirroring-witness-catalog-views-sys-database-mirroring-witnesses.md)  
  
  

