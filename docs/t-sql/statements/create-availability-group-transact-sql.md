---
title: "Создание группы ДОСТУПНОСТИ (Transact-SQL) | Документы Microsoft"
ms.custom: 
ms.date: 10/16/2017
ms.prod: sql-non-specified
ms.prod_service: sql-database
ms.service: 
ms.component: t-sql|statements
ms.reviewer: 
ms.suite: sql
ms.technology: database-engine
ms.tgt_pltfrm: 
ms.topic: language-reference
f1_keywords:
- AVAILABILITY GROUP
- CREATE_AVAILABILITY_TSQL
- CREATE_AVAILABILITY_GROUP_TSQL
- CREATE AVAILABILITY GROUP
- CREATE AVAILABILITY
- AVAILABILITY_GROUP_TSQL
dev_langs: TSQL
helpviewer_keywords:
- Availability Groups [SQL Server], listeners
- CREATE AVAILABILITY GROUP statement
- Availability Groups [SQL Server], creating
- Availability Groups [SQL Server], Transact-SQL statements
ms.assetid: a3d55df7-b4e4-43f3-a14b-056cba36ab98
caps.latest.revision: "196"
author: MikeRayMSFT
ms.author: mikeray
manager: jhubbard
ms.workload: On Demand
ms.openlocfilehash: 35ccffcfbdce2c10b20c8459e59a1c2d41962088
ms.sourcegitcommit: 66bef6981f613b454db465e190b489031c4fb8d3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2017
---
# <a name="create-availability-group-transact-sql"></a>CREATE AVAILABILITY GROUP (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2012-xxxx-xxxx-xxx-md](../../includes/tsql-appliesto-ss2012-xxxx-xxxx-xxx-md.md)]

  Создание новой группы доступности при условии, что экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] включен для функции [!INCLUDE[ssHADR](../../includes/sshadr-md.md)].  
  
> [!IMPORTANT]  
>  Выполните CREATE AVAILABILITY GROUP в экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], который предполагается использовать в качестве начальной первичной реплики создаваемой группы доступности. Этот экземпляр сервера должен располагаться на узле отказоустойчивого кластера Windows Server (WSFC).  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```SQL  
  
CREATE AVAILABILITY GROUP group_name  
   WITH (<with_option_spec> [ ,...n ] )  
   FOR [ DATABASE database_name [ ,...n ] ]  
   REPLICA ON <add_replica_spec> [ ,...n ]  
   AVAILABILITY GROUP ON <add_availability_group_spec> [ ,...2 ]  
   [ LISTENER ‘dns_name’ ( <listener_option> ) ]  
[ ; ]  
  
<with_option_spec>::=   
    AUTOMATED_BACKUP_PREFERENCE = { PRIMARY | SECONDARY_ONLY| SECONDARY | NONE }  
  | FAILURE_CONDITION_LEVEL  = { 1 | 2 | 3 | 4 | 5 }   
  | HEALTH_CHECK_TIMEOUT = milliseconds  
  | DB_FAILOVER  = { ON | OFF }   
  | DTC_SUPPORT  = { PER_DB | NONE }  
  | BASIC  
  | DISTRIBUTED
  | REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT = { integer }
  | CLUSTER_TYPE = { WSFC | EXTERNAL | NONE } 
  
<add_replica_spec>::=  
  <server_instance> WITH  
    (  
       ENDPOINT_URL = 'TCP://system-address:port',  
       AVAILABILITY_MODE = { SYNCHRONOUS_COMMIT | ASYNCHRONOUS_COMMIT | CONFIGURATION_ONLY },  
       FAILOVER_MODE = { AUTOMATIC | MANUAL | EXTERNAL }  
       [ , <add_replica_option> [ ,...n ] ]  
    )   
  
  <add_replica_option>::=  
       SEEDING_MODE = { AUTOMATIC | MANUAL }  
     | BACKUP_PRIORITY = n  
     | SECONDARY_ROLE ( {   
            [ ALLOW_CONNECTIONS = { NO | READ_ONLY | ALL } ]   
        [,] [ READ_ONLY_ROUTING_URL = 'TCP://system-address:port' ]  
     } )  
     | PRIMARY_ROLE ( {   
            [ ALLOW_CONNECTIONS = { READ_WRITE | ALL } ]   
        [,] [ READ_ONLY_ROUTING_LIST = { ( ‘<server_instance>’ [ ,...n ] ) | NONE } ]  
     } )  
     | SESSION_TIMEOUT = integer  
  
<add_availability_group_spec>::=  
 <ag_name> WITH  
    (  
       LISTENER_URL = 'TCP://system-address:port',  
       AVAILABILITY_MODE = { SYNCHRONOUS_COMMIT | ASYNCHRONOUS_COMMIT },  
       FAILOVER_MODE = MANUAL,  
       SEEDING_MODE = { AUTOMATIC | MANUAL }  
    )  
  
<listener_option> ::=  
   {  
      WITH DHCP [ ON ( <network_subnet_option> ) ]  
    | WITH IP ( { ( <ip_address_option> ) } [ , ...n ] ) [ , PORT = listener_port ]  
   }  
  
  <network_subnet_option> ::=  
     ‘four_part_ipv4_address’, ‘four_part_ipv4_mask’    
  
  <ip_address_option> ::=  
     {   
        ‘four_part_ipv4_address’, ‘four_part_ipv4_mask’  
      | ‘ipv6_address’  
     }  
  
```  
  
## <a name="arguments"></a>Аргументы  
 *имя_группы*  
 Указывает имя новой группы доступности. *имя_группы* должен быть допустимым [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] [идентификатор](../../relational-databases/databases/database-identifiers.md), и оно должно быть уникальным во всех группах доступности в кластере WSFC. Максимальная длина имени группы доступности составляет 128 символов.  
  
 AUTOMATED_BACKUP_PREFERENCE  **=**  {ОСНОВНОЙ | SECONDARY_ONLY | ВТОРИЧНЫЙ | НЕТ}  
 Указывает приоритет, согласно которому задание резервного копирования вычисляет первичную реплику при выборе места для создания резервных копий. Вы можете написать скрипт для того, чтобы задание резервного копирования учитывало приоритет автоматического резервного копирования. Важно понимать, что приоритет не определяется [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], поэтому он не влияет на выполнение нерегламентированного резервного копирования.  
  
 Поддерживаются следующие значения:  
  
 PRIMARY  
 Указывает, что резервное копирования должно всегда выполняться на первичной реплике. Данный параметр является полезным, если вам требуются такие функции резервного копирования, как создание разностных резервных копий, которые не поддерживаются при выполнении резервного копирования на вторичной реплике.  
  
> [!IMPORTANT]  
>  Если планируется использовать доставку журналов для подготовки баз данных-получателей для группы доступности, задайте параметру автоматизированного резервного копирования значение **Первичная** до тех пор, пока все базы данных-получатели не будут подготовлены и присоединены к группе доступности.  
  
 SECONDARY_ONLY  
 Указывает, что резервное копирование никогда не выполняется на первичной реплике. Если первичная реплика является единственной репликой, находящейся в режиме «в сети», резервное копирование не будет выполняться.  
  
 SECONDARY  
 Указывает, что резервное копирование должно выполняться на вторичной реплике, за исключением тех случаев, когда в режиме «в сети» находится только первичная реплика. В этом случае резервное копирование будет выполняться на первичной реплике. Это поведение по умолчанию.  
  
 None  
 Указывает, что вы предпочитаете, чтобы задания резервного копирования пропускали реплики доступности при выборе реплики для создания резервных копий. Примечание. Задания резервного копирования могут учитывать другие факторы, например приоритет резервного копирования каждой реплики доступности в сочетании с ее состоянием работоспособности и соединения.  
  
> [!IMPORTANT]  
>  Принудительного применения параметра AUTOMATED_BACKUP_PREFERENCE не существует. Интерпретация данного приоритета зависит от логики (при ее наличии), которая внесена в задания резервного копирования для баз данных в указанной группе доступности. Параметр автоматического резервного копирования не влияет на выполнение нерегламентированного резервного копирования. Дополнительные сведения см. в разделе [Настройка резервного копирования в репликах доступности &#40; SQL Server &#41; ](../../database-engine/availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).  
  
> [!NOTE]  
>  Чтобы просмотреть автоматического резервного копирования для существующей группы доступности, выберите **automated_backup_preference** или **automated_backup_preference_desc** столбец [ sys.availability_groups](../../relational-databases/system-catalog-views/sys-availability-groups-transact-sql.md) представления каталога. Кроме того [sys.fn_hadr_backup_is_preferred_replica &#40; Transact-SQL &#41; ](../../relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql.md) может использоваться для определения предпочитаемой репликой резервного копирования.  Эта функция возвращает 1 для по крайней мере одна из реплик, даже если `AUTOMATED_BACKUP_PREFERENCE = NONE`.  
  
 FAILURE_CONDITION_LEVEL  **=**  {1 | 2 | **3** | 4 | 5}  
 Указывает, какие условия сбоя инициируют автоматический переход на другой ресурс для этой группы доступности. FAILURE_CONDITION_LEVEL задается на уровне группы, но только на репликах доступности, настроенных для режима доступности синхронной фиксации (AVAILIBILITY_MODE  **=**  SYNCHRONOUS_COMMIT). Кроме того, условия сбоя могут запустить автоматический переход на другой ресурс только в том случае, если первичная и Вторичная реплики настроены на режим автоматического перехода на другой ресурс (FAILOVER_MODE  **=**  АВТОМАТИЧЕСКОГО) и Вторичная реплика в данный момент синхронизирована с первичной репликой.  
  
 Уровни условий сбоя (1–5) варьируются от наименее ограничительного уровня 1 до наиболее ограничительного уровня 5. Заданный уровень условий включает в себя ограничения всех предыдущих уровней. Таким образом, наиболее строгий уровень 5 включает в себя ограничения уровней с 1 по 4, уровень 4 содержит ограничения уровней с 1 по 3 и т. д. Уровни условий сбоя описаны в следующей таблице.  
  
|Level|Условия сбоя|  
|-----------|-----------------------|  
|1|Указывает, что следует запустить автоматический переход на другой ресурс при возникновении любой из следующих ситуаций.<br /><br /> - [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Служба не работает.<br /><br /> — Аренда группы доступности для подключения к кластеру WSFC истекла, поскольку не ACK получено от экземпляра сервера. Дополнительные сведения см. в разделе [Принцип работы. Время ожидания аренды AlwaysOn в SQL Server](http://blogs.msdn.com/b/psssql/archive/2012/09/07/how-it-works-sql-server-AlwaysOn-lease-timeout.aspx).|  
|2|Указывает, что следует запустить автоматический переход на другой ресурс при возникновении любой из следующих ситуаций.<br /><br /> -Экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не подключается к кластеру и превышено определяемый пользователем порог HEALTH_CHECK_TIMEOUT группы доступности.<br /><br /> -Группа доступности находится в неисправном состоянии.|  
|3|Указывает, что следует запустить автоматический переход на другой ресурс в случае появления критических внутренних ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], таких как потерянные спин-блокировки, серьезные нарушения доступа для записи или формирование слишком больших дампов.<br /><br /> Это поведение по умолчанию.|  
|4|Указывает, что следует запустить автоматический переход на другой ресурс в случае появления не столь серьезных внутренних ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], например устойчивое состояние нехватки памяти в пуле внутренних ресурсов [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].|  
|5|Указывает, что следует запустить автоматический переход на другой ресурс при любом удовлетворяющим условиям состоянии сбоя, включая:<br /><br /> -Исчерпание рабочих потоков SQL Engine.<br /><br /> -Обнаружение неразрешимой взаимоблокировки.|  
  
> [!NOTE]  
>  Отсутствие ответа экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] на клиентские запросы не является существенным для групп доступности.  
  
 Значения FAILURE_CONDITION_LEVEL и HEALTH_CHECK_TIMEOUT определяют *гибкой политики отработки отказа* для заданной группы. Данная гибкая политика отработки отказа предоставляет гранулярное управление условиями, которые могут вызвать автоматический переход на другой ресурс. Дополнительные сведения см. в разделе [гибкая политика отработки отказа для автоматического перехода на другой ресурс для группы доступности &#40; SQL Server &#41; ](../../database-engine/availability-groups/windows/flexible-automatic-failover-policy-availability-group.md).  
  
 HEALTH_CHECK_TIMEOUT  **=**  *миллисекунд*  
 Указывает время ожидания (в миллисекундах) для [sp_server_diagnostics](../../relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql.md) системные хранимые процедуры возвращают сведения о состоянии сервера, прежде чем кластер WSFC признает, что экземпляр сервера работает медленно или завис. HEALTH_CHECK_TIMEOUT задано на уровне группы, но только на репликах доступности, настроенных для режима доступности синхронной фиксации с автоматическим переходом на другой (AVAILIBILITY_MODE  **=**  СИНХРОННОЙ _COMMIT).  Более того, истечения времени ожидания проверки работоспособности можно запустить автоматический переход на другой ресурс только в том случае, если первичная и Вторичная реплики настроены на режим автоматического перехода на другой ресурс (FAILOVER_MODE  **=**  АВТОМАТИЧЕСКОГО) и сервер-получатель реплика синхронизируется с первичной репликой.  
  
 Значение параметра HEALTH_CHECK_TIMEOUT по умолчанию — 30 000 миллисекунд (30 секунд). Минимальное значение — 15 000 миллисекунд (15 секунд), а максимальное значение — 4 294 967 295 миллисекунд.  
  
> [!IMPORTANT]  
>  **sp_server_diagnostics** не выполняет проверку работоспособности на уровне базы данных.  
  
 DB_FAILOVER  **=**  {ON | {OFF}  
 Задает ответ, выполняемое при первичной реплике базы данных находится в автономном режиме. Если задано значение ON, любое состояние, отличное от ONLINE для базы данных в группе доступности инициирует автоматический переход на другой. Если этот параметр имеет значение OFF, только работоспособности экземпляра используется для запуска автоматического перехода на другой ресурс.  
  
  Дополнительные сведения о параметре см. в разделе [параметр обнаружения работоспособности уровня базы данных](../../database-engine/availability-groups/windows/sql-server-always-on-database-health-detection-failover-option.md) 
  
 DTC_SUPPORT  **=**  {PER_DB | НЕТ}  
 Указывает, поддерживаются ли транзакции между базами данных с помощью координатора распределенных транзакций (DTC). Межбазовые транзакции поддерживаются только начиная с версии [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]. PER_DB создает группу доступности с поддержкой этих транзакций. Дополнительные сведения см. в статье [Транзакции между базами данных и распределенные транзакции для групп доступности AlwaysOn и зеркального отображения базы данных (SQL Server)](../../database-engine/availability-groups/windows/transactions-always-on-availability-and-database-mirroring.md).  
  
 BASIC  
 Используется для создания основной группы доступности. Основные группы доступности можно только для одной базы данных и две реплики: первичной реплики и одной вторичной реплики. Этот параметр является заменой для устаревшие функцию в SQL Server Standard Edition зеркального отображения базы данных. Дополнительные сведения см. в разделе [основные группы доступности &#40; Всегда в группах доступности &#41; ](../../database-engine/availability-groups/windows/basic-availability-groups-always-on-availability-groups.md). Основные группы доступности поддерживаются начиная с версии [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)].  

 DISTRIBUTED  
 Используется для создания распределенной группы доступности. Этот параметр используется с параметром ON группы ДОСТУПНОСТИ для подключения двух групп доступности в отдельные отказоустойчивые кластеры Windows Server.  Дополнительные сведения см. в разделе [Распределенные группы доступности (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/distributed-availability-groups-always-on-availability-groups.md). Распределенные группы доступности поддерживаются начиная с версии [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]. 

 REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT   
 Появился в SQL Server 2017 г. Позволяет задать минимальное число синхронных вторичных реплик, необходимые для фиксации, прежде чем основной фиксирует транзакцию. Гарантирует транзакций SQL Server ожидает журналы транзакций будут обновлены на минимальное число вторичных реплик. Значение по умолчанию — 0, что дает то же поведение, что SQL Server 2016. Минимальное значение — 0. Максимальное значение — количество реплик минус 1. Этот параметр относится к репликам в режиме синхронной фиксации. Когда реплики находятся в режиме синхронной фиксации, операций записи на первичной реплике ждать до записи на вторичных репликах синхронной фиксации в журнал транзакций базы данных реплики. Если SQL Server, на котором размещена вторичная реплика перестает отвечать, SQL Server, на котором размещена первичная реплика реплика помечает вторичную как не СИНХРОНИЗИРОВАНЫ и продолжить работу. Когда отвечать на запросы базы данных в оперативный он находится в состоянии «не синхронизировано» и реплика помечена как как имеющий неполадки, пока основной можно вновь сделать ее синхронной. Данный параметр гарантирует, что первичная реплика ожидает, пока минимальное число реплик, которые были зафиксированы каждой транзакции. Если минимальное число реплик недоступен ошибкой фиксации на сервере-источнике. Для типа кластера `EXTERNAL` параметр изменяется при добавлении группы доступности для ресурса кластера. В разделе [высокий уровень доступности и защиты данных в конфигурации группы доступности](../../linux/sql-server-linux-availability-group-ha.md).

 CLUSTER_TYPE  
 Появился в SQL Server 2017 г. Используется для определения, если группа доступности на кластере отработки отказа Windows Server (WSFC).  Значение WSFC, если группа доступности находится на экземпляре отказоустойчивого кластера в отказоустойчивом кластере Windows Server. Значение ВНЕШНЕЙ при кластера управляется диспетчером кластеров, не отказоустойчивого кластера Windows Server, такие как Linux Pacemaker. Задано значение NONE, если не используется WSFC для координации кластера группы доступности. Например, при группы доступности включает серверы Linux с без диспетчера кластеров. 

 База данных *имя_базы_данных*  
 Задает список из одной или нескольких пользовательских баз данных на локальном экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] (то есть на экземпляре сервера, на котором создается группа доступности). Можно указать несколько баз данных для группы доступности, но каждая база данных может принадлежать только к одной группе доступности. Сведения о типе баз данных, которые могут поддерживаться группой доступности см. в разделе [условия, ограничения и рекомендации для групп доступности AlwaysOn &#40; SQL Server &#41; ](../../database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability.md). Чтобы узнать, какие локальные базы данных уже принадлежит к группе доступности, в разделе **replica_id** столбца в [sys.databases](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md) представления каталога.  
  
 Предложение DATABASE не является обязательным. Если он опущен, новой группы доступности будет пустым.  
  
 После создания группы доступности, подключитесь к каждому экземпляру сервера, на котором размещена вторичная реплика и подготовьте все базы данных-получателя и присоединить ее к группе доступности. Дополнительные сведения см. в статье [Запуск перемещения данных для базы данных-получателя AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/start-data-movement-on-an-always-on-secondary-database-sql-server.md).  
  
> [!NOTE]  
>  Затем можно добавлять готовые базы данных в экземпляре сервера, где размещается текущая первичная реплика, в группу доступности. Также можно удалять базу данных из группы доступности. Дополнительные сведения см. в разделе [ALTER AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/alter-availability-group-transact-sql.md).  
  
 REPLICA ON  
 Указывает от одного до пяти экземпляров SQL Server для размещения реплик доступности в новой группе доступности.  Каждая реплика задается по адресу экземпляра своего сервера, за которым следует предложение WITH (…). Как минимум необходимо указать экземпляр локального сервера, который станет начальной первичной репликой. Дополнительно можно указать до четырех вторичных реплик.  
  
 Необходимо включить каждую вторичную реплику в группу доступности. Дополнительные сведения см. в разделе [ALTER AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/alter-availability-group-transact-sql.md).  
  
> [!NOTE]  
>  Если указать не более четырех вторичных реплик при создании группы доступности, дополнительные вторичные реплики можно в любое время с помощью [ALTER AVAILABILITY GROUP](../../t-sql/statements/alter-availability-group-transact-sql.md) [!INCLUDE[tsql](../../includes/tsql-md.md)] инструкции. Эту инструкцию также можно использовать для удаления любой вторичной реплики из существующей группы доступности.  
  
 \<экземпляр сервера > задает адрес экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , на котором размещена реплика. Формат адреса зависит от вида экземпляра (именованный или по умолчанию) и типа экземпляра (изолированный или экземпляр отказоустойчивого кластера):  
  
 { '*системное_имя*[\\*имя_экземпляра*]' | '*сетевое_имя_FCI*[\\*имя_экземпляра*]' }  
  
 Этот адрес состоит из следующих компонентов:  
  
 *системное_имя*  
 Имя NetBIOS компьютера, на котором расположен целевой экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Этот компьютер должен быть узлом кластера WSFC.  
  
 *сетевое_имя_FCI*  
 Это сетевое имя, используемое для доступа к отказоустойчивому кластеру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Используйте его, если экземпляр сервера является участником — партнером по обеспечению отработки отказа [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Выполнение SELECT [@@SERVERNAME ](../../t-sql/functions/servername-transact-sql.md) в FCI экземпляр сервера возвращает всю его "*FCI_network_name*[\\*имя_экземпляра*]" строки (который является Полное имя реплики).  
  
 *имя_экземпляра*  
 Имя экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , размещенного на *СИСТЕМНОЕ_ИМЯ* или *FCI_network_name* и имеющий HADR включена служба. Для экземпляра сервера по умолчанию указывать параметр *имя_экземпляра* не обязательно. В именах экземпляров не учитывается регистр символов. На экземпляре изолированного сервера, этот параметр имеет значение, возвращаемое при выполнении инструкции SELECT [@@SERVERNAME](../../t-sql/functions/servername-transact-sql.md).  
  
 \  
 Разделитель, используемый только при указании *имя_экземпляра*, чтобы отделить от *СИСТЕМНОЕ_ИМЯ* или *FCI_network_name*.  
  
 Сведения о компонентах, необходимых для узлов WSFC и экземпляры сервера в разделе [условия, ограничения и рекомендации для групп доступности AlwaysOn &#40; SQL Server &#41; ](../../database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability.md).  
  
 ENDPOINT_URL **= "**TCP**://***системный_адрес***:***порт***"**  
 Указывает URL-адрес [конечной точки зеркального отображения базы данных](../../database-engine/database-mirroring/the-database-mirroring-endpoint-sql-server.md) на экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , на котором размещена реплика доступности, которая определяется в текущем предложении REPLICA ON.  
  
 Предложение ENDPOINT_URL является обязательным. Дополнительные сведения см. в разделе [Указание URL-адреса конечной точки при добавлении или изменении реплики доступности (SQL Server)](../../database-engine/availability-groups/windows/specify-endpoint-url-adding-or-modifying-availability-replica.md).  
  
 **"**TCP**://***системный_адрес***:***порт***"**  
 Задает URL-адрес для конечной точки или URL-адрес маршрутизации, доступный только для чтения. Параметры URL-адреса:  
  
 *system-address*  
 Это строка, такая как адрес системы, полное доменное имя или IP-адрес, однозначно идентифицирующий целевую компьютерную систему.  
  
 *port*  
 Номер порта, связанный с конечной точкой зеркального отображения экземпляра сервера-участника (для параметра ENDPOINT_URL), или номер порта, используемый компонентом [!INCLUDE[ssDE](../../includes/ssde-md.md)] в экземпляре сервера (для параметра READ_ONLY_ROUTING_URL).  
  
 AVAILABILITY_MODE  **=**  {{SYNCHRONOUS_COMMIT | ASYNCHRONOUS_COMMIT НЕ БОЛЕЕ ЧЕМ | CONFIGURATION_ONLY}  
 SYNCHRONOUS_COMMIT или asynchronous_commit не более чем указывает, имеет ли первичная реплика ожидания вторичной реплики подтверждения фиксации (записи) записи журнала на диск, прежде чем первичная реплика может фиксировать транзакции на сервере-источнике данного База данных. Фиксация транзакций в других базах данных, расположенных в этой первичной реплике, может выполняться независимо. SQL Server 2017 г накопительным пакетом обновления 1 появились CONFIGURATION_ONLY. Реплика CONFIGURATION_ONLY применяется только в группы доступности с CLUSTER_TYPE = ВНЕШНИЕ или CLUSTER_TYPE = NONE. 
  
 SYNCHRONOUS_COMMIT  
 Указывает, что первичная реплика ожидает фиксации транзакции, пока они не записаны в этой вторичной реплике (режим синхронной фиксации). Вы можете указать SYNCHRONOUS_COMMIT не более чем для трех реплик, включая первичную.  
  
 ASYNCHRONOUS_COMMIT  
 Указывает, что первичная реплика фиксирует транзакции без ожидания записи журнала на данной вторичной реплике (режим доступности синхронной фиксации). Вы можете указать ASYNCHRONOUS_COMMIT не более чем для пяти реплик доступности, включая первичную реплику.  

 CONFIGURATION_ONLY указывает, что первичная реплика синхронно фиксировать метаданные конфигурации группы доступности к базе данных master в этой реплике. Реплика не будет содержать данные пользователя. Этот параметр:

- Может размещаться в любом выпуске SQL Server, включая экспресс-выпуск.
- Требуется реплики CONFIGURATION_ONLY должен иметь тип конечной точки зеркального отображения данных `WITNESS`.
- Не может быть изменен.
- Не является допустимым при `CLUSTER_TYPE = WSFC`. 

   Дополнительные сведения см. в разделе [конфигурации реплицируют только](../../linux/sql-server-linux-availability-group-ha.md).
  
 Предложение AVAILABILITY_MODE является обязательным. Дополнительные сведения см. в статье [Режимы доступности (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/availability-modes-always-on-availability-groups.md).  
  
 FAILOVER_MODE  **=**  {АВТОМАТИЧЕСКОГО | ВРУЧНУЮ}  
 Указывает режим отработки отказов определяемой реплики доступности.  
  
 AUTOMATIC  
 Включает автоматический переход на другой ресурс. Этот параметр поддерживается только в том случае, если также указывается AVAILABILITY_MODE = SYNCHRONOUS_COMMIT. Значение AUTOMATIC можно задать для двух реплик доступности, включая первичную.  
  
> [!NOTE]  
>  Экземпляры отказоустойчивого кластера SQL Server не поддерживают автоматический переход на другой ресурс с учетом групп доступности, поэтому любая реплика доступности, размещенная в них, должна быть настроена для перехода на другой ресурс вручную.  
  
 MANUAL  
 Обеспечивает переход на другой ресурс вручную или Принудительный переход на другой ресурс вручную (обычно называется *Принудительная отработка отказа*) администратором базы данных.  
  
 Предложение FAILOVER_MODE является обязательным. Существует два вида перехода на другой ресурс вручную: переход на другой ресурс вручную без потери данных и принудительный переход на другой ресурс (с возможной потерей данных), которые поддерживаются в зависимости от различных условий. Дополнительные сведения см. далее в подразделе [Отработка отказа и режимы отработки отказа (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/failover-and-failover-modes-always-on-availability-groups.md).  
  
 SEEDING_MODE  **=**  {АВТОМАТИЧЕСКОГО | ВРУЧНУЮ}  
 Указывает, как вторичная реплика изначально заполнена.  
  
 AUTOMATIC  
 Позволяет прямого присвоения начальных значений. Этот метод заполняет вторичную реплику по сети. Этот метод не требует резервного копирования и восстановления копии базы данных-источника в реплике.  
  
> [!NOTE]  
>  Для прямого присвоения начальных значений, необходимо разрешить создание базы данных во вторичной реплике, вызвав **ALTER AVAILABILITY GROUP** с **GRANT CREATE ANY DATABASE** параметр.  
  
 MANUAL  
 Указывает ручного заполнения (по умолчанию). Этот метод требуется для создания резервной копии базы данных на первичной реплике и вручную восстановите эту резервную копию на вторичной реплике.  
  
 BACKUP_PRIORITY  **=** *n*  
 Указывает приоритет выполнения резервного копирования на данной реплике по отношению к другим репликам из той же группы доступности. Значение представляет собой целое число в диапазоне от 0 до 100. Данные величины имеют следующие значения:  
  
-   1..100 показывает, что реплику доступности можно выбрать для выполнения резервного копирования. 1 указывает минимальный приоритет, 100 — наивысший приоритет. При BACKUP_PRIORITY = 1 реплика доступности будет выбрана для создания резервных копий только в том случае, если реплики доступности с более высоким приоритетом отсутствуют.  
  
-   0 указывает, что эта реплика доступности не для создания резервных копий. Этот параметр может быть полезным, например, для исключения удаленной реплики доступности, создание резервных копий на которой нежелательно.  
  
 Дополнительные сведения см. в статье [Активные вторичные реплики, резервное копирование во вторичных репликах (группы доступности Always On)](../../database-engine/availability-groups/windows/active-secondaries-backup-on-secondary-replicas-always-on-availability-groups.md).  
  
 SECONDARY_ROLE **(** ... **)**  
 Задает параметры роли, которые вступают в силу, если эта реплика доступности в данный момент имеет вторичную роль (то есть когда она является вторичной). В скобках укажите один или два параметра вторичной роли. Если указываются оба параметра, используйте список с разделителями-запятыми.  
  
 Параметры вторичной роли:  
  
 ALLOW_CONNECTIONS  **=**  {НЕТ | READ_ONLY | ALL}  
 Указывает, могут ли базы данных заданной реплики доступности, играющей роль вторичной (т. е. служащей вторичной репликой), принимать соединения от клиентов. Может принимать одно из следующих значений:  
  
 NO  
 Для баз данных-получателей этой реплики соединения пользователя не разрешаются. Для них не разрешен доступ для чтения. Это поведение по умолчанию.  
  
 READ_ONLY  
 Разрешаются только соединения с базами данных во вторичной реплике, в которых свойство «назначение приложения» равно **ReadOnly**. Дополнительные сведения об этом свойстве см. в разделе [Using Connection String Keywords with SQL Server Native Client](../../relational-databases/native-client/applications/using-connection-string-keywords-with-sql-server-native-client.md).  
  
 ALL  
 К базам данных во вторичной реплике разрешаются все соединения на доступ только для чтения.  
  
 Дополнительные сведения см. в разделе [Активные вторичные реплики: доступные только для чтения вторичные реплики (группы доступности AlwaysOn)](../../database-engine/availability-groups/windows/active-secondaries-readable-secondary-replicas-always-on-availability-groups.md).  
  
 READ_ONLY_ROUTING_URL **= "**TCP**://***системный_адрес***:***порт***"**  
 Указывает URL-адрес, используемый для маршрутизации запросов на соединение с намерением чтения к этой реплике доступности. Этот URL-адрес прослушивается компонентом ядра СУБД SQL Server. Обычно экземпляр по умолчанию компонента ядра СУБД SQL Server прослушивает TCP-порт 1433.  
  
 Для именованного экземпляра, номер порта можно получить путем запроса **порт** и **type_desc** столбцы [sys.dm_tcp_listener_states](../../relational-databases/system-dynamic-management-views/sys-dm-tcp-listener-states-transact-sql.md) динамическое административное представление. Экземпляр сервера использует прослушиватель Transact-SQL (**type_desc = «TSQL»**).  
  
 Дополнительные сведения о вычислении URL маршрутизации только для чтения для реплики см. в разделе [вычисление значения read_only_routing_url для AlwaysOn](http://blogs.msdn.com/b/mattn/archive/2012/04/25/calculating-read-only-routing-url-for-AlwaysOn.aspx).  
  
> [!NOTE]  
>  Для именованного экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] прослушиватель Transact-SQL должен быть настроен для использования определенного порта. Дополнительные сведения см. в разделе [Настройка сервера для прослушивания указанного TCP-порта (диспетчер конфигурации SQL Server)](../../database-engine/configure-windows/configure-a-server-to-listen-on-a-specific-tcp-port.md).  
  
 PRIMARY_ROLE **(** ... **)**  
 Задает параметры роли, которые вступают в силу, если эта реплика доступности в данный момент имеет первичную роль (то есть когда она является первичной репликой). В скобках укажите один или два параметра первичной роли. Если указываются оба параметра, используйте список с разделителями-запятыми.  
  
 Параметры первичной роли:  
  
 ALLOW_CONNECTIONS  **=**  {READ_WRITE | ALL}  
 Указывает тип соединений, которые принимаются от клиентов базами данных заданной реплики доступности, которая играет роль первичной. Это может быть один из следующих типов:  
  
 READ_WRITE  
 Соединения, у которых свойство "Назначение приложения" равно **ReadOnly** , не разрешены.  Если свойство «Назначение приложения» имеет значение **ReadWrite** или не задано, то соединение разрешено. Дополнительные сведения о свойстве соединения «Назначение приложения» см. в разделе [Using Connection String Keywords with SQL Server Native Client](../../relational-databases/native-client/applications/using-connection-string-keywords-with-sql-server-native-client.md).  
  
 ALL  
 Разрешаются все соединения с базами данных в первичной реплике. Это поведение по умолчанию.  
  
 READ_ONLY_ROUTING_LIST  **=**  { **("**\<экземпляр_сервера >**"** [ **,**... *n* ] **)** | Нет} задает разделенный запятыми список экземпляров серверов, на которых размещены реплики доступности для этой группы доступности, которые отвечают следующим требованиям при выполнении вторичной роли:  
  
-   Настроены для разрешения всех соединений или соединений только для чтения (см. выше аргумент ALLOW_CONNECTIONS параметра SECONDARY_ROLE).  
  
-   Определен URL-адрес маршрутизации только для чтения (см. выше аргумент READ_ONLY_ROUTING_URL параметра SECONDARY_ROLE).  
  
 READ_ONLY_ROUTING_LIST имеет следующие значения.  
  
 \<экземпляр сервера > задает адрес экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , на котором размещена реплика, которая является вторичная реплика, при выполнении вторичной роли.  
  
 Используйте список с разделителями-запятыми, чтобы указать все экземпляры сервера, где может размещаться доступная для чтения вторичная реплика. Порядок, в котором серверные экземпляры указываются в списке проходит по Маршрутизация только для чтения. Если включить экземпляр сервера, где размещается реплика, в список маршрутизации только для чтения, то обычно рекомендуется поместить этот экземпляр сервера в конец списка, чтобы подключения с намерением чтения направлялись на вторичную реплику, если она доступна.  
  
 Начиная с версии [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)], вы можете балансировать нагрузку запросов доступ только для чтения на вторичные реплики для чтения. Можно указать, установив реплики в наборе вложенных скобок в списке маршрутизации только для чтения. Дополнительные сведения и примеры см. в разделе [Настройка балансировки нагрузки между репликами только для чтения](../../database-engine/availability-groups/windows/configure-read-only-routing-for-an-availability-group-sql-server.md#loadbalancing).  
  
 None  
 Указывает, когда эта реплика доступности является первичной, маршрутизация только для чтения не поддерживается. Это поведение по умолчанию.  
  
 SESSION_TIMEOUT  **=**  *целое число со знаком*  
 Указывает интервал времени ожидания сеанса в секундах. Если этот параметр не определить, интервал времени по умолчанию — 10 секунд. Минимальное значение составляет 5 секунд.  
  
> [!IMPORTANT]  
>  Рекомендуется установить интервал времени ожидания в 10 секунд или более.  
  
 Дополнительные сведения о времени ожидания сеанса см. в разделе [Обзор из группы доступности AlwaysOn &#40; SQL Server &#41; ](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md).  
  
 ГРУППЫ ДОСТУПНОСТИ  
 Указывает две группы доступности, которые составляют *распределенной группы доступности*. Каждая группа доступности входит в свой собственный кластер отработки отказа Windows Server (WSFC). При создании распределенной группы доступности в группу доступности на текущий экземпляр SQL Server становится первичной группы доступности. Вторая группа доступности становится вторичной группы доступности.  
  
 Необходимо присоединить к группе доступности во вторичной группе доступности. Дополнительные сведения см. в разделе [ALTER AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/alter-availability-group-transact-sql.md).  
  
 \<ag_name > указывает имя группы доступности, содержащийся в одной половине распределенной группы доступности.  
  
 ПРОСЛУШИВАТЕЛЬ **= "**TCP**://***системный_адрес***:***порт***"**  
 Указывает URL-адрес для прослушивателя, связанного с группой доступности.  
  
 Предложение ПРОСЛУШИВАТЕЛЯ является обязательным.  
  
 **"**TCP**://***системный_адрес***:***порт***"**  
 Указывает URL-адрес для прослушивателя, связанного с группой доступности. Параметры URL-адреса:  
  
 *system-address*  
 — Это строка, такие как имя системы, полное доменное имя или IP-адрес, однозначно идентифицирующий прослушивателя.  
  
 *port*  
 — Номер порта, который связан с конечной точкой зеркального отображения для группы доступности. Обратите внимание, что это не порта прослушивателя.  
  
 AVAILABILITY_MODE  **=**  {SYNCHRONOUS_COMMIT | ASYNCHRONOUS_COMMIT НЕ БОЛЕЕ ЧЕМ | CONFIGURATION_ONLY}  
 Указывает, имеет ли первичная реплика ожидания вторичной группы доступности для подтверждения фиксации (записи) записи журнала на диск, прежде чем первичная реплика может фиксировать транзакцию в указанной базе данных.  
  
 SYNCHRONOUS_COMMIT  
 Указывает, что первичная реплика ожидает фиксации транзакции, пока они не зафиксированы во вторичной группе доступности. Можно указать SYNCHRONOUS_COMMIT до двух групп доступности, включая первичной группы доступности.  
  
 ASYNCHRONOUS_COMMIT  
 Указывает, что первичная реплика фиксирует транзакции, не дожидаясь этой вторичной группы доступности зафиксирует журнал. Можно указать asynchronous_commit не более чем до двух групп доступности, включая первичной группы доступности.  
  
 Предложение AVAILABILITY_MODE является обязательным.  
  
 FAILOVER_MODE  **=**  {ВРУЧНУЮ}  
 Указывает режим отработки отказа распределенной группы доступности.  
  
 MANUAL  
 Обеспечивает переход на другой ресурс вручную или Принудительный переход на другой ресурс вручную (обычно называется *Принудительная отработка отказа*) администратором базы данных.  
  
 Предложение FAILOVER_MODE является обязательным, и единственный параметр — MANUAL. Во вторичной группе доступности автоматический переход на другой ресурс не поддерживается.  
  
 SEEDING_MODE  **=**  {АВТОМАТИЧЕСКОГО | ВРУЧНУЮ}  
 Указывает, как изначально заполнена вторичной группы доступности.  
  
 AUTOMATIC  
 Позволяет прямого присвоения начальных значений. Этот метод заполняет вторичной группе доступности по сети. Этот метод не требует резервного копирования и восстановления копии базы данных-источника на репликах вторичной группы доступности.  
  
 MANUAL  
 Указывает ручного заполнения (по умолчанию). Этот метод необходимо создать резервную копию базы данных на первичной реплике и вручную восстановите эту резервную копию на реплику группы доступности вторичной.  
  
 ПРОСЛУШИВАТЕЛЬ **"***dns_name***" (** \<listener_option > **)** определяет новый прослушиватель группы доступности для этого группы доступности. Аргумент LISTENER является необязательным.  
  
> [!IMPORTANT]  
>  Перед созданием первого прослушивателя настоятельно рекомендуется ознакомиться с [Создание или настройка прослушивателя группы доступности &#40; SQL Server &#41; ](../../database-engine/availability-groups/windows/create-or-configure-an-availability-group-listener-sql-server.md).  
>   
>  После создания прослушивателя для заданной группы доступности настоятельно рекомендуется выполнить следующие действия.  
>   
>  -   Попросите сетевого администратора зарезервировать IP-адрес, который будет использоваться только этим прослушивателем.  
> -   Передайте имя узла DNS прослушивателя разработчикам приложения для использования в строке подключения при запросе клиентских соединений к данной группе доступности.  
  
 *dns_name*  
 Указывает имя узла DNS для прослушивателя группы доступности. Имя DNS прослушивателя должно быть уникальным в домене и в NetBIOS.  
  
 *dns_name* является строковым значением. Это имя может содержать только буквы, цифры, дефисы (-) и знаки подчеркивания (_) в любом порядке. В именах узлов DNS учитывается регистр. Максимальная длина равна 63 символам.  
  
 Мы рекомендуем указывать строку, которая поддается толкованию. Например, для группы доступности с именем `AG1`понятным именем узла DNS будет `ag1-listener`.  
  
> [!IMPORTANT]  
>  NetBIOS распознает только первые 15 символов в dns_name. При наличии двух кластеров WSFC, которые управляются одной службой Active Directory и попытке создать прослушивателей группы доступности в обоих кластерах с именами, содержащими более 15 символов и одинаковым префиксом из 15 символов, ошибка сообщает, что виртуальной сети Имя может не удается подключить ресурс. Дополнительные сведения о правилах именования префиксов для имен DNS см. в разделе [Присвоение имен доменов](http://technet.microsoft.com/library/cc731265\(WS.10\).aspx).  
  
 \<listener_option > LISTENER принимает один из следующих \<listener_option > Параметры: 
  
 С использованием протокола DHCP [ON { **("***four_part_ipv4_address***«,»***four_part_ipv4_mask***")** }]  
 Указывает, что прослушиватель группы доступности используется протокол динамической настройки узла (DHCP).  При необходимости используйте предложение ON для идентификации в сети, на котором создан данный прослушиватель. Протокол DHCP ограничен одной подсети, используемый для каждого экземпляра сервера, на котором размещена реплика в группе доступности.  
  
> [!IMPORTANT]  
>  Использовать протокол DHCP в производственной среде не рекомендуется. Если во время простоя аренда IP-адреса протокола DHCP истечет, то на регистрацию нового сетевого IP-адреса протокола DHCP, связанного с именем DNS-прослушивателя, уйдет дополнительное время, что скажется на производительности клиента. Однако протокол DHCP полезен при настройке среды разработки и проверки и позволяет проверить базовые функции групп доступности и их интеграцию с приложениями.  
  
 Например:  
  
 `WITH DHCP ON ('10.120.19.0','255.255.254.0')`  
  
 С IP-адресом **(** { **("***four_part_ipv4_address***«,»***four_part_ipv4_mask* **')** | **("***ipv6_address***")** } [ **,** ...  *n*  ] **)** [ **,** ПОРТ  **=**  *listener_port* ]  
 Указывает, что вместо использования протокола DHCP, прослушиватель группы доступности использует один или несколько статических IP-адресов. Чтобы создать группу доступности, охватывающую несколько подсетей, в конфигурации прослушивателя должен присутствовать один статический IP-адрес для каждой подсети. Для конкретной подсети статический IP-адрес может иметь формат IPv4 или IPv6. Обратитесь к администратору сети, чтобы получить статический IP-адрес для каждой подсети, в которой размещены реплики новой группы доступности.  
  
 Например:  
  
 `WITH IP ( ('10.120.19.155','255.255.254.0') )`  
  
 *four_part_ipv4_address*  
 Задает IPv4-адрес, состоящий из четырех частей, для прослушивателя группы доступности. Например, `10.120.19.155`.  
  
 *four_part_ipv4_mask*  
 Задает IPv4-маску, состоящую из четырех частей, для прослушивателя группы доступности. Например, `255.255.254.0`.  
  
 *ipv6_address*  
 Задает IPv6-адрес для прослушивателя группы доступности. Например, `2001::4898:23:1002:20f:1fff:feff:b3a3`.  
  
 ПОРТ  **=**  *listener_port*  
 Указывает номер порта —*listener_port*— для использования прослушивателя группы доступности, который задается с помощью предложения WITH IP. Параметр PORT является необязательным.  
  
 По умолчанию поддерживается номер порта 1433. Однако из соображений безопасности, рекомендуется использовать другой номер порта.  
  
 Например: `WITH IP ( ('2001::4898:23:1002:20f:1fff:feff:b3a3') ) , PORT = 7777`.  
  
## <a name="prerequisites-and-restrictions"></a>Требования и ограничения  
 Сведения о компонентах, необходимых для создания группы доступности см. в разделе [условия, ограничения и рекомендации для групп доступности AlwaysOn &#40; SQL Server &#41; ](../../database-engine/availability-groups/windows/prereqs-restrictions-recommendations-always-on-availability.md).  
  
 Сведения об ограничениях на инструкции AVAILABILITY GROUP языка Transact-SQL см. в разделе [Обзор из инструкции Transact-SQL для групп доступности AlwaysOn &#40; SQL Server &#41; ](../../database-engine/availability-groups/windows/transact-sql-statements-for-always-on-availability-groups.md).  
  
## <a name="security"></a>безопасность  
  
### <a name="permissions"></a>Разрешения  
 Требуется членство в предопределенной роли сервера **sysadmin** и разрешение сервера CREATE AVAILABILITY GROUP, ALTER ANY AVAILABILITY GROUP или CONTROL SERVER.  
  
## <a name="examples"></a>Примеры  
  
### <a name="a-configuring-backup-on-secondary-replicas-flexible-failover-policy-and-connection-access"></a>A. Настройка резервного копирования на вторичных репликах, гибкие политики обработки отказов и доступ к соединению  
 В следующем примере создается группа доступности `MyAg` для двух пользовательских баз данных, `ThisDatabase` и `ThatDatabase`. В следующей таблице представлена сводка значений для параметров, установленных для группы доступности в целом.  
  
|Параметр группы|Настройка|Description|  
|------------------|-------------|-----------------|  
|AUTOMATED_BACKUP_PREFERENCE|SECONDARY|Параметр предпочтения автоматического резервного копирования указывает, что резервное копирование должно выполняться на вторичной реплике, за исключением тех случаев, когда в режиме «в сети» находится только первичная реплика (это режим по умолчанию). Чтобы параметр AUTOMATED_BACKUP_PREFERENCE как-то влиял на работу, необходимо создать скрипт заданий резервного копирования для баз данных доступности, чтобы они принимали в расчет предпочтения автоматического резервного копирования.|  
|FAILURE_CONDITION_LEVEL|3|Настройка уровня условия сбоя указывает, что следует запустить автоматический переход на другой ресурс в случае появления критических внутренних ошибок SQL Server, таких как потерянные спин-блокировки, серьезные нарушения доступа для записи или формирование слишком больших дампов.|  
|HEALTH_CHECK_TIMEOUT|600 000|Это значение времени ожидания проверки работоспособности 60 секунд, указывает, что кластер WSFC ожидает 60 000 миллисекунд для [sp_server_diagnostics](../../relational-databases/system-stored-procedures/sp-server-diagnostics-transact-sql.md) системные хранимые процедуры возвращают сведения о работоспособности сервера об экземпляре сервера, который является с репликой синхронной фиксации с автоматическим перед кластера предполагает, что экземпляр основного сервера работает медленно или завис. (Значение по умолчанию — 30 000 миллисекунд).|  
  
 Три реплики доступности должны быть размещены на экземплярах сервера по умолчанию на компьютерах с именами `COMPUTER01`, `COMPUTER02` и `COMPUTER03`. В следующей таблице приведена сводка значений, указанных в качестве параметров каждой реплики.  
  
|Параметр реплики|Настройка на `COMPUTER01`|Настройка на `COMPUTER02`|Настройка на `COMPUTER03`|Description|  
|--------------------|-----------------------------|-----------------------------|-----------------------------|-----------------|  
|ENDPOINT_URL|TCP: / /*COMPUTER01:5022*|TCP: / /*COMPUTER02:5022*|TCP: / /*COMPUTER03:5022*|В этом примере системы находятся в одном домене, поэтому URL-адреса конечной точки могут использовать имена компьютерной системы в качестве системного адреса.|  
|AVAILABILITY_MODE|SYNCHRONOUS_COMMIT|SYNCHRONOUS_COMMIT|ASYNCHRONOUS_COMMIT|Две реплики используют режим синхронной фиксации. При синхронизации они поддерживают отработку отказа без потери данных. Третья реплика использует режим доступности с асинхронной фиксацией.|  
|FAILOVER_MODE|AUTOMATIC|AUTOMATIC|MANUAL|Реплики с синхронной фиксацией поддерживают автоматический переход на другой ресурс и запланированный переход на другой ресурс вручную. Реплика режима доступности с синхронной фиксацией поддерживает только принудительный переход на другой ресурс вручную.|  
|BACKUP_PRIORITY|30|30|90|Более высокий приоритет со значением 90 назначается реплике с асинхронной фиксацией, а не репликам с синхронной фиксацией. Как правило, резервные копии на экземпляре сервера, на котором размещена реплика асинхронной фиксации.|  
|SECONDARY_ROLE|( ALLOW_CONNECTIONS = NO,<br /><br /> READ_ONLY_ROUTING_URL = 'TCP://COMPUTER01:1433' )|( ALLOW_CONNECTIONS = NO,<br /><br /> READ_ONLY_ROUTING_URL = 'TCP://COMPUTER02:1433' )|( ALLOW_CONNECTIONS = READ_ONLY, <br />READ_ONLY_ROUTING_URL = 'TCP://COMPUTER03:1433' )|В качестве вторичной реплики с доступом для чтения может служить только реплика с асинхронной фиксацией.<br /><br /> Указывает имя компьютера и номер порта компонента ядра СУБД по умолчанию (1433).<br /><br /> Этот аргумент является необязательным.|  
|PRIMARY_ROLE|( ALLOW_CONNECTIONS = READ_WRITE, <br />READ_ONLY_ROUTING_LIST = (COMPUTER03) )|( ALLOW_CONNECTIONS = READ_WRITE, <br />READ_ONLY_ROUTING_LIST = (COMPUTER03) )|( ALLOW_CONNECTIONS = READ_WRITE, <br />READ_ONLY_ROUTING_LIST = NONE )|В первичной роли все реплики отклонить попыток соединения с намерением чтения.<br /><br /> Запросы соединения с намерением чтения направляются на компьютер COMPUTER03, если локальная реплика выполняется под вторичной ролью. Если эта реплика работает с первичной ролью, то маршрутизация только для чтения отключается.<br /><br /> Этот аргумент является необязательным.|  
|SESSION_TIMEOUT|10|10|10|В этом примере указано значение времени ожидания завершения сеанса по умолчанию (10). Этот аргумент является необязательным.|  
  
 И наконец, в примере указано необязательное предложение LISTENER, предназначенное для создания прослушивателя группы доступности для новой группы доступности. Для этого прослушивателя задается уникальное имя DNS — `MyAgListenerIvP6`. Две реплики находятся в разных подсетях, поэтому прослушивателю необходимо использовать статические IP-адреса. Для каждой из двух реплик доступности предложение WITH IP указывает статический IP-адрес `2001:4898:f0:f00f::cf3c` и `2001:4898:e0:f213::4ce2`, использующий формат IPv6. В этом примере также указывается и используется необязательный параметр PORT, указывающий порт `60173` в качестве порта прослушивателя.  
  
```SQL
CREATE AVAILABILITY GROUP MyAg   
   WITH (  
      AUTOMATED_BACKUP_PREFERENCE = SECONDARY,  
      FAILURE_CONDITION_LEVEL  =  3,   
      HEALTH_CHECK_TIMEOUT = 600000  
       )  
  
   FOR   
      DATABASE  ThisDatabase, ThatDatabase   
   REPLICA ON   
      'COMPUTER01' WITH   
         (  
         ENDPOINT_URL = 'TCP://COMPUTER01:5022',  
         AVAILABILITY_MODE = SYNCHRONOUS_COMMIT,  
         FAILOVER_MODE = AUTOMATIC,  
         BACKUP_PRIORITY = 30,  
         SECONDARY_ROLE (ALLOW_CONNECTIONS = NO,   
            READ_ONLY_ROUTING_URL = 'TCP://COMPUTER01:1433' ),
         PRIMARY_ROLE (ALLOW_CONNECTIONS = READ_WRITE,   
            READ_ONLY_ROUTING_LIST = (COMPUTER03) ),  
         SESSION_TIMEOUT = 10  
         ),   
  
      'COMPUTER02' WITH   
         (  
         ENDPOINT_URL = 'TCP://COMPUTER02:5022',  
         AVAILABILITY_MODE = SYNCHRONOUS_COMMIT,  
         FAILOVER_MODE = AUTOMATIC,  
         BACKUP_PRIORITY = 30,  
         SECONDARY_ROLE (ALLOW_CONNECTIONS = NO,   
            READ_ONLY_ROUTING_URL = 'TCP://COMPUTER02:1433' ),  
         PRIMARY_ROLE (ALLOW_CONNECTIONS = READ_WRITE,   
            READ_ONLY_ROUTING_LIST = (COMPUTER03) ),  
         SESSION_TIMEOUT = 10  
         ),   
  
      'COMPUTER03' WITH   
         (  
         ENDPOINT_URL = 'TCP://COMPUTER03:5022',  
         AVAILABILITY_MODE = ASYNCHRONOUS_COMMIT,  
         FAILOVER_MODE =  MANUAL,  
         BACKUP_PRIORITY = 90,  
         SECONDARY_ROLE (ALLOW_CONNECTIONS = READ_ONLY,   
            READ_ONLY_ROUTING_URL = 'TCP://COMPUTER03:1433' ),  
         PRIMARY_ROLE (ALLOW_CONNECTIONS = READ_WRITE,   
            READ_ONLY_ROUTING_LIST = NONE ),  
         SESSION_TIMEOUT = 10  
         );
GO  
ALTER AVAILABIIITY GROUP [MyAg]
  ADD LISTENER ‘MyAgListenerIvP6’ ( WITH IP ( ('2001:db88:f0:f00f::cf3c'),('2001:4898:e0:f213::4ce2') ) , PORT = 60173 );   
GO  
```  
  
##  <a name="RelatedTasks"></a> Связанные задачи  
  
-   [Создание группы доступности (Transact-SQL)](../../database-engine/availability-groups/windows/create-an-availability-group-transact-sql.md)  
  
-   [Использование мастера групп доступности (среда SQL Server Management Studio)](../../database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio.md)  
  
-   [Использование диалогового окна "Создание группы доступности" (среда SQL Server Management Studio)](../../database-engine/availability-groups/windows/use-the-new-availability-group-dialog-box-sql-server-management-studio.md)  
  
-   [Использование мастера групп доступности (среда SQL Server Management Studio)](../../database-engine/availability-groups/windows/use-the-availability-group-wizard-sql-server-management-studio.md)  
  
## <a name="see-also"></a>См. также:  
 [ALTER AVAILABILITY GROUP (Transact-SQL)](../../t-sql/statements/alter-availability-group-transact-sql.md)   
 [ALTER DATABASE SET HADR (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql-set-hadr.md)   
 [DROP AVAILABILITY GROUP &#40; Transact-SQL &#41;](../../t-sql/statements/drop-availability-group-transact-sql.md)   
 [Поиск и устранение неисправностей конфигурации групп доступности #40; SQL Server &#41;](../../database-engine/availability-groups/windows/troubleshoot-always-on-availability-groups-configuration-sql-server.md)   
 [Обзор групп доступности AlwaysOn (SQL Server)](../../database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server.md)   
 [Прослушиватели групп доступности, возможность подключения клиентов и отработка отказа приложений (SQL Server)](../../database-engine/availability-groups/windows/listeners-client-connectivity-application-failover.md)  
  
  

