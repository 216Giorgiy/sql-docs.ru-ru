---
title: Уровень совместимости инструкции ALTER DATABASE (Transact-SQL) | Документы Майкрософт
ms.custom: ''
ms.date: 04/18/2018
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.component: t-sql|statements
ms.reviewer: ''
ms.suite: sql
ms.technology: t-sql
ms.tgt_pltfrm: ''
ms.topic: language-reference
f1_keywords:
- COMPATIBILITY_LEVEL_TSQL
- COMPATIBILITY_LEVEL
dev_langs:
- TSQL
helpviewer_keywords:
- 80 compatibility level
- ALTER DATABASE statement, compatibility levels
- 90 compatibility level
- compatibility levels [SQL Server]
- 100 compatibility level
- db compatibility level
- db compat level
ms.assetid: ca5fd220-d5ea-4182-8950-55d4101a86f6
caps.latest.revision: 89
author: edmacauley
ms.author: edmaca
manager: craigg
ms.openlocfilehash: 3bdc0c85068e4933b0c97cb508bd819ee1cc481d
ms.sourcegitcommit: 1740f3090b168c0e809611a7aa6fd514075616bf
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
---
# <a name="alter-database-transact-sql-compatibility-level"></a>Уровень совместимости инструкции ALTER DATABASE (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2008-asdb-xxxx-xxx-md](../../includes/tsql-appliesto-ss2008-asdb-xxxx-xxx-md.md)]

Настраивает определенное поведение баз данных для обеспечения совместимости с указанной версией [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Другие параметры ALTER DATABASE см. в разделе [ALTER DATABASE (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql.md).  

[!INCLUDE[ssMIlimitation](../../includes/sql-db-mi-limitation.md)]

 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
ALTER DATABASE database_name   
SET COMPATIBILITY_LEVEL = { 140 | 130 | 120 | 110 | 100 | 90 }  
```  
  
## <a name="arguments"></a>Аргументы  
 *database_name*  
 Имя изменяемой базы данных.  
  
 COMPATIBILITY_LEVEL { 140 | 130 | 120 | 110 | 100 | 90 | 80 }  
 Версия [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], с которой необходимо обеспечить совместимость базы данных. Можно настроить следующие значения уровня совместимости.  
  
|Продукт|Версия ядра СУБД|Назначение уровня совместимости|Поддерживаемые значения уровня совместимости|  
|-------------|-----------------------------|-------------------------------------|------------------------------------------|  
|[!INCLUDE[ssSQLv14_md](../../includes/sssqlv14-md.md)]|14|140|140, 130, 120, 110, 100|
|[!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)]|12|130|140, 130, 120, 110, 100|  
|[!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]|13|130|130, 120, 110, 100|  
|[!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]|12|120|120, 110, 100|  
|[!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]|11|110|110, 100, 90|  
|[!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)]|10.5|100|100, 90, 80|  
|[!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]|10|100|100, 90, 80|  
|[!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]|9|90|90, 80|  
|SQL Server 2000|8|80|80|  
  
> [!NOTE]  
> По состоянию на **январь 2018 г.** в базе данных SQL для вновь создаваемых баз данных по умолчанию применяется уровень совместимости 140. Мы не обновляем уровень совместимости для существующих баз данных. Это осуществляют заказчики по собственному усмотрению. Учитывая это, мы настоятельно рекомендуем заказчикам запланировать переход на последний уровень совместимости, чтобы использовать самые новые улучшения.
> 
> Если в целом вам требуется уровень 140, но по определенной причине вы предпочитаете уровень 110 алгоритма **оценки кратности**, см. статью [ALTER DATABASE SCOPED CONFIGURATION (Transact-SQL)](../../t-sql/statements/alter-database-scoped-configuration-transact-sql.md) и, в частности, ключевое слово `LEGACY_CARDINALITY_ESTIMATION = ON`.
>  
>  Дополнительные сведения о том, как оценить разницу в производительности наиболее важных запросов в двух уровнях совместимости в [!INCLUDE[ssSDS](../../includes/sssds-md.md)], см. в разделе [Улучшенная производительность запросов для уровня совместимости 130 базы данных SQL Azure](http://azure.microsoft.com/documentation/articles/sql-database-compatibility-level-query-performance-130/). Обратите внимание, что в этой статье описывается уровень совместимости 130 и SQL Server, однако при переходе на уровень 140 для SQL Server и базы данных SQL Azure применяется та же методология.


 Выполните следующий запрос, чтобы определить версию [!INCLUDE[ssDE](../../includes/ssde-md.md)], к которой вы подключены.  
  
```sql  
SELECT SERVERPROPERTY('ProductVersion');  
```  
  
> [!NOTE]  
> В [!INCLUDE[ssSDS](../../includes/sssds-md.md)] поддерживаются не все функции, которые зависят от уровня совместимости.  

 Чтобы определить текущий уровень совместимости, запросите столбец **compatibility_level** в представлении [sys.databases (Transact-SQL)](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md).  
  
```sql  
SELECT name, compatibility_level FROM sys.databases;  
```  
  
## <a name="remarks"></a>Remarks  
Для всех установок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] уровень совместимости по умолчанию установлен в зависимости от версии [!INCLUDE[ssDE](../../includes/ssde-md.md)]. Для баз данных он устанавливается в это же значение, если для базы данных **model** не установлен более низкий уровень совместимости. При обновлении базы данных с более ранней версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] база данных сохраняет существующий уровень совместимости, если он не ниже минимального значения, допустимого в этом экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. При обновлении базы данных с уровнем совместимости ниже допустимого устанавливается минимальное допустимое значение уровня совместимости. Это относится и к системным, и к пользовательским базам данных. Чтобы изменить уровень совместимости базы данных, используется инструкция **ALTER DATABASE**. Чтобы просмотреть текущий уровень совместимости базы данных, запросите столбец **compatibility_level** представления каталога [sys.databases](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md).  

> [!NOTE]  
> [База данных распространителя](../../relational-databases/replication/distribution-database.md), созданная в более ранней версии SQL Server и обновленная до версии [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)] RTM или версии с пакетом обновления 1, получает уровень совместимости 90, который не поддерживается для других баз данных. Это не влияет на функциональные возможности репликации. В результате обновления до последних пакетов обновления и версий SQL Server уровень совместимости базы данных распространителя будет увеличен до уровня, соответствующего **основной** базе данных.
  
## <a name="using-compatibility-level-for-backward-compatibility"></a>Использование уровня совместимости для обеспечения обратной совместимости  
 Уровень совместимости влияет на поведение только указанных баз данных, а не всего сервера. Уровень совместимости обеспечивает лишь частичную обратную совместимость с ранними версиями [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Начиная с режима совместимости 130, новые возможности, влияющие на план запроса, добавлены только к новому режиму совместимости. Это сделано для того, чтобы свести к минимуму риск во время обновления, связанный со снижением производительности из-за изменения плана запросов. С точки зрения приложения, целью по-прежнему является последний уровень совместимости, позволяющий наследовать некоторые новые возможности и повышение производительности в области оптимизатор запросов, но делать это под контролем. Используйте уровень совместимости в качестве промежуточной меры в процессе устранения проблем, возникших из-за различий в поведении между версиями, которые определяются соответствующей настройкой уровня совместимости. Дополнительные сведения см. в разделе с рекомендациями по обновлению в этой статье.  
  
 Если на существующие приложения [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] оказывают влияние различия поведения в вашей версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], настройте приложение для работы с новым режимом совместимости. Затем измените уровень совместимости на 130 с помощью `ALTER DATABASE`. Новый параметр совместимости для базы данных вступит в силу после выдачи `USE <database>` или обработки нового имени входа в этой базе данных в качестве базы данных по умолчанию.  
 
> [!IMPORTANT]
> Нерекомендуемые функциональные возможности, представленные в определенной версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], не защищены уровнем совместимости.
> 
> Например, указание `FASTFIRSTROW` больше не поддерживается в [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] и заменено на указание `OPTION (FAST n )`. Если задать уровень совместимости базы данных 110, нерекомендуемое указание не будет восстановлено.
> Дополнительные сведения о нерекомендуемых функциях см. в разделах [Нерекомендуемые функции ядра СУБД в SQL Server 2016](../../database-engine/discontinued-database-engine-functionality-in-sql-server-2016.md), [Нерекомендуемые функции ядра СУБД в SQL Server 2014](http://msdn.microsoft.com/library/ms144262(v=sql.120)), [Нерекомендуемые функции ядра СУБД в SQL Server 2012](http://msdn.microsoft.com/library/ms144262(v=sql.110)) и [Нерекомендуемые функции ядра СУБД в SQL Server 2008](http://msdn.microsoft.com/library/ms144262(v=sql.100)).

> [!IMPORTANT]
> Критические изменения, введенные в определенной версии [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] **могут** не защищаться уровнем совместимости. Поведение [!INCLUDE[tsql](../../includes/tsql-md.md)] обычно защищено уровнем совместимости. Однако измененные или удаленные системные объекты **не** защищены уровнем совместимости.
>
> Пример критических изменений, **защищенных** уровнем совместимости — неявное преобразование данных из типа datetime в тип datetime2. При уровне совместимости базы данных 130 эти преобразования демонстрируют повышенную точность благодаря учету долей миллисекунд. В результате преобразования дают иные значения. Чтобы восстановить прежнее поведение преобразования, задайте уровень совместимости базы данных 120 или ниже.
>
> Примеры критических изменений, **не защищенных** уровнем совместимости.
> -  Изменение имен столбцов в системных объектах. В [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] столбец *single_pages_kb* в представлении sys.dm_os_sys_info был переименован в *pages_kb*. Независимо от уровня совместимости запрос `SELECT single_pages_kb FROM sys.dm_os_sys_info` вызывает ошибку 207 (Недопустимое имя столбца).
> -  Удаление системных объектов. В [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] столбец `sp_dboption` был удален. Независимо от уровня совместимости инструкция `EXEC sp_dboption 'AdventureWorks2016CTP3', 'autoshrink', 'FALSE';` вызовет ошибку 2812 (Не удалось найти хранимую процедуру 'sp_dboption').
>
> Дополнительные сведения о критических изменениях см. в разделах [Критические изменения в функциях ядра СУБД в SQL Server 2017](../../database-engine/breaking-changes-to-database-engine-features-in-sql-server-2017.md), [Критические изменения в функциях ядра СУБД в SQL Server 2016](../../database-engine/breaking-changes-to-database-engine-features-in-sql-server-2016.md), [Критические изменения в функциях ядра СУБД в SQL Server 2014](http://msdn.microsoft.com/library/ms143179(v=sql.120)), [Критические изменения в функциях ядра СУБД в SQL Server 2012](http://msdn.microsoft.com/library/ms143179(v=sql.110)) и [Критические изменения в функциях ядра СУБД в SQL Server 2008](http://msdn.microsoft.com/library/ms143179(v=sql.100)).
  
## <a name="best-practices"></a>Рекомендации  
Рекомендуемый рабочий процесс для обновления уровня совместимости см. в разделе [Изменение режима совместимости базы данных и использование хранилища запросов](../../database-engine/install-windows/change-the-database-compatibility-mode-and-use-the-query-store.md).  
  
## <a name="compatibility-levels-and-stored-procedures"></a>Уровни совместимости и хранимые процедуры  
 При выполнении хранимой процедуры используется текущий уровень совместимости базы данных, в которой она была определена. Когда настройка совместимости базы данных подвергается изменению, все хранимые процедуры этой базы данных автоматически перекомпилируются соответствующим образом.  

## <a name="differences-between-compatibility-level-130-and-level-140"></a>Различия между уровнями совместимости 130 и 140  
В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 140.

|Уровень совместимости 130 и ниже|Уровень совместимости 140|  
|--------------------------------------------------|-----------------------------------------|  
|При оценке кратности для инструкций, ссылающихся на функции с табличным значением с несколькими инструкциями, используется предположение фиксированной строки.|При оценке кратности для соответствующих инструкций, ссылающихся на функции с табличным значением с несколькими инструкциями, будет использоваться фактическая кратность из выходных данных функции.  Это возможно благодаря **выполнению с чередованием** для функций с табличным значением с несколькими инструкциями.|
|Запросы в пакетном режиме на недостаточный объем временно предоставляемого буфера памяти, которые приводят к переносам на диск, могут сохранять проблемы при последовательном выполнении.|Запросы в пакетном режиме на недостаточный объем временно предоставляемого буфера памяти, которые приводят к переносам на диск, могут выполняться эффективнее при последовательном выполнении. Этот возможно благодаря **обратной связи по временно предоставляемому буферу памяти в пакетном режиме**, которая обновляет размер временно предоставляемого буфера кэшированного плана, если для операторов пакетного режима произошел перенос. |
|Запросы в пакетном режиме на чрезмерный объем временно предоставляемого буфера памяти, которые приводят к проблемам параллелизма, могут сохранять проблемы при последовательном выполнении.|Запросы в пакетном режиме на чрезмерный объем временно предоставляемого буфера памяти, которые приводят к проблемам параллелизма, будут выполняться эффективнее при последовательном выполнении. Этот возможно благодаря **обратной связи по временно предоставляемому буферу памяти в пакетном режиме**, которая обновляет размер временно предоставляемого буфера кэшированного плана, если был запрошен слишком большой объем.|
|Запросы в пакетном режиме, содержащие операторы соединения, подходят для трех алгоритмов физического соединения, включая вложенный цикл, хэш-соединение и соединение слиянием. Если оценки кратности для входных данных соединения неверны, может быть выбран неправильный алгоритм соединения. В этом случае производительность снижается, а неправильный алгоритм соединения будет использоваться до повторной компиляции кэшированного плана.|Существует дополнительный оператор соединения — **адаптивное соединение**. Если оценки кратности для входных данных соединения со внешней сборкой неверны, может быть выбран неправильный алгоритм соединения. Если это происходит и инструкция подходит для адаптивного соединения, для малых входных данных будет использоваться вложенный цикл, а для больших — хэш-соединение. Это будет происходить динамически, без перекомпиляции. |
|Простейшие планы, ссылающиеся на индексы columnstore, не подходят для выполнения в пакетном режиме. |Простейший план, ссылающийся на индексы columnstore, будет заменен на план, подходящий для выполнения в пакетном режиме.|
|Оператор UDX `sp_execute_external_script` может выполняться только в режиме строки.|Оператор UDX `sp_execute_external_script` может выполняться в пакетном режиме.|  
|Функции с табличным значением с несколькими инструкциями не могут выполняться с чередованием |Выполнение с чередованием для функций с табличным значением с несколькими инструкциями для повышения качества плана. |

Исправления, которые включались флагом трассировки 4199 в версиях SQL Server до SQL Server 2017, теперь включены по умолчанию. С режимом совместимости 140. Флаг трассировки 4199 по-прежнему можно использовать для новых исправлений оптимизатора запросов, выпущенных после SQL Server 2017. Дополнительные сведения о флаге трассировки 4199 см. в разделе [Флаг трассировки 4199](../../t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql.md#4199).  
  
## <a name="differences-between-compatibility-level-120-and-level-130"></a>Различия между уровнями совместимости 120 и 130  
В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 130.   

|Уровень совместимости 120 и ниже|Уровень совместимости 130|  
|--------------------------------------------------|-----------------------------------------|  
|Операция вставки в инструкции Insert-select является однопоточной.|Операция вставки в инструкции Insert-select является многопоточной или может использовать параллельный план.|  
|Запросы в таблицах, оптимизированных для памяти, выполняются в одном потоке.|Запросы в таблицах, оптимизированных для памяти, теперь могут иметь параллельные планы.|  
|Представлено в оценщике кратности SQL 2014 **CardinalityEstimationModelVersion="120"**|Дальнейшие улучшения оценки кратности в модели оценки кратности 130, видимой в плане запроса. **CardinalityEstimationModelVersion="130"**|  
|Изменения пакетного режима и режима строки в индексах columnstore<br /><br /> Сортировка в таблице с индексом columnstore осуществляется в режиме строки<br /><br /> Оконные агрегатные функции выполняются в режиме строки, например `LAG` или `LEAD`<br /><br /> Запросы в таблицах columnstore с несколькими отдельными предложениями выполнялись в режиме строки<br /><br /> Запросы, выполняемые с MAXDOP 1 или последовательным планом, выполнялись в режиме строки | Изменения пакетного режима и режима строки в индексах columnstore<br /><br /> Сортировка в таблице с индексом columnstore осуществляется в пакетном режиме<br /><br /> Оконные агрегатные функции теперь выполняются в пакетном режиме, например `LAG` или `LEAD`<br /><br /> Запросы в таблицах columnstore с несколькими отдельными предложениями выполняются в пакетном режиме<br /><br /> Запросы, выполняемые с MAXDOP 1 или последовательным планом, выполняются в пакетном режиме|  
| Статистика может обновляться автоматически. | Логика, которая автоматически обновляет статистику, более агрессивна в больших таблицах.  На практике это должно снизить число случаев, когда у клиентов возникали проблемы с производительностью при выполнении частых запросов к новым вставленным строкам, если статистика не обновлялась и не получала эти значения. |  
| Трассировка 2371 имеет значение OFF по умолчанию в [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]. | [Трассировка 2371](https://blogs.msdn.microsoft.com/psssql/2016/10/04/default-auto-statistics-update-threshold-change-for-sql-server-2016/) имеет значение ON по умолчанию в [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]. Флаг трассировки 2371 дает средству автоматического обновления статистики инструкции делать выборку подмножества строк меньшего размера, но более эффективным образом, если в таблице очень много строк. <br/> <br/> Одно из улучшений — включение в выборку большего количества строк, которые были вставлены недавно. <br/> <br/> Еще одно улучшение — выполнение запросов во время обновления статистики, без блокировки запроса. |  
| На уровне 120 выборка статистики осуществляется *одним* потоком. | На уровне 130 выборка статистики осуществляется *несколькими* потоками. |  
| Максимальное значение — 253 входящих внешних ключа. | На одну таблицу может ссылаться до 10 000 входящих внешних ключей или аналогичных элементов. Ограничения см. в разделе [Create Foreign Key Relationships](../../relational-databases/tables/create-foreign-key-relationships.md). |  
|Нерекомендуемые хэш-алгоритмы MD2, MD4, MD5, SHA и SHA1 разрешены.|Допускаются только хэш-алгоритмы SHA2_256 и SHA2_512.|
||В [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)] усовершенствованы преобразования некоторых типов данных и некоторые редко используемые операции. Дополнительные сведения см. в статье [Улучшения SQL Server 2016 для обработки некоторых типов данных и нестандартных операций](https://support.microsoft.com/help/4010261/sql-server-2016-improvements-in-handling-some-data-types-and-uncommon).|
  
Исправления, которые включались флагом трассировки 4199 в версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] до [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)], теперь включены по умолчанию. С режимом совместимости 130. Флаг трассировки 4199 по-прежнему можно использовать для новых исправлений оптимизатора запросов, выпущенных после [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]. Чтобы использовать старый оптимизатор запросов в [!INCLUDE[ssSDS](../../includes/sssds-md.md)], необходимо выбрать уровень совместимости 110. Дополнительные сведения о флаге трассировки 4199 см. в разделе [Флаг трассировки 4199](../../t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql.md#4199).  
  
## <a name="differences-between-lower-compatibility-levels-and-level-120"></a>Различия между уровнем 120 и более низкими уровнями совместимости  
 В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 120.  
  
|Уровень совместимости 110 и ниже|Установка уровня совместимости 120|  
|--------------------------------------------------|-----------------------------------------|  
|Используется старый оптимизатор запросов.|В [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] существенно усовершенствован компонент, предназначенный для создания и оптимизации планов запросов. Эта новая функция оптимизатора запросов зависит от использования уровня совместимости базы данных 120. Новые приложения базы данных необходимо разрабатывать с использованием уровня совместимости базы данных 120, чтобы воспользоваться этими усовершенствованиями. Приложения, перенесенные из предыдущих версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], необходимо тщательно тестировать, чтобы убедиться в сохранении или повышении их производительности. Если производительность снизилась, можно задать уровень совместимости базы данных равным 110 или предыдущему значению для использования методологии оптимизатора запросов из прежних версий.<br /><br /> На уровне совместимости базы данных 120 используется новый механизм оценки количества элементов, который настроен для современных рабочих нагрузок, связанных с хранением данных и OLTP. Прежде чем устанавливать уровень совместимости базы данных 110 из-за проблем с производительностью, ознакомьтесь с подразделом, посвященным планам запросов, в статье [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] [Новые возможности в ядре СУБД](../../database-engine/configure-windows/what-s-new-in-sql-server-2016-database-engine.md).|  
|Если уровень совместимости ниже 120, при преобразовании значения **date** в строковое параметр языка не учитывается. Обратите внимание, что это поведение характерно только для типа **date**. См. пример Б, приведенный ниже в разделе примеров.|Параметр языка учитывается при преобразовании значения **date** в строковое.|  
|Рекурсивные ссылки в правой части предложения `EXCEPT` создают бесконечный цикл. Это поведение показано в примере В в разделе примеров.|Рекурсивные ссылки в предложении `EXCEPT` вызывают ошибку в соответствии со стандартом ANSI SQL.|  
|Рекурсивное обобщенное табличное выражение допускает повторяющиеся имена столбцов.|В рекурсивных обобщенных табличных выражениях повторяющиеся имена столбцов не разрешены.|  
|Отключенные триггеры активируются при их изменении.|Изменение триггера не меняет состояние триггера (отключен или включен).|  
|Табличное предложение OUTPUT INTO пропускает параметр `IDENTITY_INSERT SETTING = OFF` и позволяет вставлять явные значения.|Нельзя вставить явные значения для столбца идентификаторов в таблице, если параметр `IDENTITY_INSERT` имеет значение OFF.|  
|Если выбрано частичное включение базы данных, проверка поля `$action` в предложении `OUTPUT` инструкции `MERGE` может вернуть ошибку параметров сортировки.|Параметры сортировки значений, возвращаемых предложением `$action` инструкции `MERGE`, — это параметры сортировки базы данных, а не сервера. Ошибка конфликтующих параметров сортировки сервера не возвращается.|  
|Инструкция `SELECT INTO` всегда создает однопоточную операцию вставки.|Инструкция `SELECT INTO` может создать параллельную операцию вставки. При вставке большого числа строк параллельная операция может увеличить производительность.|  
  
## <a name="differences-between-lower-compatibility-levels-and-levels-110-and-120"></a>Различия между более низкими уровнями совместимости и уровнями 110 и 120  
 В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 110.   Этот раздел относится также к уровню 120.  
  
|Уровень совместимости 100 и ниже|Установка уровня совместимости, по меньшей мере равного 110|  
|--------------------------------------------------|--------------------------------------------------|  
|Объекты базы данных среды CLR выполняются в среде CLR версии 4. Однако некоторые из особенностей поведения, изменившиеся в версии 4 среды CLR, не используются. Дополнительные сведения см. в статье [Новые возможности интеграции CLR](../../relational-databases/clr-integration/clr-integration-what-s-new.md).|Объекты базы данных среды CLR выполняются в среде CLR версии 4.|  
|Функции XQuery **string-length** и **substring** считают каждый суррогатный символ за два символа.|Функции XQuery **string-length** и **substring** считают каждый суррогатный символ за один символ.|  
|`PIVOT` можно использовать в запросах рекурсивного обобщенного табличного выражения. Однако при наличии нескольких строк в группировании запрос возвращает неверные результаты.|`PIVOT` нельзя использовать в запросах рекурсивного обобщенного табличного выражения. Возвращается ошибка.|  
|Алгоритм RC4 поддерживается только в целях обратной совместимости. Когда база данных имеет уровень совместимости 90 или 100, новые материалы могут шифроваться только с помощью алгоритмов RC4 или RC4_128. (Не рекомендуется.) В [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] материалы, зашифрованные с помощью алгоритмов RC4 или RC4_128, могут быть расшифрованы на любом уровне совместимости.|Новые материалы нельзя шифровать с помощью RC4 или RC4_128. Используйте вместо этого более новые алгоритмы, например AES. В [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] материалы, зашифрованные с помощью алгоритмов RC4 или RC4_128, могут быть расшифрованы на любом уровне совместимости.|  
|Используемый по умолчанию стиль для операций `CAST` и `CONVERT` над типами данных **time** и **datetime2** — 121, кроме случая, когда любой из этих типов используется в выражении вычисляемого столбца. Для вычисляемых столбцов используемый по умолчанию стиль — 0. Это поведение влияет на вычисляемые столбцы при их создании и использовании в запросах с автоматической параметризацией, а также при использовании в определениях ограничений.<br /><br /> Разница между стилями 0 и 121 показана в примере Г в разделе примеров. В примере не рассматривается описанное выше поведение. Дополнительные сведения о стилях даты и времени см. в разделе [CAST и CONVERT (Transact-SQL)](../../t-sql/functions/cast-and-convert-transact-sql.md).|При уровне совместимости 110 стиль по умолчанию для операций `CAST` и `CONVERT` над типами данных **time** и **datetime2** всегда имеет значение 121. Если запрос основан на прежнем поведении, следует использовать уровень совместимости ниже 110, либо явно задать в затрагиваемом запросе стиль 0.<br /><br /> Обновление базы данных до уровня совместимости 110 не приведет к изменению пользовательских данных, сохраненных на диске. Следует исправить эти данных соответствующим образом вручную. Например, если бы вы использовали предложение `SELECT INTO` для создания таблицы на основе источника, содержащего описанное выше выражение вычисляемого столбца, то сохранялись бы данные (благодаря стилю 0), а не само определение вычисляемого столбца. Потребовалось бы вручную обновлять эти данные в соответствии со стилем 121.|  
|Любые столбцы удаленных таблиц типа **smalldatetime**, фигурирующие в секционированном представлении, сопоставляются как тип **datetime**. Соответствующие им столбцы локальных таблиц (столбцы, занимающие те же порядковые позиции в списке выбора) должны иметь тип **datetime**.|Любые столбцы удаленных таблиц типа **smalldatetime**, фигурирующие в секционированном представлении, сопоставляются как тип **smalldatetime**. Соответствующие им столбцы локальных таблиц (столбцы, занимающие те же порядковые позиции в списке выбора) должны иметь тип **smalldatetime**.<br /><br /> После обновления до уровня совместимости 110 произойдет сбой распределенного секционированного представления из-за несоответствия типа данных. Данную проблему вы можете решить, изменив тип данных в удаленной таблице на **datetime** или задав уровень совместимости локальной базы данных 100 или ниже.|  
|Функция `SOUNDEX` реализует следующие правила.<br /><br /> 1) Символы H и W в верхнем регистре игнорируются, если они разделяют 2 согласные, которые имеют одинаковый номер в коде `SOUNDEX`.<br /><br /> 2) Если первые 2 символа *character_expression* имеют одинаковый номер в коде `SOUNDEX`, включаются оба символа. В противном случае, если набор последовательных согласных в коде `SOUNDEX` имеет тот же номер, все они исключаются, кроме первого символа.|Функция `SOUNDEX` реализует следующие правила.<br /><br /> 1) Если символы H или W в верхнем разделяют две согласные буквы, которые имеют одинаковый номер в коде `SOUNDEX`, то согласная буква, которая находится справа, игнорируется<br /><br /> 2) Если набор последовательных согласных в коде `SOUNDEX` имеет тот же номер, все они исключаются, кроме первого символа.<br /><br /> <br /><br /> Функция `SOUNDEX` реализует дополнительные правила, при применении которых значения, вычисляемые функцией, могут отличаться от тех значений, которые были вычислены при другом уровне совместимости. После обновления до уровня совместимости 110, возможно, придется перестроить индексы, кучи или ограничения CHECK, в которых используется функция `SOUNDEX`. Дополнительные сведения см. в статье [SOUNDEX (Transact-SQL)](../../t-sql/functions/soundex-transact-sql.md)|  
  
## <a name="differences-between-compatibility-level-90-and-level-100"></a>Различия между уровнями совместимости 90 и 100  
 В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 100.  
  
|Установка уровня совместимости 90|Установка уровня совместимости 100|Вероятность влияния|  
|----------------------------------------|-----------------------------------------|---------------------------|  
|Параметр QUOTED_IDENTIFER всегда имеет значение ON для возвращающих табличное значение функций, состоящих из нескольких инструкций, если эти функции созданы без учета параметра сеансового уровня.|Значение параметра сеанса QUOTED IDENTIFIER учитывается при создании возвращающих табличное значение функций, состоящих из нескольких инструкций.|Средний|  
|При создании или изменении функции секционирования литералы **datetime** и **smalldatetime** в функции вычисляются на основе предположения, что параметры языка имеют значение US_English.|Текущие параметры языка используются для вычисления литералов **datetime** и **smalldatetime** в функции секционирования.|Средний|  
|Предложение `FOR BROWSE` допускается (и не учитывается) в инструкциях `INSERT` и `SELECT INTO`.|Предложение `FOR BROWSE` не допускается в инструкциях `INSERT` и `SELECT INTO`.|Средний|  
|Полнотекстовые предикаты допускаются в предложении `OUTPUT`.|Полнотекстовые предикаты не допускаются в предложении `OUTPUT`.|Низкий|  
|`CREATE FULLTEXT STOPLIST`, `ALTER FULLTEXT STOPLIST` и `DROP FULLTEXT STOPLIST` не поддерживаются. Системный список стоп-слов автоматически связывается с новыми полнотекстовыми индексами.|`CREATE FULLTEXT STOPLIST`, `ALTER FULLTEXT STOPLIST` и `DROP FULLTEXT STOPLIST` поддерживаются.|Низкий|  
|`MERGE` не рассматривается как зарезервированное ключевое слово.|MERGE является полностью зарезервированным ключевым словом. Инструкция `MERGE` поддерживается на обоих уровнях совместимости, 100 и 90.|Низкий|  
|При использовании аргумента \<dml_table_source> в инструкции INSERT возникает синтаксическая ошибка.|Можно собрать результаты предложения OUTPUT во вложенных инструкциях INSERT, UPDATE, DELETE или MERGE и вставить эти результаты в целевую таблицу или представление. Это выполняется с помощью аргумента \<dml_table_source> инструкции INSERT.|Низкий|
|Если не указано предложение `NOINDEX`, инструкции `DBCC CHECKDB` и `DBCC CHECKTABLE` выполняют проверку физической и логической согласованности для одной таблицы или индексированного представления, а также для всех некластеризованных индексов и XML-индексов. Пространственные индексы не поддерживаются.|Если не указано предложение `NOINDEX`, инструкции `DBCC CHECKDB` и `DBCC CHECKTABLE` выполняют проверку физической и логической согласованности для одной таблицы и всех ее некластеризованных индексов. Однако в XML-индексах, пространственных индексах и индексированных представлениях по умолчанию выполняются только проверки физической согласованности.<br /><br /> Если указан параметр `WITH EXTENDED_LOGICAL_CHECKS`, выполняются проверки логической согласованности в индексированных представлениях, XML-индексах и пространственных индексах (при их наличии). По умолчанию проверки физической согласованности выполняются раньше, чем проверки логической согласованности. Если также указан параметр `NOINDEX`, выполняются только проверки логической согласованности.|Низкий|  
|Если предложение OUTPUT используется в инструкции DML и при выполнении инструкции возникает ошибка времени выполнения, то завершается вся транзакция и происходит откат.|Если предложение `OUTPUT` используется в инструкции DML и при выполнении инструкции возникает ошибка во время выполнения, дальнейшее поведение системы зависит от параметра `SET XACT_ABORT`. Если параметр `SET XACT_ABORT` имеет значение OFF, то аварийное прекращение выполнения инструкции из-за ошибки, возникшей при выполнении инструкции DML, в которой используется предложение `OUTPUT`, приводит к завершению инструкции, но выполнение пакета продолжается и откат транзакции не происходит. Если параметр `SET XACT_ABORT` имеет значение ON, то при возникновении любых ошибок во время выполнения, вызванных инструкцией DML, в которой используется предложение OUTPUT, происходит завершение пакета и откат транзакции.|Низкий|  
|CUBE и ROLLUP не рассматриваются как зарезервированные ключевые слова.|`CUBE` и `ROLLUP` являются зарезервированными ключевыми словами в предложении GROUP BY.|Низкий|  
|К элементам типа XML **anyType** применяется строгая проверка.|К элементам типа **anyType** применяется нестрогая проверка. Дополнительные сведения см. в статье [Компоненты-шаблоны и проверка содержимого](../../relational-databases/xml/wildcard-components-and-content-validation.md).|Низкий|  
|К специальным атрибутам **xsi:nil** и **xsi:type** нельзя выполнять запросы или вносить в них изменения с помощью инструкций DML.<br /><br /> Это означает, что выражение `/e/@xsi:nil` оканчивается неудачей, несмотря на то, что в предложении `/e/@*` атрибуты **xsi:nil** и **xsi:type** пропускаются. Однако предложение `/e` возвращает атрибуты **xsi:nil** и **xsi:type** для согласованности с инструкцией `SELECT xmlCol`, даже если `xsi:nil = "false"`.|Специальные атрибуты **xsi:nil** и **xsi:type** хранятся как обычные атрибуты, и к ним можно выполнять запросы и вносить в них изменения.<br /><br /> Например, выполнение запроса `SELECT x.query('a/b/@*')` возвращает все атрибуты, включая **xsi:nil** и **xsi:type**. Чтобы исключить эти типы из запроса, замените `@*` на `@*[namespace-uri(.) != "`*insert xsi namespace uri*`"`, а не `(local-name(.) = "type"` или `local-name(.) ="nil".`|Низкий|  
|Определяемая пользователем функция, которая преобразует строковое значение константы XML в тип [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] datetime, отмечается как детерминированная.|Определяемая пользователем функция, которая преобразует строковое значение константы XML в тип [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] datetime, отмечается как недетерминированная.|Низкий|  
|Объединение XML и типы списков поддерживаются не полностью.|Объединение и типы списков поддерживаются полностью, включая следующие функциональные возможности.<br /><br /> Объединение списков<br /><br /> Объединение объединений<br /><br /> Список атомарных типов<br /><br /> Список объединений|Низкий|  
|Проверка правильности параметров SET, требуемых для метода xQuery, не выполняется, если метод содержится в представлении или во встроенной возвращающей табличное значение функции.|Проверка правильности параметров SET, требуемых для метода xQuery, выполняется, если метод содержится в представлении или во встроенной возвращающей табличное значение функции. Если параметры SET метода заданы неправильно, возникает ошибка.|Низкий|  
|Значения XML-атрибута, которые содержат символы конца строки (символы возврата каретки и перевода строки), не нормализованы согласно стандарту XML. Таким образом, возвращаются оба символа вместо одного символа перевода строки.|Значения XML-атрибута, которые содержат символы конца строки (символы возврата каретки и перевода строки), нормализованы согласно стандарту XML. Таким образом, все символы конца строки во внешних проанализированных сущностях (включая сущность документа), нормализуются на входе, преобразуя двухсимвольные последовательности #xD #xA и символы #xD, за которыми не следует символ #xA, в единственный символ #xA.<br /><br /> Приложения, в которых используются атрибуты для переноса строковых значений, содержащих символы конца строки, не получают эти символы назад в том виде, в каком они были переданы. Чтобы предотвратить выполнение этого процесса нормализации, используйте числовые сущности-символы XML для кодирования всех символов конца строки.|Низкий|  
|Свойства столбца `ROWGUIDCOL` и `IDENTITY` могут быть неправильно именованы как ограничения. Например, инструкция `CREATE TABLE T (C1 int CONSTRAINT MyConstraint IDENTITY)` выполняется, но имя ограничения не сохраняется и не доступно для пользователя.|Свойства столбца `ROWGUIDCOL` и `IDENTITY` не могут быть именованы как ограничения. Возвращается ошибка 156.|Низкий|  
|Обновление столбцов с использованием двухстороннего присваивания, такого как `UPDATE T1 SET @v = column_name = <expression>`, может привести к получению непредвиденных результатов, поскольку активное значение переменной может использоваться в других предложениях, таких как `WHER` и `ON`, во время выполнения инструкции вместо начального значения в инструкции. Это может стать причиной того, что значения предикатов будут изменяться непредсказуемым образом при переходе от строки к строке.<br /><br /> Такое поведение применимо, только если уровень совместимости равен 90.|Обновление столбцов с использованием двухстороннего присваивания приводит к получению ожидаемых результатов, поскольку во время выполнения инструкции происходит доступ только к начальному значению столбца в инструкции.|Низкий|  
|См. пример Д, приведенный ниже в разделе с примерами.|См. пример Е, приведенный ниже в разделе с примерами.|Низкий|  
|В функции ODBC {fn CONVERT()} используется применяемый в языке по умолчанию формат даты. Для некоторых языков форматом по умолчанию является ГДМ, что может привести к ошибкам преобразования, если функция CONVERT() применяется в сочетании с другими функциями, такими как `{fn CURDATE()}`, которые предполагают использование даты в формате ГМД.|В функции ODBC `{fn CONVERT()}` используется стиль 121 (независимый от языка формат ГМД) при преобразовании в такие типы данных ODBC, как SQL_TIMESTAMP, SQL_DATE, SQL_TIME, SQLDATE, SQL_TYPE_TIME и SQL_TYPE_TIMESTAMP.|Низкий|  
|Для таких встроенных средств работы со значениями даты и времени, как DATEPART, не требуется, чтобы строковые введенные значения были допустимыми литералами даты и времени. Например, `SELECT DATEPART (year, '2007/05-30')` компилируется успешно.|Для таких встроенных средств работы со значениями даты и времени, как `DATEPART`, необходимо, чтобы входные строковые значения были допустимыми литералами даты и времени. Возвращается ошибка 241 при использовании недопустимого литерала даты и времени.|Низкий|  
  
## <a name="reserved-keywords"></a>Зарезервированные слова  
 Настройка совместимости также определяет ключевые слова, зарезервированные компонентом [!INCLUDE[ssDE](../../includes/ssde-md.md)]. В следующей таблице показаны зарезервированные ключевые слова, представленные каждым из уровней совместимости.  
  
|Настройка уровня совместимости|Зарезервированные ключевые слова|  
|----------------------------------|-----------------------|  
|130|Подлежит уточнению.|  
|120|Нет.|  
|110|WITHIN GROUP, TRY_CONVERT, SEMANTICKEYPHRASETABLE, SEMANTICSIMILARITYDETAILSTABLE, SEMANTICSIMILARITYTABLE|  
|100|CUBE, MERGE, ROLLUP|  
|90|EXTERNAL, PIVOT, UNPIVOT, REVERT, TABLESAMPLE|  
  
 На данном уровне совместимости зарезервированные ключевые слова включают в себя все ключевые слова, представленные на этом уровне или ниже. Таким образом, например, для приложений на уровне 110, все ключевые слова, перечисленные в предыдущей таблице, являются зарезервированными. На более низких уровнях совместимости ключевые слова уровня 100 остаются допустимыми именами объектов, но функции языка уровня 110, соответствующие этим ключевым словам, недоступны.  
  
 Будучи однажды представленным, ключевое слово остается зарезервированным. Например, зарезервированное ключевое слово PIVOT, которое было введено на уровне совместимости 90, является также зарезервированным на уровнях 100, 110 и 120.  
  
 Если приложение использует идентификатор, зарезервированный в качестве ключевого слова на его уровне совместимости, работа приложения приведет к ошибке. Чтобы обойти эту проблему, заключите идентификатор в квадратные скобки (**[]**) или кавычки (**""**). Например, чтобы обновить приложение, использующее идентификатор **EXTERNAL**, до уровня совместимости 90, можно изменить идентификатор на **[EXTERNAL]** или **"EXTERNAL"**.  
  
 Дополнительные сведения см. в статье [Зарезервированные ключевые слова (Transact-SQL)](../../t-sql/language-elements/reserved-keywords-transact-sql.md).  
  
## <a name="permissions"></a>Разрешения  
 Необходимо разрешение ALTER на базу данных.  
  
## <a name="examples"></a>Примеры  
  
### <a name="a-changing-the-compatibility-level"></a>A. Изменение уровня совместимости  
 В следующем примере изменяется уровень совместимости базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] до `110,`[!INCLUDE[ssSQL11](../../includes/sssql11-md.md)].  
  
```sql  
ALTER DATABASE AdventureWorks2012  
SET COMPATIBILITY_LEVEL = 110;  
GO  
```  
  
 В следующем примере возвращается уровень совместимости текущей базы данных.  
  
```sql  
SELECT name, compatibility_level   
FROM sys.databases   
WHERE name = db_name();  
```  
  
### <a name="b-ignoring--the-set-language-statement-except-under-compatibility-level-120"></a>Б. Не учитывается инструкция SET LANGUAGE, за исключением выполнения при уровне совместимости 120  
 Следующий запрос не учитывает инструкцию SET LANGUAGE, за исключением выполнения при уровне совместимости 120.  
  
```sql  
SET DATEFORMAT dmy;   
DECLARE @t2 date = '12/5/2011' ;  
SET LANGUAGE dutch;   
SELECT CONVERT(varchar(11), @t2, 106);   
  
-- Results when the compatibility level is less than 120.   
12 May 2011   
  
-- Results when the compatibility level is set to 120).  
12 mei 2011  
```  
  
### <a name="c"></a>В.  
 При уровне совместимости 110 или ниже рекурсивные ссылки в правой части предложения EXCEPT создают бесконечный цикл.  
  
```sql  
WITH   
cte AS (SELECT * FROM (VALUES (1),(2),(3)) v (a)),  
r   
AS (SELECT a FROM Table1  
UNION ALL  
(SELECT a FROM Table1 EXCEPT SELECT a FROM r) )   
SELECT a   
FROM r;  
  
```  
  
### <a name="d"></a>Г.  
 В этом примере показано различие между стилями 0 и 121. Дополнительные сведения о стилях даты и времени см. в разделе [CAST и CONVERT (Transact-SQL)](../../t-sql/functions/cast-and-convert-transact-sql.md).  
  
```sql  
CREATE TABLE t1 (c1 time(7), c2 datetime2);   
  
INSERT t1 (c1,c2) VALUES (GETDATE(), GETDATE());  
  
SELECT CONVERT(nvarchar(16),c1,0) AS TimeStyle0  
       ,CONVERT(nvarchar(16),c1,121)AS TimeStyle121  
       ,CONVERT(nvarchar(32),c2,0) AS Datetime2Style0  
       ,CONVERT(nvarchar(32),c2,121)AS Datetime2Style121  
FROM t1;  
  
-- Returns values such as the following.  
TimeStyle0       TimeStyle121       
Datetime2Style0      Datetime2Style121  
---------------- ----------------   
-------------------- --------------------------  
3:15PM           15:15:35.8100000   
Jun  7 2011  3:15PM  2011-06-07 15:15:35.8130000  
```  
  
### <a name="e"></a>Д.  
 Присваивание значения переменной допускается в инструкции, содержащей оператор UNION верхнего уровня, но возвращает непредвиденные результаты. Например, в следующих инструкциях локальной переменной `@v` присваивается значение столбца `BusinessEntityID` из объединения двух таблиц. Если инструкция SELECT возвращает более одного значения, переменной присваивается последнее возвращенное значение. В этом случае переменной правильно присваивается последнее значение, но происходит также возврат результирующего набора инструкции SELECT UNION.  
  
```sql  
ALTER DATABASE AdventureWorks2012  
SET compatibility_level = 90;  
GO  
USE AdventureWorks2012;  
GO  
DECLARE @v int;  
SELECT @v = BusinessEntityID FROM HumanResources.Employee  
UNION ALL  
SELECT @v = BusinessEntityID FROM HumanResources.EmployeeAddress;  
SELECT @v;  
```  
  
### <a name="f"></a>Е.  
 Присваивание значения переменной не допускается в инструкции, содержащей оператор UNION верхнего уровня. Возвращается ошибка 10734. Чтобы устранить эту ошибку, перепишите запрос, как показано в следующем примере.  
  
```sql  
DECLARE @v int;  
SELECT @v = BusinessEntityID FROM   
    (SELECT BusinessEntityID FROM HumanResources.Employee  
     UNION ALL  
     SELECT BusinessEntityID FROM HumanResources.EmployeeAddress) AS Test;  
SELECT @v;  
```  
  
## <a name="see-also"></a>См. также:  
 [ALTER DATABASE (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql.md)   
 [Зарезервированные ключевые слова (Transact-SQL)](../../t-sql/language-elements/reserved-keywords-transact-sql.md)   
 [CREATE DATABASE (SQL Server Transact-SQL)](../../t-sql/statements/create-database-sql-server-transact-sql.md)   
 [DATABASEPROPERTYEX (Transact-SQL)](../../t-sql/functions/databasepropertyex-transact-sql.md)   
 [sys.databases (Transact-SQL)](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md)   
 [sys.database_files (Transact-SQL)](../../relational-databases/system-catalog-views/sys-database-files-transact-sql.md)  
 [Просмотр или изменение уровня совместимости базы данных](../../relational-databases/databases/view-or-change-the-compatibility-level-of-a-database.md) 
  
