---
title: "ИЗМЕНИТЬ уровень совместимости базы данных (Transact-SQL) | Документы Microsoft"
ms.custom: 
ms.date: 08/07/2017
ms.prod: sql-non-specified
ms.prod_service: database-engine, sql-database
ms.service: 
ms.component: t-sql|statements
ms.reviewer: 
ms.suite: sql
ms.technology:
- database-engine
ms.tgt_pltfrm: 
ms.topic: language-reference
f1_keywords:
- COMPATIBILITY_LEVEL_TSQL
- COMPATIBILITY_LEVEL
dev_langs:
- TSQL
helpviewer_keywords:
- 80 compatibility level
- ALTER DATABASE statement, compatibility levels
- 90 compatibility level
- compatibility levels [SQL Server]
- 100 compatibility level
ms.assetid: ca5fd220-d5ea-4182-8950-55d4101a86f6
caps.latest.revision: 89
author: edmacauley
ms.author: edmaca
manager: craigg
ms.workload: Active
ms.translationtype: MT
ms.sourcegitcommit: 876522142756bca05416a1afff3cf10467f4c7f1
ms.openlocfilehash: 7b65511b09f2a94d30c39c1f97ed88cfbfab855b
ms.contentlocale: ru-ru
ms.lasthandoff: 09/01/2017

---
# <a name="alter-database-transact-sql-compatibility-level"></a>Уровень совместимости ALTER DATABASE (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2008-asdb-xxxx-xxx-md](../../includes/tsql-appliesto-ss2008-asdb-xxxx-xxx-md.md)]

  
Настраивает определенное поведение баз данных для обеспечения совместимости с указанной версией [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Для других параметров инструкции ALTER DATABASE. в разделе [инструкции ALTER DATABASE &#40; Transact-SQL &#41; ](../../t-sql/statements/alter-database-transact-sql.md).  
  
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)  
  
## <a name="syntax"></a>Синтаксис  
  
```  
ALTER DATABASE database_name   
SET COMPATIBILITY_LEVEL = { 140 | 130 | 120 | 110 | 100 | 90 }  
```  
  
## <a name="arguments"></a>Аргументы  
 *database_name*  
 Имя изменяемой базы данных.  
  
 COMPATIBILITY_LEVEL {140 | 130 | 120 | 110 | 100 | 90 | 80}  
 Версия [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], с которой необходимо обеспечить совместимость базы данных. Можно настроить следующие значения уровня совместимости.  
  
|Продукт|Версия ядра базы данных|Назначение уровня совместимости|Поддерживаемые значения уровня совместимости|  
|-------------|-----------------------------|-------------------------------------|------------------------------------------|  
|[!INCLUDE[ssSQLv14_md](../../includes/sssqlv14-md.md)]|14|140|140, 130, 120, 110, 100|
|[!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)]|12|130|140, 130, 120, 110, 100|  
|[!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]|13|130|130, 120, 110, 100|  
|[!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]|12|120|120, 110, 100|  
|[!INCLUDE[ssSQL11](../../includes/sssql11-md.md)]|11|110|110, 100, 90|  
|[!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)]|10.5|100|100, 90, 80|  
|[!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]|10|100|100, 90, 80|  
|SQL Server 2005|9|90|90, 80|  
|SQL Server 2000|8|80|80|  
  
> [!NOTE]  
>  **База данных SQL Azure** V12 был выпущен в декабре 2014 г. Одним из аспектов, выпускаемых был, вновь создаваемые базы данных есть свой уровень совместимости в значение 120. В 2015 базы данных SQL начала поддержка уровня 130, несмотря на то, что значение по умолчанию всегда оставалась 120.  
> 
> Начиная с версии **mid июня 2016 г.**, в базе данных SQL Azure, уровень совместимости по умолчанию являются 130 вместо 120 для **только что созданный** баз данных. Существующие базы данных, созданные до среднего июня 2016 г., не затрагиваются и сохраняют свой текущий уровень совместимости (100, 110 и 120). 
> 
> Если требуется уровень 130 для базы данных как правило, но есть причина предпочитают уровне 110 **кратности** алгоритм, см. [ALTER DATABASE SCOPED CONFIGURATION &#40; Transact-SQL &#41; ](../../t-sql/statements/alter-database-scoped-configuration-transact-sql.md)и в частности зарезервированного слова LEGACY_CARDINALITY_ESTIMATION = ON.  
>  
>  Дополнительные сведения о том, как оценить разницу в производительности наиболее важных запросов, между двумя уровнями совместимости в базе данных SQL Azure, см. [повысить производительность запросов с 130 уровень совместимости базы данных SQL Azure](http://azure.microsoft.com/documentation/articles/sql-database-compatibility-level-query-performance-130/).


 Выполните следующий запрос, чтобы определить версию [!INCLUDE[ssDE](../../includes/ssde-md.md)] , вы подключены.  
  
```tsql  
SELECT SERVERPROPERTY('ProductVersion');  
```  
  
> [!NOTE]  
>  Поддерживаются не все функции, которые зависят от уровня совместимости [!INCLUDE[ssSDS](../../includes/sssds-md.md)].  

 Чтобы определить текущий уровень совместимости, запросите **compatibility_level** столбец [sys.databases &#40; Transact-SQL &#41; ](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md).  
  
```tsql  
SELECT name, compatibility_level FROM sys.databases;  
```  
  
## <a name="remarks"></a>Замечания  
 Для всех установок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], уровень совместимости по умолчанию имеет значение версии [!INCLUDE[ssDE](../../includes/ssde-md.md)]. Базы данных устанавливаются на этом уровне, если **модели** база данных имеет более низкий уровень совместимости. При обновлении базы данных из более ранних версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], база данных сохраняет свой существующий уровень совместимости, если он по крайней мере минимальное допустимое для этого экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Обновления базы данных с уровнем совместимости ниже, чем допустимый уровень, задает наименьшее допускается уровень совместимости базы данных. Это относится и к системным, и к пользовательским базам данных. Используйте **инструкции ALTER DATABASE** для изменения уровня совместимости базы данных. Чтобы просмотреть текущий уровень совместимости базы данных, запросите **compatibility_level** столбца в **sys.databases** представления каталога.  

  
## <a name="using-compatibility-level-for-backward-compatibility"></a>Использование уровня совместимости для обеспечения обратной совместимости  
 Уровень совместимости влияет на поведение только указанных баз данных, а не всего сервера. Уровень совместимости обеспечивает лишь частичную обратную совместимость с ранними версиями [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Начиная с режимом совместимости 130 новых возможностей влияющие на план запроса были добавлены только к новый режим совместимости. Это было сделано, чтобы свести к минимуму риск во время обновления, которые возникают вследствие снижения производительности из-за изменения плана запросов. С точки зрения приложения целью является по-прежнему будет в последний уровень совместимости для наследуют некоторые новые функции, а также для улучшения производительности, в области оптимизатор запроса, но делать это контролируемым образом. Используйте уровень совместимости в качестве промежуточной меры в процессе устранения проблем, возникших из-за различий в поведении между версиями, которые определяются соответствующей настройкой уровня совместимости. Дополнительные сведения см. в разделе лучших методов обновления из статьи.  
  
 Если существующие [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] влияет на различия в поведении в версии приложения [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], преобразование приложения для работы с новый режим совместимости. Затем с помощью **инструкции ALTER DATABASE** для изменения уровня совместимости 130. Новая настройка уровня совместимости для базы данных изменения вступят в силу при **USE Database** выдается или при обработке нового имени входа этой базы данных в качестве базы данных по умолчанию.  
  
## <a name="best-practices"></a>Рекомендации  
 Изменение уровня совместимости в то время, когда пользователи подключены к базе данных, может привести к формированию неверных результирующих наборов для активных запросов. Например, если уровень совместимости изменится во время компиляции плана запроса, скомпилированный план может основываться на обоих, старом и новом, уровнях совместимости, что в результате даст неверный план и потенциально неточные результаты. Более того, проблема может стать еще более запутанной, если план будет помещен в кэш планов и повторно использован для последующих запросов. Чтобы запросы не выдавали неверных результатов, рекомендуется воспользоваться следующей процедурой для изменения уровня совместимости базы данных.  
  
1.  Перевести базу данных в однопользовательский режим работы с помощью инструкции ALTER DATABASE SET SINGLE_USER.  
  
2.  Изменить уровень совместимости базы данных.  
  
3.  Перевести базу данных в многопользовательский режим работы с помощью инструкции ALTER DATABASE SET MULTI_USER.  
  
4.  Дополнительные сведения об установке режима доступа базы данных см. в разделе [инструкции ALTER DATABASE &#40; Transact-SQL &#41; ](../../t-sql/statements/alter-database-transact-sql.md).  
  
## <a name="compatibility-levels-and-stored-procedures"></a>Уровни совместимости и хранимые процедуры  
 При выполнении хранимой процедуры используется текущий уровень совместимости базы данных, в которой она была определена. Когда настройка совместимости базы данных подвергается изменению, все хранимые процедуры этой базы данных автоматически перекомпилируются соответствующим образом.  

## <a name="differences-between-compatibility-level-130-and-level-140"></a>Различия между уровнем совместимости 130 и уровень 140  
В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 140.

|Установка уровня совместимости, меньшим или равным 130.|Установка уровня совместимости 140|  
|--------------------------------------------------|-----------------------------------------|  
|Оценки количества элементов для инструкций, ссылающихся на нескольких инструкций возвращающей табличное значение функции используют предположение фиксированной строки.|Оценки количества элементов для соответствующих инструкций, ссылающихся на нескольких инструкций возвращающей табличное значение функций будет использовать фактическое количество элементов выходные данные функции.  Этот параметр доступен через **чередуются выполнения** для многооператорных возвращающих табличное значение функций.|
|Пакетный режим запросов, недостатка памяти предоставить размеры, которые приводят к сбросы на диск может сохранять проблем на последовательных выполнений.|Запросы пакетного режима, размеры grant нехватки памяти, что приведет к сбросы на диск может иметь более высокую производительность в последовательных выполнений запросов.  Этот параметр доступен через **памяти пакетного режима предоставить отзыв** которого будет обновлять объем выделения памяти кэшированного плана, если сбросы произойти по операторам пакетного режима. |
|Размер, которого результаты в проблем параллелизма может по-прежнему возникают проблемы в последовательных выполнений предоставления пакетного режима запросов, запрашивающих чрезмерное количество ресурсов памяти.|Размер, который приводит к проблем параллелизма имеют улучшенную параллелизма на последовательных выполнений разрешений пакетного режима запросов, запрашивающих чрезмерное количество ресурсов памяти.  Этот параметр доступен через **памяти пакетного режима предоставить отзыв** которого будет обновлять объем выделения памяти кэшированного плана, если было первоначально запрошено слишком много.|
|Пакетный режим запросов, содержащих операторы соединения пригодны для трех алгоритмов физического соединения, включая вложенного цикла, хэш-соединение и соединение слиянием.  Если оценки количества элементов для входа соединения, алгоритм соединения может быть выбран.  В этом случае производительность снижается, а алгоритм соединения останутся в использовании до повторной компиляции кэшированных планов.|Оператор дополнительные соединения вызывается **адаптивной соединения**. Если оценки количества элементов для внешнего соединения конструктивный, алгоритм соединения может быть выбран.  Если это происходит, инструкция подходит для адаптивной соединения вложенного цикла будет использоваться для небольших входа соединения и хэш-соединение будет использоваться для входа большего соединения динамически без повторной компиляции. |
|Тривиальные планы, ссылающиеся индексы Columnstore не могут быть для пакетного режима. |Обычный план, ссылающиеся на индексы Columnstore будет заменен план, который подходит для пакетного режима.|
|Оператор UDX sp_execute_external_script может выполняться только в режиме "строка".|Оператор UDX sp_execute_external_script право на выполнение в пакетном режиме.|  
|Многооператорную не имеют поочередное исполнение |Поочередное исполнение для возвращающих табличное значение функций несколькими инструкциями повысить качество плана. |

Исправления, которые были под флагом трассировки 4199 в более ранних версиях SQL Server до SQL Server 2017 г. теперь включены по умолчанию. В режиме совместимости 140. Флаг трассировки 4199 по-прежнему могут быть реализованы для нового исправления оптимизатора запросов, выпущенные после 2017 г. SQL Server. Сведения о флагу трассировки 4199 см. в разделе [флагу трассировки 4199](https://support.microsoft.com/en-us/kb/974006).  
  
## <a name="differences-between-compatibility-level-120-and-level-130"></a>Различия между уровнем совместимости 120 и 130 уровень  
В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 130.   

  
|Установка уровня совместимости 120 или ниже|Установка уровня совместимости 130|  
|--------------------------------------------------|-----------------------------------------|  
|Вставки в инструкции Insert select является однопоточным.|Вставки в инструкции Insert select используется несколько потоков или может иметь параллельного плана.|  
|Запросы в таблице, оптимизированной для памяти, выполняются одним потоком.|Запросы к таблице, оптимизированной для памяти, теперь могут иметь параллельные планы.|  
|Появился в SQL 2014 механизме оценки **CardinalityEstimationModelVersion = «120»**|Дальнейшие количества элементов Планирование улучшения оценки (CE) с 130 модели оценки количества элементов, который становится видимым из запроса. **CardinalityEstimationModelVersion = «130»**|  
|Пакетный режим и режим строки изменяется с индексами Columnstore<br /><br /> Сортировка в таблице с индексом Columnstore находятся в режиме строки<br /><br /> Статистические выражения функции управления окнами работать в режиме строки, такие как LAG или ИНТЕРЕСА<br /><br /> Запросы в таблицах Columnstore с несколькими предложениями distinct эксплуатации в режиме "строка"<br /><br /> Запросы, выполняемые с MAXDOP 1 или последовательный план, который выполняется в режиме "строка" | Пакетный режим и режим строки изменяется с индексами Columnstore<br /><br /> Сортировка в таблице с индексом Columnstore теперь находятся в пакетном режиме<br /><br /> Статистические функции управления окнами теперь работать в пакетном режиме, такие как LAG или ИНТЕРЕСА<br /><br /> Запросы в таблицах Columnstore с несколькими предложениями distinct работать в пакетном режиме<br /><br /> Запросы, выполняемые с Maxdop1 или последовательный план, выполняются в пакетном режиме|  
| Статистика может обновляться автоматически. | Логику, которая автоматически обновляет статистику заметным в больших таблицах.  На практике это следует уменьшить случаев, где клиенты встречали проблем с производительностью на запросах, где получат новые вставленные строки часто, но где статистика не была обновлена для включения этих значений. |  
| Трассировки 2371 выключено по умолчанию в [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)]. | [Трассировка 2371](https://blogs.msdn.microsoft.com/psssql/2016/10/04/default-auto-statistics-update-threshold-change-for-sql-server-2016/) включено по умолчанию в [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]. Флаг трассировки 2371 сообщает автоматического обновления статистики для выборки меньшего размера, но приходить подмножество строк в таблице, имеющей большое число строк. <br/> <br/> Одно улучшение — Включение в образце больше строк, которые недавно были вставлены. <br/> <br/> Улучшения в другой — для запросов, выполняемых во время процесса обновления статистики выполнения, а не блокирует запрос. |  
| Для уровней 120, проверит Статистика *одного*-потоков процесса. | Для уровня 130 проверит Статистика *несколькими*-потоков процесса. |  
| 253 входящие внешние ключи, ограничено. | Данной таблицы может ссылаться до 10 000 входящие внешние ключи или аналогичные ссылки. Ограничения см. в разделе [Create Foreign Key Relationships](../../relational-databases/tables/create-foreign-key-relationships.md). |  
|Устаревшие алгоритмы хэширования MD2, MD4, MD5, SHA и SHA1 разрешены.|Допускаются только SHA2_256 и SHA2_512 хэш-алгоритмов.|  
  
  
Флаг, исправления, которые находятся под трассировки 4199 в более ранних версиях [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] до [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)] включены по умолчанию. В режиме совместимости 130. Флаг трассировки 4199 по-прежнему применяться для нового исправления оптимизатора запросов, выпущенные после [!INCLUDE[ssSQL15](../../includes/sssql15-md.md)]. Чтобы использовать старый оптимизатор запросов в [!INCLUDE[ssSDS](../../includes/sssds-md.md)] необходимо выбрать уровень совместимости 110. Сведения о флагу трассировки 4199 см. в разделе [флагу трассировки 4199](https://support.microsoft.com/en-us/kb/974006).  
  
## <a name="differences-between-lower-compatibility-levels-and-level-120"></a>Различия между уровнем 120 и более низкими уровнями совместимости  
 В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 120.  
  
|Уровень совместимости 110 и ниже|Установка уровня совместимости 120|  
|--------------------------------------------------|-----------------------------------------|  
|Используется старый оптимизатор запросов.|В [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] предусмотрены существенные усовершенствования компонента, предназначенного для создания и оптимизации планов запросов. Эта новая функция оптимизатора запросов зависит от использования уровня совместимости базы данных 120. Новые приложения базы данных необходимо разрабатывать с использованием уровня совместимости базы данных 120, чтобы воспользоваться этими усовершенствованиями. Приложения, перенесенные из предыдущих версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], необходимо тщательно тестировать, чтобы убедиться в сохранении или повышении их производительности. Если производительность снизилась, можно задать уровень совместимости базы данных равным 110 или предыдущему значению для использования методологии оптимизатора запросов из прежних версий.<br /><br /> На уровне совместимости базы данных 120 используется новый механизм оценки количества элементов, который настроен для современных рабочих нагрузок, связанных с хранением данных и OLTP. Прежде чем задать уровень совместимости базы данных 110 из-за проблем с производительностью, см. рекомендации в разделе планы запроса [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] [новые возможности в ядре СУБД](../../database-engine/configure-windows/what-s-new-in-sql-server-2016-database-engine.md) раздела.|  
|При уровне совместимости ниже 120, параметр языка учитывается при преобразовании **даты** значение в строковое значение. Обратите внимание, что это поведение характерно только для **даты** типа. См. пример Б в подразделе «примеры» ниже.|Параметр языка не учитывается при преобразовании **даты** значение в строковое значение.|  
|Рекурсивные ссылки в правой части предложения EXCEPT создают бесконечный цикл. Пример C в подразделе «примеры» ниже демонстрирует эту ситуацию.|Рекурсивные ссылки в предложении EXCEPT вызывают ошибку в соответствии со стандартом ANSI SQL.|  
|В рекурсивных обобщенных табличных выражениях повторяющиеся имена столбцов разрешены.|В рекурсивных обобщенных табличных выражениях повторяющиеся имена столбцов не разрешены.|  
|Отключенные триггеры активируются при их изменении.|Изменение триггера не меняет состояние триггера (отключен или включен).|  
|Табличное предложение OUTPUT INTO пропускает параметр IDENTITY_INSERT = OFF и позволяет вставлять явные значения.|Нельзя вставить явные значения для столбца идентификаторов в таблице, если параметр IDENTITY_INSERT имеет значение OFF.|  
|Если выбрано частичное включение базы данных, проверка поля $action в предложении OUTPUT инструкции MERGE может вернуть ошибку параметров сортировки.|Параметры сортировки значений, возвращаемых предложением $action инструкции MERGE, — это параметры сортировки базы данных, а не сервера. Ошибка конфликтующих параметров сортировки сервера не возвращается.|  
|Объект **SELECT INTO** оператор всегда создает операции вставки с одним потоком.|Объект **SELECT INTO** инструкции можно создать параллельную операцию вставки. При вставке большого числа строк параллельная операция может увеличить производительность.|  
  
## <a name="differences-between-lower-compatibility-levels-and-levels-110-and-120"></a>Различия между более низкими уровнями совместимости и уровнями 110 и 120  
 В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 110.   Этот раздел относится также к уровню 120.  
  
|Уровень совместимости 100 и ниже|Установка уровня совместимости, по меньшей мере равного 110|  
|--------------------------------------------------|--------------------------------------------------|  
|Объекты базы данных среды CLR выполняются в среде CLR версии 4. Однако некоторые из особенностей поведения, изменившиеся в версии 4 среды CLR, не используются. Дополнительные сведения см. в разделе [новые возможности интеграции со средой CLR](../../relational-databases/clr-integration/clr-integration-what-s-new.md).|Объекты базы данных среды CLR выполняются в среде CLR версии 4.|  
|Функции XQuery **длины строки** и **подстроки** считают каждый суррогатный символ за два символа.|Функции XQuery **длины строки** и **подстроки** рассматривать каждый суррогат как один символ.|  
|Оператор PIVOT можно использовать в запросах рекурсивного обобщенного табличного выражения. Однако при наличии нескольких строк в группировании запрос возвращает неверные результаты.|Оператор PIVOT нельзя использовать в запросах рекурсивного обобщенного табличного выражения. Возвращается ошибка.|  
|Алгоритм RC4 поддерживается только в целях обратной совместимости. Когда база данных имеет уровень совместимости 90 или 100, новые материалы могут шифроваться только с помощью алгоритмов RC4 или RC4_128. (Не рекомендуется.) В [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] материалы, зашифрованные с помощью алгоритмов RC4 или RC4_128, могут быть расшифрованы на любом уровне совместимости.|Новые материалы нельзя шифровать с помощью RC4 или RC4_128. Используйте вместо этого более новые алгоритмы, например AES. В [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] материалы, зашифрованные с помощью алгоритмов RC4 или RC4_128, могут быть расшифрованы на любом уровне совместимости.|  
|Стиль по умолчанию для операций CAST и CONVERT над **время** и **datetime2** типы данных — 121, за исключением того, при использовании любой из этих типов в выражении вычисляемого столбца. Для вычисляемых столбцов используемый по умолчанию стиль — 0. Это поведение влияет на вычисляемые столбцы при их создании и использовании в запросах с автоматической параметризацией, а также при использовании в определениях ограничений.<br /><br /> Пример Г в подразделе «примеры» ниже показано различие между стилями 0 и 121. В примере не рассматривается описанное выше поведение. Дополнительные сведения о стилях даты и времени см. в разделе [CAST и CONVERT &#40; Transact-SQL &#41; ](../../t-sql/functions/cast-and-convert-transact-sql.md).|При уровне совместимости 110 стиль по умолчанию для операций CAST и CONVERT на **время** и **datetime2** типы данных всегда имеет значение 121. Если запрос основан на прежнем поведении, следует использовать уровень совместимости ниже 110, либо явно задать в затрагиваемом запросе стиль 0.<br /><br /> Обновление базы данных до уровня совместимости 110 не приведет к изменению пользовательских данных, сохраненных на диске. Следует исправить эти данных соответствующим образом вручную. Например, если бы вы использовали предложение SELECT INTO для создания таблицы на основе источника, содержащего описанное выше выражение вычисляемого столбца, то сохранялись бы данные (благодаря стилю 0), а не само определение вычисляемого столбца. Потребовалось бы вручную обновлять эти данные в соответствии со стилем 121.|  
|Все столбцы в удаленных таблицах типа **smalldatetime** , фигурирующих в секционированном представлении, сопоставляются с типами **datetime**. Соответствующие столбцы в локальных таблиц (в те же порядковые позиции в списке выбора) должны иметь тип **datetime**.|Все столбцы в удаленных таблицах типа **smalldatetime** , фигурирующих в секционированном представлении, сопоставляются с типами **smalldatetime**. Соответствующие столбцы в локальных таблиц (в те же порядковые позиции в списке выбора) должны иметь тип **smalldatetime**.<br /><br /> После обновления до уровня совместимости 110 произойдет сбой распределенного секционированного представления из-за несоответствия типа данных. Это можно устранить путем изменения типа данных в удаленной таблице, чтобы **datetime** или установка совместимости уровня локальной базы данных 100 или ниже.|  
|Функция SOUNDEX реализует следующие правила.<br /><br /> (1) прописная H или W в верхнем регистре игнорируются, если они разделяют 2 согласные, которые имеют одинаковый номер в коде SOUNDEX.<br /><br /> (2) Если первые 2 символа *character_expression* имеют одинаковый номер в коде SOUNDEX, включаются оба символа. Иначе, если набор последовательных согласных в коде SOUNDEX имеет тот же номер, все они исключаются, кроме первого символа.|Функция SOUNDEX реализует следующие правила.<br /><br /> (1) Если верхний регистр H или W в верхнем регистре отдельные две согласные буквы, которые имеют одинаковый номер в коде SOUNDEX согласных справа игнорируется<br /><br /> (2) Если набор последовательных согласных side-by-side имеет одинаковый номер в коде SOUNDEX, все они исключаются, кроме первого.<br /><br /> <br /><br /> Функция SOUNDEX реализует дополнительные правила, при применении которых значения, вычисляемые функцией, могут отличаться от тех значений, которые были вычислены при другом уровне совместимости. После обновления до уровня совместимости 110, возможно, придется перестроить индексы, кучи или ограничения CHECK, в которых используется функция SOUNDEX. Дополнительные сведения см. в разделе [SOUNDEX &#40; Transact-SQL &#41;](../../t-sql/functions/soundex-transact-sql.md)|  
  
## <a name="differences-between-compatibility-level-90-and-level-100"></a>Различия между уровнями совместимости 90 и 100  
 В этом разделе описываются новые особенности поведения, обусловленные появлением уровня совместимости 100.  
  
|Установка уровня совместимости 90|Установка уровня совместимости 100|Вероятность влияния|  
|----------------------------------------|-----------------------------------------|---------------------------|  
|Параметр QUOTED_IDENTIFER всегда имеет значение ON для возвращающих табличное значение функций, состоящих из нескольких инструкций, если эти функции созданы без учета параметра сеансового уровня.|Значение параметра сеанса QUOTED IDENTIFIER учитывается при создании возвращающих табличное значение функций, состоящих из нескольких инструкций.|Средний|  
|При создании или изменении функции секционирования, **datetime** и **smalldatetime** литералы в функции вычисляются на основе US_English языковой параметр.|Текущих языковых параметров используется для оценки **datetime** и **smalldatetime** литералы в функции секционирования.|Средний|  
|Предложение FOR BROWSE допускается (и не учитывается) в инструкциях INSERT и SELECT INTO.|Предложение FOR BROWSE не допускается в инструкциях SELECT INTO и INSERT.|Средний|  
|Полнотекстовые предикаты допускаются в предложении OUTPUT.|Полнотекстовые предикаты не допускаются в предложении OUTPUT.|Низкий|  
|Инструкции CREATE FULLTEXT STOPLIST, ALTER FULLTEXT STOPLIST и DROP FULLTEXT STOPLIST не поддерживаются. Системный список стоп-слов автоматически связывается с новыми полнотекстовыми индексами.|Инструкции CREATE FULLTEXT STOPLIST, ALTER FULLTEXT STOPLIST и DROP FULLTEXT STOPLIST поддерживаются.|Низкий|  
|MERGE не рассматривается как зарезервированное ключевое слово.|MERGE является полностью зарезервированным ключевым словом. Инструкция MERGE поддерживается на обоих уровнях совместимости, 100 и 90.|Низкий|  
|С помощью \<dml_table_source > аргумент инструкции INSERT вызывает ошибку синтаксиса.|Можно собрать результаты предложения OUTPUT во вложенных инструкциях INSERT, UPDATE, DELETE или MERGE и вставить эти результаты в целевую таблицу или представление. Это делается с помощью \<dml_table_source > аргумент инструкции INSERT.|Низкий|
|Если не указано предложение NOINDEX, инструкции DBCC CHECKDB и DBCC CHECKTABLE выполняют проверку физической и логической согласованности для одной таблицы или индексированного представления, а также для всех некластеризованных индексов и XML-индексов. Пространственные индексы не поддерживаются.|Если не указано предложение NOINDEX, инструкции DBCC CHECKDB и DBCC CHECKTABLE выполняют проверку физической и логической согласованности для одной таблицы и всех ее некластеризованных индексов. Однако в XML-индексах, пространственных индексах и индексированных представлениях по умолчанию выполняются только проверки физической согласованности.<br /><br /> Если указан параметр WITH EXTENDED_LOGICAL_CHECKS, выполняются логические проверки в индексированных представлениях, XML-индексах и пространственных индексах (при их наличии). По умолчанию проверки физической согласованности выполняются раньше, чем проверки логической согласованности. Если также указан параметр NOINDEX, выполняются только проверки логической согласованности.|Низкий|  
|Если предложение OUTPUT используется в инструкции DML и при выполнении инструкции возникает ошибка времени выполнения, то завершается вся транзакция и происходит откат.|Если предложение OUTPUT используется в инструкции DML и при выполнении инструкции возникает ошибка времени выполнения, дальнейшие поведение системы зависит от параметра SET XACT_ABORT. Если параметр SET XACT_ABORT имеет значение OFF, то аварийное прекращение выполнения инструкции из-за ошибки, возникшей при выполнении инструкции DML, в которой используется предложение OUTPUT, приводит к завершению инструкции, но выполнение пакета продолжается и откат транзакции не происходит. Если параметр SET XACT_ABORT имеет значение ON, то при возникновении любых ошибок времени выполнения, вызванных инструкцией DML, в которой используется предложение OUTPUT, происходит завершение пакета и в транзакции происходит откат.|Низкий|  
|CUBE и ROLLUP не рассматриваются как зарезервированные ключевые слова.|CUBE и ROLLUP являются зарезервированными ключевыми словами в предложении GROUP BY.|Низкий|  
|Строгая проверка применяется к элементам типа XML **anyType** типа.|Нестрогая проверка применяется к элементам **anyType** типа. Дополнительные сведения см. в разделе [компоненты-шаблоны и проверка содержимого](../../relational-databases/xml/wildcard-components-and-content-validation.md).|Низкий|  
|Специальные атрибуты **xsi: nil** и **xsi: Type** нельзя выполнять запросы или изменен с помощью инструкции языка обработки данных.<br /><br /> Это означает, что `/e/@xsi:nil` завершается с ошибкой при `/e/@*` игнорирует **xsi: nil** и **xsi: Type** атрибуты. Тем не менее `/e` возвращает **xsi: nil** и **xsi: Type** атрибуты для согласованности с `SELECT xmlCol`, даже если `xsi:nil = "false"`.|Специальные атрибуты **xsi: nil** и **xsi: Type** хранятся как обычные атрибуты и можно запрашивать и изменять.<br /><br /> Например, выполнение запроса `SELECT x.query('a/b/@*')` возвращает все атрибуты, включая **xsi: nil** и **xsi: Type**. Чтобы исключить эти типы из запроса, замените `@*` с `@*[namespace-uri(.) != "` *вставьте uri пространства имен xsi* `"` и не `(local-name(.) = "type"` или`local-name(.) ="nil".`|Низкий|  
|Определяемая пользователем функция, которая преобразует строковое значение константы XML в тип [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] datetime, отмечается как детерминированная.|Определяемая пользователем функция, которая преобразует строковое значение константы XML в тип [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] datetime, отмечается как недетерминированная.|Низкий|  
|Объединение XML и типы списков поддерживаются не полностью.|Объединение и типы списков поддерживаются полностью, включая следующие функциональные возможности.<br /><br /> Объединение списков<br /><br /> Объединение объединений<br /><br /> Список атомарных типов<br /><br /> Список объединений|Низкий|  
|Проверка правильности параметров SET, требуемых для метода xQuery, не выполняется, если метод содержится в представлении или во встроенной возвращающей табличное значение функции.|Проверка правильности параметров SET, требуемых для метода xQuery, выполняется, если метод содержится в представлении или во встроенной возвращающей табличное значение функции. Если параметры SET метода заданы неправильно, возникает ошибка.|Низкий|  
|Значения XML-атрибута, которые содержат символы конца строки (символы возврата каретки и перевода строки), не нормализованы согласно стандарту XML. Таким образом, возвращаются оба символа вместо одного символа перевода строки.|Значения XML-атрибута, которые содержат символы конца строки (символы возврата каретки и перевода строки), нормализованы согласно стандарту XML. Таким образом, все символы конца строки во внешних проанализированных сущностях (включая сущность документа), нормализуются на входе, преобразуя двухсимвольные последовательности #xD #xA и символы #xD, за которыми не следует символ #xA, в единственный символ #xA.<br /><br /> Приложения, в которых используются атрибуты для переноса строковых значений, содержащих символы конца строки, не получают эти символы назад в том виде, в каком они были переданы. Чтобы предотвратить выполнение этого процесса нормализации, используйте числовые сущности-символы XML для кодирования всех символов конца строки.|Низкий|  
|Свойства столбца ROWGUIDCOL и IDENTITY могут быть неправильно именованы как ограничения. Например, инструкция `CREATE TABLE T (C1 int CONSTRAINT MyConstraint IDENTITY)` выполняется, но имя ограничения не сохраняется и не доступно для пользователя.|Свойства столбца ROWGUIDCOL и IDENTITY не могут быть именованы как ограничения. Возвращается ошибка 156.|Низкий|  
|Обновление столбцов с использованием двухстороннего присваивания, такого как `UPDATE T1 SET @v = column_name = <expression>`, может привести к получению непредвиденных результатов, поскольку активное значение переменной может использоваться в других предложениях, таких как WHERE и ON, во время выполнения инструкции вместо начального значения в инструкции. Это может стать причиной того, что значения предикатов будут изменяться непредсказуемым образом при переходе от строки к строке.<br /><br /> Такое поведение применимо, только если уровень совместимости равен 90.|Обновление столбцов с использованием двухстороннего присваивания приводит к получению ожидаемых результатов, поскольку во время выполнения инструкции происходит доступ только к начальному значению столбца в инструкции.|Низкий|  
|См. пример E в подразделе «примеры» ниже.|См. пример F в подразделе «примеры» ниже.|Низкий|  
|В функции ODBC {fn CONVERT()} используется применяемый в языке по умолчанию формат даты. Для некоторых языков форматом по умолчанию является «ГДМ», что может привести к ошибкам преобразования, если функция CONVERT() применяется в сочетании с другими функциями, такими как {fn CURDATE()}, которые предполагают использование даты в формате «ГМД».|В функции ODBC {fn CONVERT()} используется стиль 121 (независимый от языка формат «ГМД») при преобразовании в такие типы данных ODBC, как SQL_TIMESTAMP, SQL_DATE, SQL_TIME, SQLDATE, SQL_TYPE_TIME и SQL_TYPE_TIMESTAMP.|Низкий|  
|Для таких встроенных средств работы со значениями даты и времени, как DATEPART, не требуется, чтобы строковые введенные значения были допустимыми литералами даты и времени. Например, компиляция инструкции SELECT DATEPART (year, '2007/05-30') выполняется успешно.|Для таких встроенных средств работы со значениями даты и времени, как DATEPART, необходимо, чтобы строковые введенные значения были допустимыми литералами даты и времени. Возвращается ошибка 241 при использовании недопустимого литерала даты и времени.|Низкий|  
  
## <a name="reserved-keywords"></a>Зарезервированные слова  
 Настройка совместимости также определяет ключевые слова, зарезервированные компонентом [!INCLUDE[ssDE](../../includes/ssde-md.md)]. В следующей таблице показаны зарезервированные ключевые слова, представленные каждым из уровней совместимости.  
  
|Настройка уровня совместимости|Зарезервированные ключевые слова|  
|----------------------------------|-----------------------|  
|130|Чтобы определить.|  
|120|Нет.|  
|110|WITHIN GROUP, TRY_CONVERT, SEMANTICKEYPHRASETABLE, SEMANTICSIMILARITYDETAILSTABLE, SEMANTICSIMILARITYTABLE|  
|100|CUBE, MERGE, ROLLUP|  
|90|EXTERNAL, PIVOT, UNPIVOT, REVERT, TABLESAMPLE|  
  
 На данном уровне совместимости зарезервированные ключевые слова включают в себя все ключевые слова, представленные на этом уровне или ниже. Таким образом, например, для приложений на уровне 110, все ключевые слова, перечисленные в предыдущей таблице, являются зарезервированными. На более низких уровнях совместимости ключевые слова уровня 100 остаются допустимыми именами объектов, но функции языка уровня 110, соответствующие этим ключевым словам, недоступны.  
  
 Будучи однажды представленным, ключевое слово остается зарезервированным. Например, зарезервированное ключевое слово PIVOT, которое было введено на уровне совместимости 90, является также зарезервированным на уровнях 100, 110 и 120.  
  
 Если приложение использует идентификатор, зарезервированный в качестве ключевого слова на его уровне совместимости, работа приложения приведет к ошибке. Чтобы обойти это, заключите идентификатор в квадратные скобки, либо (**[]**) или кавычки (**» «**); например, чтобы обновить приложение, использующее идентификатор **ВНЕШНИЕ** с уровнем совместимости 90, можно изменить идентификатор либо **[EXTERNAL]** или **«EXTERNAL»**.  
  
 Дополнительные сведения см. в статье [Зарезервированные ключевые слова (Transact-SQL)](../../t-sql/language-elements/reserved-keywords-transact-sql.md).  
  
## <a name="permissions"></a>Permissions  
 Необходимо разрешение ALTER на базу данных.  
  
## <a name="examples"></a>Примеры  
  
### <a name="a-changing-the-compatibility-level"></a>A. Изменение уровня совместимости  
 В следующем примере изменяется уровень совместимости [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] базы данных для `110,` [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)].  
  
```tsql  
ALTER DATABASE AdventureWorks2012  
SET COMPATIBILITY_LEVEL = 110;  
GO  
```  
  
 В следующем примере возвращается уровень совместимости текущей базы данных.  
  
```tsql  
SELECT name, compatibility_level   
FROM sys.databases   
WHERE name = db_name();  
```  
  
### <a name="b-ignoring--the-set-language-statement-except-under-compatibility-level-120"></a>Б. Пропуск инструкцию SET LANGUAGE, за исключением при уровне совместимости 120  
 Следующий запрос не учитывает инструкцию SET LANGUAGE, за исключением при уровне совместимости 120.  
  
```tsql  
SET DATEFORMAT dmy;   
DECLARE @t2 date = '12/5/2011' ;  
SET LANGUAGE dutch;   
SELECT CONVERT(varchar(11), @t2, 106);   
  
-- Results when the compatibility level is less than 120.   
12 May 2011   
  
-- Results when the compatibility level is set to 120).  
12 mei 2011  
```  
  
### <a name="c"></a>В.  
 Для Установка уровня совместимости 110 и ниже рекурсивные ссылки в правой части предложения EXCEPT создают бесконечный цикл.  
  
```tsql  
WITH   
cte AS (SELECT * FROM (VALUES (1),(2),(3)) v (a)),  
r   
AS (SELECT a FROM Table1  
UNION ALL  
(SELECT a FROM Table1 EXCEPT SELECT a FROM r) )   
SELECT a   
FROM r;  
  
```  
  
### <a name="d"></a>Г.  
 В этом примере показано различие между стилями 0 и 121. Дополнительные сведения о стилях даты и времени см. в разделе [CAST и CONVERT &#40; Transact-SQL &#41; ](../../t-sql/functions/cast-and-convert-transact-sql.md).  
  
```tsql  
CREATE TABLE t1 (c1 time(7), c2 datetime2);   
  
INSERT t1 (c1,c2) VALUES (GETDATE(), GETDATE());  
  
SELECT CONVERT(nvarchar(16),c1,0) AS TimeStyle0  
       ,CONVERT(nvarchar(16),c1,121)AS TimeStyle121  
       ,CONVERT(nvarchar(32),c2,0) AS Datetime2Style0  
       ,CONVERT(nvarchar(32),c2,121)AS Datetime2Style121  
FROM t1;  
  
-- Returns values such as the following.  
TimeStyle0       TimeStyle121       
Datetime2Style0      Datetime2Style121  
---------------- ----------------   
-------------------- --------------------------  
3:15PM           15:15:35.8100000   
Jun  7 2011  3:15PM  2011-06-07 15:15:35.8130000  
```  
  
### <a name="e"></a>Д.  
 Присваивание значения переменной допускается в инструкции, содержащей оператор UNION верхнего уровня, но возвращает непредвиденные результаты. Например, в следующих инструкциях локальной переменной `@v` присваивается значение столбца `BusinessEntityID` из объединения двух таблиц. Если инструкция SELECT возвращает более одного значения, переменной присваивается последнее возвращенное значение. В этом случае переменной правильно присваивается последнее значение, но происходит также возврат результирующего набора инструкции SELECT UNION.  
  
```tsql  
ALTER DATABASE AdventureWorks2012  
SET compatibility_level = 90;  
GO  
USE AdventureWorks2012;  
GO  
DECLARE @v int;  
SELECT @v = BusinessEntityID FROM HumanResources.Employee  
UNION ALL  
SELECT @v = BusinessEntityID FROM HumanResources.EmployeeAddress;  
SELECT @v;  
```  
  
### <a name="f"></a>Е.  
 Присваивание значения переменной не допускается в инструкции, содержащей оператор UNION верхнего уровня. Возвращается ошибка 10734. Чтобы устранить эту ошибку, перепишите запрос, как показано в следующем примере.  
  
```tsql  
DECLARE @v int;  
SELECT @v = BusinessEntityID FROM   
    (SELECT BusinessEntityID FROM HumanResources.Employee  
     UNION ALL  
     SELECT BusinessEntityID FROM HumanResources.EmployeeAddress) AS Test;  
SELECT @v;  
```  
  
## <a name="see-also"></a>См. также:  
 [ALTER DATABASE (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql.md)   
 [Зарезервированные ключевые слова (Transact-SQL)](../../t-sql/language-elements/reserved-keywords-transact-sql.md)   
 [CREATE DATABASE (SQL Server Transact-SQL)](../../t-sql/statements/create-database-sql-server-transact-sql.md)   
 [DATABASEPROPERTYEX (Transact-SQL)](../../t-sql/functions/databasepropertyex-transact-sql.md)   
 [sys.databases (Transact-SQL)](../../relational-databases/system-catalog-views/sys-databases-transact-sql.md)   
 [sys.database_files (Transact-SQL)](../../relational-databases/system-catalog-views/sys-database-files-transact-sql.md)  
  
  

