---
title: "Инструкция DBCC SHRINKDATABASE (Transact-SQL) | Документы Microsoft"
ms.custom: 
ms.date: 07/17/2017
ms.prod: sql-non-specified
ms.prod_service: database-engine, sql-database
ms.service: 
ms.component: t-sql|database-console-commands
ms.reviewer: 
ms.suite: sql
ms.technology:
- database-engine
ms.tgt_pltfrm: 
ms.topic: language-reference
f1_keywords:
- DBCC_SHRINKDATABASE_TSQL
- DBCC SHRINKDATABASE
- SHRINKDATABASE_TSQL
- SHRINKDATABASE
dev_langs:
- TSQL
helpviewer_keywords:
- data shrinking [SQL Server]
- shrinking files
- shrinking databases
- DBCC SHRINKDATABASE statement
- decreasing database size
- file shrinking [SQL Server]
- database shrinking [SQL Server]
- logs [SQL Server], shrinking
- reducing database size
ms.assetid: fc976afd-1edb-4341-bf41-c4a42a69772b
caps.latest.revision: 62
author: JennieHubbard
ms.author: jhubbard
manager: jhubbard
ms.workload: Active
ms.translationtype: MT
ms.sourcegitcommit: 876522142756bca05416a1afff3cf10467f4c7f1
ms.openlocfilehash: c7f6e9fa3feea20bfeb82037cb9358370c67aaa0
ms.contentlocale: ru-ru
ms.lasthandoff: 09/01/2017

---
# <a name="dbcc-shrinkdatabase-transact-sql"></a>DBCC SHRINKDATABASE (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2008-asdb-xxxx-xxx-md](../../includes/tsql-appliesto-ss2008-asdb-xxxx-xxx-md.md)]

Сокращает размер файлов данных и файлов журнала в указанной базе данных.
  
![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)
  
## <a name="syntax"></a>Синтаксис  
  
```sql
DBCC SHRINKDATABASE   
( database_name | database_id | 0   
     [ , target_percent ]   
     [ , { NOTRUNCATE | TRUNCATEONLY } ]   
)  
[ WITH NO_INFOMSGS ]  
```  
  
## <a name="arguments"></a>Аргументы  
 *database_name* | *database_id* | 0  
 Имя или идентификатор базы данных, которая должна быть сжата. Если указано значение 0, используется текущая база данных.  
  
 *target_percent*  
 Процент свободного пространства, которое должно остаться в базе данных после сжатия.  
  
 NOTRUNCATE  
 Сжимает данные в файлах с помощью перемещения распределенных страниц из конца файла на место нераспределенных страниц в начале файла. *target_percent* является необязательным.  
  
 Свободное место в конце файла операционной системе не возвращается, и физический размер файла не изменяется. Следовательно, если указан аргумент NOTRUNCATE, сжатие файлов данных незначительно.  
  
 Аргумент NOTRUNCATE применим только к файлам данных. Файл журнала не затрагивается.  
  
 TRUNCATEONLY  
 Освобождает все свободное пространство в конце файла операционной системе, но не перемещает страницы внутри файла. Файл данных сокращается только до последнего выделенного экстента. *target_percent* учитывается, если указан аргумент TRUNCATEONLY.  
  
 Аргумент TRUNCATEONLY оказывает влияние на файл журнала. Для усечения только файла данных используйте инструкцию DBCC SHRINKFILE.  
  
 WITH NO_INFOMSGS  
 Подавляет все информационные сообщения со степенями серьезности от 0 до 10.  
  
## <a name="result-sets"></a>Результирующие наборы  
В следующей таблице отображены столбцы результирующего набора.
  
|Имя столбца|Description|  
|-----------------|-----------------|  
|**DbId**|Идентификатор базы данных, файл которой компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] пытался сжать.|  
|**Идентификатор файла**|Идентификатор файла, который компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] пытался сжать.|  
|**CurrentSize**|Количество 8-килобайтных страниц, занятых файлом в настоящее время.|  
|**Минимальный размер**|Минимальное количество 8-килобайтных страниц, которое может занимать файл. Оно соответствует минимальному размеру или размеру файла, указанному при создании.|  
|**UsedPages**|Количество 8-килобайтных страниц, используемых файлом в настоящее время.|  
|**EstimatedPages**|Количество 8-килобайтных страниц, до которого можно было бы сжать файл по оценке компонента [!INCLUDE[ssDE](../../includes/ssde-md.md)].|  
  
>[!NOTE]
> Компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] не отображает строки для файлов, размер которых не был сокращен.  
  
## <a name="remarks"></a>Замечания  
Чтобы сжать все файлы данных и журналов указанной базы данных, выполните команду DBCC SHRINKDATABASE. Чтобы сжать один данных или файл журнала во время для конкретной базы данных, выполните [DBCC SHRINKFILE](../../t-sql/database-console-commands/dbcc-shrinkfile-transact-sql.md) команды.
  
Чтобы просмотреть текущий объем свободного (нераспределенного) пространства в базе данных, запустите [sp_spaceused](../../relational-databases/system-stored-procedures/sp-spaceused-transact-sql.md).
  
Операции DBCC SHRINKDATABASE могут быть остановлены на любом этапе процесса, при этом вся выполненная работа сохраняется.
  
Размер базы данных нельзя сделать меньше минимального размера базы данных. Минимальный размер — это размер, указанный при создании базы данных, или последний размер, явно установленный операцией изменения размера файла, такой как DBCC SHRINKFILE или ALTER DATABASE. Например, если база данных была создана с размером 10 МБ и потом увеличилась до 100 МБ, ее можно сжать только до 10 МБ, даже если все данные удалены из базы данных.
  
Выполнение операции DBCC SHRINKDATABASE без указания параметра NOTRUNCATE или TRUNCATEONLY равносильно выполнению операции DBCC SHRINKDATABASE с параметром NOTRUNCATE после выполнения операции DBCC SHRINKDATABASE с параметром TRUNCATEONLY.
  
Сжимаемая база данных не должна находиться в однопользовательском режиме. Другие пользователи могут работать с базой данных при ее сжатии. Это касается системных баз данных.
  
Невозможно сжать базу данных во время создания ее резервной копии. И наоборот, нельзя создать резервную копию базы данных во время операции сжатия.
  
## <a name="how-dbcc-shrinkdatabase-works"></a>Работа команды DBCC SHRINKDATABASE  
Инструкция DBCC SHRINKDATABASE сжимает файлы данных по одному, а файлы журнала так, как будто все они представляют один непрерывный пул журнала. Сжатие файлов всегда ведется с конца.
  
Предположим, база данных, с именем **mydb** с файлом данных и два файла журнала. Файлы данных и журнала 10 МБ и файл данных содержит 6 МБ данных.
  
Компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] вычисляет целевой размер каждого файла. Это размер, до которого файл данных должен быть сжат. Если инструкция DBCC SHRINKDATABASE указана с *target_percent*, [!INCLUDE[ssDE](../../includes/ssde-md.md)] вычисляет целевой размер должен быть *target_percent* объем свободного пространства в файле после сжатия. Например, при указании *target_percent* 25 для сжатия **mydb**, [!INCLUDE[ssDE](../../includes/ssde-md.md)] рассчитает целевой размер для файла данных в 8 МБ (6 МБ данных и 2 МБ свободного пространства). Таким образом [!INCLUDE[ssDE](../../includes/ssde-md.md)] перемещает все данные из последних 2 МБ файла данных в любое свободное пространство в первых 8 МБ файла данных, а затем сжимает файл.
  
Предположим, в файл данных **mydb** содержит 7 МБ данных. Указание *target_percent* со значением 30 допускается для этого файла данных для освобождения 30 процентов. Однако указание *target_percent* 40 не сжать файл данных, так как [!INCLUDE[ssDE](../../includes/ssde-md.md)] не будет сжать файл до размера, меньшего, чем занимают данные сейчас. Можно также представить этой проблемы другой способ: 40 процентов желаемого свободного пространства + 70 процентов от полного файла данных (7 МБ из 10 МБ) более чем 100 процентов. Так как свободного процент, который нужен, а также текущего процента, занимаемого файлом данных более чем на 100 процентов (на 10 процентов), любое *target_size* больше 30 не приведет к сжатию файла данных.
  
Для файлов журнала [!INCLUDE[ssDE](../../includes/ssde-md.md)] использует *target_percent* для вычисления целевого размера всего журнала; таким образом, *target_percent* — это объем свободного пространства в журнале после операции сжатия. Целевой размер всего журнала затем пересчитывается в целевой размер каждого файла журнала.
  
Инструкция DBCC SHRINKDATABASE пытается немедленно сжать каждый физический файл журнала до его целевого размера. Если ни одна часть логического журнала не размещается в виртуальных файлах журнала, размер которых превосходит целевой размер файла журнала, то файл будет успешно усечен и инструкция DBCC SHRINKDATABASE завершится без каких-либо сообщений. Однако если часть логического журнала хранится в виртуальных журналах за пределами заданного размера, то компонент [!INCLUDE[ssDE](../../includes/ssde-md.md)] освобождает как можно больше места, а затем формирует информационное сообщение. Сообщение описывает действия, которые необходимо предпринять, чтобы переместить логический журнал из виртуальных журналов в конец файла. После выполнения всех действий инструкция DBCC SHRINKDATABASE может быть использована для освобождения оставшегося пространства.
  
Так как файл журнала может быть сжат только до границы виртуального файла журнала, сжатие файла журнала к размеру, меньшему, чем размер виртуального файла журнала, невозможно, даже если он не используется. Размер виртуального файла журнала динамически выбирается компонентом [!INCLUDE[ssDE](../../includes/ssde-md.md)] при создании или расширении файлов журнала.
  
## <a name="best-practices"></a>Рекомендации  
Обратите внимание на следующие сведения при планировании сжатия базы данных.
-   Наибольший эффект от операции сжатия достигается при ее применении после операции, создающей много неиспользуемого пространства, например после усечения таблицы или удаления таблицы.  
-   Большинству баз данных требуется некоторое свободное пространство для выполнения обычных ежедневных операций. Если сжатие базы данных производится регулярно, но она снова увеличивается в размерах, это означает, что место, освобожденное при сжатии, необходимо для нормальной работы. В таких случаях повторное сжатие базы данных бессмысленно.  
-   Операция сжатия не избавляет от фрагментации индексов в базе данных и обычно приводит к еще более сильной фрагментации. Это еще одна причина, по которой не стоит выполнять регулярное сжатие базы данных.  
-   Не следует устанавливать параметр базы данных AUTO_SHRINK в значение ON без достаточных на то оснований.  
  
## <a name="troubleshooting"></a>Устранение неполадок  
 Существует возможность сжатия операции могут быть блокированы транзакцией, которая выполняется под [уровень изоляции, основанном на управлении версиями строк](../../t-sql/statements/set-transaction-isolation-level-transact-sql.md). Например, если при выполнении масштабной операции удаления с уровнем изоляции, основанном на управлении версиями строк, выполнить инструкцию DBCC SHRINK DATABASE, то, прежде чем приступить к сжатию файлов, она будет ожидать завершения операции удаления. В этом случае операции DBCC SHRINKFILE и DBCC SHRINKDATABASE выводят информационное сообщение (5202 для SHRINKDATABASE и 5203 для SHRINKFILE) в журнале ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] каждые 5 минут в течение первого часа, а затем по одному сообщению каждый час. Например, журнал ошибок содержит следующее сообщение об ошибке:  
  
```sql
DBCC SHRINKDATABASE for database ID 9 is waiting for the snapshot   
transaction with timestamp 15 and other snapshot transactions linked to   
timestamp 15 or with timestamps older than 109 to finish.  
```  
  
Это означает, что операция сжатия блокируется транзакциями моментального снимка, которые имеют отметки времени старше, чем метка 109, представляющая последнюю транзакцию, завершающую операцию сжатия. Также показывает, что **transaction_sequence_num**, или **first_snapshot_sequence_num** столбцы в [sys.dm_tran_active_snapshot_database_transactions &#40; Transact-SQL &#41; ](../../relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql.md) динамическое административное представление содержит значение 15. Если параметр **transaction_sequence_num**, или **first_snapshot_sequence_num** столбцы в представлении содержат число, которое меньше, чем последняя транзакция, выполненная операцией сжатия (109), Сжатие операция будет ждать завершения этих транзакций.
  
Разрешить эту проблему можно одним из следующих способов.
-   Прервите выполнение транзакции, блокирующей операцию сжатия.  
-   Прервите операцию сжатия. Вся завершенная работа будет сохранена.  
-   Пока операция сжатия ожидает завершения блокирующей транзакции, ничего делать не нужно.  
  
## <a name="permissions"></a>Permissions  
 Необходимо быть членом предопределенной роли сервера **sysadmin** или предопределенной роли базы данных **db_owner** .  
  
## <a name="examples"></a>Примеры  
  
### <a name="a-shrinking-a-database-and-specifying-a-percentage-of-free-space"></a>A. Сжатие базы данных и определение количества свободного пространства в процентах  
 В следующем примере уменьшается размер файлов данных и журнала в пользовательской базе данных `UserDB` с целью освободить 10 процентов свободного пространства в базе данных.  
  
```sql  
DBCC SHRINKDATABASE (UserDB, 10);  
GO  
```  
  
### <a name="b-truncating-a-database"></a>Б. Усечение базы данных  
 В следующем примере файлы данных и журнала в образце базы данных `AdventureWorks` сжимаются до последнего выделенного экстента.  
  
```sql  
DBCC SHRINKDATABASE (AdventureWorks2012, TRUNCATEONLY);  
```  
  
## <a name="see-also"></a>См. также:  
[ALTER DATABASE (Transact-SQL)](../../t-sql/statements/alter-database-transact-sql.md)  
[DBCC (Transact-SQL)](../../t-sql/database-console-commands/dbcc-transact-sql.md)  
[DBCC SHRINKFILE (Transact-SQL)](../../t-sql/database-console-commands/dbcc-shrinkfile-transact-sql.md)  
[Сжатие базы данных](../../relational-databases/databases/shrink-a-database.md)
  
  

