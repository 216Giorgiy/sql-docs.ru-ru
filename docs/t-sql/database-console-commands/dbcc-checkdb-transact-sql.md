---
title: "Инструкция DBCC CHECKDB (Transact-SQL) | Документы Microsoft"
ms.custom: 
ms.date: 09/21/2016
ms.prod: sql-non-specified
ms.prod_service: database-engine, sql-database
ms.service: 
ms.component: t-sql|database-console-commands
ms.reviewer: 
ms.suite: sql
ms.technology:
- database-engine
ms.tgt_pltfrm: 
ms.topic: language-reference
f1_keywords:
- CHECKDB_TSQL
- DBCC_CHECKDB_TSQL
- DBCC CHECKDB
- CHECKDB
dev_langs:
- TSQL
helpviewer_keywords:
- CHECKDB [DBCC statement]
- database objects [SQL Server], checking
- counting pages
- per-index row counts
- per-table row counts
- DBCC CHECKDB statement
- per-table page counts
- allocation checks
- integrity [SQL Server], database objects
- per-index page counts
- counting rows
- table integrity checks [SQL Server]
- row count accuracy [SQL Server]
- negative counts
- checking database objects
- page count accuracy [SQL Server]
ms.assetid: 2c506167-0b69-49f7-9282-241e411910df
caps.latest.revision: 144
author: JennieHubbard
ms.author: jhubbard
manager: jhubbard
ms.workload: Active
ms.translationtype: MT
ms.sourcegitcommit: 876522142756bca05416a1afff3cf10467f4c7f1
ms.openlocfilehash: 0960e000c4ba1d798228445720e39db0f627f9b1
ms.contentlocale: ru-ru
ms.lasthandoff: 09/01/2017

---
# <a name="dbcc-checkdb-transact-sql"></a>DBCC CHECKDB (Transact-SQL)
[!INCLUDE[tsql-appliesto-ss2012-asdb-xxxx-xxx-md](../../includes/tsql-appliesto-ss2012-asdb-xxxx-xxx-md.md)]

  Проверяет логическую и физическую целостность всех объектов в указанной базе данных путем выполнения следующих операций.    
    
> **Примечание:** инструкции DBCC CHECKDB поддерживается для баз данных, которые содержат оптимизированные для памяти таблицы, но проверка происходит только для таблиц на диске. Однако в процессе резервного копирования и восстановления базы данных проверка CHECKSUM выполняется и для файлов в группах, оптимизированных для памяти.    
>     
>  Так как варианты восстановления DBCC недоступны для таблиц, оптимизированных для памяти, необходимо регулярно создавать и проверять резервные копии баз данных. Если возникают проблемы целостности данных таблицы для памяти, необходимо восстановить ее из последней рабочей резервной копии.    
    
-   Выполняется [DBCC CHECKALLOC](../../t-sql/database-console-commands/dbcc-checkalloc-transact-sql.md) в базе данных.    
    
-   Выполняется [DBCC CHECKTABLE](../../t-sql/database-console-commands/dbcc-checktable-transact-sql.md) для каждой таблицы и представления из базы данных.    
    
-   Выполняется [DBCC CHECKCATALOG](../../t-sql/database-console-commands/dbcc-checkcatalog-transact-sql.md) в базе данных.    
    
-   Проверка содержимого каждого индексированного представления в базе данных.    
    
-   Проверяет согласованность между таблицы метаданных и файл системным папкам и файлам на уровне ссылок при хранении **varbinary(max)** данные в файловой системе, с помощью FILESTREAM.    
    
-   Проверка данных компонента [!INCLUDE[ssSB](../../includes/sssb-md.md)] в базе данных.    
    
 Из этого следует, что не требуется дополнительно вызывать инструкции DBCC CHECKALLOC, DBCC CHECKTABLE и DBCC CHECKCATALOG при использовании инструкции DBCC CHECKDB. Дополнительные сведения о проверках, выполняемых этими командами, см. в описании данных команд.    
    
 ![Значок ссылки на раздел](../../database-engine/configure-windows/media/topic-link.gif "Значок ссылки на раздел") [Синтаксические обозначения в Transact-SQL](../../t-sql/language-elements/transact-sql-syntax-conventions-transact-sql.md)    
    
## <a name="syntax"></a>Синтаксис    
    
```    
    
DBCC CHECKDB     
    [ ( database_name | database_id | 0    
        [ , NOINDEX     
        | , { REPAIR_ALLOW_DATA_LOSS | REPAIR_FAST | REPAIR_REBUILD } ]    
    ) ]    
    [ WITH     
        {    
            [ ALL_ERRORMSGS ]    
            [ , EXTENDED_LOGICAL_CHECKS ]     
            [ , NO_INFOMSGS ]    
            [ , TABLOCK ]    
            [ , ESTIMATEONLY ]    
            [ , { PHYSICAL_ONLY | DATA_PURITY } ]    
            [ , MAXDOP  = number_of_processors ]    
        }    
    ]    
]    
```    
    
## <a name="arguments"></a>Аргументы    
 *database_name* | *database_id* | 0  
 Имя или идентификатор базы данных, для которой необходимо выполнить проверку целостности. Если значение не указано или указано значение 0, используется текущая база данных. Имена баз данных должны соответствовать правилам для [идентификаторы](../../relational-databases/databases/database-identifiers.md).  
    
 NOINDEX  
 Указывает, что тщательную проверку некластеризованных индексов для пользовательских таблиц выполнять не следует. Это уменьшает общее время выполнения. Аргумент NOINDEX не влияет на обработку системных таблиц, поскольку для индексов системных таблиц всегда выполняются проверки целостности.  
    
 REPAIR_ALLOW_DATA_LOSS | REPAIR_FAST | REPAIR_REBUILD  
 Указывает, что инструкция DBCC CHECKDB должна исправить обнаруженные ошибки. Используйте аргументы REPAIR только как последнее средство. Для применения описанных ниже параметров исправления указанная база данных   должна находиться в однопользовательском режиме.  
    
 REPAIR_ALLOW_DATA_LOSS  
 Пытается устранить все обнаруженные ошибки. Эти исправления могут привести к частичной потере данных.  
    
> [!WARNING]
> - Параметр REPAIR_ALLOW_DATA_LOSS является поддерживаемой функцией, но он не всегда может быть лучшим вариантом для приведения базы данных в физически согласованное состояние. 
> -В случае успешного выполнения параметром REPAIR_ALLOW_DATA_LOSS может привести к потере некоторых данных. Более того, объем утраченных данных может быть большим, чем при восстановлении базы данных из последней проверенной рабочей резервной копии данных. 
>
> - [!INCLUDE[msCoName](../../includes/msconame-md.md)] всегда рекомендует восстановление пользователем из последней проверенной рабочей резервной копии данных в качестве основного метода для восстановления после ошибок DBCC CHECKDB. Параметр REPAIR_ALLOW_DATA_LOSS не является альтернативой восстановлению из проверенной рабочей резервной копии. Это последнее средство, которое следует использовать лишь тогда, когда восстановление из резервной копии невозможно.    
>     
>  - Некоторые ошибки, которые можно исправить только с использованием параметра REPAIR_ALLOW_DATA_LOSS, могут включать освобождение строк, страниц или набора страниц, чтобы очистить ошибки. Освобожденные данные больше не являются доступными или восстановимыми для пользователя, точное содержимое освобожденных данных нельзя определить. Таким образом, целостность данных может быть нарушена после освобождения любых строк или страниц, поскольку ограничения внешнего ключа не проверяются и не поддерживаются в этой операции восстановления. Пользователь должен проверить целостность базы данных (с помощью инструкции DBCC CHECKCONSTRAINTS) после использования REPAIR_ALLOW_DATA_LOSS.    
>     
>  - Перед восстановлением создайте физические копии файлов, принадлежащих к этой базе данных. Сюда входят первичный файл данных (.mdf), любые вторичные файлы данных (.ndf), все файлы журнала транзакций (.ldf) и другие контейнеры, которые формируют базу данных, в том числе полнотекстовые каталоги, папки потока файлов, оптимизированные для памяти данные и т. д.    
>     
>  - Перед восстановлением можно изменить состояние базы данных на EMERGENCY, попытаться извлечь как можно больше информации из важных таблиц и сохранить эти данные.    
    
 REPAIR_FAST  
 Синтаксис поддерживается только для обеспечения обратной совместимости. Действия по восстановлению не выполняются.  
    
 REPAIR_REBUILD  
 Выполняет действия по восстановлению данных, которые можно выполнить без риска их потери. Это может быть быстрое восстановление (например, восстановление отсутствующих строк в некластеризованных индексах) или более ресурсоемкие операции (например, перестроение индекса).  
 Этот аргумент не исправляет ошибки, связанные с данными FILESTREAM.  
    
> [!IMPORTANT] 
> Поскольку операции DBCC CHECKDB с любыми параметрами REPAIR полностью заносятся в журнал и поддерживают восстановление, [!INCLUDE[msCoName](../../includes/msconame-md.md)] всегда рекомендует пользователям использовать CHECKDB с любыми параметрами REPAIR в рамках транзакции (выполните BEGIN TRANSACTION перед запуском команды), чтобы можно было подтвердить, принимать ли результаты операции. Затем пользователь может выполнить инструкцию COMMIT TRANSACTION для фиксации всей работы, выполненной операцией восстановления. Если пользователь не принимает результаты этой операции, он может выполнить операцию ROLLBACK TRANSACTION, чтобы отменить результаты восстановления.    
>     
>  Для устранения ошибок рекомендуется восстановление из резервной копии. Операции восстановления не учитывают никакие ограничения, которые могут существовать для таблиц или между таблицами. Если указанная таблица включена в одно или несколько ограничений, рекомендуется выполнить инструкцию DBCC CHECKCONSTRAINTS после операции восстановления. Если необходимо использовать аргументы REPAIR, выполните инструкцию DBCC CHECKDB без параметра восстановления, чтобы узнать требуемый уровень восстановления. При использовании уровня REPAIR_ALLOW_DATA_LOSS, рекомендуется создать резервную копию базы данных перед выполнением инструкции DBCC CHECKDB с этим параметром.    
    
 ALL_ERRORMSGS  
 Отображает все сформированные для объекта ошибки. Все сообщения об ошибках выводятся по умолчанию. Указание или пропуск этого параметра не приводит к изменениям. Сообщения об ошибках сортируются по Идентификатору объекта, за исключением сообщений, формируемых [базы данных tempdb](../../relational-databases/databases/tempdb-database.md).  
    
> [!NOTE] 
> В среде [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] максимальное число возвращаемых сообщений об ошибках равно 1000. Если указан параметр ALL_ERRORMSGS, мы рекомендуем, выполните команду DBCC с помощью [программы sqlcmd](../../tools/sqlcmd-utility.md) или с помощью планирования [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] задание агента для выполнения команды и направляют выходные данные в файл. Использование любого из этих методов обеспечит однократное выполнение команды и включение в отчет всех сообщений об ошибках.    

 EXTENDED_LOGICAL_CHECKS  
 При уровне совместимости 100 ([!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]) и выше выполняются проверки логической согласованности индексированных представлений, XML-индексов и пространственных индексов, если они есть.  
 Дополнительные сведения см. в части «Выполнение логических проверок согласованности индексов» подраздела «Замечания» далее в этом разделе.  
    
 NO_INFOMSGS  
 Подавляет вывод всех информационных сообщений.  
    
 TABLOCK  
 Указание значения аргумента приводит к получению инструкцией DBCC CHECKDB блокировок вместо использования внутреннего моментального снимка базы данных. Это включает краткосрочное использование монопольной блокировки (X) на базу данных. Аргумент TABLOCK позволит инструкции DBCC CHECKDB быстрее выполняться на базе данных, находящейся под интенсивной нагрузкой, однако уменьшит возможности одновременной работы пользователей с базой данных во время выполнения инструкции DBCC CHECKDB.  
    
> [!IMPORTANT] 
> Аргумент TABLOCK ограничивает выполняемые проверки; инструкция DBCC CHECKCATALOG не выполняется в базе данных, а данные компонента [!INCLUDE[ssSB](../../includes/sssb-md.md)] останутся непроверенными.
    
 ESTIMATEONLY  
 Отображает предполагаемый размер базы данных tempdb места, необходимого для выполнения инструкции DBCC CHECKDB со всех указанных параметров. Сама проверка базы данных не выполняется.  
    
 PHYSICAL_ONLY  
 Ограничивает проверку лишь проверкой целостности физической структуры страниц и заголовков записей и целостности выделения пространства в базе данных. Эта проверка служит для выполнения проверки физической согласованности базы данных с низкими накладными расходами на выполнение. Она может обнаруживать обрывы страниц, ошибки контрольной суммы и типичные сбои оборудования, которые могут привести к повреждению пользовательских данных.  
 Полное выполнение инструкции DBCC CHECKTABLE может занять значительно больше времени, чем в предыдущих версиях. Это происходит по следующим причинам.  
 -   Логические проверки стали более сложными.  
 -   Усложнился ряд базовых структур, нуждающихся в проверке.  
 -   Добавлено много новых проверок для поддержки новых функций.  
 Иными словами, указание параметра PHYSICAL_ONLY может существенно снизить время выполнения инструкции DBCC CHECHECKDB для больших баз данных, поэтому рекомендуется для частого использования на рабочих системах. Также рекомендуется периодически производить полный запуск инструкции DBCC CHECKDB. Периодичность запуска зависит от факторов, индивидуальных для каждого предприятия и каждой производственной среды.    
Этот argment всегда подразумевает NO_INFOMSGS и не указываться вместе с параметрами исправления.  
    
> [!WARNING] 
> Указание параметра PHYSICAL_ONLY приводит к пропуску инструкцией DBCC CHECKDB всех проверок данных FILESTREAM.
    
 DATA_PURITY  
 Указание значения аргумента приводит к выполнению инструкцией DBCC CHECKDB проверки базы данных на недействительность или выход из допустимого диапазона значений столбцов. Например, инструкция DBCC CHECKDB обнаруживает столбцы со значениями даты и времени, размер которого больше или меньше допустимого диапазона для **datetime** тип данных; или **десятичное** или приблизительных числовых данных столбцы со значениями масштаба или точности, которые являются недопустимыми.  
 Проверки целостности значений столбцов включены по умолчанию, и для них не требуется указывать параметр DATA_PURITY. Для баз данных, обновленных с предыдущих версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], проверка значений данных в столбцах по умолчанию не будет включена, пока на базе данных не будет выполнена без ошибок инструкция DBCC CHECKDB с параметром DATA_PURITY. После этого инструкция DBCC CHECKDB проверяет целостность данных в столбцах по умолчанию. Дополнительные сведения о том, как на выполнение инструкции CHECKDB влияет использование баз данных, обновленных из предыдущих версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], см. в подразделе «Замечания» далее в этом разделе.  
    
> [!WARNING]
> Если указан аргумент PHYSICAL_ONLY, проверка целостности значений в столбцах не выполняется.
    
 Ошибки проверки, передаваемые при наличии этого параметра, не могут быть устранены с помощью параметров восстановления DBCC. Сведения об устранении этих ошибок вручную см. в статье базы знаний 923247: [ошибки 2570 инструкции DBCC, устранение неполадок в SQL Server 2005 и более поздних версиях](http://support.microsoft.com/kb/923247).  
    
 MAXDOP  
 **Применяется к**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] SP2 через [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].  
    
 Переопределяет **максимальная степень параллелизма** параметр конфигурации **sp_configure** для инструкции. MAXDOP может превысить значение, настроенное с помощью хранимой процедуры sp_configure. Если MAXDOP превышает значение, настроенное с помощью регулятора ресурсов [!INCLUDE[ssDEnoversion](../../includes/ssDEnoversion_md.md)] использует значение MAXDOP регулятора ресурсов, описанное в [ALTER WORKLOAD GROUP](../../t-sql/statements/alter-workload-group-transact-sql.md). Все семантические правила, используемые параметром конфигурации max degree of parallelism, применимы при использовании указания запроса MAXDOP. Дополнительные сведения см. в разделе [Configure the max degree of parallelism Server Configuration Option](../../database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option.md).  
 
> [!WARNING] 
> Если MAXDOP равно нулю, то SQL Server выбирает максимальную степень параллельности для использования.    

## <a name="remarks"></a>Замечания    
Инструкция DBCC CHECKDB не анализирует отключенные индексы. Дополнительные сведения об отключенных индексах см. в разделе [отключение индексов и ограничений](../../relational-databases/indexes/disable-indexes-and-constraints.md).
Если определяемый пользователем тип помечен как упорядоченный по байтам, должна быть выполнена только одна сериализация определяемого пользователем типа. Невыполнение согласованной сериализации побайтно упорядоченных типов, определяемых пользователем, приведет к возникновению ошибки 2537 при запуске инструкции DBCC CHECKDB. Дополнительные сведения см. в разделе [требования определяемого пользователем типа](../../relational-databases/clr-integration-database-objects-user-defined-types/creating-user-defined-types-requirements.md).
Поскольку [базы данных Resource](../../relational-databases/databases/resource-database.md) только в однопользовательском режиме, инструкция DBCC CHECKDB, команда не может быть запущена на нем, напрямую или нет. Тем не менее, при выполнении инструкции DBCC CHECKDB к [базы данных master](../../relational-databases/databases/master-database.md), второй CHECKDB также выполняется внутри в базе данных ресурсов. Поэтому инструкция DBCC CHECKDB может вернуть дополнительные результаты. Эта команда возвратит дополнительные результирующие наборы, если не указано параметров или указан один из параметров PHYSICAL_ONLY или ESTIMATEONLY.
В версиях [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] без пакета обновления 2 (SP2) выполнение команды DBCC CHECKDB очищает кэш планов для экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Очистка кэша планов становится причиной перекомпиляции всех последующих планов выполнения и может приводить к непредвиденному временному снижению производительности обработки запросов. В версии с пакетом обновления 2 (SP2) и более поздних выполнение инструкции DBCC CHECKDB не очищает кэш планов.
    
## <a name="performing-logical-consistency-checks-on-indexes"></a>Выполнение проверок логической целостности индексов    
Процедура проверки логической целостности индексов зависит от уровня совместимости базы данных следующим образом.
-   При уровне совместимости 100 ([!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)]) и выше.    
-   Если не указан параметр NOINDEX, инструкция DBCC CHECKDB выполняет как физические, так и логические проверки целостности отдельной таблицы и всех ее некластеризованных индексов. Однако в XML-индексах, пространственных индексах и индексированных представлениях по умолчанию выполняются только проверки физической целостности.
-   Если указан параметр WITH EXTENDED_LOGICAL_CHECKS, выполняются логические проверки в индексированных представлениях, XML-индексах и пространственных индексах (при их наличии). По умолчанию проверки физической согласованности выполняются раньше, чем проверки логической согласованности. Если также указан параметр NOINDEX, выполняются только проверки логической согласованности.
    
Они проверяют согласованность внутренней таблицы индексов или объекта индекса с пользовательской таблицей, на которую он указывает. Для поиска выбросов создается внутренний запрос, выполняющий полную проверку пересечения внутренних и пользовательских таблиц. Выполнение этого запроса может крайне отрицательно сказаться на производительности, а ход его выполнения невозможно отследить. Поэтому рекомендуется указывать параметр WITH EXTENDED_LOGICAL_CHECKS только в тех случаях, когда возможно возникновение проблем с индексированием, не связанных с физическими повреждениями, или при неверных контрольных суммах на уровне страниц, или же при подозрении на повреждение оборудования на уровне столбцов.
-   Если это отфильтрованный индекс, инструкция DBCC CHECKDB выполняет проверку целостности, чтобы убедиться, что записи индекса удовлетворяют условию предиката фильтра.
-   Если уровень совместимости меньше либо равен 90 и не указан параметр NOINDEX, инструкция DBCC CHECKDB выполняет как физические, так и логические проверки целостности отдельной таблицы или индексированного представления и всех его некластеризованных и XML-индексов. Пространственные индексы не поддерживаются.  
- Начиная с SQL Server 2016, дополнительные проверки на материализованные вычисляемые столбцы, столбцы определяемого пользователем ТИПА и Фильтруемые индексы не будет выполняться по умолчанию, чтобы избежать ресурсоемких выражение вычисления. Это изменение значительно сокращает время CHECKDB для базы данных, содержащие эти объекты. Однако всегда выполняется проверки физической согласованности этих объектов. Только в том случае, если указан параметр EXTENDED_LOGICAL_CHECKS вычисления выражений выполняются в дополнение к уже присутствует логические проверки (индексированного представления, XML-индексов и пространственных индексах) как часть параметра EXTENDED_LOGICAL_CHECKS.   
    
**Чтобы узнать, уровень совместимости базы данных**
-   [Просмотр или изменение уровня совместимости базы данных](../../relational-databases/databases/view-or-change-the-compatibility-level-of-a-database.md)    
    
## <a name="internal-database-snapshot"></a>Моментальный снимок внутренней базы данных    
Инструкция DBCC CHECKDB использует внутренний моментальный снимок базы данных для обеспечения согласованности транзакций, необходимой для выполнения данных проверок. Тем самым предотвращаются проблемы блокировки и параллелизма при выполнении этих команд. Дополнительные сведения см. в разделе [Просмотр размера разреженного файла моментального снимка базы данных &#40; Transact-SQL &#41; ](../../relational-databases/databases/view-the-size-of-the-sparse-file-of-a-database-snapshot-transact-sql.md) и раздел об использовании моментальный снимок внутренней базы данных DBCC в [DBCC &#40; Transact-SQL &#41; ](../../t-sql/database-console-commands/dbcc-transact-sql.md). При невозможности создать моментальный снимок или при указании аргумента TABLOCK инструкция DBCC CHECKDB получает блокировки для обеспечения требуемой согласованности данных. В таком случае для проверки выделенных ресурсов необходима монопольная блокировка базы данных, а для проверки таблиц — разделяемая блокировка таблицы.
DBCC CHECKDB завершается со сбоем при запуске для образца, если не удается создать моментальный снимок внутренней базы данных.
Выполнение инструкции DBCC CHECKDB для базы данных tempdb не выполняет проверок выделения и проверок каталогов и необходимо получить совмещаемую блокировку таблицы для выполнения проверки таблиц. Это обусловлено тем, что по соображениям, связанным с производительностью, моментальные снимки базы данных недоступны для базы данных tempdb. Это означает, что нельзя достичь требуемой согласованности транзакций.
В Microsoft SQL Server 2012 или более ранней версии SQL Server могут появиться сообщения об ошибках при выполнении команды DBCC CHECKDB для базы данных, файлы на томе ReFS формате. Дополнительные сведения см. в статье базы знаний 2974455: [инструкции DBCC CHECKDB поведение, если база данных SQL Server, находится в томе ReFS.](https://support.microsoft.com/kb/2974455)    
    
## <a name="checking-and-repairing-filestream-data"></a>Проверка и восстановление данных FILESTREAM    
При включении FILESTREAM для базы данных и таблицы, при необходимости можно сохранить **varbinary(max)** больших двоичных объектов (BLOB) в файловой системе. При использовании инструкции DBCC CHECKDB для базы данных, хранящей данные типа больших двоичных объектов в файловой системе, эта инструкция проверяет согласованность на уровне ссылок между файловой системой и базой данных.
Например, если таблица содержит **varbinary(max)** столбец, который использует атрибут FILESTREAM, инструкция DBCC CHECKDB будет проверять, что имеется взаимно-однозначное сопоставление между системные каталоги файлов и файлов и строк таблицы, столбцы и столбцов значения. Инструкция DBCC CHECKDB может исправить повреждения при указании параметра REPAIR_ALLOW_DATA_LOSS. При восстановлении повреждений FILESTREAM инструкция DBCC удаляет все строки таблиц, в которых отсутствуют данные файловой системы.
    
## <a name="best-practices"></a>Рекомендации    
При частом использовании на рабочих системах рекомендуется указывать параметр PHYSICAL_ONLY. Использование параметра PHYSICAL_ONLY может сильно сократить время выполнения инструкции DBCC CHECKDB для больших баз данных. Также рекомендуется периодически выполнять инструкцию DBCC CHECKDB без параметров. Насколько часто необходимо это делать, зависит от факторов, индивидуальных для каждого предприятия и каждой рабочей среды.
    
## <a name="checking-objects-in-parallel"></a>Проверка объектов в параллельном режиме    
По умолчанию инструкция DBCC CHECKDB выполняет параллельную проверку объектов. Степень параллелизма определяется автоматически обработчиком запросов. Максимальная степень параллелизма настраивается так же, как и в параллельных запросах. Чтобы ограничить максимальное количество процессоров, доступных для проверки DBCC, используется [sp_configure](../../relational-databases/system-stored-procedures/sp-configure-transact-sql.md). Дополнительные сведения см. в разделе [Configure the max degree of parallelism Server Configuration Option](../../database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option.md). Параллельную проверку можно отключить с помощью флага трассировки 2528. Дополнительные сведения см. в разделе [Флаги трассировки (Transact-SQL)](../../t-sql/database-console-commands/dbcc-traceon-trace-flags-transact-sql.md).
    
> [!NOTE]
> Эта функция поддерживается не во всех выпусках [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Дополнительные сведения см. в разделе Управление СУРБД проверка согласованности параллелизма [функции, поддерживаемые различными выпусками SQL Server 2016](~/sql-server/editions-and-supported-features-for-sql-server-2016.md).    
    
## <a name="understanding-dbcc-error-messages"></a>Основные сведения о сообщениях об ошибках DBCC    
После завершения выполнения команды DBCC CHECKDB в журнал ошибок [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] записывается сообщение. Если команда DBCC выполнена успешно, сообщение указывает на успешное завершение и содержит время, в течение которого выполнялась команда. Если команда DBCC была остановлена из-за ошибки до завершения проверки, сообщение указывает на прекращение выполнения команды и содержит значение состояния и время, в течение которого выполнялась команда. В следующей таблице перечислены и описаны значения состояний, которые могут быть включены в сообщение.
    
|Состояние|Description|    
|-----------|-----------------|    
|0|Возникла ошибка с номером 8930. Указывает на повреждение в метаданных, приведшее к завершению команды DBCC.|    
|1|Возникла ошибка с номером 8967. Внутренняя ошибка DBCC.|    
|2|При аварийном восстановлении базы данных произошла ошибка.|    
|3|Указывает на повреждение в метаданных, приведшее к завершению команды DBCC.|    
|4|Обнаружено нарушение доступа или утверждения.|    
|5|Возникла неизвестная ошибка, которая привела к прекращению выполнения команды DBCC.|    
    
## <a name="error-reporting"></a>Отчет об ошибках    
Файл дампа (SQLDUMP*nnnn*.txt) создается в [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] каталог ЖУРНАЛА всякий раз, когда инструкция DBCC CHECKDB обнаруживает ошибку повреждения. При включении сбора данных об использовании компонентов и отчета об ошибках для экземпляра [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], файл автоматически отправляется корпорации Майкрософт [!INCLUDE[msCoName](../../includes/msconame-md.md)]. Собранные данные используются для улучшения функциональности [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].
Файл дампа содержит результаты выполнения команды DBCC CHECKDB и дополнительные диагностические сведения. Доступ ограничен [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] учетная запись службы и члены роли sysadmin. По умолчанию роль sysadmin содержит всех членов группы Windows BUILTIN\Administrators и группы локальных администраторов. В случае ошибки процесса сбора данных команда DBCC не завершается ошибкой.
    
## <a name="resolving-errors"></a>Разрешение ошибок    
Если инструкция DBCC CHECKDB сообщает об ошибках, вместо выполнения REPAIR с каким-либо из параметров REPAIR рекомендуется восстановить базу данных из резервной копии. Если резервной копии базы данных не существует, выполнение параметра REPAIR приведет к исправлению обнаруженных ошибок. В конце списка ошибок указано, какой из параметров REPAIR следует использовать. Однако при исправлении ошибок с использованием параметра REPAIR_ALLOW_DATA_LOSS может потребоваться удаление некоторых страниц и некоторых данных.
При некоторых обстоятельствах в базу данных могут быть введены значения, недействительные или выходящие за допустимый диапазон значений типа данных столбца. Инструкция DBCC CHECKDB может обнаруживать значения в столбцах, недопустимые для типов данных столбцов. Поэтому выполнение инструкции DBCC CHECKDB с параметром DATA_PURITY для баз данных, обновленных с предыдущих версий [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], может обнаружить существовавшие ранее ошибки значений в столбцах. Поскольку [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] не может автоматически исправить эти ошибки, значения в столбцах необходимо обновить вручную. Если инструкция CHECKDB обнаруживает такую ошибку, она возвращает предупреждение, сообщение об ошибке 2570 и сведения, позволяющие найти вызвавшую ошибку строку и исправить ошибку вручную.
Это исправление может быть выполнено в пользовательской транзакции, позволяющей пользователю выполнить откат сделанных изменений. При выполнении отката исправлений база данных снова будет содержать ошибки и ее необходимо будет восстановить из резервной копии. После завершения исправлений создайте резервную копию базы данных.
    
## <a name="resolving-errors-in-database-emergency-mode"></a>Разрешение ошибок в аварийном режиме базы данных    
Если база данных переведена в аварийный режим с помощью [инструкции ALTER DATABASE](../../t-sql/statements/alter-database-transact-sql.md) инструкции DBCC CHECKDB может выполнять некоторые специальные действия по восстановлению базы данных, если указан параметр REPAIR_ALLOW_DATA_LOSS. Эти действия по восстановлению могут позволить перевести обычно невосстановимые базы данных в рабочий режим в физически согласованном состоянии. Эти действия должны использоваться только в исключительных случаях и только когда восстановление базы данных из резервной копии невозможно. Если база данных будет переведена в аварийный режим, база данных помечена как READ_ONLY, ведение журнала отключено и доступ ограничен членами фиксированной серверной роли sysadmin.
    
> [!NOTE]
> В аварийном режиме невозможно выполнить инструкцию DBCC CHECKDB в пользовательской транзакции и выполнить откат транзакции после выполнения.    
    
Когда база данных находится в аварийном режиме и выполняется инструкция DBCC CHECKDB с предложением REPAIR_ALLOW_DATA_LOSS, выполняются следующие действия.
-   Инструкция DBCC CHECKDB использует страницы, помеченные как недоступные, из-за ошибок ввода-вывода или ошибок проверки контрольной суммы, как если бы этих ошибок не было. В результате повышается возможность восстановления данных.    
-   Инструкция DBCC CHECKDB пытается восстановить базу данных, используя стандартные методы восстановления, основанные на журналах.    
-   Если восстановление базы данных заканчивается неуспешно из-за повреждения журнала транзакций, этот журнал будет перестроен. Перестроение журнала транзакций может приводить к потере согласованности транзакций.    
    
> [!WARNING]
> Параметр REPAIR_ALLOW_DATA_LOSS является поддерживаемой функцией [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]. Но это не всегда наилучший вариант для приведения базы данных в физически согласованное состояние. В случае успеха параметр REPAIR_ALLOW_DATA_LOSS может повлечь утрату некоторых данных. Более того, объем утраченных данных может быть большим, чем при восстановлении базы данных из последней проверенной рабочей резервной копии данных. [!INCLUDE[msCoName](../../includes/msconame-md.md)] всегда рекомендует восстановление пользователем из последней проверенной рабочей резервной копии данных в качестве основного метода для восстановления после ошибок DBCC CHECKDB. Параметр REPAIR_ALLOW_DATA_LOSS не является альтернативой восстановлению из проверенной рабочей резервной копии. Это последнее средство, которое следует использовать лишь тогда, когда восстановление из резервной копии невозможно.    
>     
>  После перестроения журнала не гарантируется полное соблюдение принципа ACID.    
>     
>  После перестроения журнала будет автоматически выполнена инструкция DBCC CHECKDB, будут устранены ошибки в отчетах и ошибки физической согласованности.    
>     
>  Согласованность логических данных и принудительные ограничения бизнес-логики необходимо проверить вручную.    
>     
>  Размер журнала транзакций останется заданным по умолчанию. Нужно будет вручную установить последний размер.    
    
Если инструкция DBCC CHECKDB выполнена успешно, значит, база данных находится в физически согласованном состоянии и переведена в режим ONLINE. Однако база данных может содержать одну или больше противоречивых транзакций. Рекомендуется запускать [DBCC CHECKCONSTRAINTS](../../t-sql/database-console-commands/dbcc-checkconstraints-transact-sql.md) для идентификации дефекты бизнес-логики и немедленно создать резервную копию базы данных.
Если выполнение инструкции DBCC CHECKDB завершилось неудачей, база данных не может быть восстановлена.
    
## <a name="running-dbcc-checkdb-with-repairallowdataloss-in-replicated-databases"></a>Выполнение инструкции DBCC CHECKDB с параметром REPAIR_ALLOW_DATA_LOSS для реплицируемых баз данных    
Выполнение инструкции DBCC CHECKDB с параметром REPAIR_ALLOW_DATA_LOSS может затронуть используемые репликацией пользовательские базы данных (базы данных подписок и публикаций) и базу данных распространителя. Базы данных подписки и публикации включают опубликованные таблицы и таблицы метаданных репликации. Учитывайте следующие возможные проблемы при работе с этими базами данных.
-   Опубликованные таблицы. Действия, выполненные процессом CHECKDB по восстановлению пользовательских данных, могут быть не реплицированы.    
-   При репликации слиянием используются триггеры, чтобы отследить изменения в опубликованных таблицах. Если процессом CHECKDB были вставлены, обновлены или удалены строки, триггеры не сработают; поэтому изменения не будут реплицированы.
-   При репликации транзакций используется журнал транзакций, чтобы отследить изменения в опубликованных таблицах. Затем агент чтения журнала перемещает эти изменения в базу данных распространителя. Некоторые операции восстановления DBCC не могут быть реплицированы агентом чтения журнала, несмотря на то, что журналируются. Например, если страница данных освобождена процессом CHECKDB, агент чтения журнала не преобразует это действие в инструкцию DELETE; поэтому изменение не будет реплицировано.
-   Таблицы метаданных репликации. Действия, выполняемые процессом CHECKDB по восстановлению поврежденных таблиц метаданных репликации, требуют удаления и повторной настройки репликации.    
    
Если инструкция DBCC CHECKDB запущена с параметром REPAIR_ALLOW_DATA_LOSS для базы данных пользователя или базы данных распространителя, выполните следующие действия.
1.  Приостановите систему: останавливать операции в базе данных и во всех остальных баз данных в топологии репликации и затем попытайтесь синхронизировать все узлы. Дополнительные сведения см. в разделе [Замораживание топологии репликации (программирование репликации на языке Transact-SQL)](../../relational-databases/replication/administration/quiesce-a-replication-topology-replication-transact-sql-programming.md).    
1.  Выполните инструкцию DBCC CHECKDB.    
1.  Если отчет инструкции DBCC CHECKDB включает действия по восстановлению каких-либо таблиц в базе данных распространителя или таблиц метаданных репликации в пользовательской базе данных, удалите и заново настройте репликацию. Дополнительные сведения см. в статье [Отключение публикации и распространения](../../relational-databases/replication/disable-publishing-and-distribution.md).    
1.  Если отчет инструкции DBCC CHECKDB включает действия по восстановлению каких-либо реплицируемых таблиц, выполните проверку данных, чтобы определить, имеются ли различия между данными в базах данных подписки и публикации.    
    
## <a name="result-sets"></a>Результирующие наборы    
Инструкция DBCC CHECKDB возвращает следующий результирующий набор. Значения могут различаться, кроме случаев, когда указаны параметры ESTIMATEONLY, PHYSICAL_ONLY или NO_INFOMSGS.
    
```sql
 DBCC results for 'model'.    
    
 Service Broker Msg 9675, Level 10, State 1: Message Types analyzed: 13.    
    
 Service Broker Msg 9676, Level 10, State 1: Service Contracts analyzed: 5.    
    
 Service Broker Msg 9667, Level 10, State 1: Services analyzed: 3.    
    
 Service Broker Msg 9668, Level 10, State 1: Service Queues analyzed: 3.    
    
 Service Broker Msg 9669, Level 10, State 1: Conversation Endpoints analyzed: 0.    
    
 Service Broker Msg 9674, Level 10, State 1: Conversation Groups analyzed: 0.    
    
 Service Broker Msg 9670, Level 10, State 1: Remote Service Bindings analyzed: 0.    
    
 DBCC results for 'sys.sysrowsetcolumns'.    
    
 There are 630 rows in 7 pages for object 'sys.sysrowsetcolumns'.    
    
 DBCC results for 'sys.sysrowsets'.    
    
 There are 97 rows in 1 pages for object 'sys.sysrowsets'.    
    
 DBCC results for 'sysallocunits'.    
    
 There are 195 rows in 3 pages for object 'sysallocunits'.    
    
 There are 0 rows in 0 pages for object "sys.sysasymkeys".    
    
 DBCC results for 'sys.syssqlguides'.    
    
 There are 0 rows in 0 pages for object "sys.syssqlguides".    
    
 DBCC results for 'sys.queue_messages_1977058079'.    
    
 There are 0 rows in 0 pages for object "sys.queue_messages_1977058079".    
    
 DBCC results for 'sys.queue_messages_2009058193'.    
    
 There are 0 rows in 0 pages for object "sys.queue_messages_2009058193".    
    
 DBCC results for 'sys.queue_messages_2041058307'.    
    
 There are 0 rows in 0 pages for object "sys.queue_messages_2041058307".    
    
 CHECKDB found 0 allocation errors and 0 consistency errors in database 'model'.    
    
 DBCC execution completed. If DBCC printed error messages, contact your system administrator.    
```

Инструкция DBCC CHECKDB возвращает следующий результирующий набор (сообщение) при указании атрибута NO_INFOMSGS:
    
```sql
 The command(s) completed successfully.
 ```
 
Инструкция DBCC CHECKDB возвращает следующий результирующий набор при указании атрибута PHYSICAL_ONLY:
    
```sql
 DBCC results for 'model'.    
    
 CHECKDB found 0 allocation errors and 0 consistency errors in database 'master'.  
    
 DBCC execution completed. If DBCC printed error messages, contact your system administrator.
 ```
 
Инструкция DBCC CHECKDB возвращает следующий результирующий набор при указании атрибута ESTIMATEONLY:
    
```sql
 Estimated TEMPDB space needed for CHECKALLOC (KB)    
    
 -------------------------------------------------  
    
 13   
    
 (1 row(s) affected)   
    
 Estimated TEMPDB space needed for CHECKTABLES (KB)    
    
 --------------------------------------------------    
    
 57 
    
 (1 row(s) affected)  
    
 DBCC execution completed. If DBCC printed error messages, contact your system administrator.
```
    
## <a name="permissions"></a>Permissions    
Необходимо членство в фиксированной серверной роли sysadmin или предопределенной роли базы данных db_owner.
    
## <a name="examples"></a>Примеры    
    
### <a name="a-checking-both-the-current-and-another-database"></a>A. Проверка текущей базы данных и другой базы данных    
В следующем примере выполняется инструкция `DBCC CHECKDB` для текущей базы данных и для базы данных [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)].
    
```sql    
-- Check the current database.    
DBCC CHECKDB;    
GO    
-- Check the AdventureWorks2012 database without nonclustered indexes.    
DBCC CHECKDB (AdventureWorks2012, NOINDEX);    
GO    
```    
    
### <a name="b-checking-the-current-database-suppressing-informational-messages"></a>Б. Проверка текущей базы данных с подавлением информационных сообщений    
Следующий пример проверяет текущую базу данных и подавляет все информационные сообщения.
    
```sql    
DBCC CHECKDB WITH NO_INFOMSGS;    
GO    
```    
    
## <a name="see-also"></a>См. также:    
[DBCC (Transact-SQL)](../../t-sql/database-console-commands/dbcc-transact-sql.md)  
[Просмотр размера разреженного файла снимка базы данных (Transact-SQL)](../../relational-databases/databases/view-the-size-of-the-sparse-file-of-a-database-snapshot-transact-sql.md)  
[sp_helpdb &#40; Transact-SQL &#41;](../../relational-databases/system-stored-procedures/sp-helpdb-transact-sql.md)  
[Системные таблицы &#40; Transact-SQL &#41;](../../relational-databases/system-tables/system-tables-transact-sql.md)  


