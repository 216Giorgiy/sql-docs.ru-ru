---
title: Драйвер OLE DB для SQL Server поддержку высокого уровня доступности и аварийного восстановления | Документы Microsoft
description: Драйвер OLE DB для SQL Server поддержку высокого уровня доступности и аварийного восстановления
ms.custom: ''
ms.date: 03/26/2018
ms.prod: sql-non-specified
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.service: ''
ms.component: oledb|features
ms.reviewer: ''
ms.suite: sql
ms.technology:
- docset-sql-devref
ms.tgt_pltfrm: ''
ms.topic: reference
author: pmasl
ms.author: Pedro.Lopes
manager: jhubbard
ms.workload: On Demand
ms.openlocfilehash: 9e2d236030dd77f2902e2e13575cc4aea2bc39ae
ms.sourcegitcommit: 9f4330a4b067deea396b8567747a6771f35e6eee
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2018
---
# <a name="ole-db-driver-for-sql-server-support-for-high-availability-disaster-recovery"></a>Драйвер OLE DB для SQL Server поддержку высокого уровня доступности и аварийного восстановления
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]

  В этом разделе обсуждаются драйвер OLE DB для поддержки SQL Server (добавлено в [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)]) для [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)]. Дополнительные сведения о [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] см. в разделах [Прослушиватели групп доступности, возможность подключения клиентов и отработка отказа приложений (SQL Server)](../../../database-engine/availability-groups/windows/listeners-client-connectivity-application-failover.md), [Создание и настройка групп доступности (SQL Server)](../../../database-engine/availability-groups/windows/creation-and-configuration-of-availability-groups-sql-server.md), [Отказоустойчивая кластеризация и группы доступности AlwaysOn (SQL Server)](../../../database-engine/availability-groups/windows/failover-clustering-and-always-on-availability-groups-sql-server.md) и [Активные вторичные реплики. Доступ только для чтения ко вторичным репликам (группы доступности AlwaysOn)](../../../database-engine/availability-groups/windows/active-secondaries-readable-secondary-replicas-always-on-availability-groups.md).  
  
 Прослушиватель для заданной группы доступности можно задать в строке подключения. Если драйвер OLE DB для приложения SQL Server подключен к базе данных в группе доступности, которая выполняет отработку отказа, то исходное соединение разрывается и приложение должно установить новое соединение для продолжения работы после отработки отказа.  
  
 Если вы не подключаетесь к прослушивателю группы доступности и несколько IP-адресов связаны с именем узла, драйвер OLE DB для SQL Server будет поочередно для всех IP-адресов, ассоциированных с записью DNS. Это может занять много времени, если первый IP-адрес, возвращенный DNS-сервером, не привязан ни к одной из сетевых интерфейсных плат. При подключении к прослушивателю группы доступности драйвер OLE DB для SQL Server пытается установить соединения для всех IP-адресов в параллельном режиме, и если попытка соединения завершается успешно, то драйвер отменяет любые попытки ожидания соединения.  
  
> [!NOTE]  
>  Увеличение времени ожидания соединения и реализация логики повторного соединения позволяют повысить вероятность соединения приложения с группой доступности. Кроме того, в связи с возможностью неудачного подключения при отработке отказа группы доступности следует реализовать логику повторного соединения, обеспечивающую неограниченное число попыток соединения до достижения успеха.  
  
## <a name="connecting-with-multisubnetfailover"></a>Соединение с помощью MultiSubnetFailover  
 При установлении соединения с прослушивателем группы доступности SQL Server 2012 или экземпляром отказоустойчивого кластера SQL Server 2012 всегда необходимо указывать **MultiSubnetFailover=Yes**. **MultiSubnetFailover** обеспечивает ускоренную отработку отказа для всех групп доступности и отказоустойчивого кластера экземпляра SQL Server 2012 и значительно уменьшит время отработки отказа для одной или несколькими подсетями топологий Always On. При отработке отказа с в нескольких подсетях клиент будет выполнять попытки соединения параллельно. При отработке отказа драйвер OLE DB для SQL Server будет агрессивно повторять попытки соединения по протоколу TCP.  
  
 **MultiSubnetFailover** свойство соединения указывает, что приложение развертывается в группе доступности или экземпляра отказоустойчивого кластера и что драйвер OLE DB для SQL Server попытается соединиться с базой данных на основной [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] экземпляра, пытаясь подключиться ко всем IP-адресов. Когда для соединения установлено свойство **MultiSubnetFailover=Yes**, то клиент производит повторные попытки установить TCP-соединение быстрее интервалов повторной отправки TCP-пакетов по умолчанию для операционной системы. Это позволяет ускорить восстановление соединения после отработки отказа группы доступности AlwaysOn или всегда в экземпляр отказоустойчивого кластера и применимы к одним и несколькими подсетями группы доступности и экземпляров отказоустойчивых кластеров.  
  
 Дополнительные сведения о ключевых словах строки соединения см. в разделе [с помощью ключевых слов строки подключения с драйвер OLE DB для SQL Server](../../oledb/applications/using-connection-string-keywords-with-oledb-driver-for-sql-server.md).  
  
 Указание параметра **MultiSubnetFailover=Yes** при соединении с объектом, отличным от прослушивателя группы доступности или экземпляра отказоустойчивого кластера, может привести к снижению производительности и не поддерживается.  
  
 Следуйте приведенным ниже рекомендациям для подключения к серверу в группе доступности или экземпляру отказоустойчивого кластера.  
  
-   Пользуйтесь свойством соединения **MultiSubnetFailover** при установлении соединения с одной или несколькими подсетями, это благоприятно скажется на производительности в любом случае.  
  
-   Чтобы установить соединение с группой доступности, указывайте ее прослушиватель в строке подключения вместо сервера.  
  
-   При установлении соединения с экземпляром [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], настроенным на работу с более чем 64 IP-адресами, будет возникать ошибка соединения.  
  
-   Режим работы приложения, использующего свойство соединения **MultiSubnetFailover**, не зависит от типа проверки подлинности — [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], Kerberos или Windows.  
  
-   Значение **loginTimeout** можно увеличить с учетом времени отработки отказа, это уменьшит количество попыток повторного соединения в приложении.  
  
-   Распределенные транзакции не поддерживаются.  
  
 Если маршрутизация только для чтения неактивна, то подключение к местоположению вторичной реплики в группе доступности завершится ошибкой в следующих случаях:  
  
1.  Если местоположение вторичных реплик не настроено для приема подключений.  
  
2.  Если приложение использует **ApplicationIntent=ReadWrite** (описано ниже) и расположение вторичных реплик настроено для доступа только для чтения.  
  
 При соединении произойдет ошибка, если первичная реплика настроена для отклонения рабочих нагрузок только для чтения, а строка подключения содержит **ApplicationIntent=ReadOnly**.  
  
## <a name="upgrading-to-use-multi-subnet-clusters-from-database-mirroring"></a>Переход с зеркального отображения базы данных на использование кластеров с несколькими подсетями  
 Если в строке подключения содержатся ключевые слова **MultiSubnetFailover** и **Failover_Partner**, то при соединении произойдет ошибка. Ошибка возникает также в том случае, если используется **MultiSubnetFailover** и [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] возвращает ответ партнера по обеспечению отработки отказа, указывающий на то, что он является частью пары зеркальных баз данных.  
  
 Если обновить драйвер OLE DB для SQL Server приложения, использующего зеркальное отображение базы данных в сценарии с несколькими подсетями, следует удалить **Failover_Partner** свойства соединения и замените ее на  **MultiSubnetFailover** значение **Да** и заменить имя сервера в строке соединения с прослушивателем группы доступности. Если в строке подключения используются **Failover_Partner** и **MultiSubnetFailover=Yes**, то драйвер выдаст ошибку. Но если в строке подключения используются параметры **Failover_Partner** и **MultiSubnetFailover=No** (или **ApplicationIntent=ReadWrite**), то приложение будет использовать зеркальное отображение базы данных.  
  
 Если в базе данных-источнике группы доступности используется зеркальное отображение баз данных, то драйвер вернет ошибку. Это также произойдет в том случае, если используется параметр **MultiSubnetFailover=Yes** в строке подключения, устанавливающей соединение с базой данных-источником, а не с прослушивателем группы доступности.  
  
## <a name="specifying-application-intent"></a>Задание намерения приложения  
 Когда **ApplicationIntent = ReadOnly**, клиент запрашивает рабочую нагрузку чтения при подключении к базе данных всегда включен. Сервер принудительно реализует намерение в момент соединения и во время выполнения инструкции USE database, но только в базе данных с поддержкой Always On.  
  
 Ключевое слово **ApplicationIntent** не работает с базами данных прежних версий, доступными только для чтения.  
  
 Базы данных можно разрешить или запретить рабочую нагрузку чтения для целевой базы данных Always On. (Это выполняется с использованием предложения **ALLOW_CONNECTIONS** инструкций **PRIMARY_ROLE** и **SECONDARY_ROLE**[!INCLUDE[tsql](../../../includes/tsql-md.md)].)  
  
 Ключевое слово **ApplicationIntent** служит для включения маршрутизации только для чтения.  
  
## <a name="read-only-routing"></a>Маршрутизация только для чтения  
 Маршрутизация только для чтения — это функция, которая может обеспечить доступность реплики базы данных, доступной только для чтения. Включение маршрутизации только для чтения  
  
1.  Необходимо установить соединение с прослушивателем группы доступности Always On.  
  
2.  Ключевое слово строки подключения **ApplicationIntent** должно быть установлено в значение **ReadOnly**.  
  
3.  Группа доступности должна быть настроена администратором базы данных на поддержку маршрутизации только для чтения.  
  
 Возможно, что не все из нескольких соединений, использующих маршрутизацию только для чтения, будут подключаться к одной и той же реплике только для чтения. Изменения в синхронизации баз данных или в конфигурации маршрутизации сервера могут привести к тому, что клиент будет подключаться к различным репликам только для чтения. Чтобы гарантировать, что все запросы на подключение только для чтения будут соединяться с одной и той же репликой только для чтения, не указывайте прослушиватель группы доступности в ключевом слове строки подключения **Server**. Вместо этого укажите имя экземпляра, доступного только для чтения.  
  
 На маршрутизацию только для чтения может потребоваться больше времени, чем на подключение к первичной реплике, поскольку маршрутизация только для чтения предусматривает прежде всего подключение к первичной реплике, а затем поиск наиболее подходящей доступной для чтения вторичной реплики. Учитывая этот факт, следует увеличить время ожидания входа в систему.  

  
## <a name="ole-db"></a>OLE DB  
 Драйвер OLE DB для SQL Server поддерживает как **ApplicationIntent** и **MultiSubnetFailover** ключевые слова.   
  
 Были добавлены два ключевых слов строки подключения OLE DB для поддержки [!INCLUDE[ssHADR](../../../includes/sshadr-md.md)] в драйвер OLE DB для SQL Server:  
  
-   **ApplicationIntent** 
-   **MultiSubnetFailover**  
  
 Дополнительные сведения о ключевых словах строки подключения в драйвер OLE DB для SQL Server см. в разделе [с помощью ключевых слов строки подключения с драйвер OLE DB для SQL Server](../../oledb/applications/using-connection-string-keywords-with-oledb-driver-for-sql-server.md).  

### <a name="application-intent"></a>Назначение приложения 

 Эквивалентными свойствами соединения являются следующие:  
  
-   **SSPROP_INIT_APPLICATIONINTENT**  
  
-   **DBPROP_INIT_PROVIDERSTRING**  
  
 Драйвер OLE DB для приложений SQL Server OLE DB можно использовать один из способов для указания назначения приложения:  
  
 **IDBInitialize::Initialize**  
 **IDBInitialize::Initialize** использует ранее настроенный набор свойств для инициализации источника данных и создания объекта источника данных. Укажите назначение приложения в качестве свойства поставщика или в виде расширенной строки свойств.  
  
 **IDataInitialize::GetDataSource**  
 **IDataInitialize::GetDataSource** принимает строку подключения, которая может содержать ключевое слово **Application Intent**.  
  
 **IDBProperties::GetProperties**  
 **IDBProperties::GetProperties** получает значение свойства, которое в настоящее время задано для источника данных.  Значение **Application Intent** можно получить с помощью свойств DBPROP_INIT_PROVIDERSTRING и SSPROP_INIT_APPLICATIONINTENT.  
  
 **IDBProperties::SetProperties**  
 Чтобы задать значение свойства **ApplicationIntent**, вызовите **IDBProperties::SetProperties**, передав свойство **SSPROP_INIT_APPLICATIONINTENT** со значением "**ReadWrite**" или "**ReadOnly**" или свойство **DBPROP_INIT_PROVIDERSTRING** со значением, содержащим "**ApplicationIntent=ReadOnly**" или "**ApplicationIntent=ReadWrite**".  
  
 Назначение приложения можно указать в поле "Свойства назначения приложения" на вкладке "Все" в диалоговом окне **Свойства канала передачи данных**.  
  
 После установки неявных соединений эти подключения будут использовать настройку назначения приложения для родительского подключения. Аналогичным образом несколько сеансов, созданных с использованием одного источника данных, будут наследовать настройки назначения приложения от источника данных.  
  
### <a name="multisubnetfailover"></a>MultiSubnetFailover

Свойство эквивалентного соединения:  
  
-   **SSPROP_INIT_MULTISUBNETFAILOVER**  

Свойство SSPROP_INIT_MULTISUBNETFAILOVER логического типа. Свойство принимает значения VARIANT_TRUE или VARIANT_FALSE.

Чтобы задать значение свойства MultiSubnetFailover, вызовите **IDBProperties::SetProperties** передачи в свойстве SSPROP_INIT_MULTISUBNETFAILOVER со значением **VARIANT_TRUE** или **VARIANT_ FALSE**. 

#### <a name="example"></a>Пример

```
DBPROP rgPropMultisubnet;

rgPropMultisubnet.dwPropertyID = SSPROP_INIT_MULTISUBNETFAILOVER;
rgPropMultisubnet.dwOptions = DBPROPOPTIONS_REQUIRED;
rgPropMultisubnet.dwStatus = DBPROPSTATUS_OK;
rgPropMultisubnet.colid = DB_NULLID;
V_VT(&(rgPropMultisubnet.vValue)) = VT_BOOL;
V_BOOL(&(rgPropMultisubnet.vValue)) = VARIANT_TRUE;

DBPROPSET PropSet;

PropSet.rgProperties = &rgPropMultisubnet;
PropSet.cProperties = 1;
PropSet.guidPropertySet = DBPROPSET_SQLSERVERDBINIT;
IDBProperties* pIDBProperties = NULL;
hr = pIDBInitialize->QueryInterface(IID_IDBProperties, (void **)&pIDBProperties);
pIDBProperties->SetProperties(1, &PropSet);
```



## <a name="see-also"></a>См. также  
 [Драйвер OLE DB для компонентов SQL Server](../../oledb/features/oledb-driver-for-sql-server-features.md)    
 [Использование ключевых слов строки подключения с помощью драйвера OLE DB для SQL Server](../../oledb/applications/using-connection-string-keywords-with-oledb-driver-for-sql-server.md)  
  
  
