---
title: Работа с уведомлениями о запросах | Документы Microsoft
description: Работа с уведомлениями о запросах в драйвер OLE DB для SQL Server
ms.custom: ''
ms.date: 03/26/2018
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.component: oledb|features
ms.reviewer: ''
ms.suite: sql
ms.technology: connectivity
ms.tgt_pltfrm: ''
ms.topic: reference
helpviewer_keywords:
- data access [OLE DB Driver for SQL Server], query notifications
- rowsets [SQL Server], notifications
- OLE DB Driver for SQL Server, query notifications
- notifications [OLE DB Driver for SQL Server]
- query notifications [SQL Server], OLE DB Driver for SQL Server
- canceling rowset changes
- IRowsetNotify interface
- MSOLEDBSQL, query notifications
- OLE DB Driver for SQL Server, query notifications
- consumer notification for rowset changes [OLE DB Driver for SQL Server]
author: pmasl
ms.author: Pedro.Lopes
manager: craigg
ms.openlocfilehash: f8170e2f465ed5b153945a69e50b42cc8c001bff
ms.sourcegitcommit: 1740f3090b168c0e809611a7aa6fd514075616bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
---
# <a name="working-with-query-notifications"></a>Работа с уведомлениями запросов
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]

  Уведомления о запросах появились в [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] и драйвер OLE DB для SQL Server. С помощью уведомлений о запросах, построенных на основе инфраструктуры компонента Service Broker, представленной в [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], приложения могут получать извещения об изменениях данных. Эта функция особенно полезна для приложений, которые предоставляют кэш данных из базы данных (например, для веб-приложений), и которым требуются уведомления об изменении исходных данных.  
  
 С помощью уведомлений о запросах можно запрашивать уведомления в течение указанного времени ожидания при изменении базовых данных запроса. В запросе на уведомление указываются параметры уведомления, среди которых имя службы, текст сообщения и значение времени ожидания для сервера. Доставка уведомлений осуществляется через очередь компонента SQL Service Broker, которую приложения могут опрашивать на предмет имеющихся уведомлений.  
  
 Строка параметров уведомлений запросов имеет следующий синтаксис.  
  
 `service=<service-name>[;(local database=<database> | broker instance=<broker instance>)]`  
  
 Например:  
  
 `service=mySSBService;local database=mydb`  
  
 Подписки на уведомления переживают процесс, который их инициирует, поскольку приложение может создать подписку на уведомление, а затем завершиться. Подписка остается действительной, а уведомление будет отправлено в случае изменения данных в течение времени ожидания, указанного при создании подписки. Уведомление определяется выполненным запросом, параметрами уведомления, а также текстом сообщения. Его можно отменить, установив нуль в качестве значения времени ожидания.  
  
 Уведомления отправляются только один раз. Чтобы получать постоянные уведомления об изменении данных, необходимо создавать новую подписку после обработки каждого уведомления путем повторного выполнения запроса.  
  
 Драйвер OLE DB для SQL Server приложения обычно получают уведомления при помощи [!INCLUDE[tsql](../../../includes/tsql-md.md)] [RECEIVE](../../../t-sql/statements/receive-transact-sql.md) используется для чтения уведомлений из очереди, связанной со службой, указанных в параметрах уведомлений.  
  
> [!NOTE]  
>  В запросах необходимо указывать имена таблиц, для которых требуется отправлять уведомления, например `dbo.myTable`. Имена таблиц должны состоять из двух частей. Подписка будет недействительной в случае использования трех- или четырехкомпонентных имен.  
  
 Инфраструктура уведомлений построена поверх функции запросов, которая появилась в [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]. Как правило, уведомления, формируемые на сервере, отправляются через эти запросы для последующей обработки.  
  
 Чтобы использовать уведомления о запросах, очередь и служба должны существовать на сервере. Их можно создать при помощи [!INCLUDE[tsql](../../../includes/tsql-md.md)] следующим образом:  
  
```  
CREATE QUEUE myQueue  
CREATE SERVICE myService ON QUEUE myQueue   
  
([http://schemas.microsoft.com/SQL/Notifications/PostQueryNotification])  
```  
  
> [!NOTE]  
>  Служба должна использовать стандартный контракт, как показано выше.  
  
## <a name="ole-db-driver-for-sql-server"></a>Драйвер OLE DB для SQL Server  
 Драйвер OLE DB для SQL Server поддерживает уведомление потребителей об изменении набора строк. Потребитель получает уведомление на каждой стадии изменения набора строк, а также при каждой попытке внести изменение.  
  
> [!NOTE]  
>  Передача запроса уведомления на сервер с **ICommand::Execute** является единственным допустимым способом подписки на уведомления о запросах с помощью драйвера OLE DB для SQL Server.  
  
### <a name="the-dbpropsetsqlserverrowset-property-set"></a>Набор свойств DBPROPSET_SQLSERVERROWSET  
 Чтобы поддерживать уведомления о запросах через OLE DB, драйвер OLE DB для SQL Server добавляет в набор свойств DBPROPSET_SQLSERVERROWSET следующие новые свойства.  
  
|Название|Тип|Описание|  
|----------|----------|-----------------|  
|SSPROP_QP_NOTIFICATION_TIMEOUT|VT_UI4|время в секундах, в течение которого уведомление запроса должно оставаться активным.<br /><br /> Значение по умолчанию — 432000 секунд (5 дней). Минимальное значение — 1 секунда, а максимальное значение — 2^31-1 секунд.|  
|SSPROP_QP_NOTIFICATION_MSGTEXT|VT_BSTR|Текст сообщения уведомления. Определяется пользователем и не имеет стандартного формата.<br /><br /> По умолчанию эта строка пуста. В сообщении можно использовать от 1 до 2000 символов.|  
|SSPROP_QP_NOTIFICATION_OPTIONS|VT_BSTR|параметры уведомлений о запросах. Они указываются в строке с *имя*=*значение* синтаксиса. За создание службы и считывание уведомлений из очереди отвечает пользователь.<br /><br /> Значением по умолчанию является пустая строка.|  
  
 Подписка на уведомления всегда фиксируется независимо от того, выполнялась ли инструкция в рамках пользовательской транзакции или в режиме AUTO COMMIT, а также была ли транзакция, в рамках которой выполнялась инструкция, зафиксирована либо был выполнен ее откат. Уведомление сервера срабатывает при возникновении любого из следующих недопустимых условий: изменение базовых данных или схемы либо по истечении времени ожидания, в зависимости от того, что произойдет первым. Регистрации уведомлений удаляются сразу же после их срабатывания. Поэтому, если приложению требуется получение уведомлений в дальнейшем, оно должно подписаться на них снова сразу после получения уведомления.  
  
 Другое соединение или поток может проверять целевую очередь на наличие уведомлений. Например:  
  
```  
WAITFOR (RECEIVE * FROM MyQueue);   // Where MyQueue is the queue name.   
```  
  
 Обратите внимание, что выбор * не удаляет запись из очереди, но получения \* FROM удаляет. Если очередь пуста, поток сервера будет остановлен. При наличии в очереди записей в момент вызова они возвращаются мгновенно; в противном случае вызов ожидает появления записи в очереди.  
  
```  
RECEIVE * FROM MyQueue  
```  
  
 Если очередь пуста, то эта инструкция немедленно возвращает пустой результирующий набор; в противном случае она возвращает все уведомления в очереди.  
  
 Если значение свойств SSPROP_QP_NOTIFICATION_MSGTEXT и SSPROP_QP_NOTIFICATION_OPTIONS не равно NULL и не является пустым, то при каждом выполнении этой команды на сервер отправляется заголовок потока табличных данных уведомлений о запросах, содержащий три свойства, указанные выше. Если значение любого из них равно NULL (или пустое), заголовок не отправляется, а формируется DB_E_ERRORSOCCURRED (или DB_S_ERRORSOCCURRED, если оба свойства обозначены, как необязательные), а значение состояния устанавливается в DBPROPSTATUS_BADVALUE. Поверка выполняется в случае команды Execute/Prepare. Точно так же DB_S_ERRORSOCCURED формируется при установке свойств уведомлений о запросах для подключений к [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] версии до [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)]. В этом случае значение состояния — DBPROPSTATUS_NOTSUPPORTED.  
  
 Запуск подписки не гарантирует успешной доставки последующих сообщений. Кроме того, допустимость указанного имени службы также не проверяется.  
  
> [!NOTE]  
>  При подготовке инструкций подписка никогда не запускается. Запуск подписки происходит только при выполнении инструкций, а использование базовых служб OLE DB не оказывает влияния на уведомления о запросах.  
  
 Дополнительные сведения о наборе свойств DBPROPSET_SQLSERVERROWSET см. в разделе [свойства набора строк и поведение](../../oledb/ole-db-rowsets/rowset-properties-and-behaviors.md).  
  

  
## <a name="see-also"></a>См. также  
 [Возможности драйвера OLE DB для SQL Server](../../oledb/features/oledb-driver-for-sql-server-features.md)     
  
  
