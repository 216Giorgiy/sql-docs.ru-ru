---
title: Подготовка команд | Документы Microsoft
description: Подготовка команд с помощью драйвера OLE DB для SQL Server
ms.custom: ''
ms.date: 03/26/2018
ms.prod: sql-non-specified
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.service: ''
ms.component: ole-db-commands
ms.reviewer: ''
ms.suite: sql
ms.technology:
- docset-sql-devref
ms.tgt_pltfrm: ''
ms.topic: reference
helpviewer_keywords:
- OLE DB Driver for SQL Server, commands
- prepared statements [OLE DB Driver for SQL Server]
- commands [OLE DB]
- command preparation [OLE DB Driver for SQL Server]
author: pmasl
ms.author: Pedro.Lopes
manager: jhubbard
ms.workload: Inactive
ms.openlocfilehash: 3e3a0881b3796f1077eee4e8bcc6d8f0d9573a93
ms.sourcegitcommit: 9f4330a4b067deea396b8567747a6771f35e6eee
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/30/2018
---
# <a name="preparing-commands"></a>Подготовка команд
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]

  Драйвер OLE DB для SQL Server поддерживает подготовку команды для оптимизированного многократного выполнения одной команды; Подготовка команды создает дополнительную нагрузку, но потребителю нет необходимости подготавливать команду для ее выполнения более одного раза. Как правило, подготовку команды следует выполнять в том случае, если планируется ее не менее чем четырехкратное выполнение.  
  
 По соображениям производительности подготовка команды откладывается до ее выполнения. Это поведение по умолчанию. Об ошибках, содержащихся в подготавливаемой команде, не будет ничего известно до ее выполнения или до выполнения операции с метасвойством. При установке свойства [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] SSPROP_DEFERPREPARE в значение FALSE это поведение по умолчанию может быть отключено.  
  
 Если команда выполняется напрямую (без предварительной подготовки), то [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] создает и кэширует план выполнения. При повторном выполнении инструкции SQL [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] применяет эффективный алгоритм сопоставления новой инструкции с существующим планом выполнения и повторно использует для этой инструкции тот же план выполнения.  
  
 [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] предусматривает встроенную поддержку подготавливаемых и выполняемых инструкций. При подготовке инструкции [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] создает план выполнения, кэширует его и возвращает поставщику дескриптор этого плана. Поставщик пользуется этим дескриптором для повторного выполнения инструкции. Хранимые процедуры не создаются. Поскольку дескриптор прямо указывает на план выполнения инструкции SQL, а не сопоставляет инструкцию с планом выполнения, содержащимся в кэше (как при прямом выполнении), значительно эффективнее выполнить подготовку инструкции, а не выполнять ее напрямую, если известно, что инструкция будет использоваться многократно.  
  
 В [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] подготовленные инструкции не могут применяться для создания временных объектов (например, временных таблиц) и не могут ссылаться на создающие их системные хранимые процедуры. Эти процедуры следует выполнять напрямую.  
  
 Некоторые команды не могут быть подготовлены. Например, команды, указывающие выполнение хранимой процедуры или содержащие недопустимый текст для создания хранимой процедуры [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], подготавливаться не должны.  
  
 Если создается временная хранимая процедура, драйвер OLE DB для SQL Server выполняет временную хранимую процедуру возврата результатов, как если бы выполнялась сама инструкция.  
  
 Создание временных хранимых процедур осуществляется с помощью драйвера OLE DB для SQL Server-свойством инициализации SSPROP_INIT_USEPROCFORPREP. Если свойство имеет значение SSPROPVAL_USEPROCFORPREP_ON или SSPROPVAL_USEPROCFORPREP_ON_DROP, драйвер OLE DB для SQL Server пытается создать хранимую процедуру при подготовке команды. Хранимая процедура будет создана успешно, если пользователь приложения имеет все необходимые разрешения [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
 Для потребителей, изредка теряющих соединение, создание временных хранимых процедур может потребовать значительных ресурсов **tempdb**, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] системной базы данных, в котором создаются временные объекты. Когда SSPROP_INIT_USEPROCFORPREP имеет значение SSPROPVAL_USEPROCFORPREP_ ON, временные хранимые процедуры, созданные с помощью драйвера OLE DB для SQL Server, удаляются только в том случае, если сеанса, создавшего команду теряет соединение с экземпляром [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Если это соединение по умолчанию, созданное при инициализации источника данных, то временная хранимая процедура удаляется только тогда, когда источник данных становится неинициализированным.  
  
 Когда SSPROP_INIT_USEPROCFORPREP имеет значение SSPROPVAL_USEPROCFORPREP_ON_DROP, драйвер OLE DB для SQL Server временные хранимые процедуры удаляются, когда происходит одно из следующих:  
  
-   Потребитель вызывает **ICommandText::SetCommandText** для задания новой команды.  
  
-   Потребитель вызывает **ICommandPrepare::Unprepare** для указания, что текст команды больше не требуется.  
  
-   Потребитель освобождает все ссылки на объект команды, связанной с временной хранимой процедурой.  
  
 Объект команды имеет не более одной хранимой процедуры в **tempdb**. Любая существующая временная хранимая процедура представляет текущий текст команды для этого объекта.  
  
## <a name="see-also"></a>См. также  
 [Команды](../../oledb/ole-db-commands/commands.md)  
  
  
