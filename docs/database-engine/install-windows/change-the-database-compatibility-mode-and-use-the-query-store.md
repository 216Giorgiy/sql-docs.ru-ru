---
title: "Изменение режима совместимости базы данных и использование хранилища запросов | Документы Майкрософт"
ms.custom: 
ms.date: 07/21/2017
ms.prod: sql-non-specified
ms.prod_service: database-engine
ms.service: 
ms.component: install-windows
ms.reviewer: 
ms.suite: sql
ms.technology: setup-install
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- query plans [SQL Server], migrating
- upgrading SQL Server, migrating query plans
- plan guides [SQL Server], migrating query plans
ms.assetid: 7e02a137-6867-4f6a-a45a-2b02674f7e65
caps.latest.revision: "19"
author: MikeRayMSFT
ms.author: mikeray
manager: jhubbard
ms.openlocfilehash: a230544eba53d9b506aae4bce6feb019820550e6
ms.sourcegitcommit: 7f8aebc72e7d0c8cff3990865c9f1316996a67d5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2017
---
# <a name="change-the-database-compatibility-mode-and-use-the-query-store"></a>Изменение режима совместимости базы данных и использование хранилища запросов
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

Некоторые изменения SQL Server 2016 и SQL Server 2017 становятся доступны только после изменения уровня совместимости базы данных DATABASE_COMPATIBILITY. Это сделано по нескольким причинам:  
  
- Так как обновление является однократной операцией (версию формата файла понизить нельзя), выделение операции включения новых возможностей в отдельное действие является осмысленным.  Впоследствии можно вернуть значение DATABASE_COMPATIBILITY на предыдущий уровень.  Новая модель сокращает количество операций, которые должны быть выполнены во время отказа системы.  
  
- Изменения в обработчике запросов могут иметь сложные последствия.  Даже небольшое "удобное" изменение в системе, которое нужно большинству пользователей, может привести к неприемлемой регрессии в каком-либо важном запросе для других пользователей.  Отделение этой логики от процесса обновления позволяет таким компонентам, как хранилище запросов, быстро нивелировать регрессию, связанную с выбором плана, и даже полностью избежать подобных проблем в рабочей среде.  
  
> [!NOTE]  
>  Если уровень совместимости пользовательской базы данных до обновления был 100 или выше, после обновления он останется таким же. Если уровень совместимости до обновления был 90, в обновленной базе данных он устанавливается в значение 100, что является минимально поддерживаемым уровнем совместимости в [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]. После обновления уровням совместимости баз данных tempdb, model, msdb и Resource задается значение текущего уровня. Системная база данных master сохраняет уровень совместимости, который она имела до обновления. 
  
 Процесс обновления для включения нового обработчика запросов относится к модели обслуживания, которая предназначена для периода после выпуска продукта.  Некоторые из этих исправлений выпущены под флагом трассировки 4199.  Клиенты, которым нужны эти исправления, могут принять их без риска непредвиденной регрессии для других клиентов.  Модель обслуживания, предназначенная для периода после выпуска исправления обработчика запросов, описана [здесь](https://support.microsoft.com/en-us/kb/974006). Начиная с SQL Server 2016, перемещение на новый уровень совместимости подразумевает ненужность флага трассировки 4199, так как эти исправления включаются по умолчанию в последнем режиме совместимости.  Таким образом, в рамках процесса обновления важно убедиться, что после завершения обновления флаг 4199 не включен.  
  
 Рекомендуемый рабочий процесс для обновления до последней версии обработчика запросов:  
  
1.  Обновите базу данных до SQL Server 2016, не изменяя уровень совместимости базы данных (оставьте предыдущий уровень).  
  
2.  Включите хранилище запросов в базе данных. Дополнительные сведения о включении и использовании хранилища запросов см. в статье [Monitoring Performance By Using the Query Store](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md).  
  
3.  Подождите достаточное время, чтобы собрать репрезентативные данные по рабочей нагрузке.  
  
4.  Измените уровень совместимости базы данных до текущего уровня совместимости. 

   >[!NOTE]
   >Последний уровень совместимости зависит от версии SQL Server.
   >- SQL Server 2016: 130
   >- SQL Server 2017: 140

5. С помощью среды SQL Server Management Studio узнайте, есть ли регрессии производительности в рамках конкретных запросов после изменения уровня совместимости.
  
6.  При обнаружении регрессии осуществите принудительный переход к предыдущему плану в хранилище запросов.  
  
7.  Если не удалось принудительно перейти к некоторым планам или если производительность по-прежнему на неприемлемом уровне, рекомендуем вернуться к предыдущему уровню совместимости, а затем обратиться в службу поддержки пользователей Майкрософт.  
  
## <a name="see-also"></a>См. также:  
 [Просмотр или изменение уровня совместимости базы данных](../../relational-databases/databases/view-or-change-the-compatibility-level-of-a-database.md)  
  
  
