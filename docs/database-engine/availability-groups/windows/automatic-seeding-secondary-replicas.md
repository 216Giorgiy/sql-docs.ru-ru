---
title: "Автоматическое заполнение для вторичных реплик | Документы Майкрософт"
description: "Использование автоматического заполнения для инициализации вторичных реплик."
services: data-lake-analytics
ms.custom: 
ms.date: 06/22/2017
ms.prod: sql-server-2016
ms.reviewer: 
ms.suite: 
ms.technology:
- dbe-high-availability
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- Automatic seeding [SQL Server], secondary replica
ms.assetid: 
caps.latest.revision: 
author: MikeRayMSFT
ms.author: mikeray
manager: jhubbard
ms.translationtype: HT
ms.sourcegitcommit: 1419847dd47435cef775a2c55c0578ff4406cddc
ms.openlocfilehash: 1b72f9f5bf58f72bb4284b1a6cc8d0af7a722aed
ms.contentlocale: ru-ru
ms.lasthandoff: 08/02/2017

---
# <a name="automatic-seeding-for-secondary-replicas"></a>Автоматическое заполнение для вторичных реплик

[!INCLUDE [tsql-appliesto-ss2016-xxxx-xxxx-xxx_md](../../../includes/tsql-appliesto-ss2016-xxxx-xxxx-xxx-md.md)]

В SQL Server 2012 и 2014 единственным способом инициализации вторичной реплики в группе доступности является использование операций резервного копирования, копирования и восстановления. В SQL Server 2016 появилась новая функция для инициализации вторичной реплики — *автоматическое заполнение*. Автоматическое заполнение использует транспортный поток журнала для потокового резервного копирования с помощью VDI на вторичную реплику для каждой базы данных группы доступности, применяющую настроенные конечные точки. Эту новую функцию можно использовать во время первоначального создания группы доступности или при добавлении базы данных в группу доступности. Автоматическое заполнение доступно во всех выпусках SQL Server, поддерживающих группы доступности AlwaysOn, и может использоваться как с традиционными группами доступности, так и с [распределенными группами доступности](distributed-availability-groups.md).

## <a name="considerations"></a>Замечания

Необходимо учесть следующие замечания по использованию автоматического заполнения.

* [Влияние производительности и журнала транзакций на первичную реплику](#performance-and-transaction-log-impact-on-the-primary-replica)
* [Разметка диска](#disk-layout)
* [Безопасность](#security)


### <a name="performance-and-transaction-log-impact-on-the-primary-replica"></a>Влияние производительности и журнала транзакций на первичную реплику

Автоматическое заполнение может быть, а может и не быть удобным для инициализации вторичной реплики. Это зависит от размера базы данных, скорости сетевого подключения и расстояния между первичной и вторичной репликами. Например, если:

* размер базы данных составляет 5 ТБ;
* скорость сетевого подключения — 1 Гбит/с;
* расстояние между двумя сайтами — 1600 километров.

Сеть 1 Гбит/с может обеспечивать долговременную пропускную способность 125 МБ/с при доступной полной пропускной способности. В этом примере для автоматического заполнения может потребоваться чуть более 11 часов. На практике процесс автоматического заполнения выполняется немного медленнее, так как на больших расстояниях качество сигнала снижается и канал обычно используется совместно с другими ресурсами в сети. Во время заполнения журнал транзакций в базе данных на первичной реплике будет продолжать расти. Он не может быть усечен вплоть до завершения автоматического заполнения этой базы данных.  Затем журнал транзакций может быть усечен с помощью резервной копии журнала транзакций.

Автоматическое заполнение является однопоточным процессом, который может обрабатывать до пяти баз данных. Это может повлиять на производительность, особенно в том случае, если группа доступности имеет несколько баз данных.

Для автоматического заполнения можно использовать сжатие, но оно отключено по умолчанию. При включении сжатия снижается пропускная способность сети и, возможно, ускоряется процесс, но компромисс достигается за счет издержек на дополнительный процессор. Чтобы использовать сжатие во время автоматического заполнения, установите флаг трассировки 9567 — см. раздел [Настройка сжатия для группы доступности](tune-compression-for-availability-group.md).

### <a name="disk-layout"></a>Разметка диска

Папка, где будет создана база данных путем автоматического заполнения, уже должна существовать, и путь к ней должен совпадать с путем в первичной реплике.

### <a name="security"></a>безопасность

Разрешения безопасности зависят от типа инициализируемой реплики.

* Для традиционной группы доступности разрешения должны быть предоставлены группе доступности на вторичной реплике после ее присоединения к группе доступности. В Transact-SQL используйте команду ALTER AVAILABILITY GROUP [имя группы доступности] GRANT CREATE ANY DATABASE.
* Для распределенной группы доступности, в которой создаваемые базы данных реплики находятся на первичной реплике второй группы доступности, дополнительные разрешения не требуются, так как она уже является первичной.
* Для вторичной реплики во второй группе доступности распределенной группы доступности необходимо использовать команду ALTER AVAILABILITY GROUP [имя_второй_группы_доступности] GRANT CREATE ANY DATABASE. Эта вторичная реплика будет заполняться данными из первичной реплики второй группы доступности.

## <a name="create-an-availability-group-with-automatic-seeding"></a>Создание группы доступности с помощью автоматического заполнения

Для создания группы доступности с помощью автоматического заполнения используется Transact-SQL или среда SQL Server Management Studio (SSMS 17 или более поздней версии). Чтобы воспользоваться мастером групп доступности в среде SSMS, следуйте [этим инструкциям](use-the-availability-group-wizard-sql-server-management-studio.md). Когда вы дойдете до шага 9, вы увидите автоматическое заполнение как первый и заданный по умолчанию параметр.

![Выбор начальной синхронизации данных][1]

В следующем примере создается группа доступности с помощью Transact-SQL. См. также раздел [Создание группы доступности (Transact-SQL)](create-an-availability-group-transact-sql.md). Для включения заполнения во вторичной реплике параметру SEEDING_MODE задано значение AUTOMATIC. По умолчанию действует поведение MANUAL, присущее версиям до SQL Server 2016 и требующее резервного копирования базы данных в первичной реплике, копирования файла резервной копии на вторичную реплику и восстановления из резервной копии с параметром WITH NORECOVERY.

```
CREATE AVAILABILITY GROUP [AGName]
  FOR DATABASE db1
  REPLICA ON N'Primary_Replica'
WITH (
  ENDPOINT_URL = N'TCP://Primary_Replica.Contoso.com:5022', 
  FAILOVER_MODE = AUTOMATIC, 
  AVAILABILITY_MODE = SYNCHRONOUS_COMMIT, 
),
  N'Secondary_Replica' WITH (
    ENDPOINT_URL = N'TCP://Secondary_Replica.Contoso.com :5022', 
    FAILOVER_MODE = AUTOMATIC, 
    SEEDING_MODE = AUTOMATIC);
 GO
```

Установка параметра SEEDING_MODE на первичной реплике во время выполнения инструкции CREATE AVAILABILITY GROUP ни на что не влияет, так как первичная реплика уже содержит основную копию базы данных для чтения и записи. SEEDING_MODE будет применяться только в том случае, если другая реплика была сделана первичной и была добавлена база данных. Режим заполнения можно изменить позднее — см. подраздел [Изменение режима заполнения реплики](#change-the-seeding-mode-of-a-replica).

После присоединения экземпляра, который стал вторичной репликой, в журнал SQL Server добавляется следующее сообщение:

Локальной реплике доступности для группы доступности "имя_группы_доступности" не было предоставлено разрешение на создание баз данных, но параметру SEEDING_MODE задано значение AUTOMATIC. Используйте команду ALTER AVAILABILITY GROUP … GRANT CREATE ANY DATABASE, чтобы разрешить создание баз данных, заполняемых первичной репликой доступности.

После присоединения выполните следующую инструкцию:

```
ALTER AVAILABILITY GROUP [AGName] GRANT CREATE ANY DATABASE
 GO
````

> [!NOTE] 
> Это известная проблема, начиная с SQL Server 2016 с пакетом обновления 1 (SP1) с накопительным пакетом обновления 2 (CU2), когда вторичная реплика должна ждать три минуты, чтобы разрешить группе доступности заполнить базу данных перед выполнением инструкции ALTER AVAILABILITY GROUP... До истечения этого времени инструкция не возвратит ошибку, так как это будет означать успех операции. Это также известная проблема. Эти проблемы будут исправлены в последующем обновлении SQL Server. В качестве решения попробуйте вставить инструкцию WAITFOR:

```
WAITFOR DELAY '00:03:15';
ALTER AVAILABILITY GROUP [AGName] GRANT CREATE ANY DATABASE;
GO
```

В случае успешного выполнения базы данных автоматически создаются на вторичной реплике с одним из следующих состояний:

* SYNCHRONIZED (синхронизировано), если вторичная реплика настроена как синхронная и данные полностью синхронизированы.
* SYNCHRONIZING (синхронизируется), если вторичная реплика настроена с асинхронным перемещением данных или настроена с синхронным, но еще не синхронизирована с первичной репликой.

<a name="sql-server-log"></a> В дополнение к [динамическим административным представлениям](#dynamic-management-views), описанным ниже, запуск и завершение автоматического заполнения можно увидеть в журнале SQL Server.

![журнал SQL Server][2]

## <a name="combine-backup-and-restore-with-automatic-seeding"></a>Объединение резервного копирования и восстановление с автоматическим заполнением

Можно объединить традиционные операции резервного копирования и восстановления с автоматическим заполнением. В этом случае сначала следует восстановить базу данных на вторичной реплике, включая все доступные журналы транзакций. Затем нужно включить автоматическое заполнение при создании группы доступности, чтобы "догнать" базу данных вторичной реплики, как если бы была восстановлена резервная копия заключительного фрагмента журнала (см. раздел [Резервные копии заключительного фрагмента журнала (SQL Server)](../../../relational-databases/backup-restore/tail-log-backups-sql-server.md)).

## <a name="add-a-database-to-an-availability-group-with-automatic-seeding"></a>Добавление базы данных в группу доступности с помощью автоматического заполнения

Для добавления базы данных в группу доступности с помощью автоматического заполнения используется Transact-SQL или среда SQL Server Management Studio (SSMS 17 или более поздней версии).
Если вторичная реплика использовала автоматическое заполнение, когда она была добавлена в группу доступности, никакие дополнительные действия не требуются. Если выполнялись операции резервного копирования, копирования и восстановления, сначала измените режим заполнения (см. следующий подраздел), а затем при добавлении базы данных воспользуйтесь инструкцией GRANT — см. раздел [Добавление базы данных в группу доступности](availability-group-add-a-database.md).

## <a name="change-the-seeding-mode-of-a-replica"></a>Изменение режима заполнения реплики

Режим заполнения реплики можно изменить после создания группы доступности, поэтому автоматическое заполнение можно включать или отключать. Включение автоматического заполнения после создания позволяет добавить базу данных в группу доступности с помощью автоматического заполнения, если она была создана с функциями резервного копирования, копирования и восстановления. Например:

```
ALTER AVAILABILITY GROUP [AGName]
  MODIFY REPLICA ON 'Replica_Name'
  WITH (SEEDING_MODE = AUTOMATIC)
```

Чтобы отключить автоматическое заполнение, используйте значение MANUAL.

## <a name="prevent-automatic-seeding-after-an-availability-group-is-created"></a>Запрет автоматического заполнения после создания группы доступности

Если вы не хотите полностью отключать автоматическое заполнение для вторичной реплики, но хотите временно запретить вторичной реплике автоматически создавать базы данных, отклоните разрешение CREATE для группы доступности. Это имеет место, когда новая база данных добавляется в группу доступности, но группе доступности должно быть запрещено создание базы данных на вторичной реплике.

```
ALTER AVAILABILITY GROUP [AGName] DENY CREATE ANY DATABASE
GO
```

## <a name="monitor-automatic-seeding"></a>Мониторинг автоматического заполнения

Существует четыре способа мониторинга и устранения неполадок автоматического заполнения.

* [Журнал SQL Server](#sql-server-log), как уже описано
* [Динамические административные представления](#dynamic-management-views)
* [Таблицы журнала резервного копирования](#backup-history-tables)
* [Расширенные события](#extended-events)

### <a name="dynamic-management-views"></a>Динамические административные представления

Существует два динамических административных представления (DMV) для мониторинга заполнения: sys.dm_hadr_automatic_seeding и sys.dm_hadr_physical_seeding_stats.

* sys.dm_hadr_automatic_seeding содержит сведения об общем состоянии автоматического заполнения и сохраняет журнал при каждом выполнении (успешно или нет). В столбце current_state будет указано значение COMPLETED или FAILED. Если указано значение FAILED, используйте значение в failure_state_desc для диагностики проблемы. Чтобы увидеть, что пошло не так, вам может потребоваться объединить его со значением в [журнале SQL Server](#sql-server-log). Это динамическое административное представление заполняется на первичной и всех вторичных репликах.

* sys.dm_hadr_physical_seeding_stats показывает состояние операции автоматического заполнения по мере ее выполнения. Как и в sys.dm_hadr_automatic_seeding, здесь будут отображены значения на первичной и вторичной репликах, но этот журнал не сохраняется. Значения приводятся только для текущего выполнения и не сохраняются. Столбцы, представляющие интерес: start_time_utc, end_time_utc, estimate_time_complete_utc, total_disk_io_wait_time_ms, total_network_wait_time_ms и failure_message в случае сбоя операции заполнения.

### <a name="backup-history-tables"></a>Таблицы журнала резервного копирования

Автоматическое заполнение также помещает данные в таблицы `msdb`, где хранится журнал для резервного копирования и восстановления. На вторичной реплике, которая получает автоматическое заполнение, столбец physical_device_name таблицы `backupmediafamily` содержит идентификатор GUID для его значения, а соответствующая запись в `backupset` носит имя первичной реплики для server_name и machine_name.

### <a name="extended-events"></a>Расширенные события

Автоматическое заполнение добавляет новые расширенные события для отслеживания изменения состояния, сбоев и статистики производительности во время инициализации.
Например, следующий скрипт создает сеанс расширенных событий, который фиксирует события, связанные с автоматическим заполнением.

```
CREATE EVENT SESSION [AG_autoseed] ON SERVER 
    ADD EVENT sqlserver.hadr_automatic_seeding_state_transition,
    ADD EVENT sqlserver.hadr_automatic_seeding_timeout,
    ADD EVENT sqlserver.hadr_db_manager_seeding_request_msg,
    ADD EVENT sqlserver.hadr_physical_seeding_backup_state_change,
    ADD EVENT sqlserver.hadr_physical_seeding_failure,
    ADD EVENT sqlserver.hadr_physical_seeding_forwarder_state_change,
    ADD EVENT sqlserver.hadr_physical_seeding_forwarder_target_state_change,
    ADD EVENT sqlserver.hadr_physical_seeding_progress,
    ADD EVENT sqlserver.hadr_physical_seeding_restore_state_change,
    ADD EVENT sqlserver.hadr_physical_seeding_submit_callback
    ADD TARGET package0.event_file(SET filename=N’autoseed.xel’,max_file_size=(5),max_rollover_files=(4))
  WITH (MAX_MEMORY=4096 KB,EVENT_RETENTION_MODE=ALLOW_SINGLE_EVENT_LOSS,MAX_DISPATCH_LATENCY=30 SECONDS,MAX_EVENT_SIZE=0 KB,MEMORY_PARTITION_MODE=NONE,TRACK_CAUSALITY=OFF,STARTUP_STATE=ON)
GO

ALTER EVENT SESSION AlwaysOn_autoseed ON SERVER STATE=START
GO
```

В таблице ниже перечислены расширенные события, связанные с автоматическим заполнением.

|Имя|Описание|
|----|-----------|
|hadr_db_manager_seeding_request_msg|Заполнение сообщения запроса.|
|hadr_physical_seeding_backup_state_change|Изменение состояния на стороне резервного копирования при физическом заполнении.|
|hadr_physical_seeding_restore_state_change|Изменение состояния на стороне восстановления при физическом заполнении.|
|hadr_physical_seeding_forwarder_state_change|Изменение состояния на стороне сервера пересылки при физическом заполнении.|
|hadr_physical_seeding_forwarder_target_state_change|Изменение состояния на стороне цели сервера пересылки при физическом заполнении.|
|hadr_physical_seeding_submit_callback|Событие обратного вызова при фиксации физического заполнения.|
|hadr_physical_seeding_failure|Событие сбоя физического заполнения.|
|hadr_physical_seeding_progress|Событие хода выполнения физического заполнения.|
|hadr_physical_seeding_schedule_long_task_failure|Событие сбоя длительной задачи с расписанием физического заполнения.|
|hadr_automatic_seeding_start|Происходит при отправке операции автоматического заполнения.|
|hadr_automatic_seeding_state_transition|Происходит при изменении состояния операции автоматического заполнения.|
|hadr_automatic_seeding_success|Происходит при успешном выполнении операции автоматического заполнения.|
|hadr_automatic_seeding_failure|Происходит при сбое операции автоматического заполнения.|
|hadr_automatic_seeding_timeout|Происходит при истечении времени ожидания операции автоматического заполнения.|

## <a name="see-also"></a>См. также:

[ALTER AVAILABILITY GROUP (Transact-SQL)](/sql/t-sql/statements/alter-availability-group-transact-sql)

[CREATE AVAILABILITY GROUP (Transact-SQL)](https://msdn.microsoft.com/library/ff878399.aspx)

[Руководство по мониторингу и устранению неполадок в группах доступности AlwaysOn](http://technet.microsoft.com/library/dn135328.aspx)

> Автор этого материала — Аллан Хирт ([Allan Hirt](http://mvp.microsoft.com/en-us/PublicProfile/4025254?fullName=Allan%20Hirt)), сотрудник со статусом Microsoft Most Valued Professional.

<!--Image references-->
[1]: ./media/auto-seed-new-availability-group.png
[2]: ./media/auto-seed-sql-server-log.png

