---
title: "Транзакции — группы доступности AlwaysOn и зеркальное отображение баз данных | Документы Майкрософт"
ms.custom: 
ms.date: 11/01/2017
ms.prod: sql-non-specified
ms.prod_service: database-engine
ms.service: 
ms.component: availability-groups
ms.reviewer: 
ms.suite: sql
ms.technology: dbe-high-availability
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- database mirroring [SQL Server], interoperability
- cross-database transactions [SQL Server]
- transactions [database mirroring]
- Availability Groups [SQL Server], interoperability
- troubleshooting [SQL Server], cross-database transactions
ms.assetid: 9f7ed895-ad65-43e3-ba08-00d7bff1456d
caps.latest.revision: "33"
author: MikeRayMSFT
ms.author: mikeray
manager: craigg
ms.workload: On Demand
ms.openlocfilehash: 25e9efc5d7ffb6d4d0c09cc88e19671ed7f7b043
ms.sourcegitcommit: dcac30038f2223990cc21775c84cbd4e7bacdc73
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/18/2018
---
# <a name="transactions---availability-groups-and-database-mirroring"></a>Транзакции — группы доступности AlwaysOn и зеркальное отображение баз данных
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md](../../../includes/appliesto-ss-xxxx-xxxx-xxx-md.md)]

В этом разделе описываются транзакции между базами данных и распределенные транзакции для групп доступности AlwaysOn и зеркального отображения базы данных.  

## <a name="support-for-distributed-transactions"></a>Поддержка распределенных транзакций

SQL Server 2017 поддерживает распределенные транзакции для баз данных в группах доступности. Эта поддержка распространяется на базы данных на одном экземпляре SQL Server или базы данных на разных экземплярах SQL Server. Распределенные транзакции не поддерживаются для баз данных, настроенных для зеркального отображения.

>[!NOTE]
>[!INCLUDE[SQL Server 2016]](../../../includes/sssql15-md.md)] В SQL Server 2016 включена ограниченная поддержка распределенных транзакций для баз данных в группе доступности. Распределенные транзакции с использованием баз данных в группе доступности поддерживались при условии, что другие базы данных в транзакции отсутствовали в том же экземпляре SQL Server. Дополнительные сведения см. в статье [SQL Server 2016 DTC Support in Availability Groups](http://blogs.technet.microsoft.com/dataplatform/2016/01/25/sql-server-2016-dtc-support-in-availability-gr) (Поддержка DTC для SQL Server 2016 в группах доступности).

Сведения о настройка группы доступности для распределенных транзакций см. в статье [Configure Availability Group for Distributed Transactions](configure-availability-group-for-distributed-transactions.md) (Настройка группы доступности для распределенных транзакций).

Дополнительные сведения см. в следующих статьях:

- [DTC Administration Guide](http://msdn.microsoft.com/library/ms681291.aspx) (Руководство по администрированию DTC)
- [DTC Developers Guide](http://msdn.microsoft.com/library/ms679938.aspx) (Руководство для разработчиков DTC)
- [DTC Programmers Reference](http://msdn.microsoft.com/library/ms686108.aspx) (Справочник для программистов DTC)

## <a name="sql-server-2016-and-before-support-for-cross-database-transactions-within-the-same-sql-server-instance"></a>SQL Server 2016 и более ранние версии: поддержка транзакций между базами данных в одном экземпляре SQL Server  

В SQL Server 2016 и более ранних версиях транзакции между базами данных в одном и том же экземпляре SQL Server не поддерживаются в группах доступности. Это означает, что при транзакции между базами данных две базы данных не могут размещаться в одном экземпляре SQL Server даже в том случае, если они принадлежат к одной и той же группе доступности.  
  
Межбазовые транзакции также не поддерживаются для зеркального отображения базы данных.  
  
##  <a name="dtcsupport"></a> SQL Server 2016: поддержка распределенных транзакций  
Распределенные транзакции поддерживаются для групп доступности. Это относится к распределенным транзакциям между базами данных, размещенными в двух разных экземплярах SQL Server, и к распределенным транзакциям между SQL Server и другим сервером, соответствующим DTC.  
 
Координатор распределенных транзакций (Майкрософт) (MSDTC) — это служба Windows, которая предоставляет инфраструктуру транзакций для распределенных систем. MSDTC позволяет клиентским приложениям включать несколько источников данных в одну транзакцию, которая затем фиксируется на всех серверах, включенных в транзакцию. Например, с помощью MSDTC можно координировать транзакции, которые охватывают несколько баз данных на разных серверах.

В SQL Server 2016 представлена возможность использования распределенных транзакций, где одна или несколько баз данных входят в группу доступности. До выпуска SQL Server 2016 распределенные транзакции не поддерживались для баз данных в группах доступности. SQL Server 2016 может регистрировать диспетчер ресурсов для каждой базы данных. Эта новая функция определяет возможность включения баз данных в группах доступности в распределенные транзакции.
  
 Необходимо выполнить следующие требования.  
  
-   Группы доступности должны быть запущены на Windows Server 2016 или Windows Server 2012 R2. Для Windows Server 2012 R2 необходимо установить обновление KB3090973, доступное по адресу [https://support.microsoft.com/en-us/kb/3090973](https://support.microsoft.com/en-us/kb/3090973).  
  
-   Группы доступности необходимо создать с помощью команды **CREATE AVAILABILITY GROUP** и предложения **WITH DTC\_SUPPORT = PER_DB**. Сейчас невозможно изменить существующую группу доступности.  

- Все экземпляры SQL Server, которые будут входить в группу доступности, должна быть экземплярами SQL Server 2016 или более поздней версии.
 
 ## <a name="non-support-for-distributed-transactions"></a>Отсутствие поддержки распределенных транзакций
 Далее приведены конкретные случаи, когда распределенные транзакции не поддерживаются.
 
 - В SQL Server 2016 и более ранних версиях несколько баз данных, включенных в транзакцию, находятся в одной группе доступности.
 
 - В SQL Server 2016 и более ранних версиях по меньшей мере одна база данных находится в группе доступности, а другая база данных — в одном экземпляре SQL Server. 
 
 - Группа доступности не была создана с включенной распределенной транзакцией.
 
 - Зеркальное отображение базы данных.
 
 > [!IMPORTANT]
 > Определите соответствующий результат по умолчанию для транзакций, которые DTC не удалось разрешить для вашей среды.  Сведения о настройке результата по умолчанию см. в разделе [Параметр конфигурации сервера in-doubt xact resolution](../../../database-engine/configure-windows/in-doubt-xact-resolution-server-configuration-option.md).
  
## <a name="example-scenario-with-database-mirroring"></a>Пример сценария с зеркальным отображением базы данных  
 В следующем примере зеркального отображения базы данных показано, как возникает логическое несоответствие. В этом примере приложение использует межбазовую транзакцию для вставки двух строк данных: одна строка вставляется в таблицу зеркально отображаемой базы данных A, другая — в таблицу второй базы данных, B. База данных A зеркально отображается в режиме высокого уровня безопасности с автоматической отработкой отказа. При фиксации транзакции база данных A становится недоступной, и сеанс зеркального отображения автоматически переходит на зеркальное отображение базы данных A.  
  
 После автоматической отработки отказа межбазовая транзакция может успешно зафиксироваться в базе данных B, но не в базе данных, с которой выполнен автоматический переход. Это случится, если исходный основной сервер для базы данных А перед переходом не отправил журнал межбазовых транзакций на зеркальный сервер. После автоматической отработки отказа эта транзакция не будет существовать на новом основном сервере. Базы данных A и B станут несогласованными, поскольку вставленные данные в базе данных B останутся нетронутыми, в то время как вставленные данные в базе данных A будут потеряны.  
  
 Похожее может произойти при использовании транзакций MS DTC. Например, после автоматической отработки отказа новая основная база данных обращается к MS DTC. Но MS DTC не знает о новом основном сервере и завершает все транзакции, готовящиеся к фиксации, которые считаются зафиксированными в других базах данных.  
  
> [!NOTE]  
>  Применение зеркального отображения базы данных или использование групп доступности с помощью DTC способами, которые не утверждены в этом разделе, не поддерживается.  Это не означает, что компоненты продукта, не связанные с DTC, также не поддерживаются. Однако проблемы в связи с ненадлежащим использованием распределенных транзакций не будут устранены.  
  
## <a name="next-steps"></a>Следующие шаги  
 [Always On availability groups: Interoperability &#40;SQL Server&#41;](../../../database-engine/availability-groups/windows/always-on-availability-groups-interoperability-sql-server.md)  
  
  
