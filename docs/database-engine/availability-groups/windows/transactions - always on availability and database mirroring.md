---
title: "Транзакции между базами данных и распределенные транзакции для групп доступности AlwaysOn и зеркального отображения базы данных (SQL Server) | Microsoft Docs"
ms.custom: ""
ms.date: "03/23/2017"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "dbe-high-availability"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "зеркальное отображение базы данных [SQL Server], взаимодействие"
  - "межбазовые транзакции [SQL Server]"
  - "транзакции [зеркальное отображение базы данных]"
  - "Группы доступности [SQL Server], взаимодействие"
  - "Устранение неполадок [SQL Server], транзакции между базами данных"
ms.assetid: 9f7ed895-ad65-43e3-ba08-00d7bff1456d
caps.latest.revision: 33
ms.author: "mikeray"
manager: "jhubbard"
---
# Транзакции между базами данных и распределенные транзакции для групп доступности AlwaysOn и зеркального отображения базы данных (SQL Server)
[!INCLUDE[tsql-appliesto-ss2016-xxxx-xxxx-xxx_md](../../../includes/tsql-appliesto-ss2016-xxxx-xxxx-xxx-md.md)]

В этом разделе описываются транзакции между базами данных и распределенные транзакции для групп доступности AlwaysOn и зеркального отображения базы данных.  
  
## Поддержка транзакций между базами данных в одном экземпляре SQL Server  
Транзакции между базами данных в одном и том же экземпляре SQL Server не поддерживаются в группах доступности AlwaysOn. Это означает, что при транзакции между базами данных две базы данных не могут размещаться в одном экземпляре SQL Server даже в том случае, если они принадлежат к одной и той же группе доступности.  
  
Межбазовые транзакции также не поддерживаются для зеркального отображения базы данных.  
  
##  <a name="dtcsupport"></a> Поддержка распределенных транзакций  
Распределенные транзакции поддерживаются для групп доступности AlwaysOn. Это относится к распределенным транзакциям между базами данных, размещенными в двух разных экземплярах SQL Server, и к распределенным транзакциям между SQL Server и другим сервером, совместимым с DTC.  
 
Координатор распределенных транзакций (Майкрософт) (MSDTC) — это служба Windows, которая предоставляет инфраструктуру транзакций для распределенных систем. MSDTC позволяет клиентским приложениям включать несколько источников данных в одну транзакцию, которая затем фиксируется на всех серверах, включенных в транзакцию. Например, с помощью MSDTC можно координировать транзакции, которые охватывают несколько баз данных на разных серверах.

В SQL Server 2016 представлена возможность использования распределенных транзакций, где одна или несколько баз данных входят в группу доступности. До выпуска SQL Server 2016 распределенные транзакции не поддерживались для баз данных в группах доступности. SQL Server 2016 может регистрировать диспетчер ресурсов для каждой базы данных. Эта новая функция определяет возможность включения баз данных в группах доступности в распределенные транзакции.

  
 Необходимо выполнить следующие требования.  
  
-   Группы доступности должны быть запущены на Windows Server 2016 или Windows Server 2012 R2. Для Windows Server 2012 R2 необходимо установить обновление KB3090973, доступное по адресу [https://support.microsoft.com/en-us/kb/3090973](https://support.microsoft.com/en-us/kb/3090973).  
  
-   Группы доступности необходимо создать с помощью команды **CREATE AVAILABILITY GROUP** и предложения **WITH DTC_SUPPORT = PER_DB**. Сейчас невозможно изменить существующую группу доступности.  

- Все экземпляры SQL Server, которые будут входить в группу доступности, должна быть экземплярами SQL Server 2016 или более поздней версии.
  
 
 ## Отсутствие поддержки распределенных транзакций
 Далее приведены конкретные случаи, когда распределенные транзакции не поддерживаются.
 
 -  Несколько баз данных, включенных в транзакцию, находятся в одной группе доступности.
 
 -  По меньшей мере одна база данных находится в группе доступности, а другая база данных находится в одном экземпляре SQL Server. 
 
 -  Группа доступности не была создана с включенной распределенной транзакцией.
 
 -  Зеркальное отображение базы данных.
 
 ## Рекомендация
 В рабочей среде следует кластеризовать службу DTC. В противном случае SQL Server будет использовать локальную службу DTC. Это приведет к снижению общего уровня доступности решения. При использовании кластеризованной службы DTC в случае сбоя узла кластера все выполняющиеся транзакции можно будет восстановить.
 
 > [!IMPORTANT]
 > Определите соответствующий результат по умолчанию для транзакций, которые DTC не удалось разрешить для вашей среды.  Сведения о настройке результата по умолчанию см. в разделе [Параметр конфигурации сервера in-doubt xact resolution](../../../database-engine/configure-windows/in-doubt-xact-resolution-server-configuration-option.md).
  
## Пример сценария с зеркальным отображением базы данных  
 В следующем примере зеркального отображения базы данных показано, как возникает логическое несоответствие. В этом примере приложение использует межбазовую транзакцию для вставки двух строк данных: одна строка вставляется в таблицу зеркально отображаемой базы данных A, другая — в таблицу второй базы данных, B. База данных A зеркально отображается в режиме высокого уровня безопасности с автоматической отработкой отказа. При фиксации транзакции база данных A становится недоступной, и сеанс зеркального отображения автоматически переходит на зеркальное отображение базы данных A.  
  
 После автоматической отработки отказа межбазовая транзакция может успешно зафиксироваться в базе данных B, но не в базе данных, с которой выполнен автоматический переход. Это случится, если исходный основной сервер для базы данных А перед переходом не отправил журнал межбазовых транзакций на зеркальный сервер. После автоматической отработки отказа эта транзакция не будет существовать на новом основном сервере. Базы данных A и B станут несогласованными, поскольку вставленные данные в базе данных B останутся нетронутыми, в то время как вставленные данные в базе данных A будут потеряны.  
  
 Похожее может произойти при использовании транзакций MS DTC. Например, после автоматической отработки отказа новая основная база данных обращается к MS DTC. Но MS DTC не знает о новом основном сервере и завершает все транзакции, готовящиеся к фиксации, которые считаются зафиксированными в других базах данных.  
  
> [!NOTE]  
>  Применение зеркального отображения базы данных или использование групп доступности AlwaysOn с помощью DTC способами, которые не утверждены в этом разделе, не поддерживается.  Это не означает, что компоненты продукта, не связанные с DTC, также не поддерживаются. Однако проблемы в связи с ненадлежащим использованием распределенных транзакций не будут устранены.  
  
## См. также:  
 [Группы доступности AlwaysOn: взаимодействие (SQL Server)](../../../database-engine/availability-groups/windows/always-on-availability-groups-interoperability-sql-server.md)  
  
  