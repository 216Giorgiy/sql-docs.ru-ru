---
title: "SQL Server Always On схем развертывания группы доступности | Документы Microsoft"
ms.custom: 
ms.date: 06/16/2017
ms.prod: sql-linux
ms.reviewer: 
ms.suite: 
ms.technology: database-engine
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: edd75f68-dc62-4479-a596-57ce8ad632e5
caps.latest.revision: 34
author: MikeRayMSFT
ms.author: mikeray
manager: jhubbard
ms.translationtype: MT
ms.sourcegitcommit: 21f0cfd102a6fcc44dfc9151750f1b3c936aa053
ms.openlocfilehash: 353e7cf5cef8430303e3ee6fbefc92db08f5f733
ms.contentlocale: ru-ru
ms.lasthandoff: 08/28/2017

---
# <a name="high-availability-and-data-protection-for-availability-group-configurations"></a>Высокий уровень доступности и защиты данных в конфигурации группы доступности

[!INCLUDE[tsql-appliesto-sslinux-only](../includes/tsql-appliesto-sslinux-only.md)]

Эта статья содержит конфигурации развертывания, поддерживаемые для группы обеспечения доступности AlwaysOn в SQL Server на серверах Linux. Группа доступности поддерживает высокий уровень доступности и защите данных. Сбой автоматического обнаружения, автоматический переход на другой и прозрачный переподключения после отработки отказа обеспечения высокого уровня доступности. Синхронизированные реплики обеспечения защиты данных. 

>[!NOTE]
>Помимо высокого уровня доступности и защите данных группы доступности можно также выполнения аварийного восстановления, платформа Миграция между и чтение горизонтального масштабирования. В этой статье в основном рассматривается реализации высокого уровня доступности и защиты данных. 

С отказоустойчивой кластеризацией, является обычной конфигурацией для высокого уровня доступности использует два синхронных реплик и Windows Server [общей папке следящего сервера](http://technet.microsoft.com/library/cc731739.aspx). Файл ресурса-свидетеля проверяет конфигурацию группы доступности — состояние синхронизации и роль реплики, например. Эта конфигурация гарантирует, что вторичная реплика, выбрана, так как цель перехода содержит последние данные и изменения конфигурации группы доступности. 

Текущего решения высокого уровня доступности для Linux не рассчитан на работу внешних следящего сервера, например файловый ресурс-свидетель в отказоустойчивом кластере Windows Server. При наличии не отказоустойчивого кластера Windows Server, конфигурации группы доступности хранится в базе данных master на экземпляры-участники SQL Server. Таким образом группа доступности требуется по крайней мере три синхронных реплик высокого уровня доступности и защиты данных. После создания группы доступности на серверах Linux, создайте ресурс кластера. Параметры ресурсов кластера определить конфигурацию для обеспечения высокой доступности.

Выберите проект группы доступности для удовлетворять определенным бизнес-требованиям для обеспечения высокой доступности, защиты данных и чтения горизонтального масштабирования.

>[!IMPORTANT]
>Следующие конфигурации описаны принципы разработки группы доступности и возможности каждого шаблона. Эти шаблоны проектирования применяются к группам доступности с `CLUSTER_TYPE = EXTERNAL` для решения высокого уровня доступности. 

Конструктор шаблонов являются две конфигурации группы доступности. Настройки включают:

- **Три синхронных реплик**

- **Два синхронных реплик**

## <a name="how-the-configuration-affects-default-resource-settings"></a>Влияние конфигурации параметров ресурсов по умолчанию

Параметр ресурса кластера `required_synchronized_secondaries_to_commit` гарантирует, что каждая транзакция переписываться минимальное число журналов вторичной реплики до фиксации транзакции на первичной реплике. Этот параметр может повлиять на высокий уровень доступности и защите данных, в зависимости от конфигурации. При установке агента ресурсов SQL Server - `mssql-server-ha` - и создать ресурс кластера для группы доступности, диспетчер кластеров определяет доступность группы конфигурации и наборы `required_synchronized_secondaries_to_commit` соответствующим образом. 

Если поддерживается конфигурацией, то параметр агента ресурсов `required_synchronized_secondaries_to_commit` присвоено значение, которое обеспечивает высокий уровень доступности и защиты данных. Дополнительные сведения см. в разделе [агент SQL Server понять ресурсов для pacemaker](#pacemakerNotify).

В следующих разделах объясняется поведение по умолчанию для ресурса кластера. 

<a name="threeSynch"></a>

## <a name="three-synchronous-replicas"></a>Три синхронных реплик

Эта конфигурация состоит из трех синхронных реплик. По умолчанию он обеспечивает высокий уровень доступности и защиты данных. Он также может предоставлять чтения масштабирования.

![Три реплики][3]

В следующей таблице описаны высокого уровня доступности и данных поведение защиты на основе параметров для группы доступности с тремя синхронных реплик: 

|`required_synchronized_secondaries_to_commit`|0 |1 \*|2
| --- |:---:|:---:|:---:
|Автоматический переход на другой после сбоя первичной реплики| |✔| 
|Доступна после сбоя одного вторичной реплики первичная реплика|✔|✔| 
|Доступна после двух сбоев вторичной реплики первичная реплика|✔| |
|Отработка отказа вручную после сбоя первичной реплики - возможной потерей данных|✔| | 

\*Значение по умолчанию при добавлении группы доступности в качестве ресурса кластера.

<a name="twoSynch"></a>

## <a name="two-synchronous-replicas"></a>Два синхронных реплик

Такая конфигурация обеспечивает защиту данных. Как и другие конфигурации группы доступности ее можно включить чтения масштабирования. Конфигурация два синхронных реплик не обеспечивает автоматическое высокого уровня доступности. 

![Два синхронных реплик][1]

Эта конфигурация требует двух серверов. Эти серверы выполнения роли первичной и вторичной реплики. 

Два синхронных реплик конфигурация оптимизирована для данных защиты и распределения рабочей нагрузки чтения для базы данных. По умолчанию этот ресурс настроен для защиты данных. Эта конфигурация не обеспечивают высокую доступность, если один из экземпляров SQL Server завершается ошибкой, либо база данных доступна не полностью или не риск потери данных. 

В следующей таблице описаны поведение защиты данных в соответствии с возможные значения для группы доступности с двумя синхронными репликами: 

|`required_synchronized_secondaries_to_commit`|0 \*|1 
| --- |:---|:---
|Автоматический переход на другой после сбоя первичной реплики| |✔ \*\* | 
|Доступна после сбоя вторичной реплики первичная реплика|✔| |

\*Значение по умолчанию при добавлении группы доступности в качестве ресурса кластера.

\*\*В этой конфигурации после сбоя первичной реплики происходит автоматическое группы доступности при сбое. Приложения не смогут подключиться к группе доступности, пока первичная реплика не восстановится - теперь как вторичная реплика. 

Два синхронных реплик конфигурации возможно наиболее экономичным требуется только два экземпляра SQL Server на двух серверах.

<a name="pacemakerNotify"></a>

## <a name="understand-sql-server-resource-agent-for-pacemaker"></a>Понимать ресурс агента SQL Server для pacemaker

SQL Server 2017 г CTP-версии 1.4 добавлена `sequence_number` для `sys.availability_groups` разрешающее Pacemaker определить порядок обновления получателя будут реплики с первичной репликой. `sequence_number`— монотонно возрастающее значение типа BIGINT, представляющее порядок обновления реплики группы доступности локальных ресурсов. Обновления pacemaker `sequence_number` с каждым изменением конфигурации группы доступности. Изменения конфигурации примеры перехода на другой ресурс, реплика сложения или удаления. Число обновлены на сервере-источнике, а затем реплицируются во вторичные реплики. Таким образом вторичную реплику, которая имеет актуальную конфигурацию имеет тем же порядковым номером, что и первичная. 

Когда Pacemaker решает promote реплика-источник, он сначала отправляет *предварительно promote* уведомления для всех реплик. Реплики возвращает порядковый номер. Далее когда Pacemaker фактически пытается повысить уровень реплики на основной, реплики только повышает уровень сам если его порядковый номер — самым высоким порядковых номеров. Если порядковый номер не соответствует наибольший порядковый номер, реплика отклоняет promote операции. Таким образом, до первичной реплики может быть обновлена только реплика с наибольшим значением порядкового номера, что позволяет избежать потери данных. 

Этот процесс требует доступен хотя бы одна реплика для повышения уровня с тем же порядковым номером предыдущей первичной. Наборы Pacemaker ресурсов агента `required_synchronized_secondaries_to_commit` таким образом, что по крайней мере одна реплика вторичной и имеет актуальную версию доступной целью автоматического перехода на другой ресурс по умолчанию. С каждой действие мониторинга значение `required_synchronized_secondaries_to_commit` вычисляется (и обновление при необходимости). `required_synchronized_secondaries_to_commit` Значение «число синхронных реплик» деленному на 2. Во время перехода на другой ресурс требуется агент ресурсов (`total number of replicas`  -  `required_synchronized_secondaries_to_commit` реплик) реагировать на предварительно promote уведомления. Реплика с самым высоким `sequence_number` повышается до основного. 

Например группа доступности с тремя синхронные реплики - одну первичную реплику и двух синхронных вторичных реплик.

- `required_synchronized_secondaries_to_commit`-1; (3 / 2 -> 1).

- Требуемое количество реплик реагировать на предварительно преобразовать действие — 2. (3 - 1 = 2). 

В этом случае ответ для отработки отказа, чтобы оно запускалось у двух реплик. Для успешного автоматического перехода на другой после сбоя первичной реплики обоих вторичные реплики должны актуальные и реагировать на предварительно promote уведомления. В таком случае online и синхронный они имеют один и тот же номер последовательности. Группы доступности повышает уровень одного из них. Если только одной из вторичных реплик реагирует на предварительно преобразовать действие, не может гарантировать ресурсов агента, сервер-получатель, ответившего имеет наивысший sequence_number и отработки отказа не происходит.

>[!IMPORTANT]
>Нулевое значение `required_synchronized_secondaries_to_commit` создает риск потери данных. Во время сбоя первичной реплики агент ресурса не вызывает изменения автоматически отработки отказа. Можно ожидать первичный для восстановления, или вручную при сбое с помощью `FORCE_FAILOVER_ALLOW_DATA_LOSS`.

Вы можете переопределить поведение по умолчанию и предотвратить параметр группы доступности `required_synchronized_secondaries_to_commit` автоматически.

Следующий скрипт задает `required_synchronized_secondaries_to_commit` 0 для группы доступности с именем `<**ag1**>`. Прежде чем выполнять замену `<**ag1**>` с именем группы доступности.

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=0
```

Чтобы восстановить значения по умолчанию на основании конфигурации группы доступности запуска:

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=
```

>[!NOTE]
>При выполнении предыдущей команды основной временно переводится в режим получателей, затем повторно повышается. Обновление ресурсов приводит все реплики остановить и перезапустить. Новое значение`required_synchronized_secondaries_to_commit` устанавливается только после перезапуска реплики, а не мгновенно.

<!--Image references-->
[1]: ./media/sql-server-linux-availability-group-ha/1-read-scale-out.png
[3]: ./media/sql-server-linux-availability-group-ha/3-three-replica.png
