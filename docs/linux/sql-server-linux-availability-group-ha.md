---
title: "SQL Server Always On схем развертывания группы доступности | Документы Microsoft"
ms.custom: 
ms.date: 10/16/2017
ms.prod: sql-non-specified
ms.prod_service: database-engine
ms.service: 
ms.component: sql-linux
ms.reviewer: 
ms.suite: sql
ms.technology: database-engine
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: edd75f68-dc62-4479-a596-57ce8ad632e5
caps.latest.revision: "34"
author: MikeRayMSFT
ms.author: mikeray
manager: jhubbard
ms.workload: Inactive
ms.openlocfilehash: 7131eec581f973738d1cacb45dd355e2b7168aeb
ms.sourcegitcommit: 531d0245f4b2730fad623a7aa61df1422c255edc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/01/2017
---
# <a name="high-availability-and-data-protection-for-availability-group-configurations"></a>Высокий уровень доступности и защиты данных в конфигурации группы доступности

[!INCLUDE[tsql-appliesto-sslinux-only](../includes/tsql-appliesto-sslinux-only.md)]

Эта статья содержит конфигурации развертывания, поддерживаемые для группы обеспечения доступности AlwaysOn в SQL Server на серверах Linux. Группа доступности поддерживает высокий уровень доступности и защите данных. Сбой автоматического обнаружения, автоматический переход на другой и прозрачный переподключения после отработки отказа обеспечения высокого уровня доступности. Синхронизированные реплики обеспечения защиты данных. 

В Windows Server отказоустойчивого кластера (WSFC), является обычной конфигурацией для обеспечения высокой доступности использует два синхронных реплик и третий сервера или общего ресурса для кворума. Файл ресурса-свидетеля проверяет конфигурацию группы доступности — состояние синхронизации и роль реплики, например. Эта конфигурация гарантирует, что вторичная реплика, выбрана, так как цель перехода содержит последние данные и изменения конфигурации группы доступности. 

WSFC синхронизирует метаданные конфигурации для перехода на другой ресурс разрешения конфликтов между реплики группы доступности и общей папке следящего сервера. Если группа доступности не находится в кластере WSFC, экземпляры SQL Server хранить метаданные конфигурации в базе данных master.

Например, группы доступности в кластере Linux имеет `CLUSTER_TYPE = EXTERNAL`. Не WSFC для перехода на другой ресурс, могут решать, не существует. В этом случае метаданные конфигурации управление и сохраняется в экземплярах SQL Server. Так как отсутствует следящий сервер в этом кластере, третий экземпляр SQL Server требуется для хранения метаданных состояние конфигурации. Все три экземпляра SQL Server обеспечивают распределенные метаданные хранилища для кластера. 

Диспетчер кластеров запросы к экземплярам SQL Server в группе доступности и оркестрации для поддержания высокого уровня доступности. В кластере Linux Pacemaker — диспетчер кластера. 

1 CU 2017 г. SQL Server обеспечивает высокий уровень доступности для группы доступности с `CLUSTER_TYPE = EXTERNAL` для двух синхронных реплик, а также конфигурации только реплики. Реплику только конфигурации может размещаться в любом выпуске SQL Server CU1 2017 г. или более поздней версии — включая SQL Server Express edition. Только реплики конфигурации поддерживает информацию о группе доступности базы данных master конфигурации, но не содержит пользовательских баз данных в группе доступности. 

## <a name="how-the-configuration-affects-default-resource-settings"></a>Влияние конфигурации параметров ресурсов по умолчанию

Представляет 2017 г. SQL Server `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` параметр ресурса кластера. Это обеспечит указанное число вторичных реплик записи данных транзакций перед первичная реплика фиксирует каждой транзакции. При использовании диспетчера кластеров внешних этот параметр влияет на высокий уровень доступности и защите данных. Значение по умолчанию для параметра зависит от архитектуры, во время создания ресурса кластера. При установке агента ресурсов SQL Server - `mssql-server-ha` - и создать ресурс кластера для группы доступности, диспетчер кластеров определяет доступность группы конфигурации и наборы `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` соответствующим образом. 

Если поддерживается конфигурацией, то параметр агента ресурсов `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` присвоено значение, которое обеспечивает высокий уровень доступности и защиты данных. Дополнительные сведения см. в разделе [агент SQL Server понять ресурсов для pacemaker](#pacemakerNotify).

В следующих разделах объясняется поведение по умолчанию для ресурса кластера. 

Выберите проект группы доступности в соответствии с определенным бизнес-требованиям высокого уровня доступности, защиту данных и чтения шкалы.

Следующие конфигурации описаны принципы разработки группы доступности и возможности каждого шаблона. Эти шаблоны проектирования применяются к группам доступности с `CLUSTER_TYPE = EXTERNAL` для решения высокого уровня доступности. 

- **Три синхронных реплик**
- **Два синхронных реплик**
- **Два синхронных реплик и единственной репликой конфигурации**

<a name="threeSynch"></a>

## <a name="three-synchronous-replicas"></a>Три синхронных реплик

Эта конфигурация состоит из трех синхронных реплик. По умолчанию он обеспечивает высокий уровень доступности и защиты данных. Он также может предоставлять чтения шкалы.

![Три реплики][3]

Группа доступности с тремя синхронных реплик может предоставить чтения масштабирования, высокого уровня доступности и защите данных. В следующей таблице описывается поведение доступности. 

| |чтение шкалы|Высокий уровень доступности & </br> Защита данных | Защита данных
|:---|---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 |1<sup>*</sup>|2
|Сбой первичной реплики | Переход на другой ресурс вручную. Возможна потеря данных. R — новый первичный / W. |Автоматический переход на другой ресурс. R — новый первичный / W. |Автоматический переход на другой ресурс. Новый сервер-источник недоступна для пользовательских транзакций, пока бывшей первичной восстанавливает и присоединяет группу доступности в качестве получателя. 
|Сбой одной вторичной реплики  | Основной R / W. Без автоматического перехода на другой ресурс при сбое основного. |Основной R / W. Без автоматического перехода на другой ресурс при сбое основной, а также. | Основной доступен не для пользовательских транзакций. 
<sup>*</sup>По умолчанию

<a name="twoSynch"></a>

## <a name="two-synchronous-replicas"></a>Два синхронных реплик

Такая конфигурация обеспечивает защиту данных. Как и другие конфигурации группы доступности ее можно включить чтения шкалы. Конфигурация два синхронных реплик не обеспечивает автоматическое высокого уровня доступности. 

![Два синхронных реплик][1]

Группы доступности с двумя синхронными репликами обеспечивает масштаб чтения и защиты данных. В следующей таблице описывается поведение доступности. 

| |чтение шкалы |Защита данных
|:---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>*</sup>|1
|Сбой первичной реплики | Переход на другой ресурс вручную. Возможна потеря данных. R — новый первичный / W.| Автоматический переход на другой ресурс. Новый сервер-источник недоступна для пользовательских транзакций, пока бывшей первичной восстанавливает и присоединяет группу доступности в качестве получателя.
|Сбой одной вторичной реплики  |Первичный — для чтения и записи, работой в незащищенном режиме к потере данных. |Основной доступен не для пользовательских транзакций до получателя выполнено восстановление.
<sup>*</sup>По умолчанию

>[!NOTE]
>Поведение до SQL Server 2017 г накопительным пакетом обновления 1 — в предыдущем сценарии. 

<a name = "configOnly"></a>

## <a name="two-synchronous-replicas-and-a-configuration-only-replica"></a>Два синхронных реплик и единственной репликой конфигурации

Группа доступности с два (или более) синхронные реплики и реплики только конфигурация обеспечивает защиту данных и также могут обеспечить высокий уровень доступности. Следующая диаграмма представляет эта архитектура:

![Группа доступности только для конфигурации][2]

1. Синхронная репликация данных пользователя на вторичную реплику. Он также включает метаданные конфигурации группы доступности.
2. Синхронная репликация метаданные конфигурации группы доступности. Он не включает данные пользователя.

На диаграмме группы доступности первичная реплика отправляет данные конфигурации вторичной реплики и реплики только конфигурации. Вторичная реплика также принимает данные пользователя. Только реплики конфигурации не получает данные пользователя. Вторичная реплика находится в режиме доступности синхронной. Только реплики конфигурации не содержит баз данных в группе доступности - только метаданные о группе доступности. Данные конфигурации реплики только конфигурации фиксируется синхронно.

>[!NOTE]
>Группы availabilility с единственной репликой конфигурации является новым для SQL Server CU1 2017 г. Все экземпляры SQL Server в группе доступности должны быть CU1 2017 г. SQL Server или более поздней версии. 

Значение по умолчанию для `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` равно 0. В следующей таблице описывается поведение доступности. 

| |Высокий уровень доступности & </br> Защита данных | Защита данных
|:---|---|---
|`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT=`|0 <sup>*</sup>|1
|Сбой первичной реплики | Автоматический переход на другой ресурс. R — новый первичный / W. | Автоматический переход на другой ресурс. Новый сервер-источник недоступен для пользовательских транзакций. 
|Вторичная реплика сбоя | Первичный — для чтения и записи, работой в незащищенном режиме к потере данных (если основной завершается ошибкой и не может быть восстановлена). Без автоматического перехода на другой ресурс при сбое основной, а также. | Основной доступен не для пользовательских транзакций. Ни одна из реплик на переход к, если первичная невозможна. 
|Только реплики простой конфигурации | Основной R / W. Без автоматического перехода на другой ресурс при сбое основной, а также. | Основной R / W. Без автоматического перехода на другой ресурс при сбое основной, а также. 
|Синхронного сервера-получателя + конфигурации только для отключения реплики| Основной доступен не для пользовательских транзакций. Автоматическая отработка отказа. | Основной доступен не для пользовательских транзакций. Переход на другой ресурс, если ни одна из реплик также основной завершается ошибкой. 
<sup>*</sup>По умолчанию

>[!NOTE]
>Экземпляр SQL Server, на котором размещена реплика только конфигурации может также содержать другие базы данных. Он также может выступать только базу данных конфигурации для более чем одной группы доступности. 

## <a name="requirements"></a>Требования

* Все реплики в группу доступности с репликами только конфигурации должен быть SQL Server 2017 г накопительным пакетом обновления 1 или более поздней версии.
* Любой выпуск SQL Server может размещать реплику только конфигурации, включая SQL Server Express. 
* Группа доступности должна по крайней мере одна вторичная реплика - дополнение к первичной реплике.
* Максимальное число реплик на один экземпляр SQL Server не считаются конфигурации реплики. SQL Server standard edition поддерживает до трех реплик, SQL Server Enterprise Edition позволяет до 9.

## <a name="considerations"></a>Замечания

* Только реплики не более чем одна конфигурация каждой группы доступности. 
* Только реплики конфигурации не может быть первичной реплики.
* Невозможно изменить режим доступности реплики конфигурации. Чтобы изменить только конфигурации реплики синхронной или асинхронной вторичной реплики, удаление реплики только конфигурации и добавление вторичной реплики с режимом требуемый уровень доступности. 
* Конфигурации только реплика является синхронным по метаданных группы доступности. Нет данных пользователя. 
* Группа доступности с одну первичную реплику и реплицируют только одна конфигурация, но ни одна вторичная реплика не является допустимым. 
* Не удается создать группу доступности на экземпляре SQL Server Express edition. 

<a name="pacemakerNotify"></a>

## <a name="understand-sql-server-resource-agent-for-pacemaker"></a>Понимать ресурс агента SQL Server для pacemaker

SQL Server 2017 г CTP-версии 1.4 добавлена `sequence_number` для `sys.availability_groups` разрешающее Pacemaker определить порядок обновления получателя будут реплики с первичной репликой. `sequence_number`— монотонно возрастающее значение типа BIGINT, представляющее порядок обновления реплики группы доступности локальных ресурсов. Обновления pacemaker `sequence_number` с каждым изменением конфигурации группы доступности. Изменения конфигурации примеры перехода на другой ресурс, реплика сложения или удаления. Число обновлены на сервере-источнике, а затем реплицируются во вторичные реплики. Таким образом вторичную реплику, которая имеет актуальную конфигурацию имеет тем же порядковым номером, что и первичная. 

Когда Pacemaker решает promote реплика-источник, он сначала отправляет *предварительно promote* уведомления для всех реплик. Реплики возвращает порядковый номер. Далее когда Pacemaker фактически пытается повысить уровень реплики на основной, реплики только повышает уровень сам если его порядковый номер — самым высоким порядковых номеров. Если порядковый номер не соответствует наибольший порядковый номер, реплика отклоняет promote операции. Таким образом, до первичной реплики может быть обновлена только реплика с наибольшим значением порядкового номера, что позволяет избежать потери данных. 

Этот процесс требует доступен хотя бы одна реплика для повышения уровня с тем же порядковым номером предыдущей первичной. Наборы Pacemaker ресурсов агента `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` таким образом, что по крайней мере одна реплика вторичной и имеет актуальную версию доступной целью автоматического перехода на другой ресурс по умолчанию. С каждой действие мониторинга значение `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` вычисляется (и обновление при необходимости). `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` Значение «число синхронных реплик» деленному на 2. Во время перехода на другой ресурс требуется агент ресурсов (`total number of replicas`  -  `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` реплик) реагировать на предварительно promote уведомления. Реплика с самым высоким `sequence_number` повышается до основного. 

Например группа доступности с тремя синхронные реплики - одну первичную реплику и двух синхронных вторичных реплик.

- `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT`-1; (3 / 2 -> 1).

- Требуемое количество реплик реагировать на предварительно преобразовать действие — 2. (3 - 1 = 2). 

В этом случае ответ для отработки отказа, чтобы оно запускалось у двух реплик. Для успешного автоматического перехода на другой после сбоя первичной реплики обоих вторичные реплики должны актуальные и реагировать на предварительно promote уведомления. В таком случае online и синхронный они имеют один и тот же номер последовательности. Группы доступности повышает уровень одного из них. Если только одной из вторичных реплик реагирует на предварительно преобразовать действие, не может гарантировать ресурсов агента, сервер-получатель, ответившего имеет наивысший sequence_number и отработки отказа не происходит.

>[!IMPORTANT]
>Нулевое значение `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` создает риск потери данных. Во время сбоя первичной реплики агент ресурса не вызывает изменения автоматически отработки отказа. Можно ожидать первичный для восстановления, или вручную при сбое с помощью `FORCE_FAILOVER_ALLOW_DATA_LOSS`.

Вы можете переопределить поведение по умолчанию и предотвратить параметр группы доступности `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` автоматически.

Следующий скрипт задает `REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` 0 для группы доступности с именем `<**ag1**>`. Прежде чем выполнять переход, замените `<**ag1**>` на имя группы доступности.

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=0
```

Чтобы восстановить значения по умолчанию на основании конфигурации группы доступности запуска:

```bash
sudo pcs resource update <**ag1**> required_synchronized_secondaries_to_commit=
```

>[!NOTE]
>При выполнении предыдущей команды основной временно переводится в режим получателей, затем повторно повышается. Обновление ресурсов приводит все реплики остановить и перезапустить. Новое значение`REQUIRED_SYNCHRONIZED_SECONDARIES_TO_COMMIT` устанавливается только после перезапуска реплики, а не мгновенно.

## <a name="see-also"></a>См. также

[Группы доступности в Linux](sql-server-linux-availability-group-overview.md)

<!--Image references-->
[1]: ./media/sql-server-linux-availability-group-ha/1-read-scale-out.png
[2]: ./media/sql-server-linux-availability-group-ha/2-configuration-only.png
[3]: ./media/sql-server-linux-availability-group-ha/3-three-replica.png
[4]: ./media/sql-server-linux-availability-group-ha/configuration-only-example.png
