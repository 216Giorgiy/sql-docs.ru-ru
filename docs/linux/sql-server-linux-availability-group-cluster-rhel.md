---
title: "Настройка RHEL кластера для группы доступности SQL Server | Документы Microsoft"
description: 
author: MikeRayMSFT
ms.author: mikeray
manager: jhubbard
ms.date: 06/14/2017
ms.topic: article
ms.prod: sql-linux
ms.technology: database-engine
ms.assetid: b7102919-878b-4c08-a8c3-8500b7b42397
ms.translationtype: MT
ms.sourcegitcommit: 1419847dd47435cef775a2c55c0578ff4406cddc
ms.openlocfilehash: 7930fd8cee6f6fabe00a711f9109573e42550563
ms.contentlocale: ru-ru
ms.lasthandoff: 08/02/2017

---

# <a name="configure-rhel-cluster-for-sql-server-availability-group"></a>Настройка RHEL кластера для группы доступности SQL Server

В этом документе описывается создание кластера группы доступности с тремя узлами для SQL Server в Red Hat Enterprise Linux. Для обеспечения высокой доступности группы доступности для Linux требует трех узлов — см. [высокий уровень доступности и защиты данных в конфигурации группы доступности](sql-server-linux-availability-group-ha.md). Уровень кластеризации основан на Red Hat Enterprise Linux (RHEL) [высокого уровня ДОСТУПНОСТИ надстройки](https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/pdf/High_Availability_Add-On_Overview/Red_Hat_Enterprise_Linux-6-High_Availability_Add-On_Overview-en-US.pdf) построены на основе [Pacemaker](http://clusterlabs.org/). 

> [!NOTE] 
> Доступ к полной документацией Red Hat требует допустимую подписку. 

Дополнительные сведения о конфигурации кластера, параметры агентов ресурсов и управления на сайте [RHEL справочной документации](http://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/index.html).

> [!NOTE] 
> SQL Server не интегрирована так же строго Pacemaker в Linux как в отказоустойчивой кластеризации Windows Server. Экземпляр SQL Server неизвестно кластера. Pacemaker обеспечивает согласование ресурса кластера. Кроме того имя виртуальной сети для отказоустойчивого кластера Windows Server — не имеет эквивалента в Pacemaker. Доступность группы динамические административные представления (DMV), запрашивать сведения о кластере возвращать пустые строки в кластерах Pacemaker. Чтобы создать прослушиватель для прозрачного переподключения после отработки отказа, вручную Зарегистрируйте имя прослушивателя в DNS с IP-адрес, используемый для создания виртуального IP-ресурс. 

Следующие разделы содержат пошаговые инструкции пошаговые инструкции по настройке кластера Pacemaker и добавить группы доступности в качестве ресурса кластера для обеспечения высокой доступности.

## <a name="roadmap"></a>Стратегия

Инструкции по созданию группы доступности на серверах Linux для обеспечения высокой доступности, отличаются от действия, указанные на отказоустойчивом кластере Windows Server. Ниже приводятся общие действия. 

1. [Настройка SQL Server на узлах кластера](sql-server-linux-setup.md).

2. [Создание группы доступности](sql-server-linux-availability-group-configure-ha.md). 

3. Настройте диспетчер ресурсов кластера, например Pacemaker. Эти инструкции приведены в этом документе.
   
   Способ настройки диспетчер ресурсов кластера зависит от конкретных дистрибутивах Linux. 

   >[!IMPORTANT]
   >Рабочих средах требуется агент разграничения, например STONITH для обеспечения высокой доступности. Демонстрации в этой документации не используйте разграничения агентов. Для тестирования и проверки только являются демонстраций. 
   
   >Кластер Linux использует разграничения для возвращения известного состояния кластера. Способ настройки разграничения зависит от того, распределение и среды. В настоящее время разграничения недоступна в некоторых средах облака. Дополнительные сведения см. в разделе [политики поддержки для высокой доступности кластеров RHEL - платформ виртуализации](https://access.redhat.com/articles/29440).

5. [Добавление группы доступности в качестве ресурса кластера](sql-server-linux-availability-group-cluster-rhel.md#create-availability-group-resource).  

## <a name="configure-high-availability-for-rhel"></a>Настройка высокой доступности для RHEL

Для настройки высокой доступности для RHEL, включите подписку высокого уровня доступности, а затем настройте Pacemaker.

### <a name="enable-the-high-availability-subscription-for-rhel"></a>Включение подписки высокого уровня доступности для RHEL

Каждый узел в кластере необходимо иметь соответствующие подписку RHEL и высокий уровень доступности, добавьте на. Ознакомьтесь с требованиями на [Установка пакетов кластера высокой доступности в Red Hat Enterprise Linux](http://access.redhat.com/solutions/45930). Выполните следующие действия для настройки подписки и репозиториев.

1. Зарегистрируйтесь в системе.

   ```bash
   sudo subscription-manager register
   ```

   Укажите имя пользователя и пароль.   

1. Список доступных пулов для регистрации.

   ```bash
   sudo subscription-manager list --available
   ```

   Из списка доступных пулов Обратите внимание, идентификатор пула для подписки высокого уровня доступности.

1. Обновите следующий скрипт. Замените `<pool id>` с Идентификатором пула для обеспечения высокой доступности на предыдущем шаге. Запустите скрипт для присоединения подписки.

   ```bash
   sudo subscription-manager attach --pool=<pool id>
   ```

1. Включите репозитория.

   ```bash
   sudo subscription-manager repos --enable=rhel-ha-for-rhel-7-server-rpms
   ```

Дополнительные сведения см. в разделе [Pacemaker — с открытым кодом, высокий уровень доступности кластера](http://www.opensourcerers.org/pacemaker-the-open-source-high-availability-cluster/). 

После настройки подписки, выполните следующие действия по настройке Pacemaker.

### <a name="configure-pacemaker"></a>Настройка Pacemaker

После регистрации подписки, выполните следующие действия по настройке Pacemaker.
   
[!INCLUDE [RHEL-Configure-Pacemaker](../includes/ss-linux-cluster-pacemaker-configure-rhel.md)]

После настройки Pacemaker использовать `pcs` для взаимодействия с кластером. Выполните все команды на один узел из кластера. 

## <a name="configure-fencing-stonith"></a>Настройка разграничения (STONITH)

Pacemaker кластера поставщиков требуют STONITH должно быть включено и разграничения устройству, настроенному для поддерживаемых кластера. STONITH расшифровывается как «прокрутить другой узел в начало». Когда диспетчер ресурсов кластера не удается определить состояние узла или ресурса на узле, разграничения снова переводит кластера в известное состояние.

Ресурс уровня разграничения гарантирует, что без повреждения данных в случае сбоя путем настройки ресурса. Например, можно использовать ресурс уровня разграничения пометить диск на узле как устаревший, когда канал связи выходит из строя. 

Узел уровня разграничения гарантирует узла не выполняет какие-либо ресурсы. Это делается путем сброса узла. Pacemaker поддерживает разнообразных ограждения устройств. Примеры источников бесперебойного питания питания или управления карт для серверов.

Сведения о STONITH и разграничения см. в следующих статьях:

* [Pacemaker кластеры с нуля](http://clusterlabs.org/doc/en-US/Pacemaker/1.1-plugin/html/Clusters_from_Scratch/ch05.html)
* [Разграничения и STONITH](http://clusterlabs.org/doc/crm_fencing.html)
* [Red Hat надстройку высокого уровня доступности с Pacemaker: ограждения](http://access.redhat.com/documentation/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/ch-fencing-HAAR.html)

Поскольку уровень узла ограждения конфигурации сильно зависит от среды, отключите его для этого учебника (его можно настроить позже). Следующий скрипт отключает разграничения уровня узла:

```bash
sudo pcs property set stonith-enabled=false
```
  
>[!IMPORTANT]
>Отключение STONITH — только для целей тестирования. Если вы планируете использовать Pacemaker в рабочей среде, следует планировать реализацию STONITH в зависимости от среды и хранить включена. RHEL не предоставляет разграничения агентов для облачных сред (включая Azure) или Hyper-V. Следовательно поставщика кластера не обеспечивает поддержку для запуска рабочих кластерах в этих средах. Мы работаем над решением для пропуска, будут доступны в будущих выпусках.

## <a name="set-cluster-property-start-failure-is-fatal-to-false"></a>Значение свойства кластера start сбой является Неустранимая false

`start-failure-is-fatal`Указывает ли сбой запуска ресурса на узле предотвращает последующие попытки запуска на этом узле. Если задано значение `false`, кластер решает, следует ли попробуйте запустить на том же узле, еще раз на основании ресурса текущего счетчика и миграции Порог сбоя. После перехода на другой ресурс, Pacemaker повторных попыток запуска доступности группы ресурсов прежней основной после экземпляра SQL Server. Pacemaker можно понизить уровень вторичную реплику, и автоматически подключится к группе доступности. 

Чтобы обновить значение свойства `false` запуска:

```bash
sudo pcs property set start-failure-is-fatal=false
```

>[!WARNING]
>После автоматического перехода на другой ресурс при `start-failure-is-fatal = true` попытается запустить ресурс диспетчера ресурсов. В случае неудачи при первой попытке вручную запустить `pcs resource cleanup <resourceName>` для очистки количество сбоев ресурсов и сбросить конфигурацию.

Сведения о свойствах Pacemaker кластера см. в разделе [Pacemaker кластеры свойства](http://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/ch-clusteropts-HAAR.html).

## <a name="create-a-sql-server-login-for-pacemaker"></a>Создайте имя входа SQL Server для Pacemaker

[!INCLUDE [SQL-Create-SQL-Login](../includes/ss-linux-cluster-pacemaker-create-login.md)]

## <a name="create-availability-group-resource"></a>Создание группы доступности

Чтобы создать ресурс группы доступности, используйте `pcs resource create` команды и задать свойства ресурса. Следующая команда создает `ocf:mssql:ag` ведущий и ведомый типа ресурса для группы доступности с именем `ag1`.

```bash
sudo pcs resource create ag_cluster ocf:mssql:ag ag_name=ag1 --master meta notify=true
```

[!INCLUDE [required-synchronized-secondaries-default](../includes/ss-linux-cluster-required-synchronized-secondaries-default.md)]

<a name="createIP"></a>

## <a name="create-virtual-ip-resource"></a>Создайте виртуальные IP-адреса

Чтобы создать виртуальный ресурс IP-адреса, выполните следующую команду на одном узле. Используйте статический IP-адрес доступен по сети. Замените между IP-адресом `**<10.128.16.240>**` допустимый IP-адрес.

```bash
sudo pcs resource create virtualip ocf:heartbeat:IPaddr2 ip=**<10.128.16.240>**
```

Отсутствует эквивалент в Pacemaker имя виртуального сервера. Чтобы использовать строку соединения, которая указывает на строковое имя сервера вместо IP-адреса, зарегистрируйте виртуальный IP-адрес ресурса и имя нужного виртуального сервера в DNS. Для конфигураций аварийного восстановления Зарегистрируйте имя нужного виртуального сервера и IP-адрес в DNS-серверов на основном сервере и сайт аварийного восстановления.

## <a name="add-colocation-constraint"></a>Добавить ограничение совместного размещения

Практически каждое решение в кластере Pacemaker, такие как выбор, где должны запускаться ресурс выполняется путем сравнения оценок. Результаты вычисляются для каждого ресурса. Диспетчер ресурсов кластера выбирает узел с высший показатель для конкретного ресурса. Если узел имеет отрицательный показатель для ресурса, ресурс может быть выполнен на этом узле.

В кластере pacemaker можно управлять решения кластера с ограничениями. Ограничения имеют оценку. Если ограничение имеет показатель меньше `INFINITY`, Pacemaker считает его в качестве рекомендации. Показатель `INFINITY` является обязательным.

Чтобы гарантировать, что первичная реплика и виртуального IP-адреса ресурсов запущен на том же узле, определите ограничение совместного размещения с оценкой бесконечность. Чтобы добавить ограничение совместного размещения, выполните следующую команду на одном узле.

```bash
sudo pcs constraint colocation add virtualip ag_cluster-master INFINITY with-rsc-role=Master
```

## <a name="add-ordering-constraint"></a>Добавить ограничение порядка сортировки

Ограничение совместного размещения имеет неявное ограничение порядка сортировки. Он перемещает виртуальные IP-адреса, прежде чем перейти в ресурс группы доступности. По умолчанию является последовательность событий:

1. Пользователь выполняет `pcs resource move` группой доступности первичной из узел1 и узел2.
1. Виртуальные IP-адреса останавливается на узле 1.
1. Виртуальные IP-адреса запускается на узле 2.
  
   >[!NOTE]
   >На этом этапе IP-адрес временно указывает на узел 2 пока узел 2 по-прежнему pre-отработки отказа Вторичная. 
   
1. Источник на узле 1 группы доступности будет понижен до получателя.
1. Группы доступности вторичной базы данных на узле 2 повышается до основного. 

Чтобы предотвратить временно указывающие на узел с данными дополнительных pre-отработки отказа IP-адрес, добавьте ограничением порядка сортировки. 

Чтобы добавить упорядочивания ограничение, выполните следующую команду на одном узле:

```bash
sudo pcs constraint order promote ag_cluster-master then start virtualip
```

>[!IMPORTANT]
>После настройки кластера и добавить группу доступности в качестве ресурса кластера, Transact-SQL нельзя использовать для отработки отказа ресурсов группы доступности. Ресурсы кластера SQL Server в Linux не связаны тесно как с операционной системой, как и на кластере отработки отказа Windows Server (WSFC). Службы SQL Server не имеет сведений о присутствии кластера. Все взаимодействие осуществляется с помощью средства управления кластером. В RHEL или Ubuntu использовать `pcs` и используется для SLES `crm` средства. 

Вручную переключить группу доступности с `pcs`. Инициирует переход на другой ресурс с помощью Transact-SQL. Инструкции см. в разделе [перехода на другой ресурс](sql-server-linux-availability-group-failover-ha.md#failover).

## <a name="next-steps"></a>Следующие шаги

[Работать с высокой ДОСТУПНОСТИ группы доступности](sql-server-linux-availability-group-failover-ha.md)

