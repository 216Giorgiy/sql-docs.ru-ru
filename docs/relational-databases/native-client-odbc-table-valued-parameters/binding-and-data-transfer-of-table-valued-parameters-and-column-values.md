---
title: Привязка и передача данных возвращающих табличные значения параметров и значений столбцов | Документы Microsoft
ms.custom: ''
ms.date: 04/04/2017
ms.prod: sql
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.service: ''
ms.component: native-client-odbc-table-valued-parameters
ms.reviewer: ''
ms.suite: sql
ms.technology: ''
ms.tgt_pltfrm: ''
ms.topic: reference
helpviewer_keywords:
- table-valued parameters (ODBC), binding and data transfer
ms.assetid: 0a2ea462-d613-42b6-870f-c7fa086a6b42
caps.latest.revision: 28
author: MightyPen
ms.author: genemi
manager: craigg
ms.workload: Inactive
monikerRange: '>= aps-pdw-2016 || = azuresqldb-current || = azure-sqldw-latest || >= sql-server-2016 || = sqlallproducts-allversions'
ms.openlocfilehash: fe37d43513051134632215cc6b551d8ec471b736
ms.sourcegitcommit: 7a6df3fd5bea9282ecdeffa94d13ea1da6def80a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
---
# <a name="binding-and-data-transfer-of-table-valued-parameters-and-column-values"></a>Привязка и передача данных возвращающих табличное значение параметров и значений столбцов
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]
[!INCLUDE[SNAC_Deprecated](../../includes/snac-deprecated.md)]

  Возвращающие табличное значение параметры, как и другие параметры, нуждаются в привязке до их передачи на сервер. Приложение привязывает возвращающие табличные значения параметров так же, оно привязывает другие параметры: с помощью SQLBindParameter или эквивалентные вызовы SQLSetDescField или SQLSetDescRec. Типом данных на сервере для параметра, возвращающего табличное значение, является SQL_SS_TABLE. Тип C может иметь значение SQL_C_DEFAULT или SQL_C_BINARY.  
  
 В [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] и более поздних версиях возвращающие табличное значение параметры поддерживаются только как входные. Поэтому любая попытка установить для SQL_DESC_PARAMETER_TYPE значение, отличное от SQL_PARAM_INPUT, приведет к возникновению ошибки SQL_ERROR с SQLSTATE = HY105 и появлению сообщения «Недопустимый тип параметра».  
  
 Можно назначать значение по умолчанию для целых столбцов возвращающих табличное значение параметров с помощью атрибута SQL_CA_SS_COL_HAS_DEFAULT_VALUE. Значения столбца отдельных параметров, возвращающих табличные значения, однако нельзя задать значения по умолчанию с помощью значения SQL_DEFAULT_PARAM параметра *StrLen_or_IndPtr* с SQLBindParameter. Возвращающие табличные значения параметров в целом не может быть присвоено значение по умолчанию с помощью значения SQL_DEFAULT_PARAM параметра *StrLen_or_IndPtr* с SQLBindParameter. Если эти правила нарушены, SQLExecute или SQLExecDirect возвращает значение SQL_ERROR. Будет создана диагностическая запись с кодом SQLSTATE = 07S01 и сообщением «недопустимое использование параметра по умолчанию для параметра \<p >», где \<p > — порядковый номер возвращающего табличное значение Параметра в инструкции запроса.  
  
 После привязки возвращающего табличное значение параметра приложение должно выполнить привязку каждого столбца параметров, возвращающих табличное значение. Для этого приложения сначала вызывает SQLSetStmtAttr присваивающий параметру SQL_SOPT_SS_PARAM_FOCUS порядковый номер возвращающего табличное значение параметра. Затем приложение выполняет привязку столбцов возвращающих табличные значения параметра с помощью вызовов следующих процедур: SQLBindParameter, SQLSetDescRec и SQLSetDescField. Присвоение атрибуту SQL_SOPT_SS_PARAM_FOCUS значения 0 восстанавливает обычное воздействие SQLBindParameter, SQLSetDescRec и SQLSetDescField при работе с параметры верхнего уровня.
 
 Примечание: для драйверов Mac ODBC и Linux с unixODBC 2.3.1 для 2.3.4, задавая имя возвращающего табличное значение Параметра через SQLSetDescField по полю дескриптора SQL_CA_SS_TYPE_NAME unixODBC не преобразуется автоматически из ANSI в Юникод строк, в зависимости от точное функция, вызываемая (SQLSetDescFieldA / SQLSetDescFieldW). Бывает необходимо всегда использовать SQLBindParameter или SQLSetDescFieldW строкой в Юникоде (UTF-16) присвойте имя возвращающего табличное значение Параметра.
  
 Для самого возвращающего табличное значение параметра никакие данные не передаются и не принимаются. Передаются и принимаются данные для каждого из столбцов, составляющих этот параметр. Поскольку табличное значение параметра представляет собой Псевдостолбец, параметры SQLBindParameter используются для ссылки на другие атрибуты, чем другие типы данных, следующим образом:  
  
|Параметр|Связанные атрибуты для невозвращающих табличного значения параметров, в том числе столбцов|Связанные атрибуты для возвращающих табличное значение параметров|  
|---------------|--------------------------------------------------------------------------------|----------------------------------------------------|  
|*InputOutputType*|SQL_DESC_PARAMETER_TYPE в IPD.<br /><br /> Для столбцов, возвращающих табличное значение параметров, этот атрибут должен совпадать с настройкой для самого возвращающего табличное значение параметра.|SQL_DESC_PARAMETER_TYPE в IPD.<br /><br /> Это должен быть атрибут SQL_PARAM_INPUT.|  
|*ValueType*|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в APD.|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в APD.<br /><br /> Это должен быть атрибут SQL_C_DEFAULT или SQL_C_BINARY.|  
|*ParameterType*|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в IPD.|SQL_DESC_TYPE, SQL_DESC_CONCISE_TYPE в IPD.<br /><br /> Это должен быть атрибут SQL_SS_TABLE.|  
|*ColumnSize*|SQL_DESC_LENGTH или SQL_DESC_PRECISION в IPD.<br /><br /> Это зависит от значения *ParameterType*.|SQL_DESC_ARRAY_SIZE<br /><br /> Значение этого атрибута можно задать также с помощью атрибута SQL_ATTR_PARAM_SET_SIZE, когда фокус параметра установлен на возвращающий табличное значение параметр.<br /><br /> Для возвращающего табличное значение параметра эта величина равна количеству строк в буферах столбцов данного параметра.|  
|*DecimalDigits*|SQL_DESC_PRECISION или SQL_DESC_SCALE в IPD.|Не используется. Атрибут должен иметь значение 0.<br /><br /> Если значение параметра не равно 0, будет SQLBindParameter будут формироваться возврата SQL_ERROR и создается диагностическая запись с кодом SQLSTATE = HY104 и сообщением «Недопустимая точность или масштаб».|  
|*ParameterValuePtr*|SQL_DESC_DATA_PTR в APD.|SQL_CA_SS_TYPE_NAME.<br /><br /> Необязательный атрибут для вызова хранимых процедур. Если значение не нужно, можно задать NULL. Для инструкций SQL, не являющихся вызовами процедур, атрибут должен быть задан.<br /><br /> Этот параметр также служит уникальным значением, по которому приложение может узнать конкретный возвращающий табличное значение параметр при использовании переменной строковой привязки. Дополнительные сведения см. в подразделе «Переменная строковая привязка возвращающих табличное значение параметров» далее в этом разделе.<br /><br /> Имя типа возвращающего табличное значение параметра указан во время вызова SQLBindParameter, необходимо указать как значение Юникода, даже в тех приложениях, построенных с кодировкой ANSI. Значение, используемое для параметра *StrLen_or_IndPtr* должен быть SQL_NTS или длина строки имени, умноженную на sizeof(WCHAR).|  
|*BufferLength*|SQL_DESC_OCTET_LENGTH в APD.|Длина имени типа возвращающего табличное значение параметра в байтах.<br /><br /> Значение может быть равно SQL_NTS, если имя типа представляет собой строку, завершающуюся нулем, или 0, если имя типа возвращающего табличное значение параметра не требуется.|  
|*StrLen_or_IndPtr*|SQL_DESC_OCTET_LENGTH_PTR в APD.|SQL_DESC_OCTET_LENGTH_PTR в APD.<br /><br /> Для возвращающих табличное значение параметров этот атрибут хранит не длину данных, а количество строк.|  
  
 Для возвращающих табличное значение параметров поддерживаются два режима передачи данных: фиксированная и переменная привязка строк.  
  
## <a name="fixed-table-valued-parameter-row-binding"></a>Фиксированная привязка строк возвращающего табличное значение параметра  
 Для фиксированной привязки строк приложение выделяет буферы (или буферные массивы), достаточно большие для всех возможных значений входных столбцов. Приложение выполняет следующие действия.  
  
1.  С помощью вызовов SQLBindParameter, SQLSetDescRec или SQLSetDescField привязку всех параметров.  
  
    1.  Присваивает атрибуту SQL_DESC_ARRAY_SIZE значение максимально возможного числа рядов, которые можно передать для каждого возвращающего табличное значение параметра. Это можно сделать в вызове функции SQLBindParameter.  
  
2.  Вызывает SQLSetStmtAttr присваивающий параметру SQL_SOPT_SS_PARAM_FOCUS порядковый номер каждого возвращающего табличное значение параметра.  
  
    1.  Для каждого параметра, возвращающие табличные значения привязывает столбцы возвращающего табличное значение параметра, используя вызовы SQLBindParameter, SQLSetDescRec или SQLSetDescField.  
  
    2.  Для каждого столбца табличное значение параметра, которые будут иметь значения по умолчанию вызывает SQLSetDescField, чтобы присвоить атрибуту SQL_CA_SS_COL_HAS_DEFAULT_VALUE значение 1.  
  
3.  Вызывает SQLSetStmtAttr присваивающий параметру SQL_SOPT_SS_PARAM_FOCUS значение 0. Это необходимо сделать перед SQLExecute или SQLExecDirect вызывается. В противном случае функция вернет значение SQL_ERROR и будет создана диагностическая запись с параметром SQLSTATE=HY024 и сообщением «Недопустимое значение атрибута SQL_SOPT_SS_PARAM_FOCUS (атрибут должен быть равен нулю во время выполнения)».  
  
4.  Наборы *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR процедуры SQL_DEFAULT_PARAM для возвращающих табличные значения параметра нет строк или количество строк для будет передано при следующем вызове функции SQLExecute или SQLExecDirect, если возвращающие табличные значения параметр не имеет строк. *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR нельзя присвоить значение SQL_NULL_DATA для возвращающего табличное значение параметра как табличные параметры не допускают значения NULL (хотя столбцы, составляющие табличное значение параметра могут быть обнуляемыми). Если задано недопустимое значение SQLExecute или SQLExecDirect возвращает значение SQL_ERROR и создана диагностическая запись с кодом SQLSTATE = HY090 и сообщением «Недопустимая длина строки или буфера для параметра \<p >», где p — порядковый номер параметра.  
  
5.  Вызывает SQLExecute или SQLExecDirect.  
  
 Входные значения столбца возвращающих табличные значения параметров можно передавать по частям, если *StrLen_or_IndPtr* задано значение SQL_LEN_DATA_AT_EXEC (*длина*) или SQL_DATA_AT_EXEC для столбца. Это похоже на передачу значений по частям при использовании массивов параметров. Как и все параметры данных времени выполнения, SQLParamData не указывают какой строки массива драйвер запрашивает данные; приложение должно заботиться. Приложение не может делать никаких предположений о порядке, в котором драйвер будет запрашивать данные.  
  
## <a name="variable-table-valued-parameter-row-binding"></a>Переменная привязка строк возвращающего табличное значение параметра  
 Строки при использовании переменной привязки передаются пакетами во время выполнения, и приложение передает их драйверу по требованию. Это похоже на данные времени выполнения для отдельных значений параметров. Для переменной привязки строк приложение выполняет следующие действия.  
  
1.  Привязывает параметры и столбцы возвращающих табличное значение параметров, как описано в шагах с 1 по 3 предыдущего раздела «Фиксированная привязка строк возвращающего табличное значение параметра».  
  
2.  Наборы *StrLen_or_IndPtr* или SQL_DESC_OCTET_LENGTH_PTR для возвращающих табличные значения параметров, передаваемых во время выполнения в значение SQL_DATA_AT_EXEC. Если ни один из указанных атрибутов не установлен, параметр будет обрабатываться, как описано в предыдущем разделе.  
  
3.  Вызывает SQLExecute или SQLExecDirect. При наличии любых параметров типа SQL_PARAM_INPUT или SQL_PARAM_INPUT_OUTPUT, которые должны быть обработаны как параметры с данными времени выполнения, этот вызов функции вернет значение SQL_NEED_DATA. В этом случае приложение выполняет следующие действия.  
  
    -   Вызывает SQLParamData. Возвращает *ParameterValuePtr* значение для параметра данных во время выполнения и код возврата SQL_NEED_DATA. Когда все данные параметра был передан драйвер, SQLParamData возвращает SQL_SUCCESS, SQL_SUCCESS_WITH_INFO или SQL_ERROR. Для параметров данных во время выполнения *ParameterValuePtr*, которого совпадает со значением дескриптора поля SQL_DESC_DATA_PTR, можно рассматривать как уникальный токен параметра, для которого требуется значение. Этот токен передается приложением драйверу во время привязки, а затем передается обратно приложению во время выполнения.  
  
4.  Для отправки данных строк табличное значение параметра для возвращающих табличные значения параметры null, если табличное значение параметра не имеет строк, приложение вызывает SQLPutData с *StrLen_or_Ind* в значение SQL_DEFAULT_PARAM.  
  
     Для возвращающих табличное значение параметров, отличных от NULL, приложение выполняет следующие действия.  
  
    -   Наборы *Str_Len_or_Ind* для всех столбцов возвращающих табличные значения параметра с соответствующими значениями и заполняет буферы данных для столбцов возвращающих табличные значения параметров, которые не используют параметры с данными времени выполнения. Данные времени выполнения можно использовать для столбцов возвращающих табличное значение параметров, подобно тому, как обычные параметры могут передаваться драйверу по частям.  
  
    -   Вызывает SQLPutData с *Str_Len_or_Ind* числом строк будут отправляться на сервер. Любое значение, меньше 0 или больше SQL_DESC_ARRAY_SIZE или SQL_DEFAULT_PARAM, является ошибкой, и в этом случае вызов вернет состояние SQLSTATE HY090 с сообщением «Недопустимая длина строки или буфера». 0 означает, что все строки уже были переданы и в данном возвращающем табличное значение параметре данных больше нет (как указано во втором пункте данного списка). SQL_DEFAULT_PARAM можно использовать только в случае, если драйвер запрашивает данные возвращающего табличное значение параметра впервые (как описано в первом пункте данного списка).  
  
5.  После передачи всех строк вызывает SQLPutData для возвращающих табличные значения параметра с *Str_Len_or_Ind* значение 0, а затем переходит к шагу 3а, описанному выше.  
  
6.  Вызывает SQLParamData снова. В случае любого параметра данных во время выполнения, включая столбцы возвращающего табличное значение параметра, они будут опознаны по значению *ValuePtrPtr* возвращенных SQLParamData. Если доступны все значения столбцов, снова вернет SQLParamData *ParameterValuePtr* значения для параметров, возвращающих табличные значения и приложение начинается снова.  
  
## <a name="see-also"></a>См. также  
 [Возвращающие табличные значения параметров &#40;ODBC&#41;](../../relational-databases/native-client-odbc-table-valued-parameters/table-valued-parameters-odbc.md)  
  
  
