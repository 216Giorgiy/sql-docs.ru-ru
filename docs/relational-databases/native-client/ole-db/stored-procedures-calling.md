---
title: "Вызов хранимой процедуры (OLE DB) | Документы Microsoft"
ms.custom: 
ms.date: 03/16/2017
ms.prod: sql-non-specified
ms.prod_service: database-engine, sql-database, sql-data-warehouse, pdw
ms.service: 
ms.component: native-client-ole-db
ms.reviewer: 
ms.suite: sql
ms.technology: docset-sql-devref
ms.tgt_pltfrm: 
ms.topic: reference
helpviewer_keywords:
- calling stored procedures
- RPC escape sequence
- OLE DB, stored procedures
- parameters [SQL Server Native Client], OLE DB
- ODBC CALL escape sequence
- stored procedures [OLE DB], calling
- SQL Server Native Client OLE DB provider, stored procedures
ms.assetid: 8e5738e5-4bbe-4f34-bd69-0c0633290bdd
caps.latest.revision: "39"
author: JennieHubbard
ms.author: jhubbard
manager: jhubbard
ms.workload: Inactive
ms.openlocfilehash: 57c9413ed5a962c9bc2422e007d92ce88ffbebca
ms.sourcegitcommit: 44cd5c651488b5296fb679f6d43f50d068339a27
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2017
---
# <a name="stored-procedures---calling"></a>Хранимые процедуры - вызов
[!INCLUDE[appliesto-ss-asdb-asdw-pdw-md](../../../includes/appliesto-ss-asdb-asdw-pdw-md.md)]
[!INCLUDE[SNAC_Deprecated](../../../includes/snac-deprecated.md)]

  Хранимая процедура может иметь ноль и более параметров. Также она может возвращать значение. При использовании [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] поставщика OLE DB для собственного клиента параметры хранимой процедуре могут передаваться:  
  
-   Заданные в коде значения данных.  
  
-   Указание параметров с помощью маркера параметра (?), привязка программной переменной к маркеру параметра и последующее помещение значений данных в программную переменную.  
  
> [!NOTE]  
>  При вызове хранимых процедур [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] с использованием именованных параметров в OLE DB имена параметров должны начинаться со знака @. Это ограничение, характерное для [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. В поставщике OLE DB для собственного клиента [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] это ограничение соблюдается более строго, чем в компонентах MDAC.  
  
 Для поддержки параметров, **ICommandWithParameters** интерфейс, предоставленный в объекте command. Чтобы использовать параметры, потребитель сначала описывает параметры для поставщика путем вызова **ICommandWithParameters::SetParameterInfo** метод (или при необходимости подготавливает вызывающий оператор, который вызывает **GetParameterInfo** метода). Затем потребитель создает метод доступа, определяющий структуру буфера и помещающий значения параметров в этот буфер. Наконец, он передает дескриптор метода доступа и указатель на буфер **Execute**. При последующих вызовах **Execute**, потребитель помещает новые значения параметров в буфер и вызывает функцию **Execute** с указателем дескрипторов и буфера метода доступа.  
  
 Команда, вызывающая временную хранимую процедуру с помощью параметров необходимо сначала вызвать **ICommandWithParameters::SetParameterInfo** для определения сведений о параметрах, прежде чем команда может быть успешно подготовлен. Это происходит по той причине, что внутреннее имя временной хранимой процедуры отличается от внешнего имени, используемого клиентом, а SQLOLEDB не может запрашивать системные таблицы, чтобы определить сведения о параметрах временной хранимой процедуры.  
  
 Далее приведены шаги процесса привязки параметров.  
  
1.  Внесите сведения о параметре (имя параметра, специфическое для поставщика имя типа данных параметра или стандартное имя типа данных и т. д.) в массив структур DBPARAMBINDINFO. Каждая структура в массиве описывает один параметр. Этот массив передается в **SetParameterInfo** метод.  
  
2.  Вызовите **ICommandWithParameters::SetParameterInfo** метод, чтобы описать параметры для поставщика. **Метод SetParameterInfo** указывает собственного типа данных каждого параметра. **Метод SetParameterInfo** аргументы:  
  
    -   Количество параметров, для которых задаются сведения о типе.  
  
    -   Массив порядковых номеров параметров, для которых задаются сведения о типе.  
  
    -   Массив структур DBPARAMBINDINFO.  
  
3.  Создайте метод доступа к параметру с помощью **IAccessor::CreateAccessor** команды. Метод доступа указывает структуру буфера и помещает в буфер значения параметров. **CreateAccessor** команда создает метод доступа из набора привязок. Эти привязки описываются потребителем с помощью массива структур DBBINDING. Каждая привязка связывает отдельный параметр с буфером потребителя и содержит следующие сведения.  
  
    -   Порядковый номер параметра, к которому применяется привязка.  
  
    -   Что привязывается (значение данных, длина и состояние).  
  
    -   Смещение в буфере для каждой из этих частей.  
  
    -   Длина и тип значения данных в том виде, в котором оно представлено в буфере потребителя.  
  
     Метод доступа определяется его дескриптором типа HACCESSOR. Этот дескриптор возвращается **CreateAccessor** метод. Когда потребитель завершает использование метода доступа, пользователь должен вызвать **ReleaseAccessor** метод для освобождения памяти, он содержит.  
  
     Когда потребитель вызывает метод, такой как **ICommand::Execute**, он передает дескриптор методу доступа, а указатель непосредственно буферу. Поставщик использует этот метод доступа, чтобы определить способ передачи данных из буфера.  
  
4.  Заполните структуру DBPARAMS. Переменные потребителя значения берутся из какой входной параметр и в какой выходной параметр записываются значения передаются во время выполнения для **ICommand::Execute** в структуре DBPARAMS. Структура DBPARAMS включает три следующих элемента.  
  
    -   Указатель на буфер, из которого поставщик получает данные входных параметров и в который возвращает данные выходных параметров в соответствии с привязками, указанными дескриптором метода доступа.  
  
    -   Количество наборов параметров в буфере.  
  
    -   Дескриптор метода доступа, созданный на шаге 3 .  
  
5.  Выполните команду с помощью **ICommand::Execute**.  
  
## <a name="methods-of-calling-a-stored-procedure"></a>Методы вызова хранимых процедур  
 При выполнении хранимой процедуры в [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] поддерживает поставщик OLE DB для собственного клиента:  
  
-   Escape-последовательность ODBC CALL.  
  
-   Escape-последовательность удаленного вызова процедур (RPC).  
  
-   Инструкция [!INCLUDE[tsql](../../../includes/tsql-md.md)] EXECUTE.  
  
### <a name="odbc-call-escape-sequence"></a>Escape-последовательность ODBC CALL  
 Если вы знаете, сведения о параметрах, вызовите **ICommandWithParameters::SetParameterInfo** метод, чтобы описать параметры для поставщика. В противном случае, если для вызова хранимой процедуры используется синтаксис ODBC CALL, поставщик вызывает вспомогательную функцию для поиска сведений о параметрах хранимой процедуры.  
  
 Если сведения о параметрах (метаданные параметров) точно неизвестны, рекомендуется применять синтаксис ODBC CALL.  
  
 Общий синтаксис для вызова процедуры с помощью escape-последовательности ODBC CALL выглядит следующим образом.  
  
 {[**?=**]**call***procedure_name*[**(**[*parameter*][**,**[*parameter*]]... **)**]}  
  
 Например:  
  
```  
{call SalesByCategory('Produce', '1995')}  
```  
  
### <a name="rpc-escape-sequence"></a>Escape-последовательность RPC  
 Escape-последовательность RPC похожа на синтаксис ODBC CALL для вызова хранимой процедуры. Если нужно вызывать процедуру несколько раз, escape-последовательность RPC обеспечивает наиболее оптимальную производительность из всех трех методов вызова хранимой процедуры.  
  
 Если escape-последовательность RPC используется для выполнения хранимой процедуры, поставщик не вызывает вспомогательные функции для определения сведений о параметре, как в случае применения синтаксиса ODBC CALL. Синтаксис RPC проще синтаксиса ODBC CALL, поэтому команда анализируется быстрее, что увеличивает производительность. В этом случае необходимо предоставить сведения о параметрах, выполнив **ICommandWithParameters::SetParameterInfo**.  
  
 Escape-последовательность RPC требует наличия возвращаемого значения. Если хранимая процедура не возвращает значение, сервер по умолчанию возвращает 0. Кроме того, для хранимой процедуры нельзя открыть курсор [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Хранимая процедура подготавливается неявно и вызов **ICommandPrepare::Prepare** завершится ошибкой. Невозможно подготовить вызов RPC не могут запрашивать метаданные столбцов; Методы IColumnsInfo::GetColumnInfo и IColumnsRowset::GetColumnsRowset будут возвращать значение DB_E_NOTPREPARED.  
  
 Если известны все метаданные параметров, для выполнения хранимых процедур рекомендуется использовать escape-последовательность RPC.  
  
 Далее приведен пример escape-последовательности RPC для вызова хранимой процедуры.  
  
```  
{rpc SalesByCategory}  
```  
  
 Образец приложения, демонстрирующий escape-последовательность RPC, в разделе [выполнение хранимой процедуры &#40; С помощью синтаксиса RPC &#41; и обработки возвращаемых кодов и выходные параметры &#40; OLE DB &#41; ](../../../relational-databases/native-client-ole-db-how-to/results/execute-stored-procedure-with-rpc-and-process-output.md).  
  
### <a name="transact-sql-execute-statement"></a>Инструкция Transact-SQL EXECUTE  
 Escape-последовательность ODBC CALL и escape-последовательность RPC — это предпочтительные способы для вызова хранимой процедуры, а не [EXECUTE](../../../t-sql/language-elements/execute-transact-sql.md) инструкции. [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] Поставщик OLE DB для собственного клиента использует механизм RPC [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] для оптимизации обработки команд. Этот протокол RPC повышает производительность, устраняя большую часть обработки параметров и синтаксической проверки инструкций на сервере.  
  
 Это пример [!INCLUDE[tsql](../../../includes/tsql-md.md)] **EXECUTE** инструкции:  
  
```  
EXECUTE SalesByCategory 'Produce', '1995'  
```  
  
## <a name="see-also"></a>См. также:  
 [Хранимые процедуры](../../../relational-databases/native-client/ole-db/stored-procedures.md)  
  
  
