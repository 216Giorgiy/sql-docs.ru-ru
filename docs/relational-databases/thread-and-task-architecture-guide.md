---
title: Руководство по архитектуре потоков и задач | Документация Майкрософт
ms.custom: ''
ms.date: 10/26/2016
ms.prod: sql
ms.prod_service: database-engine, sql-database
ms.component: relational-databases-misc
ms.reviewer: ''
ms.suite: sql
ms.technology:
- database-engine
ms.tgt_pltfrm: ''
ms.topic: conceptual
helpviewer_keywords:
- guide, thread and task architecture
- thread and task architecture guide
ms.assetid: 925b42e0-c5ea-4829-8ece-a53c6cddad3b
caps.latest.revision: 3
author: rothja
ms.author: jroth
manager: craigg
monikerRange: =azuresqldb-current||>=sql-server-2016||=sqlallproducts-allversions||>=sql-server-linux-2017
ms.openlocfilehash: 9e9f6c052e436f0f35e38551af4bf795a9fee9ff
ms.sourcegitcommit: 4cd008a77f456b35204989bbdd31db352716bbe6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/06/2018
ms.locfileid: "39540404"
---
# <a name="thread-and-task-architecture-guide"></a>руководство по архитектуре потоков и задач
[!INCLUDE[appliesto-ss-asdb-xxxx-xxx-md](../includes/appliesto-ss-asdb-xxxx-xxx-md.md)]

Потоки — это возможность операционной системы, позволяющая разделить логику приложений на несколько одновременных путей выполнения. Эта особенность полезна, когда сложные приложения имеют много задач, которые могут выполняться одновременно. 

Когда операционная система выполняет экземпляр приложения, она создает модуль, называемый процессом, для управления экземпляром. Процесс имеет поток выполнения. Это ряд программных команд, выполненных кодом приложения. Например, если простое приложение имеет один набор команд, которые могут быть выполнены последовательно, есть только один путь выполнения или поток приложения. Более сложные приложения могут иметь несколько задач, которые могут выполняться одновременно, а не последовательно. Приложение может сделать это, запуская отдельные процессы для каждой задачи. Однако запуск процесса — это ресурсоемкая операция. Вместо этого приложение может запустить отдельные потоки. Они относительно менее ресурсоемки. Кроме этого, каждый поток можно запланировать для выполнения независимо от других потоков, связанных с процессом.

Потоки позволяют сложным приложениям более эффективно использовать ЦП, даже на компьютерах с одним ЦП. С одним ЦП только один поток может выполняться одновременно. Если один поток выполняет длительную операцию, которая не использует ЦП, например считывание с диска или запись на диск, другой поток может выполняться, пока первая операция не завершится. Возможность выполнять потоки, в то время как другие потоки ожидают завершения операции, позволяет приложению увеличить использование ЦП. Это особенно касается многопользовательских приложений, интенсивно использующих операции дискового ввода-вывода, например сервера базы данных. Компьютеры, имеющие несколько микропроцессоров или ЦП, могут выполнять одновременно по одному потоку на каждом ЦП. Например, если компьютер имеет восемь ЦП, он может выполнять одновременно восемь потоков.

## <a name="sql-server-batch-or-task-scheduling"></a>Работа с расписаниями задач и пакетов SQL Server

### <a name="allocating-threads-to-a-cpu"></a>Распределение потоков ЦП

По умолчанию каждый экземпляр SQL Server запускает определенный поток. Если функция подобия была включена, операционная система назначает поток конкретному ЦП. Операционная система распределяет потоки экземпляров SQL Server между микропроцессорами или ЦП компьютера в зависимости от загрузки. Иногда операционная система также может перенести поток из загруженного ЦП на другой. Компонент SQL Server Database Engine в свою очередь назначает рабочие потоки планировщикам, которые равномерно распределяют потоки между ЦП.

Параметр affinity mask задается с помощью инструкции [ALTER SERVER CONFIGURATION](../t-sql/statements/alter-server-configuration-transact-sql.md). Если параметр affinity mask не задан, экземпляр SQL Server равномерно распределяет рабочие потоки между планировщиками, которые не были исключены.

### <a name="using-the-lightweight-pooling-option"></a>параметр «использование упрощенных пулов»

Нагрузка, возникающая при контекстном переключении потоков, не очень высока. Для большинства экземпляров SQL Server выбор значения 0 или 1 для параметра "Использование упрощенных пулов" не вызовет заметного влияния на производительность. Воспользоваться преимуществами, связанными с параметром [Использование упрощенных пулов](../database-engine/configure-windows/lightweight-pooling-server-configuration-option.md) , могут только те экземпляры SQL Server, которые выполняются на компьютере со следующими характеристиками:    
* установлен мощный многопроцессорный сервер;
* все процессоры работают почти на пределе производительности;
* высок уровень переключения контекста.

В таких системах может наблюдаться небольшое повышение эффективности, если для параметра "Использование упрощенных пулов" установлено значение 1.

Использовать планирование в режиме волокон для выполнения распространенных операций не рекомендуется. Это может привести к снижению производительности, мешая нормальной работе переключения контекста. Кроме того, некоторые компоненты SQL Server не выполняются правильно в режиме волокон. Дополнительные сведения см. в разделе об использовании упрощенных пулов.

## <a name="thread-and-fiber-execution"></a>Выполнение потоков и волокон

В Microsoft Windows используется числовая система приоритетов, распределяющая выполняемые потоки по уровням от 1 до 31. Значение 0 зарезервировано для использования операционной системой. При наличии в очереди на выполнение нескольких потоков Windows сначала обслуживает поток с наивысшим приоритетом.

Каждый экземпляр SQL Server по умолчанию имеет уровень приоритета 7, что соответствует стандартному уровню. Это значение по умолчанию задает потокам SQL Server достаточно высокий уровень приоритета, позволяющий им получать достаточно ресурсов ЦП, не снижая производительность других приложений. 

Параметр конфигурации [priority boost](../database-engine/configure-windows/configure-the-priority-boost-server-configuration-option.md) используется для повышения приоритета потоков экземпляра SQL Server до значения 13. Это наивысший приоритет. Этот параметр назначает потокам SQL Server более высокий приоритет по отношению к другим приложениям. При этом потоки SQL Server в большинстве случаев будут обслуживаться в первую очередь, а потоки других приложений не смогут занимать ресурсы системы ранее потоков с более высоким приоритетом. Это, возможно, поможет повысить производительность сервера, на котором выполняются только экземпляры SQL Server. Но если в приложении SQL Server выполняется ресурсоемкая операция, не рекомендуется присваивать высокий приоритет другим приложениям, так как это может привести к загрузке ресурсов, необходимых для обслуживания потока SQL Server. 

Если на компьютере выполняется несколько экземпляров SQL Server, повышение приоритетов одних может привести к снижению производительности других. Кроме того, включение параметра priority boost может привести к простою других приложений и компонентов, выполняемых на компьютере. Таким образом, данный параметр рекомендуется использовать только в строго определенных условиях.


## <a name="hot-add-cpu"></a>ЦП с поддержкой горячей замены

ЦП с поддержкой горячей замены — это возможность динамически добавлять центральные процессоры в запущенную систему. Добавление центральных процессоров может осуществляться физически — путем добавления нового оборудования, логически — путем аппаратного секционирования в сети, виртуально — через уровень виртуализации. Начиная с версии SQL Server 2008 приложение SQL Server поддерживает ЦП с поддержкой горячей замены.

Требования для ЦП с поддержкой горячей замены:  
* оборудование с поддержкой ЦП с поддержкой горячей замены;
* 64-разрядный выпуск Windows Server 2008 Datacenter или Windows Server 2008 Enterprise Edition для операционных систем на платформе Itanium;
* наличие SQL Server Enterprise.
* SQL Server нельзя настроить на использование программной архитектуры NUMA. Дополнительные сведения о программной архитектуре NUMA см. в разделе [Архитектура Soft-NUMA (SQL Server)](../database-engine/configure-windows/soft-numa-sql-server.md).

SQL Server не начинает автоматически использовать добавленные ЦП. Благодаря этому SQL Server не использует ЦП, добавленные для каких-либо других целей. Добавив ЦП, выполните инструкцию [RECONFIGURE](../t-sql/language-elements/reconfigure-transact-sql.md) . Так SQL Server будет распознавать новые ЦП в качестве доступных ресурсов.

> [!NOTE]
> Для использования новых ЦП необходимо изменить настройки параметра [affinity64 mask](../database-engine/configure-windows/affinity64-mask-server-configuration-option.md) .
 

## <a name="best-practices-for-running-sql-server-on-computers-that-have-more-than-64-cpus"></a>Рекомендации по использованию SQL Server на компьютерах, которые имеют более 64 процессоров

### <a name="assigning-hardware-threads-with-cpus"></a>Назначение аппаратных потоков процессорам

Не используйте параметры конфигурации сервера affinity mask и affinity64 mask для привязки процессоров к определенным потокам. Эти параметры ограничены 64 процессорами. Вместо этого следует использовать параметр SET PROCESS AFFINITY инструкции [ALTER SERVER CONFIGURATION](../t-sql/statements/alter-server-configuration-transact-sql.md) .

### <a name="managing-the-transaction-log-file-size"></a>Управление размером файла журнала транзакций

Не следует полагаться на функцию автоувеличения для увеличения размера файла журнала транзакций. Увеличение журнала транзакций должно происходить последовательно. Увеличение журнала может помешать выполнению операций записи транзакций до тех пор, пока увеличение журнала не будет завершено. Вместо этого заранее выделите место для файлов журнала, установив размер файла в значение, достаточное для поддержки обычной рабочей нагрузки в среде.

### <a name="setting-max-degree-of-parallelism-for-index-operations"></a>Задание максимальной степени параллелизма для операций с индексами

На компьютерах, имеющих несколько процессоров, с помощью временного изменения модели восстановления базы данных на модель восстановления с неполным протоколированием или простую модель восстановления можно улучшить производительность операций с индексами, таких как создание или перестроение индексов. Эти операции с индексами могут создавать значительную нагрузку на журнал, а конфликт журнала может негативно повлиять на оптимальную степень параллелизма, выбранную SQL Server.

Кроме того, рассмотрите возможность настройки параметра **максимальной степени параллелизма (MAXDOP)** в конфигурации сервера для выполнения этих операций. Следующие рекомендации основаны на результатах внутренних тестов и носят общий характер. Попробуйте несколько различных параметров MAXDOP, чтобы определить оптимальное значение для вашей среды.

* Для модели полного восстановления укажите для максимальной степени параллелизма значение не больше 8.   
* Для модели с неполным протоколированием или простой модели восстановления можно указать для максимальной степени параллелизма значение больше 8.   
* Для серверов с настроенным компонентом NUMA максимальная степень параллелизма не должна превышать количество процессоров, назначенное каждому узлу NUMA. Это обусловлено тем, что запрос чаще всего использует локальную память первого узла NUMA, что может позволить улучшить время доступа к памяти.  
* Для серверов с включенным параметром гиперпоточности, произведенных до 2009 года включительно (до того как функция гиперпоточности была доработана), значение параметра MAXDOP не должно превышать число физических, а не логических процессоров.

Дополнительные сведения о параметре max degree of parallelism см. в статье [Настройка параметра конфигурации сервера max degree of parallelism](../database-engine/configure-windows/configure-the-max-degree-of-parallelism-server-configuration-option.md).

### <a name="setting-the-maximum-number-of-worker-threads"></a>Задание максимального числа рабочих потоков

Всегда задавайте максимальное число рабочих потоков таким образом, чтобы оно было больше параметра максимальной степени параллелизма. Количество рабочих потоков всегда должно быть по крайней мере в семь раз больше количества процессоров, имеющихся на сервере. Дополнительные сведения см. в статье [Настройка параметра конфигурации сервера max worker threads](../database-engine/configure-windows/configure-the-max-worker-threads-server-configuration-option.md).

### <a name="using-sql-trace-and-sql-server-profiler"></a>Использование приложения SQL Trace и SQL Server Profiler

 В рабочей среде использовать SQL Trace и SQL Server Profiler не рекомендуется. Издержки использования этих средств также увеличиваются по мере увеличения числа ЦП. Если в рабочей среде необходимо использовать приложение трассировки SQL, следует ограничить до минимума число отслеживаемых событий. Следует внимательно тестировать каждое событие трассировки под нагрузкой и избегать сочетания событий, которые могут значительно повлиять на производительность.

### <a name="setting-the-number-of-tempdb-data-files"></a>Задание количества файлов данных базы данных tempdb

Обычно число файлов данных tempdb должно соответствовать числу ЦП. Однако можно уменьшить ресурсы, используемые для управления базой данных, внимательно изучив параллельное использование базы данных tenpdb. Например, если в системе используется 64 ЦП, при этом только 32 запроса используют tempdb, увеличение числа файлов tempdb до 64 не приведет к улучшению производительности.

### <a name="sql-server-components-that-can-use-more-than-64-cpus"></a>Компоненты SQL Server, которые поддерживают более 64 процессоров

В следующей таблице перечислены компоненты SQL Server и указано, могут ли они использовать больше чем 64 ЦП.

|Имя процесса   |Исполняемая программа |Использование более 64 процессоров |  
|----------|----------|----------|  
|Компонент SQL Server Database Engine |Sqlserver.exe  |Да |  
|Службы Reporting Services |Rs.exe |нет |  
|Службы Analysis Services  |As.exe |нет |  
|Службы Integration Services   |Is.exe |нет |  
|Компонент Service Broker |Sb.exe |нет |  
|Компонент Full-text Search   |Fts.exe    |нет |  
|Агент SQL Server   |Sqlagent.exe   |нет |  
|SQL Server Management Studio   |Ssms.exe   |нет |  
|программа установки SQL Server   |Setup.exe  |нет |  


