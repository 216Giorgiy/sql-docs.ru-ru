---
title: Прозрачное шифрование данных для хранилища данных и базы данных SQL Azure | Документы Майкрософт
description: Общие сведения о прозрачном шифровании данных для хранилища данных и базы данных SQL. Этот документ описывает его преимущества и параметры конфигурации, включая прозрачное шифрование данных, управляемое службой, и создание собственных ключей.
keywords: ''
author: becczhang
manager: craigg
editor: ''
ms.prod: ''
ms.reviewer: ''
ms.suite: sql
ms.prod_service: sql-database, sql-data-warehouse
ms.service: sql-database
ms.tgt_pltfrm: ''
ms.topic: conceptual
ms.date: 05/08/2018
ms.author: rebeccaz
monikerRange: = azuresqldb-current || = sqlallproducts-allversions
ms.openlocfilehash: 1f545dcc5ea5ef018a6e2aaa750305245c211e69
ms.sourcegitcommit: a78fa85609a82e905de9db8b75d2e83257831ad9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/18/2018
ms.locfileid: "35695535"
---
# <a name="transparent-data-encryption-for-sql-database-and-data-warehouse"></a>Прозрачное шифрование данных для хранилища данных и базы данных SQL Azure
[!INCLUDE[appliesto-xx-asdb-asdw-xxx-md](../../../includes/appliesto-xx-asdb-asdw-xxx-md.md)]

Прозрачное шифрование данных (TDE) защищает хранилище данных Azure и базу данных SQL Azure от вредоносных действий. В реальном времени оно выполняет шифрование и расшифровку неактивной базы данных, а также неактивных связанных резервных копий и файлов журнала транзакций. При этом изменение приложения не требуется. Прозрачное шифрование данных включается по умолчанию для всех новых развертываемых баз данных SQL Azure, однако для старых баз данных его может потребоваться включить вручную.  

Прозрачное шифрование данных шифрует пространство хранения всей базы данных, используя симметричный ключ, который называется ключом шифрования базы данных. Ключ шифрования базы данных защищается средством защиты прозрачного шифрования данных. Оно представляет собой либо управляемый службой сертификат (прозрачное шифрование данных, управляемое службой), либо асимметричный ключ, хранящийся в Azure Key Vault (создание собственных ключей). Настройка средства защиты прозрачного шифрования данных производится на уровне сервера. 

При запуске базы данных зашифрованный ключ шифрования базы данных расшифровывается, а затем используется для расшифровки и повторного шифрования файлов базы данных в процессе ядра СУБД SQL Server. Прозрачное шифрование данных выполняет шифрование и расшифровку данных в операциях ввода-вывода на уровне страниц в реальном времени. Каждая страница расшифровывается при считывании в память и шифруется перед записью на диск. Общее описание прозрачного шифрования данных см. в статье [Прозрачное шифрование данных](transparent-data-encryption.md).

SQL Server, запущенный на виртуальной машине Azure, может также использовать асимметричный ключ из Key Vault. При этом этапы настройки будут не такими, как при использовании асимметричного ключа в базе данных SQL. Дополнительные сведения см. в статье [Расширенное управление ключами с помощью Azure Key Vault (SQL Server)](extensible-key-management-using-azure-key-vault-sql-server.md).

## <a name="service-managed-transparent-data-encryption"></a>Прозрачное шифрование данных, управляемое службой

В Azure параметр по умолчанию для прозрачного шифрования данных означает, что для защиты ключа шифрования базы данных используется встроенный сертификат сервера. Встроенный сертификат уникален для каждого сервера. Если база данных находится в отношении георепликации, база данных-источник и база данных-получатель с георепликацией защищаются ключом родительского сервера первичной базы данных. Если две базы данных подключены к одному серверу, используется один встроенный сертификат. Майкрософт автоматически меняет эти сертификаты каждые 90 дней.

Кроме того, Майкрософт прозрачно перемещает и администрирует ключи, когда это требуется для георепликации и восстановления. 

> [!IMPORTANT]
> По умолчанию все создаваемые базы данных SQL шифруются с использованием прозрачного шифрования данных, управляемого службой. Базы данных, существовавшие до мая 2017 года, и базы данных, созданные путем восстановления, георепликации и копирования, по умолчанию не шифруются.
>

## <a name="bring-your-own-key"></a>Создание собственных ключей

Поддержка создания собственных ключей позволяет управлять ключами прозрачного шифрования данных и контролировать, кто и когда может получать к ним доступ. Key Vault — это облачная внешняя система управления ключами Azure, которая является первой службой управления ключами, интегрированной с прозрачным шифрованием данных для поддержки создания собственных ключей. Благодаря созданию собственных ключей ключ шифрования базы данных защищен асимметричным ключом, хранящимся в Key Vault. Асимметричный ключ никогда не покидает Key Vault. Когда сервер получает разрешения для хранилища ключей, он отправляет к нему базовые запросы операций с ключами через Key Vault. Асимметричный ключ задается на уровне сервера и наследуется всеми базами данных на этом сервере.

Поддержка создания собственных ключей позволяет контролировать задачи управления ключами, такие как смена ключа и разрешения хранилища ключей. Вы также можете удалить ключи и включить аудит или ведение отчетов для всех ключей шифрования. Key Vault обеспечивает центральное управление ключами и использует строго отслеживаемые аппаратные модули безопасности. Key Vault обеспечивает раздельное управление ключами и данными для соответствия нормативным требованиям. Дополнительные сведения о Key Vault см. на [странице документации по Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault).

Дополнительные сведения о прозрачном шифровании данных с поддержкой создания собственных ключей для хранилища данных и базы данных SQL см. в статье [Прозрачное шифрование данных с поддержкой создания собственных ключей](transparent-data-encryption-byok-azure-sql.md).

Инструкции по началу работы с прозрачным шифрованием данных с поддержкой создания собственных ключей см. в руководстве [Включение прозрачного шифрования данных с использованием собственного ключа из Key Vault с помощью PowerShell](transparent-data-encryption-byok-azure-sql-configure.md).

## <a name="move-a-transparent-data-encryption-protected-database"></a>Перемещение базы данных, защищаемой с помощью прозрачного шифрования данных

Расшифровывать базы данных для работы в Azure не нужно. Параметры прозрачного шифрования данных для базы данных-источника прозрачно наследуются целевым объектом. Сюда входят операции, связанные с:
- геовосстановлением;
- самостоятельным восстановлением до точки во времени;
- восстановлением удаленной базы данных;
- активной георепликацией;
- созданием копии базы данных.

При экспорте базы данных, защищаемой прозрачным шифрованием, экспортируемое содержимое базы данных не шифруется. Экспортированное содержимое хранится в незашифрованных файлах BACPAC. Не забудьте защитить файлы BACPAC соответствующим образом и включить прозрачное шифрование данных после завершения импорта новой базы данных.

Например, если файл BACPAC экспортируется из локального экземпляра SQL Server, то импортированное содержимое новой базы данных не шифруется автоматически. Точно так же новая база данных автоматически не шифруется при экспорте файла BACPAC в локальный экземпляр SQL Server.

Единственное исключение — экспорт в базу данных SQL или из нее. Прозрачное шифрование данных в новой базе данных включено, но сам BACPAC-файл по-прежнему не шифруется.

## <a name="manage-transparent-data-encryption-in-the-azure-portal"></a>Управление прозрачным шифрованием данных на портале Azure

Чтобы настроить прозрачное шифрование данных через портал Azure, нужно подключиться в качестве владельца Azure, участника или диспетчера безопасности SQL. 

Прозрачное шифрование данных задается на уровне базы данных. Чтобы включить прозрачное шифрование данных в базе данных, войдите на [портал Azure](https://portal.azure.com) с помощью учетной записи администратора или участника Azure. Найдите параметры прозрачного шифрования данных для своей пользовательской базы данных. По умолчанию используется прозрачное шифрование данных, управляемое службой. Сертификат прозрачного шифрования данных автоматически создается для сервера, содержащего базу данных. 

![Прозрачное шифрование данных, управляемое службой](./media/transparent-data-encryption-azure-sql/service-managed-tde.png)  

Главный ключ прозрачного шифрования данных, который также называется средством защиты прозрачного шифрования данных, задается на уровне сервера. Чтобы использовать прозрачное шифрование данных с поддержкой создания собственных ключей и защитить базы данных с помощью ключа из Key Vault, откройте параметры прозрачного шифрования данных для своего сервера. 

![Прозрачное шифрование данных с поддержкой создания собственных ключей](./media/transparent-data-encryption-azure-sql/tde-byok-support.png) 

## <a name="manage-transparent-data-encryption-by-using-powershell"></a>Управление прозрачным шифрованием данных с помощью PowerShell

Чтобы настроить прозрачное шифрование данных через PowerShell, нужно подключиться в качестве владельца Azure, участника или диспетчера безопасности SQL. 

| Командлет | Описание |
| --- | --- |
| [Set-AzureRmSqlDatabaseTransparentDataEncryption](/powershell/module/azurerm.sql/set-azurermsqldatabasetransparentdataencryption) |Включает или отключает прозрачное шифрование данных для базы данных.|
| [Get-Azure-Rm-Sql-Database-Transparent-Data-Encryption](/powershell/module/azurerm.sql/get-azurermsqldatabasetransparentdataencryption) |Получает состояние прозрачного шифрования данных для базы данных. |
| [Get-Azure-Rm-Sql-Database-Transparent-Data-Encryption-Activity](/powershell/module/azurerm.sql/get-azurermsqldatabasetransparentdataencryptionactivity) |Проверяет ход шифрования для базы данных. |
| [Add-AzureRmSqlServerKeyVaultKey](/powershell/module/azurerm.sql/add-azurermsqlserverkeyvaultkey) |Добавляет ключ Key Vault в экземпляр SQL Server. |
| [Get-AzureRmSqlServerKeyVaultKey](/powershell/module/azurerm.sql/get-azurermsqlserverkeyvaultkey) |Получает ключи Key Vault для экземпляра SQL Server.  |
| [Set-AzureRmSqlServerTransparentDataEncryptionProtector](/powershell/module/azurerm.sql/set-azurermsqlservertransparentdataencryptionprotector) |Задает средство защиты прозрачного шифрования данных для экземпляра SQL Server. |
| [Get-AzureRmSqlServerTransparentDataEncryptionProtector](/powershell/module/azurerm.sql/get-azurermsqlservertransparentdataencryptionprotector) |Возвращает средство защиты прозрачного шифрования данных. |
| [Remove-AzureRmSqlServerKeyVaultKey](/powershell/module/azurerm.sql/remove-azurermsqlserverkeyvaultkey) |Удаляет ключ Key Vault из экземпляра SQL Server. |
|  | |

## <a name="manage-transparent-data-encryption-by-using-transact-sql"></a>Управление прозрачным шифрованием данных с помощью Transact-SQL

Подключитесь к базе данных, используя учетные данные администратора или участника роли **dbmanager** в базе данных master.

| Command | Описание |
| --- | --- |
| [ALTER DATABASE (база данных Azure SQL)](/sql/t-sql/statements/alter-database-azure-sql-database) | Параметр SET ENCRYPTION ON/OFF используется для шифрования и расшифровки базы данных. |
| [sys.dm_database_encryption_keys](/sql/relational-databases/system-dynamic-management-views/sys-dm-database-encryption-keys-transact-sql) |Возвращает сведения о состоянии шифрования базы данных и о связанных ключах шифрования базы данных. |
| [sys.dm_pdw_nodes_database_encryption_keys](https://docs.microsoft.com/sql/relational-databases/system-dynamic-management-views/sys-dm-pdw-nodes-database-encryption-keys-transact-sql) |Возвращает сведения о состоянии шифрования каждого узла хранилища данных и о связанных ключах шифрования базы данных. | 
|  | |

Средство защиты прозрачного шифрования данных невозможно переключить на ключ из Key Vault с помощью Transact-SQL. Для этого нужно использовать PowerShell или портал Azure.

## <a name="manage-transparent-data-encryption-by-using-the-rest-api"></a>Управление прозрачным шифрованием данных с помощью REST API
 
Чтобы настроить прозрачное шифрование данных через REST API, нужно подключиться в качестве владельца Azure, участника или диспетчера безопасности SQL. 

| Command | Описание |
| --- | --- |
|[Создать или обновить сервер](/rest/api/sql/servers/createorupdate)|Добавляет удостоверение Azure Active Directory в экземпляр SQL Server (используется для предоставления доступа к Key Vault).|
|[Создать или обновить ключ сервера](/rest/api/sql/serverkeys/createorupdate)|Добавляет ключ Key Vault в экземпляр SQL Server.|
|[Удалить ключ сервера](/rest/api/sql/serverkeys/delete)|Удаляет ключ Key Vault из экземпляра SQL Server.|
|[Получить ключи сервера](/rest/api/sql/serverkeys/get)|Получает заданный ключ Key Vault из экземпляра SQL Server.|
|[Список ключей серверов по серверам](/rest/api/sql/serverkeys/listbyserver)|Получает ключи Key Vault для экземпляра SQL Server. |
|[Создать или обновить средство защиты шифрования](/rest/api/sql/encryptionprotectors/createorupdate)|Задает средство защиты прозрачного шифрования данных для экземпляра SQL Server.|
|[Получить средство защиты шифрования](/rest/api/sql/encryptionprotectors/get)|Возвращает средство защиты прозрачного шифрования данных для экземпляра SQL Server.|
|[Список средств защиты шифрования по серверам](/rest/api/sql/encryptionprotectors/listbyserver)|Возвращает средство защиты прозрачного шифрования данных для экземпляра SQL Server. |
|[Создать или обновить конфигурацию прозрачного шифрования данных](/rest/api/sql/transparentdataencryptions/createorupdate)|Включает или отключает прозрачное шифрование данных для базы данных.|
|[Получить конфигурацию прозрачного шифрования данных](/rest/api/sql/transparentdataencryptions/get)|Получает конфигурацию прозрачного шифрования данных для базы данных.|
|[Список результатов конфигурации прозрачного шифрования данных](/rest/api/sql/transparentdataencryptionactivities/ListByConfiguration)|Получает результат шифрования для базы данных.|

## <a name="next-steps"></a>Следующие шаги

- Общее описание прозрачного шифрования данных см. в статье [Прозрачное шифрование данных](transparent-data-encryption.md).
- Дополнительные сведения о прозрачном шифровании данных с поддержкой создания собственных ключей для хранилища данных и базы данных SQL см. в статье [Прозрачное шифрование данных с поддержкой создания собственных ключей](transparent-data-encryption-byok-azure-sql.md).
- Инструкции по началу работы с прозрачным шифрованием данных с поддержкой создания собственных ключей см. в руководстве [Включение прозрачного шифрования данных с использованием собственного ключа из Key Vault с помощью PowerShell](transparent-data-encryption-byok-azure-sql-configure.md).
- Дополнительные сведения о Key Vault см. на [странице документации по Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault).
