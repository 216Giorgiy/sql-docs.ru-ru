---
title: "Прозрачное шифрование данных с поддержкой использования собственных ключей в Azure SQL | Документы Майкрософт"
description: "Общие сведения о поддержке использования собственных ключей для прозрачного шифрования данных с помощью Azure Key Vault для базы данных и хранилища данных SQL Azure. В этом документе рассматриваются преимущества этой возможности, принципы ее работы, а также предоставляются рекомендации."
keywords: 
services: sql-database
documentationcenter: 
author: becczhang
manager: cguyer
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: security
ms.workload: Inactive
ms.tgt_pltfrm: 
ms.devlang: na
ms.topic: article
ms.date: 08/07/2017
ms.author: rebeccaz
ms.openlocfilehash: 35e51899bda60ccb5b176de0a3d7fabcc86faad7
ms.sourcegitcommit: 9678eba3c2d3100cef408c69bcfe76df49803d63
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2017
---
# <a name="transparent-data-encryption-with-bring-your-own-key-support-for-azure-sql-database-and-data-warehouse"></a>Прозрачное шифрование данных с поддержкой использования собственных ключей для базы данных и хранилища данных SQL Azure

[!INCLUDE[tsql-appliesto-xxxxxx-asdb-asdw-xxx-md](../../../includes/tsql-appliesto-xxxxxx-asdb-asdw-xxx-md.md)]

Поддержка использования собственных ключей (BYOK) для [прозрачного шифрования данных (TDE)](transparent-data-encryption.md) позволяет управлять ключами TDE и контролировать, кто и когда может получать к ним доступ. [Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault) — это облачная внешняя система управления ключами Azure, которая является первой службой управления ключами, где TDE располагает встроенной поддержкой BYOK. Благодаря BYOK ключ шифрования базы данных защищен асимметричным ключом, хранящимся в хранилище Key Vault. Асимметричный ключ задается на уровне сервера и наследуется всеми базами данных на этом сервере. 

Благодаря поддержке BYOK пользователи могут выполнять задачи управления ключами, включая смену ключей, разрешения хранилища ключей, удаление ключей и включение проверки всех ключей шифрования или формирования связанных с ними отчетов. Хранилище ключей обеспечивает централизованное управление ключами, предоставляет тщательно отслеживаемые аппаратные модули безопасности (HSM) и позволяет разделить управление ключами и данными для выполнения законодательных норм. 

TDE с поддержкой BYOK обеспечивает следующие преимущества:
- Повышенная прозрачность и детализированный контроль с возможностью самостоятельного управления средством защиты TDE   
- Централизованное управление ключами шифрования TDE (а также другими ключами и секретами, используемыми в других службах Azure) путем их размещения в хранилище Key Vault.
- Разделение управления ключами и данными в организации для поддержки разделения ролей.
- Более высокий уровень доверия клиентов, так как хранилище Key Vault не позволяет Майкрософт просматривать или извлекать ключи шифрования. 
- Поддержка смены ключей

> [!IMPORTANT]
> Для тех пользователей, которые используют управляемое службой прозрачное шифрование данных и хотят работать с хранилищем Key Vault, функции TDE сохраняются в ходе процесса перехода на ключ из хранилища Key Vault. Процедура выполняется без простоя и без повторного шифрования самих файлов базы данных. Для перехода с управляемого службой ключа на ключ хранилища Key Vault требуется повторное шифрование ключа шифрования базы данных. Эта операция происходит быстро и в оперативном режиме.
>

## <a name="how-does-tde-with-byok-support-work"></a>Как работает TDE с поддержкой BYOK?
 
![Проверка подлинности сервера в хранилище Key Vault](./media/transparent-data-encryption-byok-azure-sql/tde-byok-server-authentication-flow.PNG)

Если TDE настроено для использования ключа из хранилища Key Vault, сервер отправляет ключ шифрования базы данных каждой базы данных с поддержкой TDE в хранилище Key Vault для запроса *упаковки ключа*. Хранилище Key Vault возвращает ключ шифрования зашифрованной базы данных, который хранится в базе данных пользователя. 

Важно отметить, что **после сохранения в хранилище Key Vault ключ никогда не покидает это хранилище**. Ключ с поддержкой аппаратного модуля безопасности (HSM) в хранилище Key Vault никогда не выходит за границу безопасности HSM. Сервер может только отправлять запросы на операции ключа в материал ключа средства защиты TDE в рамках хранилища Key Vault. Администратор хранилища Key Vault может в любой момент отменить разрешения Key Vault. В этом случае все подключения к серверу разрываются. 

## <a name="considerations"></a>Замечания

Использование TDE с поддержкой BYOK налагает на вас дополнительные задачи по управлению ключами и связанные затраты по использованию самого хранилища ключей. Эти вопросы рассматриваются в следующих двух разделах.

### <a name="key-management-responsibilities"></a>Обязанности управления ключами

Управление ключами шифрования ресурсов приложения является важной обязанностью. Использование прозрачного шифрования данных с поддержкой BYOK в хранилище Key Vault предполагает выполнение следующих задач по управлению ключами.
- **Смена ключа.** Смена средств защиты TDE осуществляется согласно внутренним нормативам или требованиям в области соответствия. Смены ключей можно производить с помощью хранилища ключей средства защиты TDE.  
- **Разрешения для хранилища ключей.** Разрешения в хранилище Key Vault предоставляются на уровне хранилища ключей и сервера. Разрешения сервера для хранилища ключей могут быть отменены в любое время с помощью политики доступа к хранилищу ключей.
- **Удаление ключей.** В целях дополнительной безопасности или соблюдения нормативных требований ключи могут быть удалены из хранилища Key Vault и с сервера SQL.
- **Аудит или отчетность по всем ключам шифрования.** В хранилище Key Vault находятся журналы, которые легко внедряются в другие средства управления безопасностью информации и событиями (SIEM). Примером уже интегрированной службы является Operations Management Suite (OMS) [Log Analytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-azure-key-vault).

### <a name="pricing-considerations"></a>Замечания по ценам 

Прозрачное шифрование данных с поддержкой BYOK представляет собой возможность безопасности, встроенную в базы данных, и хранилище данных SQL Azure без дополнительных затрат. Однако использование самого хранилища Key Vault связано с определенными расходами. За операции Key Vault, выполненные сервером, взимается плата как за обычные операции с хранилищем. Для них действуют [цены](https://azure.microsoft.com/pricing/details/key-vault/) Key Vault. Сервер отправляет запросы в хранилище Key Vault для следующих событий:
- перезапуски экземпляра SQL;
- смены ключей;
- выполняемые каждые 6 часов проверки для определения изменений, внесенных в разрешения сервера для хранилища ключей.

## <a name="important-warnings"></a>Важные предупреждения

### <a name="loss-of-access-to-keys"></a>Потеря доступа к ключам

После того как сервер теряет доступ к средству защиты TDE (в результате удаления разрешений Key Vault или удаления ключа), **блокируются все подключения к зашифрованным базам данных для сервера, и эти базы данных переходят в автономный режим и удаляются в течение 24 часов**. Старые резервные копии, зашифрованные с помощью недоступного ключа, становятся недоступными. В исключительном случае, когда возникают подозрения относительно компрометации ключа (например, служба или пользователь получили несанкционированный доступ к ключу), рекомендуется удалить ключ, следуя инструкциям в разделе об [удалении потенциально скомпрометированного ключа](transparent-data-encryption-byok-azure-sql-remove-tde-protector.md). Базы данных должны быть удалены перед удалением действующего средства защиты TDE, чтобы избежать потери данных за 10 минут.  

### <a name="expired-keys"></a>Ключи с истекшим сроком действия

Так как доступность средства защиты TDE напрямую влияет на доступность базы данных, запрещается добавлять ключ с датой окончания срока действия на сервер SQL. Если ключ уже используется в качестве средства защиты TDE для сервера и в Azure Key Vault позже добавляется дата окончания срока действия, то **после истечения срока действия ключа зашифрованные базы данных теряют доступ к своему средству защиты TDE и удаляются в течение 24 часов.**

### <a name="deleted-server-identities"></a>Удаленные идентификаторы серверов 

Управление доступом сервера к хранилищу Key Vault осуществляется с помощью уникального идентификатора Azure Active Directory (AAD) сервера. Таким образом, если идентификатор сервера удаляется из AAD, сервер теряет доступ к своим хранилищам ключей. В результате **блокируются все подключения к зашифрованным базам данных для сервера, и эти базы данных переходят в автономный режим и удаляются в течение 24 часов.**

## <a name="limitations"></a>Ограничения

Используемые для прозрачного шифрования данных хранилища ключей должны находиться в одном клиенте AAD с сервером SQL базы данных или хранилища данных. Взаимодействия ключа хранилища для нескольких клиентов и сервера не поддерживаются. Ресурс, который шифруется с помощью ключа из хранилища Key Vault, нельзя перемещать между подписками Azure. В противном случае нарушается работа необходимых элементов управления доступом к хранилищу Key Vault, которые обеспечивают функционировавшие TDE с поддержкой BYOK. Чтобы переместить ресурсы в другую подписку, измените режим прозрачного шифрования данных с BYOK на [прозрачное шифрование данных, управляемое службой](transparent-data-encryption-azure-sql.md). 

Уникальные средства защиты TDE для базы данных или хранилища данных не поддерживаются. Средство защиты TDE задается на уровне сервера и наследуется всеми ресурсами на сервере. 

## <a name="guidelines-for-managing-encrypted-databases"></a>Рекомендации по управлению зашифрованными базами данных

### <a name="high-availability-and-disaster-recovery"></a>Высокий уровень доступности и аварийное восстановление
  
Существует два способа настройки георепликации для серверов с помощью хранилища Key Vault. 

- **Отдельное хранилище ключей.** Каждый сервер имеет доступ к отдельному хранилищу ключей (в идеале — каждое в собственном регионе Azure). Это рекомендуемая конфигурация, поскольку каждый сервер имеет собственную копию средства защиты TDE для зашифрованных геореплицированных баз данных. Если один из регионов Azure сервера переходит в автономный режим, другие серверы могут продолжать обращаться к геореплицированным базам данных.   

- **Общее хранилище ключей.** Все серверы совместно используют одно хранилище ключей. Эту конфигурацию проще настроить, но если регион Azure, где находится хранилище ключей, переходит в автономный режим, все серверы не смогут считывать зашифрованные геореплицированные базы данных или собственные зашифрованные базы данных. 
 
Чтобы приступить к работе, используйте командлет [Add-AzureRmSqlServerKeyVaultKey](/powershell/module/azurerm.sql/add-azurermsqlserverkeyvaultkey) для добавления ключа хранилища Key Vault каждого сервера на другие серверы в ссылке георепликации.  
(Пример KeyId из Key Vault: *https://contosokeyvault.vault.azure.net/keys/Key1/1a1a2b2b3c3c4d4d5e5e6f6f7g7g8h8h*.)

   ```powershell
   <# Include the version guid in the KeyId #>
   Add-AzureRmSqlServerKeyVaultKey `
   -KeyId <KeyVaultKeyId> `
   -ServerName <LogicalServerName> `
   -ResourceGroup <SQLDatabaseResourceGroupName>
   ```

>[!NOTE]
>Общая длина имени хранилища ключей и имени ключа не может превышать 94 символов.
>

Чтобы настроить активную георепликацию с этими серверами и запустить отработку отказа, следуйте указаниям в статье с [общими сведениями об активной георепликации](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview).  

### <a name="backup-and-restore"></a>Резервное копирование и восстановление

После шифрования базы данных помощью TDE с использованием ключа из хранилища Key Vault все создаваемые резервные копии также шифруются с помощью того же средства защиты TDE.

Чтобы восстановить резервную копию, зашифрованную с помощью средства защиты TDE, из хранилища Key Vault, убедитесь, что материал ключа по-прежнему находится в исходном хранилище и имеет исходное имя ключа. При изменении средства защиты TDE для базы данных старые резервные копии базы данных **не** обновляются для использования последней версии средства защиты TDE. Поэтому рекомендуется сохранять все прежние версии средства защиты TDE в хранилище Key Vault для последующего восстановления баз данных из резервных копий. 

Если ключ, который может потребоваться для восстановления резервной копии, отсутствует в исходном хранилище ключей, возвращается следующее сообщение об ошибке: "Target server <Servername> does not have access to all AKV Uris created between <Timestamp #1> and <Timestamp #2>. Please retry operation after restoring all AKV Uris." (Целевой сервер не может получить доступ ко всем URI AKV, созданным в период с <Timestamp #1> по <Timestamp #2>. Повторите операцию после восстановления всех URI AKV.)

Чтобы избежать этого, выполните командлет [Get-AzureRmSqlServerKeyVaultKey](/powershell/module/azurerm.sql/get-azurermsqlserverkeyvaultkey) для получения списка ключей из хранилища Key Vault, которые были добавлены на сервер. Чтобы убедиться в возможности восстановления всех резервных копий, целевой сервер для резервной копии должен иметь доступ ко всем этим ключам.

   ```powershell
   Get-AzureRmSqlServerKeyVaultKey `
   -ServerName <LogicalServerName> `
   -ResourceGroup <SQLDatabaseResourceGroupName>
   ```
Дополнительные сведения о восстановлении базы данных SQL из резервной копии см. в разделе [Восстановление базы данных Azure SQL](https://docs.microsoft.com/azure/sql-database/sql-database-recovery-using-backups). Дополнительные сведения о восстановлении хранилища данных SQL из резервной копии см. в разделе [Восстановление хранилища данных Azure SQL](https://docs.microsoft.com/azure/sql-data-warehouse/sql-data-warehouse-restore-database-overview).

## <a name="best-practices"></a>Рекомендации

### <a name="key-management"></a>Управление ключами 

Для обеспечения быстрого восстановления ключей и возможности доступа к данным за пределами Azure мы рекомендуем следующее.
- Создайте ключ шифрования локально на локальном устройстве HSM. (Убедитесь, что это асимметричный ключ RSA 2048, который можно поместить в Azure Key Vault.)
- Импортируйте файл ключа шифрования (PFX, BYOK или BACKUP) в Azure Key Vault. Попробуйте использовать хранилище ключей со включенной функцией [обратимого удаления](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete) для защиты от случайного удаления ключей.
- Перед первым использованием ключа в хранилище ключей Azure создайте резервную копию ключа из хранилища ключей Azure. См. дополнительные сведения о команде [Backup-AzureKeyVaultKey](https://msdn.microsoft.com/library/mt126292.aspx) .
- При каждом внесении изменений в ключ (например, при добавлении списков управления доступом, тегов, ключевых атрибутов) снова создайте резервную копию ключа из Azure Key Vault.
- Во время смены ключей **сохраняйте предыдущие версии ключа** в хранилище ключей, чтобы можно было восстановить старые резервные копии базы данных. 

Создание ключа шифрования TDE в локальной среде и импорт асимметричного ключа настоятельно рекомендуется для рабочих сценариев, так как это позволяет администратору передать ключ в систему переноса ключей. Если асимметричный ключ создается в Azure Key Vault, он не может быть передан, так как закрытый ключ не может покидать хранилище. Ключи, используемые для защиты важных данных, должны быть перенесены. Потеря асимметричного ключа приводит к невозможности восстановить данные.

### <a name="pre-configuration-for-replicated-databases"></a>Предварительная настройка для реплицированных баз данных

Если зашифрованная база данных будет реплицирована на другой сервер, **перед** перемещением или репликацией базы данных проверьте, что у сервера есть доступ к копии материал ключа в Key Vault, используемого на другом сервере.  

Рекомендуется, чтобы каждый сервер имел доступ к копии используемого на другом сервере материала ключа, который хранится в отдельном хранилище ключей (в идеале каждый в том же регионе Azure, что и сервер). В этом случае каждый сервер имеет собственную копию средства защиты TDE для зашифрованных реплицированных баз данных. Если один из регионов Azure сервера переходит в автономный режим, другие серверы могут продолжать обращаться к реплицированным базам данных.

## <a name="next-steps"></a>Следующие шаги

- Начините использовать поддержку BYOK для TDE: [Turn on TDE using your own key from Key Vault using PowerShell](transparent-data-encryption-byok-azure-sql-configure.md) (Включение TDE с использованием собственного ключа из Key Vault с помощью PowerShell).
- Узнайте, как заменить средство защиты TDE сервера в соответствии с требованиями безопасности: [Rotate the Transparent Data Encryption protector Using PowerShell](transparent-data-encryption-byok-azure-sql-key-rotation.md) (Смена средства защиты прозрачного шифрования данных с помощью PowerShell).
- Узнайте, как удалить потенциально скомпрометированное средство защиты TDE в случае угрозы безопасности, изучив [эту статью](transparent-data-encryption-byok-azure-sql-remove-tde-protector.md). 
