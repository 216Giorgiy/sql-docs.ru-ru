---
title: Прозрачное шифрование данных с поддержкой использования собственных ключей в Azure SQL | Документы Майкрософт
description: Поддержка использования собственных ключей для прозрачного шифрования данных с помощью Azure Key Vault для базы данных и хранилища данных SQL. Общие сведения о прозрачном шифровании данных с поддержкой использования собственных ключей, описание преимуществ, принципов работы и рекомендаций.
keywords: ''
services: sql-database
documentationcenter: ''
author: aliceku
manager: craigg
ms.prod: ''
ms.reviewer: ''
ms.suite: sql
ms.prod_service: sql-database, sql-data-warehouse
ms.service: sql-database
ms.custom: ''
ms.tgt_pltfrm: ''
ms.topic: conceptual
ms.date: 04/19/2018
ms.author: aliceku
monikerRange: = azuresqldb-current || = azure-sqldw-latest || = sqlallproducts-allversions
ms.openlocfilehash: e5031c7e0b17177bb09ee91845626c9c32bd1bcc
ms.sourcegitcommit: a78fa85609a82e905de9db8b75d2e83257831ad9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/18/2018
ms.locfileid: "35698335"
---
# <a name="transparent-data-encryption-with-bring-your-own-key-support-for-azure-sql-database-and-data-warehouse"></a>Прозрачное шифрование данных с поддержкой использования собственных ключей для базы данных и хранилища данных SQL Azure
[!INCLUDE[appliesto-xx-asdb-asdw-xxx-md](../../../includes/appliesto-xx-asdb-asdw-xxx-md.md)]

Поддержка создания собственных ключей (BYOK) для [прозрачного шифрования данных (TDE)](transparent-data-encryption.md) позволяет зашифровать ключ шифрования базы данных с помощью асимметричного ключа, который называется средством защиты TDE.  Средство защиты TDE хранится под вашим управлением в [Azure Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-secure-your-key-vault), облачной внешней системе управления ключами Azure. Azure Key Vault — это первая служба управления ключами, где TDE располагает встроенной поддержкой BYOK. Ключ шифрования базы данных TDE, который хранится на странице загрузки базы данных, шифруется и расшифровывается средством защиты TDE. Средство защиты TDE хранится в Azure Key Vault и никогда не покидает хранилище ключей. Если доступ сервера к хранилищу ключей отозван, базу данных невозможно расшифровать и считать в памяти.  Средство защиты TDE задается на уровне логического сервера и наследуется всеми базами данных, связанными с этим сервером. 

Благодаря поддержке BYOK пользователи могут выполнять задачи управления ключами, включая смену ключей, разрешения хранилища ключей, удаление ключей и включение аудита или создания отчетов во всех средствах защиты TDE с помощью функций Azure Key Vault. Хранилище ключей обеспечивает централизованное управление ключами, предоставляет тщательно отслеживаемые аппаратные модули безопасности (HSM) и позволяет разделить обязанности по управлению ключами и данными для выполнения законодательных норм.  


TDE с поддержкой BYOK обеспечивает следующие преимущества:
- Повышенная прозрачность и детализированный контроль с возможностью самостоятельного управления средством защиты TDE   
- Централизованное управление средствами защиты TDE (а также другими ключами и секретами, используемыми в других службах Azure) путем их размещения в хранилище Key Vault
- Разделение ролей управления ключами и данными в организации для поддержки разделения обязанностей
- Более высокий уровень доверия клиентов, так как хранилище Key Vault не позволяет Майкрософт просматривать или извлекать ключи шифрования. 
- Поддержка смены ключей

> [!IMPORTANT]
> Для тех пользователей, которые используют управляемое службой прозрачное шифрование данных и хотят работать с хранилищем Key Vault, функции TDE сохраняются в ходе процесса перехода на средство защиты TDE в Key Vault. Процедура выполняется без простоя и без повторного шифрования файлов базы данных. Для перехода с управляемого службой ключа на ключ Key Vault требуется только повторное шифрование ключа шифрования базы данных. Эта операция происходит быстро и в оперативном режиме. 
>

## <a name="how-does-tde-with-byok-support-work"></a>Как работает TDE с поддержкой BYOK?
 
![Проверка подлинности сервера в хранилище Key Vault](./media/transparent-data-encryption-byok-azure-sql/tde-byok-server-authentication-flow.PNG)

При первой настройке использования средства защиты TDE из Key Vault в TDE сервер отправляет ключ шифрования базы данных каждой базы данных с поддержкой TDE в Key Vault для запроса упаковки ключа. Хранилище Key Vault возвращает ключ шифрования зашифрованной базы данных, который хранится в базе данных пользователя.  

>[!IMPORTANT]
>Обратите внимание, что **после сохранения средства защиты TDE в Azure Key Vault оно никогда не покидает Azure Key Vault**. Логический сервер может только отправлять запросы на операции ключа в материал ключа средства защиты TDE в Key Vault и **никогда не обращается к средству защиты TDE и не кэширует его**. Администратор Key Vault может в любой момент отозвать разрешения Key Vault. В этом случае все подключения к серверу разрываются. 
>


## <a name="guidelines-for-configuring-tde-with-byok"></a>Рекомендации по настройке TDE с BYOK

### <a name="general-guidelines"></a>Общие рекомендации
- Убедитесь, что Azure Key Vault и база данных SQL Azure будут находиться в одном клиенте.  Взаимодействие с ключом хранилища и сервера между несколькими клиентами **не поддерживается**.
- Решите, какие подписки будут использоваться для необходимых ресурсов. При перемещении сервера между подписками позже потребуется повторная настройка TDE с BYOK.
- При настройке TDE с BYOK важно учитывать нагрузку на хранилище ключей, создаваемую повторяющимися операциями упаковки и распаковки. Например, поскольку все базы данных, связанные с логическим сервером, используют одно средство защиты TDE, отработка отказа этого сервера приведет к выполнению операций с ключами в хранилище, количество которых равно количеству баз данных на сервере. Исходя из нашего опыта и задокументированных [ограничений службы хранилища ключей](https://docs.microsoft.com/en-us/azure/key-vault/key-vault-service-limits), мы рекомендуем связывать не более 500 баз данных уровня "Стандартный" или "Критически важный для бизнеса" либо 200 баз данных уровня "Премиум" или "Общего назначения" с одним хранилищем ключей Azure в рамках одной подписки, чтобы обеспечить постоянную высокую доступность средства защиты TDE в хранилище. 
- Рекомендуется хранить локальную копию средства защиты TDE.  Для этого на устройстве HSM нужно создать локальную копию средства защиты TDE и системы депонирования ключей.


### <a name="guidelines-for-configuring-azure-key-vault"></a>Рекомендации по настройке Azure Key Vault

- Создайте хранилище ключей с [обратимым удалением](https://docs.microsoft.com/azure/key-vault/key-vault-ovw-soft-delete) для защиты от потери данных на случай случайного удаления ключа или хранилища ключей.  Необходимо использовать [PowerShell для включения свойства обратимого удаления](https://docs.microsoft.com/en-us/azure/key-vault/key-vault-soft-delete-powershell) в хранилище ключей (этот параметр на данный момент недоступен на портале Azure Key Vault, но по-прежнему является обязательным для SQL).  
  - Ресурсы с обратимым удалением хранятся в течение заданного периода времени (90 дней), в течение которого их можно восстановить или удалить.
  - С действиями **Восстановить** и **Удалить** связаны отдельные разрешения в политике доступа хранилища ключей. 

- Предоставьте логическому серверу доступ к хранилищу ключей с помощью удостоверения Azure Active Directory (Azure AD).  При использовании пользовательского интерфейса портала удостоверение Azure Active Directory создается автоматически, и серверу предоставляется доступ к хранилищу ключей.  При использовании PowerShell для настройки TDE с BYOK нужно создать удостоверение Azure Active Directory и подтвердить выполнение. Подробные пошаговые инструкции по использованию PowerShell см. в разделе [Настройка TDE с BYOK](transparent-data-encryption-byok-azure-sql-configure.md).

  >[!NOTE]
  >При **случайном удалении удостоверения Azure Active Directory или отзыве разрешений сервера** с помощью политики доступа хранилища ключей сервер потеряет доступ к хранилищу ключей.
  >
  
- Включите аудит и создание отчетов во всех ключах шифрования: Key Vault предоставляет журналы, которые легко использовать в других средствах управления информационной безопасностью и событиями безопасности (SIEM). Примером уже интегрированной службы является Operations Management Suite (OMS) [Log Analytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-azure-key-vault).
- Чтобы обеспечить высокую доступность зашифрованных баз данных, настройте каждый логический сервер с помощью двух Azure Key Vault, которые находятся в разных регионах.


### <a name="guidelines-for-configuring-the-tde-protector-asymmetric-key-stored-in-azure-key-vault"></a>Рекомендации по настройке средства защиты TDE (асимметричный ключ) хранятся в Azure Key Vault

- Создайте ключ шифрования локально на локальном устройстве HSM. Убедитесь, что это асимметричный ключ RSA 2048, который можно хранить в Azure Key Vault.
- Депонируйте ключ в систему депонирования ключей.  
- Импортируйте файл ключа шифрования (PFX, BYOK или BACKUP) в Azure Key Vault. 
    

>[!NOTE] 
    >Для тестирования можно создать ключ в Azure Key Vault, но его невозможно будет депонировать, так как закрытый ключ не может находиться за пределами хранилища ключей.  Всегда создавайте резервные копии ключей и депонируйте ключи, используемые для шифрования рабочих данных, так как потеря ключа (случайное удаление из хранилища ключей, истечение срока действия и т. д.) приводит к потере данных без возможности восстановления.
    >
    
- Используйте ключ без срока действия и никогда не задавайте дату истечения для используемых ключей: **после истечения срока действия зашифрованные базы данных потеряют доступ к средству защиты TDE и будут удалены в течение 24 часов**.
- Убедитесь, что ключ включен и имеет разрешения на выполнение операций *get*, *wrap key* и *unwrap key*.
- Создайте резервную копию ключа в Azure Key Vault перед первым использованием ключа в Azure Key Vault. См. дополнительные сведения о команде [Backup-AzureKeyVaultKey](https://docs.microsoft.com/en-us/powershell/module/azurerm.keyvault/backup-azurekeyvaultkey?view=azurermps-5.1.1) .
- Создавайте резервную копию при каждом внесении изменений в ключ (например, при добавлении ACL, тегов, атрибутов ключей).
- **Сохраняйте предыдущие версии** ключа в хранилище ключей при их смене, чтобы можно было восстановить более старые резервные копии баз данных. При изменении средства защиты TDE для базы данных старые резервные копии базы данных **не обновляются** для использования последней версии средства защиты TDE.  Во время восстановления каждой резервной копии нужно средство защиты TDE, в котором она была создана. Для смены ключей выполните следующие инструкции в разделе [Смена средства защиты прозрачного шифрования данных с помощью PowerShell](transparent-data-encryption-byok-azure-sql-key-rotation.md).
- Сохраняйте все ранее использованные ключи в Azure Key Vault после возврата к ключам, управляемым службой.  Это гарантирует, что резервные копии баз данных можно будет восстановить с помощью средств защиты TDE, хранящихся в Azure Key Vault.  Средства защиты TDE, созданные с помощью Azure Key Vault, нужно обслуживать, пока все сохраненные резервные копии не будут созданы с помощью ключей, управляемых службой.  
- Создайте восстанавливаемые резервные копии этих ключей с помощью [Backup-AzureKeyVaultKey](https://docs.microsoft.com/en-us/powershell/module/azurerm.keyvault/backup-azurekeyvaultkey?view=azurermps-5.1.1).
- Чтобы удалить потенциально скомпрометированный ключ во время инцидента безопасности без риска потери данных, следуйте шагам в разделе [Удаление потенциально скомпрометированного ключа](transparent-data-encryption-byok-azure-sql-remove-tde-protector.md).


## <a name="high-availability-geo-replication-and-backup--restore"></a>Высокая доступность, георепликация, резервное копирование и восстановление

### <a name="high-availability-and-disaster-recovery"></a>Высокий уровень доступности и аварийное восстановление

Способ настройки высокой доступности в Azure Key Vault зависит от конфигурации базы данных и логического сервера. Рекомендуемые конфигурации для двух разных случаев описаны ниже.  Первый случай — автономная база данных или логический сервер без настроенной геоизбыточности.  Второй случай — база данных или логический сервер, настроенные с помощью групп отработки отказа или геоизбыточности, где нужно, чтобы каждая геоизбыточная копия имела локальную копию Azure Key Vault в группе отработки отказа для обеспечения работы географической отработки отказа. В первом случае, если вам нужна высокая доступность базы данных и логического сервера без настройки геоизбыточности, рекомендуется настроить на сервере использование двух разных хранилищ ключей в двух разных регионах с одним материалом ключа.  Для этого создайте средство защиты TDE с помощью первичного Key Vault, расположенного в том же регионе, что и логический сервер, и клонируйте ключ в хранилище ключей в другом регионе Azure, чтобы сервер имел доступ к вторичному хранилищу ключей, если в первичном произойдет сбой во время работы базы данных. Используйте командлет Backup-AzureKeyVaultKey, чтобы извлечь ключ в зашифрованном формате из первичного хранилища ключей, а затем используйте командлет Restore-AzureKeyVaultKey и укажите хранилище ключей во втором регионе.


![Высокая доступность на одном сервере и отсутствие географического аварийного восстановления](./media/transparent-data-encryption-byok-azure-sql/SingleServer_HA_Config.PNG)

## <a name="how-to-configure-geo-dr-with-azure-key-vault"></a>Настройка географического аварийного восстановления с использованием Azure Key Vault

Чтобы обеспечить высокую доступность средств защиты TDE для зашифрованных баз данных, необходимо настроить избыточные Azure Key Vault на основе существующих групп отработки отказа или активных экземпляров копий георепликации базы данных SQL.  Каждому геореплицированному серверу требуется отдельное хранилище ключей, которое должно находиться в том же регионе Azure, что и сервер. Если база данных-источник станет недоступной из-за сбоя в одном регионе и активации отработки отказа, база данных-получатель сможет использовать вторичное хранилище ключей. 
 
Для геореплицированных баз данных SQL Azure требуется следующая конфигурация Azure Key Vault:
- Одна база данных-источник с хранилищем ключей в регионе, а также одна база данных-получатель с хранилищем ключей в регионе. 
- Обязательно наличие как минимум одной базы данных-получателя (всего поддерживается до четырех таких баз). 
- Создание цепочек баз данных, являющихся получателями баз данных-получателей, не поддерживается.

В следующем разделе действия по настройке и конфигурации будут описаны более подробно. 

### <a name="azure-key-vault-configuration-steps"></a>Действия по конфигурации Azure Key Vault

- Установите [PowerShell](https://docs.microsoft.com/en-us/powershell/azure/install-azurerm-ps?view=azurermps-5.6.0) 
- Создайте два хранилища Azure Key Vault в двух разных регионах, используя [PowerShell для включения свойства "soft-delete"](https://docs.microsoft.com/en-us/azure/key-vault/key-vault-soft-delete-powershell) хранилищ ключей (этот параметр на данный момент недоступен на портале Azure Key Vault, но по-прежнему является обязательным для SQL).
- Для работы функций резервного копирования и восстановления ключей оба хранилища ключей Azure Key Vault должны быть расположены в двух регионах, доступных в одном географическом регионе Azure.  Если вам требуется, чтобы два хранилища ключей располагались в разных географических регионах в соответствии с требованиями к георепликации SQL, используйте [процесс BYOK](https://docs.microsoft.com/en-us/azure/key-vault/key-vault-hsm-protected-keys), который позволяет импортировать ключи из локального аппаратного модуля безопасности.
- Создайте новый ключ в первом хранилище ключей:  
  - Ключ RSA/RSA-HSA 2048 
  - Не устанавливайте сроки действия 
  - Ключ включается и будет иметь разрешения на выполнение операций get, wrap key и unwrap key 
- Создайте резервную копию первичного ключа и восстановите его во втором хранилище ключей.  См. разделы [BackupAzureKeyVaultKey](https://docs.microsoft.com/en-us/powershell/module/azurerm.keyvault/backup-azurekeyvaultkey?view=azurermps-5.1.1) и [Restore-AzureKeyVaultKey](https://docs.microsoft.com/en-us/powershell/module/azurerm.keyvault/restore-azurekeyvaultkey?view=azurermps-5.5.0). 

### <a name="azure-sql-database-configuration-steps"></a>Действия по конфигурации базы данных SQL Azure

Приведенные ниже действия по конфигурации отличаются в зависимости от того, создается ли новое развертывание SQL или вы работаете с существующим развертыванием для географического аварийного восстановления SQL.  Для начала будут приведены действия для нового развертывания. После этого будет описано назначение средств защиты TDE, хранящихся в Azure Key Vault, существующему развертыванию, для которого уже установлен канал географического аварийного восстановления. 

Действия для нового развертывания:
- Создайте два логических сервера SQL в тех же двух регионах, где ранее были созданы хранилища ключей. 
- Выберите область TDE, а затем для каждого логического сервера SQL выполните следующие действия:  
   - Выберите хранилище Azure Key Vault в том же регионе 
   - Выберите ключ, который будет использоваться в качестве средства защиты TDE (на каждом сервере будет использоваться локальная копия средства защиты TDE). 
   - Если сделать это, на портале будет создан [AppID](https://docs.microsoft.com/en-us/azure/active-directory/managed-service-identity/overview) для логического сервера SQL, который будет использоваться для назначения логическому серверу SQL разрешений на доступ к хранилищу ключей. Не удаляйте это удостоверение. Доступ можно отменить путем удаления разрешений в Azure Key Vault, а не удостоверения для логического сервера SQL Server, которое будет использоваться для назначения логическому серверу SQL Server разрешений на доступ к хранилищу ключей.
- Создайте базу данных-источник. 
- Для завершения этого сценария следуйте [руководству по активной георепликации](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-geo-replication-overview). На этом шаге будет создана база данных-получатель.

![Группы отработки отказа и географическое аварийное восстановление](./media/transparent-data-encryption-byok-azure-sql/Geo_DR_Config.PNG)

>[!NOTE]
>Прежде чем перейти к установлению географической связи между базами данных, важно убедиться, что в обоих хранилищах ключей присутствуют одинаковые средства защиты TDE.
>

Действия для существующей базы данных SQL с развертыванием для географического аварийного восстановления:

Поскольку логические серверы SQL уже существуют и назначены база данных-источник и база данных-получатель, действия по конфигурации Azure Key Vault необходимо выполнять в следующем порядке: 
- Начните с логического сервера SQL, на котором размещается база данных-получатель: 
   - Назначьте хранилище ключей, расположенное в том же регионе 
   - Назначьте средство защиты TDE 
- Далее перейдите к логическому серверу SQL, на котором размещается база данных-источник: 
   - Выберите то же средство защиты TDE, которое используется для базы данных-получателя
   
![Группы отработки отказа и географическое аварийное восстановление](./media/transparent-data-encryption-byok-azure-sql/geo_DR_ex_config.PNG)

>[!NOTE]
>При назначении хранилища ключей серверу важно начинать с сервера-получателя.  На втором шаге следует назначить хранилище ключей серверу-источнику и обновить средство защиты TDE. Канал географического аварийного восстановления продолжит работать, поскольку на этом этапе средство защиты TDE, используемое реплицированной базой данных, доступно обоим серверам.
>

Прежде чем включать TDE с управляемыми ключами клиентов в Azure Key Vault для сценария с географическим аварийным восстановлением базы данных SQL, важно создать и поддерживать в актуальном состоянии два хранилища Azure Key Vault с идентичным содержимым в тех же регионах, которые будут использоваться для георепликации базы данных SQL.  Под идентичностью содержимого понимается то, что оба хранилища ключей должны содержать копии одних и тех же средств защиты TDE, то есть оба сервера имеют доступ к средствам защиты TDE, используемым всеми базами данных.  Забегая вперед, это необходимо для обеспечения синхронизации обоих хранилищ ключей. Это значит, что они должны содержать одинаковые копии средств защиты TDE после смены ключа и хранить старые версии ключей, используемых для файлов журнала или резервных копий. Средства защиты TDE должны хранить одни и те же свойства ключей, а хранилища ключей должны содержать одинаковые разрешения доступа для SQL.  
 
Для проверки и активации отработки отказа следует регулярно выполнять действия, описываемые в разделе [Общие сведения об активной георепликации](https://docs.microsoft.com/azure/sql-database/sql-database-geo-replication-overview), что позволяет подтвердить наличие разрешений доступа к обоим хранилищам ключей для SQL. 


### <a name="backup-and-restore"></a>Резервное копирование и восстановление

После шифрования базы данных помощью TDE с использованием ключа из хранилища Key Vault все создаваемые резервные копии также шифруются с помощью того же средства защиты TDE.

Чтобы восстановить резервную копию, зашифрованную с помощью средства защиты TDE, из хранилища Key Vault, убедитесь, что материал ключа по-прежнему находится в исходном хранилище и имеет исходное имя ключа. При изменении средства защиты TDE для базы данных старые резервные копии базы данных **не** обновляются для использования последней версии средства защиты TDE. Поэтому рекомендуется сохранять все прежние версии средства защиты TDE в хранилище Key Vault для последующего восстановления баз данных из резервных копий. 

Если ключ, который может потребоваться для восстановления резервной копии, отсутствует в исходном хранилище ключей, возвращается следующее сообщение об ошибке: "Target server <Servername> does not have access to all AKV Uris created between <Timestamp #1> and <Timestamp #2>. Please retry operation after restoring all AKV Uris." (Целевой сервер не может получить доступ ко всем URI AKV, созданным в период с <Timestamp #1> по <Timestamp #2>. Повторите операцию после восстановления всех URI AKV.)

Чтобы избежать этого, выполните командлет [Get-AzureRmSqlServerKeyVaultKey](/powershell/module/azurerm.sql/get-azurermsqlserverkeyvaultkey) для получения списка ключей из Key Vault, которые были добавлены на сервер (если они не были удалены пользователем). Чтобы гарантировать возможность восстановления всех резервных копий, целевой сервер для резервной копии должен иметь доступ ко всем этим ключам.

   ```powershell
   Get-AzureRmSqlServerKeyVaultKey `
   -ServerName <LogicalServerName> `
   -ResourceGroup <SQLDatabaseResourceGroupName>
   ```
Дополнительные сведения о восстановлении базы данных SQL из резервной копии см. в разделе [Восстановление базы данных Azure SQL](https://docs.microsoft.com/azure/sql-database/sql-database-recovery-using-backups). Дополнительные сведения о восстановлении хранилища данных SQL из резервной копии см. в разделе [Восстановление хранилища данных Azure SQL](https://docs.microsoft.com/azure/sql-data-warehouse/sql-data-warehouse-restore-database-overview).


Дополнительное замечание относительно резервных копий файлов журнала: при резервном копировании файлы журнала остаются зашифрованными с помощью исходного шифратора TDE, даже если произошла смена средства защиты TDE и база данных теперь использует новое средство защиты TDE.  Во время восстановления в базе данных будет необходимо восстановить оба ключа.  Если файл журнала использует средство защиты TDE, хранящееся в Azure Key Vault, этот ключ потребуется во время восстановления, даже если для базы данных за это время было настроено использование TDE под управлением службы.


