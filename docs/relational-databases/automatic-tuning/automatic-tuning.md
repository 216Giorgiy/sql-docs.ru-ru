---
title: Автоматической настройки | Документы Microsoft
description: Дополнительные сведения об автоматической настройки в SQL Server и базы данных SQL Azure
ms.custom: ''
ms.date: 08/16/2017
ms.prod: sql-non-specified
ms.prod_service: database-engine, sql-database
ms.service: ''
ms.component: automatic-tuning
ms.reviewer: ''
ms.suite: sql
ms.technology:
- database-engine
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- performance tuning [SQL Server]
ms.assetid: ''
caps.latest.revision: ''
author: jovanpop-msft
ms.author: jovanpop
manager: craigg
ms.workload: On Demand
ms.openlocfilehash: 2f08de0fadb8fbc237af89a3132cfd747c9d62c7
ms.sourcegitcommit: 8b332c12850c283ae413e0b04b2b290ac2edb672
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/05/2018
---
# <a name="automatic-tuning"></a>Автоматическая настройка
[!INCLUDE[tsql-appliesto-ss2017-asdb-xxxx-xxx-md](../../includes/tsql-appliesto-ss2017-asdb-xxxx-xxx-md.md)]

  Функция автоматической настройки базы данных предоставляет сведения о возможных проблемах с обработкой запросов и рекомендуемые решения. Она также может автоматически исправлять выявленные проблемы.

Автоматической настройки [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] уведомит пользователя при обнаружении потенциальных проблем производительности, а также позволяет применять действия по исправлению или позволяет [!INCLUDE[ssde_md](../../includes/ssde_md.md)] автоматически устранить проблемы с производительностью.
Автоматической настройки [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] позволяет определить и устранить проблемы с производительностью за **регрессию при выборе плана SQL**. Автоматической настройки [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] создает необходимые индексы и удаляет неиспользуемые индексы.

[!INCLUDE[ssde_md](../../includes/ssde_md.md)] отслеживает запросы, которые выполняются в базе данных и автоматически повысит производительность рабочей нагрузки. [!INCLUDE[ssde_md](../../includes/ssde_md.md)] имеется встроенный механизм, который может автоматически настраивать и повысить производительность запросов путем динамической адаптации базы данных рабочей нагрузки. Существует два автоматической настройки функций, доступных.

 -  **План автоматического исправления** (в [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] и [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)]), идентифицирующий планов выполнения проблемных запросов и исправления SQL планирование проблемы с производительностью.
 -  **Управление индексами автоматического** (доступно только в [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)]), определяющий индексы, которые должны быть добавлены в базу данных и индексы, которые должны быть удалены.

## <a name="why-automatic-tuning"></a>Почему автоматической настройки?

Одно из основных задач администрирования классические базы данных на наблюдение за рабочей нагрузки, определение критических [!INCLUDE[tsql_md](../../includes/tsql_md.md)] запросы, индексы, которые должны быть добавлены для повышения производительности и редко используемые индексы. [!INCLUDE[ssde_md](../../includes/ssde_md.md)] предоставляет точное представление о запросов и индексов, которые необходимо отслеживать. Однако постоянно наблюдения за базой данных является жестких и трудоемкой задачей, особенно при работе со множеством баз данных. Управление огромное число баз данных может быть невозможно эффективно выполнять. Вместо контроля и настройки базы данных вручную, может потребоваться делегирование некоторые наблюдения и настройки действия, [!INCLUDE[ssde_md](../../includes/ssde_md.md)] с помощью функции автоматической настройки.

### <a name="how-does-automatic-tuning-works"></a>Принцип работы автоматической настройки

Автоматической настройки непрерывного наблюдения и процесс анализа, который постоянно узнает о характеристик рабочей нагрузки и определите потенциальные проблемы и усовершенствования.

![Процесс автоматической настройки](./media/tuning-process.png)

Это позволяет динамически адаптироваться к рабочей нагрузки путем нахождения какие индексы и планов может способствовать повышению производительности для рабочих нагрузок и какие индексы влияют на рабочей нагрузки на базу данных. На основании этих результатов, автоматическую настройку применяет настройки действий, которые повышают производительность рабочей нагрузки. Кроме того база данных постоянно отслеживает производительность после изменения, внесенные с автоматической настройки, убедитесь, что позволяет повысить производительность рабочей нагрузки. Любое действие, которое значительного повышения производительности автоматически отменена. Процесс проверки является функцией ключа, которая гарантирует, что любые изменения, сделанные с автоматической настройки не приводит к снижению производительности рабочей нагрузки.

## <a name="automatic-plan-correction"></a>План автоматического исправления

План автоматического исправления является функция автоматической настройки, который идентифицирует **SQL plans регрессии Выбор** и автоматически устранить проблему путем принудительного последнего известного хороший план.

### <a name="what-is-sql-plan-choice-regression"></a>Что такое Регрессия Выбор плана SQL

[!INCLUDE[ssdenoversion_md](../../includes/ssdenoversion_md.md)] для выполнения может использовать разные планы SQL [!INCLUDE[tsql_md](../../includes/tsql_md.md)] запросов. Планы запросов зависят от статистики, индексов и других факторов. Оптимальный план, который должен использоваться для выполнения некоторых [!INCLUDE[tsql_md](../../includes/tsql_md.md)] запроса может измениться со временем. В некоторых случаях новый план не может быть лучше, чем предыдущий, а новый план может привести со снижением производительности.

 ![Регрессия Выбор плана SQL](media/plan-choice-regression.png "регрессии Выбор плана SQL") 

Каждый раз, когда вы заметили регрессии выбором плана, вы должны найти некоторые предыдущие хорошее планирование и заставить его вместо текущего использования одного `sp_query_store_force_plan` процедуры.
[!INCLUDE[ssde_md](../../includes/ssde_md.md)] в [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)] представлены сведения об сниженные планы и рекомендуемые действия по исправлению.
Кроме того [!INCLUDE[ssde_md](../../includes/ssde_md.md)] позволяет полностью автоматизировать этот процесс и позволить [!INCLUDE[ssde_md](../../includes/ssde_md.md)] устранить проблему, обнаруженную об изменениях плана.

### <a name="automatic-plan-choice-correction"></a>План автоматический выбор исправления

[!INCLUDE[ssde_md](../../includes/ssde_md.md)] можно автоматически переключается последнего известного хороший план при обнаружении регрессии выбора плана.

![Исправление Выбор плана SQL](media/force-last-good-plan.png "исправления Выбор плана SQL") 

[!INCLUDE[ssde_md](../../includes/ssde_md.md)] автоматически обнаруживает все возможные плана Выбор регрессию план, который должен использоваться вместо неверный план.
При [!INCLUDE[ssde_md](../../includes/ssde_md.md)] применяется последний известный хороший план, автоматически осуществляет мониторинг производительности принудительного плана. Если принудительный план не лучше, чем регрессионных плана, новый план будет unforced и [!INCLUDE[ssde_md](../../includes/ssde_md.md)] компилируется новый план. Если [!INCLUDE[ssde_md](../../includes/ssde_md.md)] проверяет лучше, чем регрессионных принудительного плана, принудительного плана будут храниться до перекомпиляции (например, при следующей смене статистики или схемы) в случае лучше, чем регрессионных плана.

### <a name="enabling-automatic-plan-choice-correction"></a>Включение автоматического плана вариант исправления

Вы можете отдельно для каждой базы данных включить автоматическую настройку и указать, что при ухудшении производительности после изменения плана следует принудительно использовать последний известный эффективный план. Автоматическая настройка включается с помощью следующей команды.

```sql   
ALTER DATABASE current
SET AUTOMATIC_TUNING ( FORCE_LAST_GOOD_PLAN = ON ); 
```
После включения вы этот параметр, [!INCLUDE[ssde_md](../../includes/ssde_md.md)] будет автоматически принудительно никаких рекомендаций, где Предполагаемый рост ЦП выше, чем 10 секунд, или количество ошибок в новом плане больше, чем количество ошибок в плане рекомендуемые и убедитесь, что Принудительный план лучше, отличную от текущей.

### <a name="alternative---manual-plan-choice-correction"></a>Альтернативой - исправления Выбор плана вручную

Без автоматической настройки пользователи должны периодически проверять состояние системы и искать запросы, в которых были потери производительности. Если сниженные любого плана, пользователь должен находиться в некоторых предыдущих хорошее планирование и заставить его вместо текущего использования одного `sp_query_store_force_plan` процедуры. Рекомендуемым способом будет принудительно последнего известного хороший план, поскольку старые планов может быть недопустим из-за изменения статистики или индекса. Пользователь, принудительно последнего известного хороший план необходимо отслеживать производительность запроса, который выполняется с помощью принудительного плана и убедитесь, что принудительного плана, работают нормально. В зависимости от результатов, мониторинга и анализа следует принудительно применить план или пользователь должен найти иным способом для оптимизации запроса.
Вручную принудительные планы не обязательно навсегда, так как [!INCLUDE[ssde_md](../../includes/ssde_md.md)] должны иметь возможность применить оптимальный планов. Пользователь или администратор базы данных должен в конечном итоге отменить принудительное использование плана с помощью `sp_query_store_unforce_plan` процедуру, чтобы [!INCLUDE[ssde_md](../../includes/ssde_md.md)] найти оптимальный план.

[!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] предоставляет все необходимые представления и процедуры, необходимые для наблюдения за производительностью и устранения неполадок в хранилище запросов.

В [!INCLUDE[sssql15-md](../../includes/sssql15-md.md)], можно найти с помощью системных представлений хранилища запросов регрессию при выборе плана. В [!INCLUDE[sssqlv14-md](../../includes/sssqlv14-md.md)], [!INCLUDE[ssde_md](../../includes/ssde_md.md)] обнаруживает и отображает потенциальных регрессию при выборе плана и рекомендуемые действия, которые должны применяться в [sys.dm_db_tuning_recommendations &#40;Transact-SQL&#41; ](../../relational-databases/system-dynamic-management-views/sys-dm-db-tuning-recommendations-transact-sql.md) представления. В представлении отображаются сведения о проблему, важность проблемы и сведения, например указанный запрос, идентификатор регрессионных плана, идентификатор, используемый для сравнения, в качестве базового плана и [!INCLUDE[tsql_md](../../includes/tsql_md.md)] инструкцию, которая может выполняться по устранению проблема.

| type | description | datetime | score | подробности | … |
| --- | --- | --- | --- | --- | --- |
| `FORCE_LAST_GOOD_PLAN` | Изменено с 4 мс на 14 мс времени ЦП | 3/17/2017 | 83 | `queryId` `recommendedPlanId` `regressedPlanId` `T-SQL` |   |
| `FORCE_LAST_GOOD_PLAN` | Изменено с 37 ms 84 мс времени ЦП | 3/16/2017 | 26 | `queryId` `recommendedPlanId` `regressedPlanId` `T-SQL` |   |

В следующем списке описываются некоторые столбцы из данного представления:
 - Тип Рекомендуемое действие - `FORCE_LAST_GOOD_PLAN`.
 - Описание, которое содержит сведения о том, почему [!INCLUDE[ssde_md](../../includes/ssde_md.md)] считает, что это изменение плана потенциальных снижения производительности.
 - Дата и время при обнаружении потенциальных регрессии.
 - Оценка этой рекомендации. 
 - Сведения о проблемах, например идентификатор плана обнаруженных, идентификатор плана регрессионных, идентификатор плана, обязательно должно устранить проблему, [!INCLUDE[tsql_md](../../includes/tsql_md.md)]
 сценарий, который может применяться для устранения проблемы, и т. д. Сведения хранятся в [формат JSON](../../relational-databases/json/index.md).

Используйте следующий запрос, чтобы получить скрипт, который устраняет проблемы и Дополнительные сведения о примерные получить:

```sql   
SELECT reason, score,
      script = JSON_VALUE(details, '$.implementationDetails.script'),
      planForceDetails.*,
      estimated_gain = (regressedPlanExecutionCount+recommendedPlanExecutionCount)
                  *(regressedPlanCpuTimeAverage-recommendedPlanCpuTimeAverage)/1000000,
      error_prone = IIF(regressedPlanErrorCount>recommendedPlanErrorCount, 'YES','NO')
FROM sys.dm_db_tuning_recommendations
  CROSS APPLY OPENJSON (Details, '$.planForceDetails')
    WITH (  [query_id] int '$.queryId',
            [current plan_id] int '$.regressedPlanId',
            [recommended plan_id] int '$.recommendedPlanId',

            regressedPlanErrorCount int,
            recommendedPlanErrorCount int,

            regressedPlanExecutionCount int,
            regressedPlanCpuTimeAverage float,
            recommendedPlanExecutionCount int,
            recommendedPlanCpuTimeAverage float

          ) as planForceDetails;
```

[!INCLUDE[ssresult-md](../../includes/ssresult-md.md)]     

| reason | score | скрипт | запрос\_идентификатор | текущий план\_идентификатор | Рекомендуется использовать план\_идентификатор | предполагаемый\_получить | Ошибка\_ошибкам
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| Изменено с 3 ms 46 мс времени ЦП | 36 | EXEC sp\_запроса\_хранения\_принудительно\_плана 12, 17; | 12 | 28 | 17 | 11.59 | 0

`estimated_gain` Представляет предполагаемое количество секунд, которые будут сохраняться при рекомендуемые план будет выполняться вместо текущего плана. Рекомендуемые плана должно быть принудительно вместо текущий план, если прибыли больше 10 секунд. Если имеются дополнительные ошибки (например, истечение времени ожидания или прерванных выполнений) в текущем плане, чем в рекомендуемую планирования, столбец `error_prone` будет присвоено значение `YES`. План вероятность возникновения ошибки еще одна причина, почему рекомендуется плана должно быть принудительно вместо текущей.

Несмотря на то что [!INCLUDE[ssde_md](../../includes/ssde_md.md)] предоставляет все данные, необходимые для идентификации регрессию при выборе плана; непрерывный мониторинг и устранение проблем с производительностью может быть трудоемким процессом. Автоматической настройки упрощает этот процесс намного проще.

## <a name="automatic-index-management"></a>Индекс автоматического управления

В [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)], упрощается управление индексами из-за [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] узнает о рабочей нагрузки и гарантирует данных всегда оптимально индексируется. Проектирование индекса правильную крайне важна для обеспечения оптимальной производительности рабочей нагрузки и индекс автоматического управления может помочь оптимизировать индексах. Управление индексами автоматического можно устранять проблемы с производительностью в неправильно индексированных баз данных, или сохранить и оптимизируйте индексы по существующей схемы базы данных. Автоматической настройки [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] выполняет следующие действия:

 - Идентифицирует индексы, которые может улучшить производительность запросов T-SQL, считывающие данные из таблиц.
 - Идентифицирует избыточных индексы или индексы, которые не использовались в течение длительного периода времени, может быть удален. Удаление ненужных индексов повышает производительность запросов, которые используются для обновления данных в таблицах.

### <a name="why-do-you-need-index-management"></a>Зачем нужен индекс управления?

Индексы ускорить некоторые запросы на чтение данных из таблиц; Тем не менее может снизить производительность запросов, которые используются для обновления данных. Необходимо тщательно проанализировать необходимость создания индекса и столбцы, которые необходимо включить в индекс. Некоторые индексы могут оказаться ненужными через некоторое время. Таким образом необходимо периодически определить и удалить индексы, которые не следует переводить никаких преимуществ. Если сейчас пропустить неиспользуемых индексов без никаких преимуществ для запросов, которые считывают данные бы уменьшить производительность запросов, которые используются для обновления данных. Неиспользуемые индексы также влиять на общую производительность системы, так как дополнительные обновления требуют ненужные ведения журнала.

Поиск оптимальный набор индексов, которые повышают производительность запросов, которые считывать данные из таблиц и оказывать минимальное влияние на обновления может потребоваться непрерывные и сложного анализа.

[!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] использует встроенные аналитики и расширенных правил, которые анализируют запросы, определить индексы, которые были бы оптимально подходит для вашей текущей рабочей нагрузкой и индексы могут быть удалены. База данных SQL Azure гарантирует, что минимальный набор необходимых индексов, оптимизировать запросы, которые считывают данные с свернутого влияние на другие запросы.

### <a name="automatic-index-management"></a>Индекс автоматического управления

Помимо обнаружения [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] могут автоматически применять идентифицированных рекомендации. Если обнаружится, что встроенные правила повышения производительности базы данных, можно разрешить [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] автоматически управлять индексах.

Включение автоматической настройки в базе данных SQL Azure и позволяют полностью управлять работой функция автоматической настройки, в разделе [включить автоматическую настройку в базе данных SQL Azure с помощью портала Azure](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-automatic-tuning-enable).

Когда [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] относится рекомендация CREATE INDEX или DROP INDEX, он автоматически отслеживает производительность запросов, которые повлияли индекс. Создание индекса будут храниться только в том случае, если улучшить производительность соответствующих запросов. Удаленный индекс будет автоматически создан повторно, если некоторые запросы, которые выполняются медленнее из-за отсутствия индекса.

### <a name="automatic-index-management-considerations"></a>Рекомендации по управлению автоматического индекса

Действия, необходимые для создания необходимых индексов в [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] могут потреблять ресурсы и временно повлиять на производительность рабочей нагрузки. Чтобы свести к минимуму влияние на производительность рабочей нагрузки создание индекса, базы данных SQL Azure находит соответствующий период для любой операции управления индекса. Действия по настройке будет отложена, если база данных должна ресурсов для выполнения рабочей нагрузки и запускается, когда база данных имеет достаточно неиспользуемые ресурсы, которые могут использоваться для задач обслуживания. Одна из важных функций в индекс автоматического управления используется для подтверждения действия. Если база данных SQL Azure создается или удаляется индекс, процесс мониторинга анализирует производительность рабочей нагрузки, чтобы убедиться, что действие улучшена производительность. Если его не удалось перевести существенным усовершенствованием — действие возвращается немедленно. Таким образом, база данных SQL Azure гарантирует, что автоматические действия не снижает производительность рабочей нагрузки. Индексы, созданные путем автоматической настройки прозрачны для операции обслуживания на базовой схемы. Изменения схемы, например, удаление или переименование столбцов наличием автоматически созданные индексов не блокируются. Индексы, которые автоматически создаются в базе данных SQL Azure немедленно удаляются при связанных удалении таблицы или столбцы.

### <a name="alternative---manual-index-management"></a>Альтернативой - Управление индексами вручную

Без управления автоматическое индекс, ему потребуется вручную запросить [sys.dm_db_missing_index_details &#40;Transact-SQL&#41; ](../../relational-databases/system-dynamic-management-views/sys-dm-db-missing-index-details-transact-sql.md) представление, чтобы найти индексы, которые могут повысить производительность, создать индексы, используя указанные данные в состав этого представления и вручную монитор производительности запроса. Чтобы найти индексы, которые должны быть удалены, пользователи должны статистику операционного использования индексов для поиска редко используемые индексы.

[!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] упрощает этот процесс. [!INCLUDE[ssazure_md](../../includes/ssazure_md.md)] анализа рабочей нагрузки, определяет запросы, которые могут выполняться быстрее с новым индексом и идентифицирует неиспользуемые или повторяющиеся индексы. Дополнительные сведения об идентификации индексов, которые должны быть изменены на [найти рекомендации по индексам на портале Azure](https://docs.microsoft.com/en-us/azure/sql-database/sql-database-advisor-portal).

## <a name="see-also"></a>См. также  
 [ALTER базы данных SET AUTOMATIC_TUNING &#40;Transact-SQL&#41;](../../t-sql/statements/alter-database-transact-sql-set-options.md)   
 [sys.database_automatic_tuning_options &#40;Transact-SQL&#41;](../../relational-databases/system-catalog-views/sys-database-automatic-tuning-options-transact-sql.md)  
 [sys.dm_db_tuning_recommendations &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-db-tuning-recommendations-transact-sql.md)   
 [sys.dm_db_missing_index_details &#40;Transact-SQL&#41;](../../relational-databases/system-dynamic-management-views/sys-dm-db-missing-index-details-transact-sql.md)   
 [sp_query_store_force_plan &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-query-store-force-plan-transact-sql.md)     
 [sp_query_store_unforce_plan &#40;Transact-SQL&#41;](../../relational-databases/system-stored-procedures/sp-query-store-unforce-plan-transact-sql.md)           
 [sys.database_query_store_options &#40;Transact-SQL&#41;](../../relational-databases/system-catalog-views/sys-database-query-store-options-transact-sql.md)   
 [Функции JSON](../../relational-databases/json/index.md)
