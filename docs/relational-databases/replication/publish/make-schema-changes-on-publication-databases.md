---
title: "Внесение изменений схем в базы данных публикации | Microsoft Docs"
ms.custom: ""
ms.date: "03/20/2017"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "replication"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "репликация [SQL Server], изменения схемы"
  - "репликация моментальных снимков [SQL Server], репликация изменений схемы"
  - "репликация слиянием [репликация SQL Server], репликация изменений схемы"
  - "репликация транзакций, репликация изменений схемы"
  - "схемы [репликация SQL Server], репликация изменений"
  - "публикация [репликация SQL Server], изменения схемы"
ms.assetid: 926c88d7-a844-402f-bcb9-db49e5013b69
caps.latest.revision: 73
author: "BYHAM"
ms.author: "rickbyh"
manager: "jhubbard"
caps.handback.revision: 73
---
# Внесение изменений схем в базы данных публикации
  Репликация поддерживает широкий диапазон изменений схем для опубликованных объектов. При выполнении любого из следующих изменений схемы для соответствующего опубликованного объекта на [!INCLUDE[msCoName](../../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] издатель, это изменение распространяется по умолчанию на все [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] подписчики:  
  
-   ALTER TABLE  
  
-   Не следует использовать параметр ALTER TABLE SET LOCK ESCALATION, если включена репликация изменения схемы и топология включает [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] или [!INCLUDE[ssEWnoversion](../../../includes/ssewnoversion-md.md)] Subscribers.ALTER VIEW  
  
-   ALTER PROCEDURE  
  
-   ALTER FUNCTION  
  
-   ALTER TRIGGER  
  
     Параметр ALTER TRIGGER можно использовать только для триггеров языка обработки данных DML, поскольку триггеры языка описания данных DDL не могут быть реплицированы.  
  
> [!IMPORTANT]  
>  Изменения схем таблиц должны выполняться с использованием [!INCLUDE[tsql](../../../includes/tsql-md.md)] или объектов SMO [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)]. Когда изменения схемы выполняются в среде [!INCLUDE[ssManStudioFull](../../../includes/ssmanstudiofull-md.md)], среда [!INCLUDE[ssManStudio](../../../includes/ssmanstudio-md.md)] пытается удалить и затем повторно создать таблицу. Опубликованные объекты невозможно удалить, поэтому изменения схемы завершаются ошибкой.  
  
 При репликации транзакций и репликации слиянием изменения схемы распространяются в режиме последовательных добавлений при запусках агента распространителя или агента слияния. В случае репликации моментальных снимков изменения схемы распространяются при применении нового моментального снимка на подписчике. В репликации моментальных снимков при каждой синхронизации подписчику отправляется новая копия схемы. Поэтому все изменения схемы (не только перечисленные выше) в ранее опубликованных объектах автоматически распространяются при каждой синхронизации.  
  
 Сведения о добавлении и удалении статей из публикаций см. в разделе [Добавление и удаление статей в существующих публикациях](../../../relational-databases/replication/publish/add-articles-to-and-drop-articles-from-existing-publications.md).  
  
 **Репликация изменений схемы**  
  
 Перечисленные выше изменения схемы реплицируются по умолчанию. Сведения об отключении репликации изменений схемы см. в разделе [репликация изменений схемы](../../../relational-databases/replication/publish/replicate-schema-changes.md).  
  
## Вопросы изменений схемы  
 При репликации изменений схемы учитывайте следующее.  
  
### Общие рекомендации  
  
-   Изменения схемы подвержены любым ограничениям, накладываемым языком [!INCLUDE[tsql](../../../includes/tsql-md.md)]. Например, ALTER TABLE не позволяет изменять первичные ключевые столбцы.  
  
-   Сопоставление типов данных выполняется только для исходного моментального снимка. Изменения схемы не сопоставляются с предыдущими версиями типов данных. Например если инструкция `ALTER TABLE ADD datetime2 column` используется в [!INCLUDE[ssSQL11](../../../includes/sssql11-md.md)], не преобразуется в тип данных **nvarchar** для [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)] подписчиков. В некоторых случаях изменения схемы блокируются на издателе.  
  
-   Если в публикации разрешено распространение изменений схемы, то изменения схемы распространяются независимо от того, как установлен соответствующий параметр схемы для статьи в публикации. Например, если вы указываете не реплицировать ограничения внешних ключей для статьи таблицы, а затем выполняете команду ALTER TABLE, которая добавляет внешний ключ в таблицу на издателе, внешний ключ будет добавлен в таблицу на подписчике. Чтобы предотвратить это, отключите распространение изменений схемы перед выполнением команды ALTER TABLE.  
  
-   Изменения схемы должны выполняться только на издателе, а не на подписчиках (включая переиздающих подписчиков). Репликация слиянием предотвращает изменения схемы на подписчиках. Репликация транзакций не предотвращает изменения, однако изменения могут быть причиной ошибки репликации.  
  
-   Изменения, распространяемые на переиздающего подписчика, по умолчанию распространяются на его подписчиков.  
  
-   Если изменение схемы ссылается на объекты или ограничения, существующие на издателе, но отсутствующие на подписчике, изменение схемы будет успешно выполнено на издателе, а на подписчике оно завершится ошибкой.  
  
-   Любой объект на подписчике, на который имеются ссылки, при добавлении внешнего ключа должен иметь то же имя и того же владельца, что и соответствующий объект на издателе.  
  
-   Явное добавление, удаление и изменение индексов не поддерживаются. Поддерживается неявное создание индексов для ограничений (например, для ограничения первичного ключа).  
  
-   Изменение или удаление столбцов идентификаторов, управляемых репликацией, не поддерживается. Дополнительные сведения об автоматическом управлении столбцами идентификаторов см. в разделе [репликации столбцов идентификаторов](../../../relational-databases/replication/publish/replicate-identity-columns.md).  
  
-   Изменения схемы, включающие недетерминированные функции, не поддерживаются, поскольку они могут привести к разным данным на издателе и на подписчике (эта разница данных называется расхождением). Например, если выполнить следующую команду на издателе: `ALTER TABLE SalesOrderDetail ADD OrderDate DATETIME DEFAULT GETDATE()`, значения различаются, когда команда реплицируются на подписчик и выполняется. Дополнительные сведения о недетерминированных функциях см. в разделе [Deterministic and Nondeterministic Functions](../../../relational-databases/user-defined-functions/deterministic-and-nondeterministic-functions.md).  
  
-   Рекомендуется именовать ограничения явным образом. Если ограничение не именовано явным образом, то [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] создает для него имя. Эти имена будут отличаться для издателя и подписчика. Это может стать причиной проблем во время репликации изменений схемы. Например, если на издателе удаляется столбец и зависимое ограничение, то во время репликации будет произведена попытка удалить ограничение на подписчике. Эта попытка удаления на подписчике завершится ошибкой, так как имена ограничения на издателе и на подписчике различаются. Если синхронизация завершается сбоем из-за различия имен ограничения, то удалите ограничение на подписчике вручную, а затем перезапустите агент слияния.  
  
-   При публикации какой-либо таблицы для репликации невозможно изменить данные столбца в этой таблице на данные типа XML, если моментальный снимок публикации уже создан. Перед изменением столбца необходимо вначале удалить репликацию.  
  
-   Уровень изоляции «read uncommitted» не является поддерживаемым уровнем изоляции при выполнении DDL в опубликованной таблице.  
  
-   **SET CONTEXT_INFO** не будет использовать для изменения контекста транзакции когда выполняются изменения схемы для опубликованных объектов.  
  
#### Добавление столбцов  
  
-   Чтобы добавить новый столбец в таблицу и включить этот столбец в существующую публикацию, выполните ALTER TABLE \< таблица> Добавить \< столбец>. По умолчанию этот столбец затем реплицируется на все подписчики. Столбец должен допускать использование значений NULL или содержать ограничение по умолчанию. Дополнительные сведения о добавлении столбцов см. в подразделе «Репликация слиянием» этого раздела.  
  
-   Чтобы добавить новый столбец в таблицу и не включить этот столбец в существующую публикацию, отключите репликацию изменений схемы, а затем выполните ALTER TABLE \< таблица> Добавить \< столбец>.  
  
-   Чтобы включить существующий столбец в существующую публикацию, используйте [sp_articlecolumn & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-articlecolumn-transact-sql.md), [sp_mergearticlecolumn & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-mergearticlecolumn-transact-sql.md), или **Свойства публикации — \< публикация>** диалоговое окно.  
  
     Дополнительные сведения см. в статье [Define and Modify a Column Filter](../../../relational-databases/replication/publish/define-and-modify-a-column-filter.md). Это потребует повторной инициализации подписок.  
  
-   Добавление столбца идентификаторов в опубликованную таблицу не поддерживается, поскольку это может привести к расхождению данных при репликации столбца на подписчик. Значения в столбце идентификаторов на издателе зависят от порядка, в котором строки изменяемой таблицы хранятся физически. Строки могут храниться по-разному на подписчике. Поэтому значение для столбца идентификаторов может быть разным для одинаковых строк.  
  
#### Удаление столбцов  
  
-   Чтобы удалить столбец из существующей публикации и удалить столбец из таблицы на издателе, выполните ALTER TABLE \< таблица> DROP \< столбец>. По умолчанию столбец затем удаляется из таблицы на всех подписчиках.  
  
-   Чтобы удалить столбец из существующей публикации, но сохранить столбец в таблице на издателе, используйте [sp_articlecolumn & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-articlecolumn-transact-sql.md), [sp_mergearticlecolumn & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-mergearticlecolumn-transact-sql.md), или **Свойства публикации — \< публикация>** диалоговое окно.  
  
     Дополнительные сведения см. в статье [Define and Modify a Column Filter](../../../relational-databases/replication/publish/define-and-modify-a-column-filter.md). Это потребует создания нового моментального снимка.  
  
-   Удаляемый столбец не может использоваться в предложениях фильтра любой статьи любой публикации в базе данных.  
  
-   При удалении столбца из опубликованной статьи имейте в виду возможное влияние на базу данных ограничений, индексов и свойств столбца. Например:  
  
    -   Нельзя удалить столбцы, используемые первичным ключом, из статей в публикациях транзакций, потому что они используются репликацией.  
  
    -   Нельзя удалить столбец rowguid из статей в публикациях слиянием или столбец mstran_repl_version из статей в публикациях транзакций, поддерживающих обновляемые подписки, поскольку они используются репликацией.  
  
    -   Изменения индекса не распространяются на подписчики: при удалении столбца на издателе и зависимого индекса репликация удаления индекса не производится. Чтобы выполнить удаление столбца при его реплицировании с издателя на подписчик, следует удалить индекс на подписчике перед удалением столбца на издателе. Если выполнить синхронизацию не удалось из-за какого-либо индекса на подписчике, то удалите этот индекс вручную, а затем перезапустите агент слияния.  
  
    -   Ограничения следует именовать явным образом для удаления. Дополнительные сведения см. в подразделе «Общие вопросы» этого раздела.  
  
### Репликация транзакций  
  
-   Изменения схемы распространяются на подписчики, использующие предыдущие версии [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)], однако инструкция DDL должна содержать только тот синтаксис, который поддерживается версией подписчика.  
  
     Если подписчик публикует данные повторно, поддерживаемые изменения схемы включают только добавление и удаление столбца. Необходимо внести эти изменения на издатель с помощью [sp_repladdcolumn & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-repladdcolumn-transact-sql.md) и [sp_repldropcolumn & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-repldropcolumn-transact-sql.md) вместо синтаксиса ALTER DDL таблицы.  
  
-   Репликация изменений схемы не выполняется для подписчиков, отличных от подписчиков SQL Server.  
  
-   Изменения схемы не распространяются на издатели, не относящиеся к [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].  
  
-   Индексированные представления, которые реплицируются в виде таблиц, невозможно изменить. Индексированные представления, которые реплицируются как индексированные представления, могут быть изменены, однако их изменение приведет к тому, что они станут обычными, а не индексированными представлениями.  
  
-   Если публикация поддерживает подписки с немедленным обновлением или обновляемой посредством очередей подписки, перед выполнением изменений схемы следует заморозить систему: любые действия в опубликованной таблице должны быть прекращены на издателе и подписчиках, а отложенные изменения данных должны быть распространены на все узлы. После распространения изменений схемы на все узлы можно возобновить действия в опубликованных таблицах.  
  
-   Если публикация находится в одноранговой топологии, перед выполнением изменений схемы система должна быть приостановлена. Дополнительные сведения см. в разделе [замораживание топологии репликации & #40; Программирование репликации Transact-SQL & #41;](../../../relational-databases/replication/administration/quiesce-a-replication-topology-replication-transact-sql-programming.md).  
  
-   Добавление в таблицу столбца типа timestamp и сопоставление типа timestamp с типом binary(8) вызывает повторную инициализацию статьи для всех активных подписок.  
  
### Репликация слиянием  
  
-   Способ обработки изменений схемы при репликации слиянием определяется уровнем совместимости публикации и режимом моментального снимка — собственным (по умолчанию) или символьным.  
  
    -   Для репликации изменений схемы уровень совместимости публикации должен быть не меньше 90RTM. Если подписчики использующие предыдущие версии [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] или уровень совместимости меньше 90RTM, можно использовать [sp_repladdcolumn & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-repladdcolumn-transact-sql.md) и [sp_repldropcolumn & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-repldropcolumn-transact-sql.md) для добавления и удаления столбцов. Однако эти процедуры являются устаревшими.  
  
    -   Если попытаться добавить в существующую статью столбец с типом данных, появившимся в [!INCLUDE[ssKatmai](../../../includes/sskatmai-md.md)], то [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] будет вести себя следующим образом.  
  
        ||100RTM, собственный режим моментального снимка|100RTM, символьный режим моментального снимка|Все другие уровни совместимости|  
        |-|-----------------------------|--------------------------------|------------------------------------|  
        |**hierarchyid**|Разрешить изменения|Блокировать изменения|Блокировать изменения|  
        |**География** и **geometry**|Разрешить изменения|Разрешить изменения*|Блокировать изменения|  
        |**файловый поток**|Разрешить изменения|Блокировать изменения|Блокировать изменения|  
        |**Дата**, **время**, **datetime2**, и **datetimeoffset**|Разрешить изменения|Разрешить изменения*|Блокировать изменения|  
  
         * Подписчики SQL Server Compact преобразуют эти типы данных на подписчике.  
  
-   Если при применении изменения схемы возникает ошибка (например, ошибка по причине добавления внешнего ключа, ссылающегося на таблицу, которая недоступна на подписчике), синхронизация завершается ошибкой, и подписка должна быть инициализирована повторно.  
  
-   Если изменение схемы выполняется в столбце, входящем в фильтр соединения или параметризованный фильтр, потребуется повторно инициализировать все подписки и заново создать моментальный снимок.  
  
-   Репликация слиянием обеспечивает игнорирование хранимыми процедурами изменений схемы во время устранения неполадок. Дополнительные сведения см. в разделе [sp_markpendingschemachange & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-markpendingschemachange-transact-sql.md) и [sp_enumeratependingschemachanges & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-enumeratependingschemachanges-transact-sql.md).  
  
## См. также:  
 [Инструкция ALTER TABLE & #40; Transact-SQL и #41;](../../../t-sql/statements/alter-table-transact-sql.md)   
 [ALTER VIEW & #40; Transact-SQL и #41;](../../../t-sql/statements/alter-view-transact-sql.md)   
 [ALTER PROCEDURE & #40; Transact-SQL и #41;](../../../t-sql/statements/alter-procedure-transact-sql.md)   
 [ALTER FUNCTION & #40; Transact-SQL и #41;](../../../t-sql/statements/alter-function-transact-sql.md)   
 [ALTER TRIGGER & #40; Transact-SQL и #41;](../../../t-sql/statements/alter-trigger-transact-sql.md)   
 [Публикация данных и объектов базы данных](../../../relational-databases/replication/publish/publish-data-and-database-objects.md)   
 [Повторное создание пользовательских процедур транзакций для отражения изменений схем](../../../relational-databases/replication/transactional/regenerate-custom-transactional-procedures-to-reflect-schema-changes.md)  
  
  