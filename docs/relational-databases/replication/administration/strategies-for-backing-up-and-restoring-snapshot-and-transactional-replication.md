---
title: "Стратегии резервного копирования и восстановления из копии репликации моментальных снимков и репликации транзакций | Microsoft Docs"
ms.custom: ""
ms.date: "03/14/2017"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "replication"
ms.tgt_pltfrm: ""
ms.topic: "article"
helpviewer_keywords: 
  - "резервные копии [репликация SQL Server], репликация моментальных снимков"
  - "восстановление [репликация SQL Server], репликация транзакций"
  - "репликация моментальных снимков [SQL Server], резервное копирование и восстановление"
  - "восстановление [репликация SQL Server], репликация моментальных снимков"
  - "восстановление [репликация SQL Server], репликация транзакций"
  - "репликация транзакций, резервное копирование и восстановление"
  - "восстановление [репликация SQL Server], репликация моментальных снимков"
  - "синхронизация с резервной копией [репликация SQL Server]"
  - "резервные копии [репликация SQL Server], репликация транзакций"
ms.assetid: a8afcdbc-55db-4916-a219-19454f561f9e
caps.latest.revision: 59
author: "BYHAM"
ms.author: "rickbyh"
manager: "jhubbard"
caps.handback.revision: 59
---
# Стратегии резервного копирования и восстановления из копии репликации моментальных снимков и репликации транзакций
  При разработке стратегии резервного копирования и восстановления для репликации моментальных снимков и репликации транзакций необходимо учитывать три аспекта.  
  
-   Какие базы данных будут подвергаться резервному копированию.  
  
-   Настройки резервного копирования для репликации транзакций.  
  
-   Шаги, необходимые для восстановления базы данных. Они зависят от типа репликации и выбранных параметров.  
  
 Эта тема охватывает данные группы вопросов в следующих трех разделах. Сведения о резервном копировании и восстановлении для публикации Oracle см. в разделе [резервное копирование и восстановление для издателей Oracle](../../../relational-databases/replication/non-sql/backup-and-restore-for-oracle-publishers.md).  
  
## Резервное копирование баз данных  
 Для репликации моментальных снимков и репликации транзакций необходимо регулярно выполнять резервное копирование следующих баз данных:  
  
-   База данных публикации на издателе.  
  
-   База данных распространителя на распространителе.  
  
-   База данных подписки на подписчике.  
  
-   Системные базы данных **master** и **msdb** на издателе, распространителе и на всех подписчиках. Резервные копии этих баз данных и копия соответствующей базы данных репликации должны быть сделаны одновременно. Например, создайте резервную копию **master** и **msdb** базы данных издателя в то же время, что резервное копирование базы данных публикации. Если база данных публикации восстановлена, убедитесь, что **master** и **msdb** согласованы с базой данных публикации по параметрам и конфигурации репликации.  
  
 Если резервное копирование журналов выполняется регулярно, любые изменения, касающиеся репликации, будут заноситься в резервные копии журнала. Если не выполняется резервное копирование журналов, то необходимо выполнить это резервное копирование при каждом изменении настройки, относящейся к репликации. Дополнительные сведения см. в статье [Common Actions Requiring an Updated Backup](../../../relational-databases/replication/administration/common-actions-requiring-an-updated-backup.md).  
  
## Настройки резервного копирования для репликации транзакций  
 Репликация транзакций включает **синхронизации с резервной копией** вариант, который можно задать в базе данных распространителя и базы данных публикации:  
  
-   Рекомендуется устанавливать этот параметр в базе данных распространителя.  
  
     Установка этого параметра для базы данных распространителя гарантирует, что транзакции в журнале базы данных публикации не будут усечены до тех пор, пока не будет создана их резервная копия в базе данных распространителя. Базу данных распространителя можно восстановить до последней резервной копии, а все потерянные транзакции будут доставлены из базы данных публикации в базу данных распространителя. Репликация не затрагивается.  
  
     Установка этого параметра для базы данных распространителя не влияет на задержку репликации. Тем не менее этот параметр откладывает усечение журнала в базе данных публикации до того момента, пока не завершится резервное копирование соответствующих транзакций в базе данных распространителя. (Это может привести к увеличению размера журнала транзакций в базе данных публикации.)  
  
-   Рекомендуется установить этот параметр для базы данных публикации, если приложение допускает дополнительную задержку.  
  
     Установка этого параметра для базы данных публикации гарантирует, что транзакции не будут доставлены в базу данных распространителя до тех пор, пока не будет создана их резервная копия в базе данных публикации. Последняя резервная копия базы данных публикации может быть затем восстановлена на издателе, при этом в базе данных распространителя не будет транзакций, которых нет в восстановленной базе данных публикации.  
  
     Задержка и пропускная способность изменяются, так как транзакции не могут быть доставлены в базу данных распространителя до тех пор, пока не будут созданы их резервные копии на издателе. Например, если резервная копия журнала транзакций создается каждые пять минут, потребуются дополнительные пять минут задержки между фиксацией транзакции на издателе и доставкой транзакции сначала в базу данных распространителя, а затем подписчику.  
  
    > [!NOTE]  
    >   **Синхронизации с резервной копией** обеспечивает согласованность базы данных публикации и базе данных распространителя, но параметр не гарантирует отсутствия потерь данных. Например, если журнал транзакций потерян, транзакции, зафиксированные после последнего резервного копирования журнала транзакций, не будут доступны в базе данных публикации или базе данных распространителя. Точно так же ведет себя нереплицируемая база данных.  
  
 **Установка параметра «sync with backup»**  
  
-   Репликация [!INCLUDE[tsql](../../../includes/tsql-md.md)] программирования: [Включение скоординированного резервного копирования для репликации транзакций и #40; Программирование репликации Transact-SQL и #41;](../../../relational-databases/replication/administration/enable coordinated backups for transactional replication.md)  
  
## Восстановление баз данных, участвующих в репликации  
 Если имеются последние резервные копии и выполнены соответствующие шаги, можно восстановить все базы данных в топологии репликации. Действия по восстановлению базы данных публикации зависят от типа репликации и от используемых параметров, однако действия по восстановлению всех других баз данных не зависят от типа репликации и параметров.  
  
 Служба репликации поддерживает восстановление реплицированной базы данных на том же сервере и в той же базе данных, где была создана ее резервная копия. Если восстановить резервную копию реплицированной базы данных на другом сервере или в другой базе данных, то станет невозможным сохранение настроек репликации. В этом случае после восстановления из резервной копии потребуется повторно создать все публикации и подписки.  
  
### Издатель  
 Последовательность шагов по восстановлению предлагается для следующих типов репликации:  
  
-   репликация моментальных снимков;  
  
-   репликация транзакций, доступная только для чтения;  
  
-   репликация транзакций с обновляемыми подписками;  
  
-   одноранговая репликация транзакций.  
  
 Восстановление **msdb** и **master** баз данных, которые также рассматриваются в этом разделе, является одинаковым для всех четырех типов.  
  
#### База данных публикации: репликация моментальных снимков  
  
1.  Восстановите последнюю резервную копию базы данных публикации. Перейдите к шагу 2.  
  
2.  Содержит ли резервная копия базы данных публикации последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 3.  
  
3.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. Восстановление завершено.  
  
     Дополнительные сведения об удалении репликации см. в разделе [sp_removedbreplication & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql.md).  
  
#### База данных публикации: репликация транзакций, доступная только для чтения  
  
1.  Восстановите последнюю резервную копию базы данных публикации. Перейдите к шагу 2.  
  
2.  Было **синхронизации с резервной копией** в базе данных публикации перед сбоем включен параметр? Если да, перейдите к шагу 3, если нет — к шагу 5.  
  
     Если параметр включен, запрос `SELECT DATABASEPROPERTYEX('<PublicationDatabaseName>', 'IsSyncWithBackup')` возвращает '1'.  
  
3.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 4.  
  
4.  Сведения о конфигурации восстановленной базы данных публикации устарели. Необходимо убедиться, что у подписчиков имеются все команды, ожидающие выполнения в базе данных распространителя, а затем удалить и повторно создать конфигурацию репликации.  
  
    1.  Запускайте агент распространителя до полной синхронизации подписчиков с ожидающими выполнения командами в базе данных распространителя. Убедитесь, что все команды доставлены подписчикам с помощью **Нераспространенные команды** вкладки в мониторе репликации или запросив [MSdistribution_status](../../../relational-databases/system-views/msdistribution-status-transact-sql.md) представления в базе данных распространителя. Перейдите к шагу b.  
  
         Дополнительные сведения о запуске агента распространителя см. в разделе [Запуск и остановка агента репликации & #40; SQL Server Management Studio & #41;](../../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../../../relational-databases/replication/concepts/replication-agent-executables-concepts.md).  
  
         Дополнительные сведения о проверке команд см. в разделе [команды реплицировать представления и другие сведения в базе данных распространителя и #40; Программирование репликации Transact-SQL & #41;](../../../relational-databases/replication/monitor/view replicated commands and information in distribution database.md) и [Просмотр сведений и выполнение задач для агентов, связанных с подпиской и #40; Монитор репликации & #41;](../../../relational-databases/replication/monitor/view information and perform tasks for subscription agents.md).  
  
    2.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Восстановление завершено.  
  
         Дополнительные сведения об удалении репликации см. в разделе [sp_removedbreplication & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql.md).  
  
         Дополнительные сведения о том, как указать, что у подписчика уже есть данные в разделе [Инициализация подписки вручную](../../../relational-databases/replication/initialize-a-subscription-manually.md).  
  
5.   **Синхронизации с резервной копией** не установлен параметр базы данных публикации. Следовательно, транзакции, не включенные в восстановленную резервную копию, могли быть переданы распространителю и подписчикам. Необходимо убедиться, что в базе данных распространителя у подписчиков есть все команды, ожидающие обработки, затем вручную применить к базе данных публикации все транзакции, отсутствующие в восстановленной резервной копии.  
  
    > [!IMPORTANT]  
    >  В результате этих действий опубликованные таблицы могут быть восстановлены до более современных версий, чем версии неопубликованных таблиц, восстановленных из резервной копии.  
  
    1.  Запускайте агент распространителя до полной синхронизации подписчиков с ожидающими выполнения командами в базе данных распространителя. Убедитесь, что все команды доставлены подписчикам с помощью **Нераспространенные команды** вкладки в мониторе репликации или запросив [MSdistribution_status](../../../relational-databases/system-views/msdistribution-status-transact-sql.md) представления в базе данных распространителя. Перейдите к шагу b.  
  
         Дополнительные сведения о запуске агента распространителя см. в разделе [Запуск и остановка агента репликации & #40; SQL Server Management Studio & #41;](../../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../../../relational-databases/replication/concepts/replication-agent-executables-concepts.md).  
  
         Дополнительные сведения о проверке команд см. в разделе [команды реплицировать представления и другие сведения в базе данных распространителя и #40; Программирование репликации Transact-SQL & #41;](../../../relational-databases/replication/monitor/view replicated commands and information in distribution database.md) и [Просмотр сведений и выполнение задач для агентов, связанных с подпиской и #40; Монитор репликации & #41;](../../../relational-databases/replication/monitor/view information and perform tasks for subscription agents.md).  
  
    2.  Используйте [программа tablediff](../../../tools/tablediff-utility.md) или другое средство для ручной синхронизации издателя с подписчиком. Это позволяет восстанавливать данные из базы данных подписчика, которая не содержалась в резервной копии базы данных публикации. Перейдите к шагу c.  
  
         Дополнительные сведения о **tablediff** программы, в разделе [сравнения реплицированных таблицах для различия & #40; Программирование репликации на & #41;](../../../relational-databases/replication/administration/compare-replicated-tables-for-differences-replication-programming.md).  
  
    3.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если Да, выполнять [sp_replrestart](../../../relational-databases/system-stored-procedures/sp-replrestart-transact-sql.md) хранимую процедуру, чтобы повторно синхронизировать метаданные издателя и распространителя с помощью. Восстановление завершено. Если нет, перейдите к шагу d.  
  
    4.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Восстановление завершено.  
  
         Дополнительные сведения об удалении репликации см. в разделе [sp_removedbreplication & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql.md).  
  
         Дополнительные сведения о том, как указать, что у подписчика уже есть данные в разделе [Инициализация подписки вручную](../../../relational-databases/replication/initialize-a-subscription-manually.md).  
  
#### База данных публикации: репликация транзакций с обновлением подписок  
  
1.  Восстановите последнюю резервную копию базы данных публикации. Перейдите к шагу 2.  
  
2.  Запускайте агент распространителя до полной синхронизации подписчиков с ожидающими выполнения командами в базе данных распространителя. Убедитесь, что все команды доставлены подписчикам с помощью **Нераспространенные команды** вкладки в мониторе репликации или запросив [MSdistribution_status](../../../relational-databases/system-views/msdistribution-status-transact-sql.md) представления в базе данных распространителя. Перейдите к шагу 3.  
  
     Дополнительные сведения о запуске агента распространителя см. в разделе [Запуск и остановка агента репликации & #40; SQL Server Management Studio & #41;](../../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../../../relational-databases/replication/concepts/replication-agent-executables-concepts.md).  
  
     Дополнительные сведения о проверке команд см. в разделе [команды реплицировать представления и другие сведения в базе данных распространителя и #40; Программирование репликации Transact-SQL & #41;](../../../relational-databases/replication/monitor/view replicated commands and information in distribution database.md) и [Просмотр сведений и выполнение задач для агентов, связанных с подпиской и #40; Монитор репликации & #41;](../../../relational-databases/replication/monitor/view information and perform tasks for subscription agents.md).  
  
3.  Если вы используете обновляемые посредством очередей подписки, подключитесь к каждому подписчику и удалите все строки из [MSreplication_queue & #40; Transact-SQL & #41;](../../../relational-databases/system-tables/msreplication-queue-transact-sql.md) Таблица в базе данных подписки. Перейдите к шагу 4.  
  
    > [!NOTE]  
    >  Если используются обновляемые посредством очередей подписки и какие-либо таблицы содержат столбцы идентификаторов, следует убедиться, что после восстановления назначены правильные диапазоны идентификаторов. Дополнительные сведения см. в разделе [репликации столбцов идентификаторов](../../../relational-databases/replication/publish/replicate-identity-columns.md).  
  
4.  Необходимо убедиться, что в базе данных распространителя у подписчиков есть все команды, ожидающие обработки, затем вручную применить к базе данных публикации все транзакции, отсутствующие в восстановленной резервной копии.  
  
    > [!IMPORTANT]  
    >  В результате этих действий опубликованные таблицы могут быть восстановлены до более современных версий, чем версии неопубликованных таблиц, восстановленных из резервной копии.  
  
    1.  Запускайте агент распространителя до полной синхронизации подписчиков с ожидающими выполнения командами в базе данных распространителя. Убедитесь, что все команды доставлены подписчикам с помощью монитора репликации или запросив [MSdistribution_status](../../../relational-databases/system-views/msdistribution-status-transact-sql.md) представления в базе данных распространителя. Перейдите к шагу b.  
  
    2.  Используйте [программа tablediff](../../../tools/tablediff-utility.md) или другое средство для ручной синхронизации издателя с подписчиком. Это позволяет восстанавливать данные из базы данных подписчика, которая не содержалась в резервной копии базы данных публикации. Перейдите к шагу c.  
  
         Дополнительные сведения о **tablediff** программы, в разделе [сравнения реплицированных таблицах для различия & #40; Программирование репликации на & #41;](../../../relational-databases/replication/administration/compare-replicated-tables-for-differences-replication-programming.md).  
  
    3.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если Да, выполнять [sp_replrestart](../../../relational-databases/system-stored-procedures/sp-replrestart-transact-sql.md) хранимую процедуру, чтобы повторно синхронизировать метаданные издателя и распространителя с помощью. Восстановление завершено. Если нет, перейдите к шагу d.  
  
    4.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Восстановление завершено.  
  
         Дополнительные сведения об удалении репликации см. в разделе и [sp_removedbreplication & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql.md).  
  
         Дополнительные сведения о том, как указать, что у подписчика уже есть данные в разделе [Инициализация подписки вручную](../../../relational-databases/replication/initialize-a-subscription-manually.md).  
  
#### База данных публикации: одноранговая репликация транзакций  
 В следующих шагах базы данных публикаций **A**, **B**, и **C** в топологии репликации транзакций peer-to-peer. Базы данных **A** и **C** подключены к сети и работает правильно, базы данных **B** является восстанавливаемой базы данных. Описанные здесь действия, особенно шаги 7, 10 и 11, очень похожи на процесс добавления узла к одноранговой топологии. Самый простой путь выполнения этих шагов — использование мастера настройки одноранговой топологии, однако можно использовать и хранимые процедуры.  
  
1.  Запустите агент распространителя для синхронизации подписок в базах данных **A** и **C**. Перейдите к шагу 2.  
  
     Дополнительные сведения о запуске агента распространителя см. в разделе [Запуск и остановка агента репликации & #40; SQL Server Management Studio & #41;](../../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../../../relational-databases/replication/concepts/replication-agent-executables-concepts.md).  
  
2.  Если база данных распространителя, **B** использует все еще доступна, запустите агент распространителя для синхронизации подписок между базами данных **B** и **A** и баз данных, так и B и **C**. Перейдите к шагу 3.  
  
3.  Удалите метаданные из распределения базы данных, которые **B** использует при выполнении [sp_removedistpublisherdbreplication](../../../relational-databases/system-stored-procedures/sp-removedistpublisherdbreplication-transact-sql.md) в базе данных распространителя для **B**. Перейдите к шагу 4.  
  
4.  В базах данных **A** и **C**, удалите подписки на публикацию в базе данных **B**. Перейдите к шагу 5.  
  
     Дополнительные сведения об удалении подписок см. в разделе [подписаться на публикации](../../../relational-databases/replication/subscribe-to-publications.md).  
  
5.  Выполните резервное копирование журнала или полное резервное копирование базы данных **A**. Перейдите к шагу 6.  
  
6.  Восстановите резервную копию базы данных **A** в базе данных **B**. База данных **B** теперь содержит данные из базы данных **A**, но не конфигурацию репликации. При восстановлении резервной копии на другой сервер, репликация удаляется; Таким образом, репликация была удалена из базы данных **B**. Перейдите к шагу 7.  
  
7.  Повторно создайте публикацию в базе данных **B**, и создайте заново подписки между базами данных **A** и **B**. (Подписки, затрагивающие базу данных **C** обрабатываются в дальнейшем.).  
  
    1.  Повторно создайте публикацию в базе данных **B**. Перейдите к шагу b.  
  
    2.  Создайте заново подписку в базе данных **B** публикацию в базе данных **A**, указав, что подписка должна быть инициализирована с резервной копией (значение **инициализации при помощи резервной копии** для **@sync_type** параметр [sp_addsubscription](../../../relational-databases/system-stored-procedures/sp-addsubscription-transact-sql.md)). Перейдите к шагу c.  
  
    3.  Создайте заново подписку в базе данных **A** публикацию в базе данных **B**, указав, что подписчик уже содержит данные (значение **Поддержка только репликации** для **@sync_type** параметр [sp_addsubscription](../../../relational-databases/system-stored-procedures/sp-addsubscription-transact-sql.md)). Перейдите к шагу 8.  
  
8.  Запустите агент распространителя для синхронизации подписок в базах данных **A** и **B**. Если в публикуемых таблицах имеются столбцы идентификаторов, перейдите к шагу 9. Если нет, перейдите к шагу 10.  
  
9. После восстановления диапазон идентификаторов, назначенный для таблиц в базе данных **значение** будет также использоваться в базе данных **B**. Убедитесь, что Восстановленная база данных **B** получил все изменения из поврежденной базы данных **B** которые были переданы в базу данных **A** базы данных и **C**; и повторное заполнение диапазона идентификаторов для каждой таблицы.  
  
    1.  Выполнение [sp_requestpeerresponse](../../../relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql.md) в базе данных **B** и получите возвращаемый параметр **@request_id**. Перейдите к шагу b.  
  
    2.  По умолчанию агент распространителя работает непрерывно, поэтому токены отправляются на все узлы автоматически. Если агент распространителя не выполняется в непрерывном режиме, запустите его. Дополнительные сведения см. в разделе [Основные понятия исполняемых файлов агента репликации](../../../relational-databases/replication/concepts/replication-agent-executables-concepts.md) или [Запуск и остановка агента репликации & #40; SQL Server Management Studio & #41;](../../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md). Перейдите к шагу c.  
  
    3.  Выполнение [sp_helppeerresponses](../../../relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql.md), указав **@request_id** значение, полученное на шаге b. Подождите, пока все узлы сообщат о получении однорангового запроса. Перейдите к шагу d.  
  
    4.  Используйте [DBCC CHECKIDENT](../../../t-sql/database-console-commands/dbcc-checkident-transact-sql.md) для каждой таблицы в базе данных **B** Чтобы убедиться в том, что используется соответствующий диапазон. Перейдите к шагу 10.  
  
     Дополнительные сведения об управлении диапазонами идентификаторов см. раздел «Присвоение диапазонов для ручного управления диапазонами идентификаторов» [репликации столбцов идентификаторов](../../../relational-databases/replication/publish/replicate-identity-columns.md).  
  
10. На этом этапе база данных **B** базы данных и **C** не связаны напрямую, но они будут получать изменения через базу данных **A**. Если топология содержит узлы, на которых выполняется [!INCLUDE[ssVersion2005](../../../includes/ssversion2005-md.md)], перейдите к шагу 11, в противном случае перейдите к шагу 12.  
  
11. Приостановите систему и создайте заново подписки между базами данных **B** и **C**. Приостановка системы подразумевает остановку действий в опубликованных таблицах на всех узлах и проверку получения изменений на каждом узле.  
  
    1.  Остановите все действия в опубликованных таблицах в одноранговой топологии. Перейдите к шагу b.  
  
    2.  Выполнение [sp_requestpeerresponse](../../../relational-databases/system-stored-procedures/sp-requestpeerresponse-transact-sql.md) в базе данных **B** и получите возвращаемый параметр **@request_id**. Перейдите к шагу c.  
  
    3.  По умолчанию агент распространителя работает непрерывно, поэтому токены отправляются на все узлы автоматически. Если агент распространителя не выполняется в непрерывном режиме, запустите его. Перейдите к шагу d.  
  
    4.  Выполнение [sp_helppeerresponses](../../../relational-databases/system-stored-procedures/sp-helppeerresponses-transact-sql.md), указав **@request_id** значение, полученное на шаге b. Подождите, пока все узлы сообщат о получении однорангового запроса. Перейдите к шагу e.  
  
    5.  Создайте заново подписку в базе данных **B** публикацию в базе данных **C**, указав, что подписчик уже содержит данные. Перейдите к шагу b.  
  
    6.  Создайте заново подписку в базе данных **C** публикацию в базе данных **B**, указав, что подписчик уже содержит данные. Перейдите к шагу 13.  
  
12. Создайте заново подписку между базами данных **B** и **C**:  
  
    1.  В базе данных **B**, запрос [MSpeer_lsns](../../../relational-databases/system-tables/mspeer-lsns-transact-sql.md) таблицы для получения порядковый номер транзакции в журнале (LSN) последней транзакции базы данных **B** из базы данных **C**.  
  
    2.  Создайте заново подписку в базе данных **B** публикацию в базе данных **C**, указав, что подписка должна быть инициализирована на основе номера LSN (значение **инициализировать из номера lsn** для **@sync_type** параметр [sp_addsubscription](../../../relational-databases/system-stored-procedures/sp-addsubscription-transact-sql.md)). Перейдите к шагу b.  
  
    3.  Создайте заново подписку в базе данных **C** публикацию в базе данных **B**, указав, что подписчик уже содержит данные. Перейдите к шагу 13.  
  
13. Запустите агент распространителя для синхронизации подписок в базах данных **B** и **C**. Восстановление завершено.  
  
#### База данных msdb (Издатель)  
  
1.  Восстановите последнюю резервную копию **msdb** базы данных.  
  
2.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 3.  
  
3.  Создайте заново задание очистки подписки из скриптов репликации. Восстановление завершено.  
  
#### База данных master (Издатель)  
  
1.  Восстановите последнюю резервную копию **master** базы данных.  
  
2.  Убедитесь, что база данных согласована с базой данных публикации по конфигурации и параметрам репликации.  
  
### Базы данных на распространителе  
  
#### База данных распространителя  
  
1.  Восстановите последнюю резервную копию базы данных распространителя.  
  
2.  Было **синхронизации с резервной копией** на базе данных распространителя перед сбоем включен параметр? Если да, перейдите к шагу 3, если нет — к шагу 4.  
  
     Если параметр включен, запрос `SELECT DATABASEPROPERTYEX('<DistributionDatabaseName>', 'IsSyncWithBackup')` возвращает '1'.  
  
3.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 4.  
  
4.  Сведения конфигурации в восстановленной базе данных распространителя не обновлена, или **синхронизации с резервной копией** не установлен параметр базы данных распространителя. (После восстановления в базе данных распространителя могут иметься потерянные транзакции, зафиксированные на издателе, но не переданные подписчикам.) Удалите и создайте заново репликацию, а затем выполните проверку.  
  
    1.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Перейдите к шагу b.  
  
         Дополнительные сведения об удалении репликации см. в разделе [sp_removedbreplication & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql.md).  
  
         Дополнительные сведения о том, как указать, что у подписчика уже есть данные в разделе [Инициализация подписки вручную](../../../relational-databases/replication/initialize-a-subscription-manually.md).  
  
    2.  Отметьте все публикации для проверки. Повторно инициализируйте все подписки, не прошедшие проверку. Восстановление завершено.  
  
         Дополнительные сведения о проверке см. в разделе [проверки репликации данных](../../../relational-databases/replication/validate-replicated-data.md). Дополнительные сведения о повторной инициализации см. в разделе [повторно инициализировать подписки](../../../relational-databases/replication/reinitialize-subscriptions.md).  
  
#### База данных msdb (Распространитель)  
  
1.  Восстановите последнюю резервную копию **msdb** базы данных.  
  
2.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех публикаций и подписок? Если да, восстановление завершено. Если нет, перейдите к шагу 3.  
  
3.  Удалите конфигурацию репликации с издателя, распространителя и подписчиков, затем создайте конфигурацию заново. При повторном создании подписок укажите, что подписчик уже содержит данные. Перейдите к шагу 4.  
  
     Дополнительные сведения об удалении репликации см. в разделе [sp_removedbreplication & #40; Transact-SQL & #41;](../../../relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql.md).  
  
     Дополнительные сведения о том, как указать, что у подписчика уже есть данные в разделе [Инициализация подписки вручную](../../../relational-databases/replication/initialize-a-subscription-manually.md).  
  
4.  Отметьте все публикации для проверки. Повторно инициализируйте все подписки, не прошедшие проверку. Восстановление завершено.  
  
     Дополнительные сведения о проверке см. в разделе [проверки репликации данных](../../../relational-databases/replication/validate-replicated-data.md). Дополнительные сведения о повторной инициализации см. в разделе [повторно инициализировать подписки](../../../relational-databases/replication/reinitialize-subscriptions.md).  
  
#### База данных master (Распространитель)  
  
1.  Восстановите последнюю резервную копию **master** базы данных.  
  
2.  Убедитесь, что база данных согласована с базой данных публикации по конфигурации и параметрам репликации.  
  
### Базы данных на подписчике  
  
#### База данных подписки  
  
1.  Является ли последняя резервная копия базы данных подписки более поздней, чем значение параметра минимального срока хранения распространения в базе данных распространителя? (Этим определяется, имеются ли у распространителя все команды, необходимые для обновления подписчика.) Если да, перейдите к шагу 2. Если нет, выполните повторную инициализацию подписки. Восстановление завершено.  
  
     Чтобы определить параметры хранения максимальное распространения, выполните [sp_helpdistributiondb](../../../relational-databases/system-stored-procedures/sp-helpdistributiondb-transact-sql.md) и извлеките значение из **max_distretention** столбец (это значение в часах).  
  
     Дополнительные сведения о повторной инициализации подписки см. в разделе [Повторная инициализация подписки](../../../relational-databases/replication/reinitialize-a-subscription.md).  
  
2.  Восстановите последнюю резервную копию базы данных подписки. Перейдите к шагу 3.  
  
3.  Если база данных подписки содержит только принудительные подписки, перейдите к шагу 4. Если база данных подписки содержит какие-либо подписки по запросу, задайте следующие вопросы. Актуальны ли сведения о подписке? Включает ли база данных все таблицы и параметры, которые были установлены на момент сбоя. Если да, перейдите к шагу 4. Если нет, выполните повторную инициализацию подписки. Восстановление завершено.  
  
4.  Для синхронизации подписчика запустите агент распространителя. Восстановление завершено.  
  
     Дополнительные сведения о запуске агента распространителя см. в разделе [Запуск и остановка агента репликации & #40; SQL Server Management Studio & #41;](../../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md) и [Основные понятия исполняемых файлов агента репликации](../../../relational-databases/replication/concepts/replication-agent-executables-concepts.md).  
  
#### База данных msdb (Подписчик)  
  
1.  Восстановите последнюю резервную копию **msdb** базы данных. Используются ли на этом подписчике подписки по запросу? Если нет, восстановление завершено. Если да, перейдите к шагу 2.  
  
2.  Является ли восстановленная резервная копия полной и содержащей последние данные? Содержит ли она последнюю конфигурацию всех подписок по запросу? Если да, восстановление завершено. Если нет, перейдите к шагу 3.  
  
3.  Удалите и создайте заново подписки по запросу. При повторном создании подписок укажите, что подписчик уже содержит данные. Восстановление завершено.  
  
     Дополнительные сведения об удалении подписок см. в разделе [подписаться на публикации](../../../relational-databases/replication/subscribe-to-publications.md).  
  
     Дополнительные сведения о том, как указать, что у подписчика уже есть данные в разделе [Инициализация подписки вручную](../../../relational-databases/replication/initialize-a-subscription-manually.md).  
  
#### База данных master (Подписчик)  
  
1.  Восстановите последнюю резервную копию **master** базы данных.  
  
2.  Убедитесь, что база данных согласована с базой данных публикации по конфигурации и параметрам репликации.  
  
## См. также:  
 [Резервное копирование и восстановление баз данных SQL Server](../../../relational-databases/backup-restore/back-up-and-restore-of-sql-server-databases.md)   
 [Создание резервной копии и восстановление из копий реплицируемых баз данных](../../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md)   
 [Настройка распространителя](../../../relational-databases/replication/configure-distribution.md)   
 [Публикация данных и объектов базы данных](../../../relational-databases/replication/publish/publish-data-and-database-objects.md)   
 [Подписка на публикации](../../../relational-databases/replication/subscribe-to-publications.md)   
 [Инициализация подписки](../../../relational-databases/replication/initialize-a-subscription.md)   
 [Синхронизация данных](../../../relational-databases/replication/synchronize-data.md)  
  
  