---
title: Устранение неполадок SQL Server управляемого резервного копирования в Windows Azure | Документы Microsoft
ms.custom: ''
ms.date: 03/08/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.suite: ''
ms.technology:
- dbe-backup-restore
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: a34d35b0-48eb-4ed1-9f19-ea14754650da
caps.latest.revision: 18
author: JennieHubbard
ms.author: jhubbard
manager: jhubbard
ms.openlocfilehash: ffe54aa0c911b659283784196d52f073c772a3af
ms.sourcegitcommit: 5dd5cad0c1bbd308471d6c885f516948ad67dfcf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2018
ms.locfileid: "36086944"
---
# <a name="troubleshooting-sql-server-managed--backup-to-windows-azure"></a>Устранение неполадок SQL Server управляемого резервного копирования в Windows Azure
  В этом разделе описываются задачи и средства, позволяющие устранять ошибки, которые могут возникнуть при выполнении операций [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
## <a name="overview"></a>Обзор  
 В [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] есть встроенные проверки и процедуры устранения неполадок, поэтому во многих случаях внутренними сбоями занимается сам процесс [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
 Примером такого случая является удаление файла резервной копии в результате разрыва цепочки журналов, влияющего на возможность восстановления, — [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] определит разрыв в цепочке и запланирует немедленное резервное копирование. Однако рекомендуется отслеживать состояние и устранять все ошибки, требующие вмешательства пользователя.  
  
 В журналы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] записываются события и ошибки с использованием системных хранимых процедур, системных представлений и расширенных событий. Системные представления и хранимые процедуры предоставляют данные конфигурации [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)], состояние запланированных операций резервного копирования, а также ошибки, зарегистрированные расширенными событиями. [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] использует расширенные события для регистрации событий и последующего устранения неполадок. Помимо регистрации событий политики SQL Server Smart Admin предоставляют состояние работоспособности, используемое заданием уведомления по электронной почте для отправки уведомлений об ошибках и проблемах. Дополнительные сведения см. [монитора SQL Server Managed Backup to Windows Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).  
  
 Службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] используют то же журналирование, что и при ручном создании резервных копий в хранилище Windows Azure (резервное копирование SQL Server на URL-адрес). Для проблем, связанных с Дополнительные сведения о резервном копировании на URL-адрес, в разделе об устранении неполадок в [SQL Server Backup to URL Best Practices и устранение неполадок](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md)  
  
### <a name="general-troubleshooting-steps"></a>Основные шаги диагностики  
  
1.  Включите уведомление по электронной почте, чтобы получать сообщения с ошибками и предупреждениями.  
  
     Кроме того, можно периодически выполнять `smart_admin.fn_get_health_status` для проверки статистических ошибок и счетчиков. Например, `number_of_invalid_credential_errors` указывает, сколько раз резервное копирование Smart Backup завершилось с ошибкой из-за неверных учетных данных. `Number_of_backup_loops` и `number_of_retention_loops` не являются ошибками, но указывают, сколько раз поток резервного копирования и поток хранения сканировали список баз данных. Как правило, когда @begin_time и @end_time пользователь не указан, функция отображает сведения за последние 30 минут, то должны отображаться ненулевые значения для этих двух столбцов. Если они равны нулю, это означает, что система перегружена или даже не отвечает. Дополнительные сведения см. в разделе **проблемы системы диагностики** далее в этом разделе.  
  
2.  Изучите журналы расширенных событий, чтобы получить дополнительные сведения об ошибках и связанных событиях.  
  
3.  Данные в журналах помогут устранить проблему.  В случае системной проблемы или ошибки, возможно, придется перезапустить службу или агент SQL Server.  
  
### <a name="common-causes-of-errors"></a>Распространенные причины появления ошибок  
 Далее представлен список распространенных причин, приводящих к сбоям.  
  
1.  **Изменения учетных данных SQL:** Если имя учетных данных используется [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] изменяется или удаляется, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не смогут выполнять резервное копирование. Изменение должно быть применено к параметрам конфигурации [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
2.  **Изменение значений ключа доступа хранилища:** Если изменения значений ключа хранилища для учетной записи Windows Azure, но учетные данные SQL не обновляется новыми значениями [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] произойдет сбой при проверке подлинности в хранилище и не может выполнить резервное копирование базы данных, настроенные для использования этой учетной записи.  
  
3.  **Изменение учетной записи хранилища Windows Azure:** удаление или переименование учетной записи хранения без соответствующих изменений учетных данных SQL приведет к [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] сбой, резервное копирование не будет завершена. При удалении учетной записи хранения убедитесь, что в настройки баз данных будут внесены сведения о действительной учетной записи хранения. Если учетная запись хранения переименована или меняются значения ключей, убедитесь в том, что эти изменения отражены в учетных данных SQL, используемых [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
4.  **Изменения свойств базы данных:** изменение моделей восстановления или изменения имени может вызвать ошибки резервного копирования.  
  
5.  **Изменение модели восстановления:** Если модель восстановления базы данных является меняется с простой на полную или с неполным протоколированием, резервное копирование прекратится и баз данных будет пропускать [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]. Дополнительные сведения см. в разделе [SQL Server Managed Backup to Windows Azure: взаимодействие и совместная работа](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-interoperability-and-coexistence.md)  
  
### <a name="most-common-error-messages-and-solutions"></a>Самые распространенные сообщения об ошибках и способы их устранения  
  
1.  **Ошибки при включении или настройке [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]:**  
  
     Ошибка: «не удалось получить доступ к URL-адрес хранилища... Укажите допустимые учетные данные SQL...» : Может появиться это и другие похожие ошибки вызваны учетными данными SQL.  В таких случаях изучите имя предоставленных учетных данных SQL и сведения в них: имя учетной записи хранения, ключ доступа к хранилищу — и убедитесь, что указаны допустимые данные.  
  
     Ошибка: «... не удается настроить базу данных... Поскольку Системная база данных»: Эта ошибка возникает при попытке включить [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] для системной базы данных.  [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не поддерживает резервные копии для системных баз данных.  Чтобы настроить резервное копирование для системных баз данных, используйте другие технологии резервного копирования SQL Server, например планы обслуживания.  
  
     Ошибка:»... Задайте срок хранения...» : Вы могут возникнуть ошибки, связанные со сроком хранения, если вы не указали срок хранения для базы данных или экземпляра при настройке этих значений в первый раз. Ошибка также может возникнуть в том случае, если указано значение, не входящее в диапазон от 1 до 30. Допустимые значения срока хранения — число от 1 до 30.  
  
2.  **Ошибки уведомления по электронной почте:**  
  
     Ошибка: «компонент Database Mail не включен...» — Если включить уведомления по электронной почте, но не настроен компонент Database Mail на экземпляре вы увидите эту ошибку. Необходимо настроить компонент Database Mail в экземпляре, чтобы получать уведомление о состоянии работоспособности [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]. Сведения о включении компонента database mail см. в разделе [настроить компонент Database Mail](../relational-databases/database-mail/configure-database-mail.md). Чтобы использовать Database Mail для уведомлений, также необходимо включить агент SQL Server. Дополнительные сведения см. в разделе [перед началом](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md#BeforeYouBegin).  
  
     Ниже приведен список кодов возможных ошибок, связанных с уведомлениями по электронной почте.  
  
    -   Номер ошибки: 45209  
  
    -   Номер ошибки: 45210  
  
    -   Номер ошибки: 45211  
  
3.  **Ошибки подключения:**  
  
    -   **Ошибки, связанные с подключением SQL:** эти ошибки возникают при наличии проблемы с подключением к экземпляру SQL Server. Расширенные события предоставляют тип ошибок в канале администратора. Далее приведены два расширенных события, которые можно видеть в связи с возникновением ошибок подключения.  
  
         FileRetentionAdminXEvent with event_type = SqlError. Сведения о данной ошибке см. в параметрах error_code, error_message и stack_trace данного события. Значение error_code — это номер ошибки SqlException.  
  
         SmartBackupAdminXevent со следующими префиксами сообщения:  
  
         *«Произошла внутренняя ошибка при настройке SQL Server Managed Backup в Windows Azure параметры по умолчанию для экземпляра. Ошибка может быть временной.»*  
  
         *«Вероятные проблемы с подключением с SQL Server. Пропуск базы данных в текущей итерации.»*  
  
         *«Сведения об использовании журнала не удалось выполнить запрос. Сбой может быть временным. Пропуск базы данных в текущей итерации.»*  
  
         *«Обнаружено SQL-исключение при загрузке метаданных агента SSMBackup2WA. Сбой может быть временным. Операция будет повторена.»*  
  
         *«Агент SSMBackup2WA обнаружил SQL-исключение при... "*  
  
    -   **Ошибки при подключении к учетной записи хранения:**  
  
         Исключения хранилища в событии FileRetentionAdminXEvent с event_type = XstoreError. Сведения о данной ошибке см. в параметрах error_message и stack_trace данного события.  
  
         В управляемом резервном копировании SQL Server используется нижележащий компонент «Резервное копирование на URL-адрес», поэтому ошибки, связанные с подключением к хранилищу, относятся к обоим компонентам. Дополнительные сведения о шаги по устранению неполадок см. в разделе **устранении неполадок** из [SQL Server Backup to URL Best Practices and Troubleshooting](../relational-databases/backup-restore/sql-server-backup-to-url-best-practices-and-troubleshooting.md) статьи.  
  
### <a name="troubleshooting-system-issues"></a>Проблемы системы диагностики  
 Ниже приведены некоторые сценарии, описывающие проблему с системой (SQL Server, агент SQL Server) и ее влияние на [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].  
  
-   **Sqlservr.exe перестает отвечать на запросы или останавливает работу, когда [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] работает:** Если SQL Server перестает работать, агента SQL Server выполняет правильное завершение работы, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] также останавливаются, а события записываются в файл SQL Agent.out.  
  
     Если SQL Server прекращает отвечать, события записываются в канал администратора.  Пример журнала событий.  
  
     *Ошибка SQL (модуль не отвечает или возвращает sqlException: SqlException:*   
     *код ошибки, сообщение и трассировка стека будет отображаться в канале администратора xevent вместе с некоторыми дополнительными сведениями, например:*   
    *«Вероятные проблемы с подключением с SQL Server. Пропуск базы данных в текущей итерации»*  
  
-   **Агент SQL перестает отвечать на запросы или останавливает работу, когда [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] работает под управлением:**  
  
     Если агент SQL Server прекращает работу, то службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] также останавливаются, а события записываются в канал администратора. Это аналогично сценариям, когда SQL Server прекращает отвечать.  
  
     Если агент SQL Server прекращает отвечать, то службы [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] не смогут продолжать операции резервного копирования, а события будут записаны в канал администратора. Пример журнала событий.  
  
     *Зависания заданий: см. канал администратора xevents*   
    *«Обновление хода выполнения, которые не были получены от SQL Server в более чем "+ Constants.DBBackupInfoMsgMaxWaitTime + «ч для резервного копирования базы данных.   Резервное копирование SSM в облаке продолжит ожидание.»*  
  
 При включении уведомлений по электронной почте, вы получите уведомление, которое включает в себя **число циклов резервного копирования** и **количества циклов хранения**. Если значения, возвращенные в уведомлении для одного или обоих этих столбцов, равны нулю, это может указывать на то, что система не отвечает.  
  
> [!WARNING]  
>  Внутренние процессы, которые формируют результаты для отчета, предполагают, что журналы диагностики ядра находятся в одном расположении с журналом ошибок агента SQL, который по умолчанию находится в той же папке, что и журналы ошибок экземпляра SQL Server. Если в журналах диагностики ядра перемещаются в каталог, который отличается от места хранения журнала ошибок агента SQL Server, то система не может найти журналы диагностики интеллектуального резервного копирования, что в свою очередь ведет к тому, что отчет, приведенный в отправляемом по электронной почте уведомлении, может быть неправильным. Например, может появиться значение **0** во всех полях отчета, включая количество циклов резервного копирования и количества циклов хранения. В этом случае, когда журналы диагностики перемещены в другое расположение, это может означать не то, что система не отвечает, а то, что система не может найти журналы. Прежде всего убедитесь в том, что журналы диагностики и журналы ошибок агента SQL Server находятся в одном расположении. Для проверки текущего расположения журналов диагностических данных, можно использовать [sys.dm_os_server_diagnostics_log_configurations](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-server-diagnostics-log-configurations). `path` Столбец возвращает текущее расположение подсистемы журналы диагностики.  Он должен быть в той же папке, что и журналы ошибок агента SQL Server. Получить путь к журналам ошибок агента SQL Server можно с помощью хранимой процедуры `dbo.sp_get_sqlagent_properties`.  
  
 Проверьте журналы расширенных событий, чтобы просмотреть подробные сведения об ошибках. исправьте ошибки или перезапустите агент SQL Server, чтобы исправить ситуацию.  
  
  
