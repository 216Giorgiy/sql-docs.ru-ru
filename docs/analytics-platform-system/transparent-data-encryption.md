---
title: "Прозрачное шифрование данных для параллельного хранилища данных"
author: barbkess
ms.author: barbkess
manager: jhubbard
ms.prod: sql-non-specified
ms.prod_service: mpp-data-warehouse
ms.service: 
ms.component: analytics-platform-system
ms.suite: sql
ms.custom: 
ms.technology: mpp-data-warehouse
description: "Прозрачное шифрование данных (TDE) выполняет в реальном времени ввода-вывода шифрования и расшифровки данных и файлов журнала транзакций и специальные файлы журналов PDW."
ms.date: 10/20/2016
ms.topic: article
ms.assetid: b82ad21d-09dd-43dd-8fab-bcf2c8c3ac6d
caps.latest.revision: "22"
ms.openlocfilehash: b0544f5dee735b8444ce68d25e3be288be214202
ms.sourcegitcommit: 44cd5c651488b5296fb679f6d43f50d068339a27
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2017
---
# <a name="transparent-data-encryption"></a>прозрачное шифрование данных.
Чтобы защитить базу данных, можно принять ряд мер предосторожности, например спроектировать систему безопасности, проводить шифрование конфиденциальных ресурсов и поместить серверы базы данных под защиту брандмауэра. Однако если будет похищен физический носитель (например, диск или ленты резервной копии), злоумышленник может легко восстановить или подключить базу данных и получить доступ к данным. Одним из решений может стать шифрование конфиденциальных данных в базе данных и защита ключей, используемых при шифровании, с помощью сертификата. Это не позволит использовать данные ни одному человеку, не имеющему ключей, но такой тип защиты следует планировать заранее.  
  
*Прозрачное шифрование данных* (TDE) выполняет в реальном времени ввода-вывода шифрования и расшифровки данных и файлов журнала транзакций и PDW специальные файлы журналов. При шифровании используется ключ шифрования базы данных (DEK), который хранится в загрузочной записи базы данных, где можно получить к нему доступ при восстановлении. Ключ шифрования базы данных является симметричным ключом, защищенным с помощью сертификата, хранящегося в базе данных master SQL Server PDW. Функция прозрачного шифрования данных защищает "неактивные" данные, то есть файлы данных и журналов. Благодаря ей обеспечивается соответствие требованиям различных законов, постановлений и рекомендаций, действующих в разных отраслях. Это позволяет разработчикам программного обеспечения шифровать данные с помощью алгоритмов шифрования AES и 3DES, не меняя существующие приложения.  
  
> [!IMPORTANT]  
> Прозрачное шифрование данных не обеспечивает шифрование для данных, передаваемых между клиентом и PDW. Дополнительные сведения о способах шифрования данных между клиентом и SQL Server PDW см. в разделе [подготовить сертификат](provision-certificate.md).  
>   
> Прозрачное шифрование данных не шифровать данные при перемещении или используется. Внутренний трафик между компонентами PDW внутри SQL Server PDW, не шифруются. Данные временно хранятся в памяти буферы не шифруются. Чтобы уменьшить этот риск, управлять физического доступа и подключений к SQL Server PDW.  
  
После защиты базы данных ее можно восстановить с помощью правильного сертификата.  
  
> [!NOTE]  
> При создании сертификата для прозрачного шифрования данных необходимо немедленно архивировать его, а также связанный закрытый ключ. В случае если сертификат окажется недоступен или понадобится восстановить базу данных на другом сервере либо присоединить ее к другому серверу, необходимо иметь копии сертификата и закрытого ключа. Иначе будет невозможно открыть базу данных. Сертификат шифрования следует сохранить, даже если функция прозрачного шифрования в базе данных будет отключена. Даже если база данных не зашифрована, части журнала транзакций могут по-прежнему оставаться защищенными, а для некоторых операций будет требоваться сертификат до выполнения полного резервного копирования базы данных. Сертификат, который превысил свой срок хранения, все еще может быть использован для шифрования и расшифровки данных с помощью прозрачного шифрования данных.  
  
Шифрование файла базы данных проводится на уровне страниц. Страницы в зашифрованной базе данных шифруются до записи на диск и дешифруются при чтении в память. Прозрачное шифрование данных не увеличивает размер зашифрованной базы данных.  
  
На следующем рисунке показано иерархии разделов для Прозрачного шифрования данных:  
  
![Отображает иерархию, описанную в разделе. ] (media/tde-architecture.png "TDE_Architecture")  
  
## <a name="using-tde"></a>Использование прозрачного шифрования данных  
Чтобы использовать прозрачное шифрование данных, выполните следующие действия. Первые три шага осуществляется только один раз, когда Подготовка SQL Server PDW для поддержки прозрачного шифрования данных.  
  
1.  Создайте главный ключ базы данных master.  
  
2.  Используйте **sp_pdw_database_encryption** Включение прозрачного шифрования данных в SQL Server PDW. Эта операция изменяет временных баз данных для обеспечения защиты будущих временных данных и завершится ошибкой, если выполняется при наличии любой активных сеансов, имеющих временных таблиц. **sp_pdw_database_encryption** включает маскирование данных пользователя в журналах системы PDW. (Дополнительные сведения о маскирование данных пользователя в журналах системы PDW см. в разделе [sp_pdw_log_user_data_masking](../relational-databases/system-stored-procedures/sp-pdw-log-user-data-masking-sql-data-warehouse.md).)  
  
3.  Используйте [sp_pdw_add_network_credentials](../relational-databases/system-stored-procedures/sp-pdw-add-network-credentials-sql-data-warehouse.md) создать учетные данные, проверку подлинности, необходимо записать в общую папку, где будет храниться резервную копию сертификата. Если учетные данные уже существуют для предполагаемого хранилища сервера, можно использовать существующие учетные данные.  
  
4.  В базе данных master создайте сертификат, защищен главным ключом.  
  
5.  Создайте резервную копию сертификата в общую папку хранилища.  
  
6.  В базе данных пользователей создайте ключ шифрования базы данных и защитите его с помощью сертификата, который хранится в базе данных master.  
  
7.  Используйте `ALTER DATABASE` инструкции для шифрования базы данных, с помощью прозрачного шифрования данных.  
  
В следующем примере демонстрируется шифрование `AdventureWorksPDW2012` базы данных с помощью сертификата с именем `MyServerCert`, созданный в SQL Server PDW.  
  
**Первый этап: Включить прозрачное шифрование данных на сервере SQL Server PDW.** Это требуется только один раз.  
  
```sql  
USE master;  
GO  
  
-- Create a database master key in the master database  
CREATE MASTER KEY ENCRYPTION BY PASSWORD = '<UseStrongPasswordHere>';  
GO  
  
-- Enable encryption for PDW  
EXEC sp_pdw_database_encryption 1;  
GO  
  
-- Add a credential that can write to the share  
-- A credential created for a backup can be used if you wish  
EXEC sp_pdw_add_network_credentials 'SECURE_SERVER', '<domain>\<Windows_user>', '<password>';  
```  
  
**Второй: Создание и резервную копию сертификата в базе данных master.** Это только требуется один раз. Может иметь отдельный сертификат для каждой базы данных (рекомендуется), или можно защитить несколько баз данных с одним сертификатом.  
  
```sql  
-- Create certificate in master  
CREATE CERTIFICATE MyServerCert WITH SUBJECT = 'My DEK Certificate';  
GO  
  
-- Back up the certificate with private key  
BACKUP CERTIFICATE MyServerCert   
    TO FILE = '\\SECURE_SERVER\cert\MyServerCert.cer'  
    WITH PRIVATE KEY   
    (   
        FILE = '\\SECURE_SERVER\cert\MyServerCert.key',  
        ENCRYPTION BY PASSWORD = '<UseStrongPasswordHere>'   
    )   
GO  
```  
  
**: Создайте ключ шифрования данных и последнего Шифрования базы данных пользователя с помощью инструкции ALTER DATABASE.** Это повторяется для каждой базы данных, который защищен службой прозрачного шифрования данных.  
  
```sql  
USE AdventureWorksPDW2012;  
GO  
  
CREATE DATABASE ENCRYPTION KEY  
WITH ALGORITHM = AES_128  
ENCRYPTION BY SERVER CERTIFICATE MyServerCert;  
GO  
  
ALTER DATABASE AdventureWorksPDW2012 SET ENCRYPTION ON;  
GO  
```  
  
Операции шифрования и дешифрования запланированы в фоновых потоках в SQL Server. Состояние этих операций можно просмотреть в представлениях каталога и динамических административных представлениях в списке, представленном далее в этом разделе.  
  
> [!CAUTION]  
> Файлы резервных копий баз данных, в которых включено TDE, также шифруются с помощью ключа шифрования базы данных. Поэтому для восстановления таких резервных копий необходимо иметь сертификат, защищающий ключ шифрования базы данных. Это значит, что помимо резервного копирования базы данных обязательно необходимо сохранять резервные копии сертификатов серверов, чтобы не допустить потери данных. Если сертификат станет недоступным, это приведет к потере данных.  
  
## <a name="commands-and-functions"></a>Команды и функции  
Чтобы в следующих инструкциях можно было использовать сертификаты TDE, они должны быть зашифрованы главным ключом базы данных.  
  
В следующей таблице представлены ссылки и объяснения команд и функций TDE.  
  
|Команда или функция|Назначение|  
|-----------------------|-----------|  
|[СОЗДАНИЕ КЛЮЧА ШИФРОВАНИЯ БАЗЫ ДАННЫХ](../t-sql/statements/create-database-encryption-key-transact-sql.md)|Создает ключ, используемый для шифрования базы данных.|  
|[ИЗМЕНИТЬ КЛЮЧ ШИФРОВАНИЯ БАЗЫ ДАННЫХ](../t-sql/statements/alter-database-encryption-key-transact-sql.md)|Изменяет ключ, используемый для шифрования базы данных.|  
|[УДАЛИТЬ КЛЮЧ ШИФРОВАНИЯ БАЗЫ ДАННЫХ](../t-sql/statements/drop-database-encryption-key-transact-sql.md)|Удаляет ключ, использовавшийся для шифрования базы данных.|  
|[ИЗМЕНЕНИЕ БАЗЫ ДАННЫХ](../t-sql/statements/alter-database-parallel-data-warehouse.md)|Объясняет параметр **ALTER DATABASE** , который используется для включения TDE.|  
  
## <a name="catalog-views-and-dynamic-management-views"></a>Представления каталога и динамические административные представления  
В следующей таблице показаны представления каталогов и динамические административные представления TDE.  
  
|Представление каталога или динамическое административное представление|Назначение|  
|-------------------------------------------|-----------|  
|[sys.databases](../relational-databases/system-catalog-views/sys-databases-transact-sql.md)|Представление каталога со сведениями о базе данных.|  
|[sys.certificates](../relational-databases/system-catalog-views/sys-certificates-transact-sql.md)|Представление каталога с сертификатами из базы данных.|  
|[sys.dm_pdw_nodes_database_encryption_keys](../relational-databases/system-dynamic-management-views/sys-dm-pdw-nodes-database-encryption-keys-transact-sql.md)|Динамическое административное представление, предоставляющий сведения о ключах шифрования, используемых в базе данных и состояние шифрования базы данных для каждого узла.|  
  
## <a name="permissions"></a>Permissions  
Для каждой функции или команды TDE действуют отдельные требования к разрешениям, описанные в таблицах выше.  
  
Для просмотра метаданных, связанных с TDE, необходимо `CONTROL SERVER` разрешение.  
  
## <a name="considerations"></a>Замечания  
Во время проверки базы данных на повторное шифрование, выполняемой для операции шифрования, операции обслуживания базы данных отключаются.  
  
Состояние шифрования базы данных с помощью можно определить **sys.dm_pdw_nodes_database_encryption_keys** динамическое административное представление. Дополнительные сведения см. в разделе *представления каталогов и динамические административные представления* ранее в этом разделе).  
  
### <a name="restrictions"></a>Ограничения  
Следующие операции запрещены во время `CREATE DATABASE ENCRYPTION KEY`, `ALTER DATABASE ENCRYPTION KEY`, `DROP DATABASE ENCRYPTION KEY`, или `ALTER DATABASE...SET ENCRYPTION` инструкции.  
  
-   Удаление базы данных.  
  
-   С помощью `ALTER DATABASE` команды.  
  
-   Запуск резервной копии базы данных.  
  
-   Запуск восстановления базы данных.  
  
Следующие операции или условия запрещают `CREATE DATABASE ENCRYPTION KEY`, `ALTER DATABASE ENCRYPTION KEY`, `DROP DATABASE ENCRYPTION KEY`, или `ALTER DATABASE...SET ENCRYPTION` инструкции.  
  
-   `ALTER DATABASE` Выполняется команда.  
  
-   выполняется какая-либо операция резервного копирования;  
  
При создании файлов базы данных быстрая инициализация файлов недоступна при включенном TDE.  
  
### <a name="areas-not-protected-by-tde"></a>Области, не защищенные прозрачного шифрования данных  
Прозрачное шифрование данных не защищает внешних таблиц.  
  
Прозрачное шифрование данных не защищает диагностических сеансов. Пользователям следует соблюдать осторожность не в запросы с конфиденциальные параметры во время диагностики сеансов уже используются. Должны быть удалены диагностических сеансов, которые раскрываются конфиденциальные сведения, как только они больше не нужны.  
  
При помещении в памяти SQL Server PDW, расшифровываются, защищаемую прозрачным Шифрованием данных. Дампы памяти создаются при возникновении некоторых проблем в устройстве. Dump файлы представляют собой содержимое памяти во время появления проблемы и могут содержать конфиденциальные данные в незашифрованном виде. Они являются общими с другими пользователями, необходимо проверить содержимое дампы памяти.  
  
База данных master не защищен прозрачного шифрования данных. Хотя базы данных master не содержит данных пользователя, отчет содержит сведения, такие как имена входа.  
  
### <a name="transparent-data-encryption-and-transaction-logs"></a>Прозрачное шифрование данных и журналы транзакций  
Включение прозрачного шифрования данных в базе данных приводит к обнулению оставшейся части виртуального журнала транзакций для принудительного нового виртуального журнала транзакций. Это гарантирует, что после включения шифрования базы данных в журналах транзакций не останется простого текста. Можно определить состояние шифрования файла журнала на каждом узле PDW, просмотрев `encryption_state` столбца в `sys.dm_pdw_nodes_database_encryption_keys` представление, как показано в примере:  
  
```sql  
WITH dek_encryption_state AS   
(  
    SELECT ISNULL(db_map.database_id, dek.database_id) AS database_id, encryption_state  
    FROM sys.dm_pdw_nodes_database_encryption_keys AS dek  
        INNER JOIN sys.pdw_nodes_pdw_physical_databases AS node_db_map  
           ON dek.database_id = node_db_map.database_id AND dek.pdw_node_id = node_db_map.pdw_node_id  
        LEFT JOIN sys.pdw_database_mappings AS db_map  
            ON node_db_map .physical_name = db_map.physical_name  
        INNER JOIN sys.dm_pdw_nodes AS nodes  
            ON nodes.pdw_node_id = dek.pdw_node_id  
    WHERE dek.encryptor_thumbprint <> 0x  
)  
SELECT TOP 1 encryption_state  
       FROM dek_encryption_state  
       WHERE dek_encryption_state.database_id = DB_ID('AdventureWorksPDW2012 ')  
       ORDER BY (CASE encryption_state WHEN 3 THEN -1 ELSE encryption_state END) DESC;  
```  
  
Все данные, записанные в журнале транзакций до изменения ключа шифрования базы данных, будут зашифрованы с помощью предыдущего ключа шифрования базы данных.  
  
### <a name="pdw-activity-logs"></a>Журналы действий PDW  
SQL Server PDW поддерживает набор журналы предназначены для устранения неполадок. (Обратите внимание, это не журнала транзакций в журнале ошибок SQL Server и журнал событий Windows.) Эти журналы действий PDW могут содержать полный инструкции в виде открытого текста, некоторые из которых может содержать пользовательские данные. Типичными примерами являются **вставить** и **обновление** инструкции. Маскирование данных пользователя может быть явным образом включать и выключать с помощью **sp_pdw_log_user_data_masking**. Чтобы защитить их Включение шифрования в SQL Server PDW автоматически включает маски пользовательских данных в журналы действий PDW. **sp_pdw_log_user_data_masking** может также использоваться для маски инструкций, без использования прозрачного шифрования данных, однако, не рекомендуется, так как это значительно снижает возможность анализировать проблемы в службу поддержки Майкрософт.  
  
### <a name="transparent-data-encryption-and-the-tempdb-system-database"></a>Прозрачное шифрование данных и системная база данных tempdb  
Системная база данных tempdb шифруются в том случае, если включено шифрование с помощью [sp_pdw_database_encryption](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-sql-data-warehouse.md). Это необходимо, перед любой базы данных можно использовать прозрачное шифрование данных. Это может влиять на производительность незашифрованных баз данных на том же экземпляре SQL Server PDW.  
  
## <a name="key-management"></a>Управление ключами  
Ключ шифрования базы данных (DEK) защищен сертификаты, хранящиеся в базе данных master. Эти сертификаты защищаются с помощью главного ключа базы данных (DMK) базы данных master. Главный ключ базы данных должен быть защищен главным ключом службы (SMK) для использования для прозрачного шифрования данных.  
  
Система получить доступ к ключам без необходимости вмешательства человека (например, пароля). Если сертификат недоступен, система выдаст ошибку, о том, что не удалось расшифровать ключ шифрования данных пока не станет доступен действующий сертификат.  
  
При перемещении базы данных с одного устройства к другому, сертификат, используемый для защиты его ' DEK необходимо сначала восстановить на целевом сервере. Затем базу данных можно восстановить в обычном режиме. Дополнительные сведения см. в документации standard SQL Server, на [перемещение защищенной базы данных прозрачного шифрования данных на другой сервер SQL](http://technet.microsoft.com/library/ff773063.aspx).  
  
Сертификаты, используемые для шифрования причина должна сохраняться до тех пор, пока существуют резервные копии баз данных, которые их используют. Резервные копии сертификата необходимо включить закрытый ключ сертификата, так как сертификат без закрытого ключа не может использоваться для восстановления базы данных. Эти сертификата закрытого ключа резервные копии хранятся в отдельном файле защищен паролем, которые необходимы для восстановления сертификата.  
  
## <a name="restoring-the-master-database"></a>Восстановление базы данных master  
Можно восстановить базу данных master с помощью **DWConfig**, в процессе аварийного восстановления.  
  
-   Если узел элемента управления не изменился, это master база данных восстанавливается в устройстве же и без изменений, с которой была сделана резервная копия базы данных master, главный ключ базы данных и все сертификаты, будет ли для чтения без дополнительных действий.  
  
-   При восстановлении базы данных master на различные устройства или узел элемента управления был изменен после резервного копирования базы данных master, дополнительные действия потребуется использовать для повторного создания главного ключа.  
  
    1.  Откройте главный ключ базы данных:  
  
        ```sql  
        OPEN MASTER KEY DECRYPTION BY PASSWORD = '<password>';  
        ```  
  
    2.  Добавьте шифрование главного ключа службы.  
  
        ```sql  
        ALTER MASTER KEY   
            ADD ENCRYPTION BY SERVICE MASTER KEY;  
        ```  
  
    3.  Перезагрузите устройство.  
  
## <a name="upgrade-and-replacing-virtual-machines"></a>Обновление и замена виртуальные машины  
Если главный ключ базы данных существует в устройстве, на котором было выполнено обновление или замените виртуальной Машины, необходимо указать пароль главного ключа базы данных, как параметр.  
  
Пример действия по обновлению. Замените `**********` с паролем главного ключа базы данных.  
  
`setup.exe /Action=ProvisionUpgrade … DMKPassword='**********'  `  
  
Пример замены действия виртуальной машины.  
  
`setup.exe /Action=ReplaceVM … DMKPassword='**********'  `  
  
Во время обновления Если шифрование базы данных пользователя и пароль главного ключа базы данных не указан, действие обновления завершится ошибкой. Во время замены Если пароль не указан, если главный ключ базы данных существует, операция пропустить этап восстановления главного ключа базы данных. Остальные шаги будет завершено в конце операция замены виртуальной Машины, однако действие будет завершаться сбоем в конце, чтобы указать, что дополнительные действия не требуются. В журналах установки (расположенный в **\ProgramData\Microsoft\Microsoft SQL Server Parallel Data Warehouse\100\Logs\Setup\\\Detail-Setup < метка времени >**), будет отображаться следующее предупреждение перед завершением.  
  
`*** WARNING \*\*\* DMK is detected in master database, but could not be recovered automatically! The DMK password was either not provided or is incorrect!  `
  
Выполните эти инструкции вручную в PDW и перезапустить устройство после этого, чтобы восстановить главный ключ базы данных:  
  
```sql
OPEN MASTER KEY DECRYPTION BY PASSWORD = '<DMK password>';  
ALTER MASTER KEY ADD ENCRYPTION BY SERVICE MASTER KEY;  
```
  
Следуйте инструкциям в **восстановление базы данных master** абзаца, чтобы восстановить базу данных, а затем перезагрузите устройство.  
  
Если главный ключ базы данных существовали до, но не была восстановлена после выполнения действий, следующее сообщение об ошибке возникает при запросе к базе данных.  
  
```sql
Msg 110806;  
A distributed query failed: Database '<db_name>' cannot be opened due to inaccessible files or insufficient memory or disk space. See the SQL Server errorlog for details.
```  
  
## <a name="performance-impact"></a>Влияние на производительность  
Влияние на производительность прозрачного шифрования данных, зависит от типа данных, хранение и тип действия рабочей нагрузки в SQL Server PDW. При защите с прозрачного шифрования данных, ввода-вывода чтения и затем расшифровки данных или шифрования и последующей записи данных служб с интенсивным использованием ЦП и будет иметь восприятие время другие действия служб с интенсивным использованием ЦП в то же время. Поскольку TDE шифрует `tempdb`, прозрачного шифрования данных может повлиять на производительность базы данных, которые не шифруются. Чтобы получить точное представление о производительности, следует проверить всю систему с действием данных и запросов.  
  
## <a name="related-content"></a>См. также  
Следующие ссылки содержат общие сведения о том, как SQL Server управляет шифрования. Эти разделы помогут вам понять шифрование SQL Server, но эти разделы отсутствуют сведения, относящиеся к SQL Server PDW и обсуждаются функции, которые не существуют в SQL Server PDW.  
  
-   [Шифрование SQL Server](../relational-databases/security/encryption/sql-server-encryption.md)  
  
-   [Иерархия шифрования](../relational-databases/security/encryption/encryption-hierarchy.md)  
  
-   [Ключи шифрования SQL Server и базы данных](../relational-databases/security/encryption/sql-server-and-database-encryption-keys-database-engine.md)  

  
## <a name="see-also"></a>См. также:  
[ИЗМЕНЕНИЕ БАЗЫ ДАННЫХ](../t-sql/statements/alter-database-parallel-data-warehouse.md)  
[СОЗДАНИЕ ГЛАВНОГО КЛЮЧА](../t-sql/statements/create-master-key-transact-sql.md)  
[СОЗДАНИЕ КЛЮЧА ШИФРОВАНИЯ БАЗЫ ДАННЫХ](../t-sql/statements/create-database-encryption-key-transact-sql.md)  
[BACKUP CERTIFICATE](../t-sql/statements/backup-certificate-transact-sql.md)  
[sp_pdw_database_encryption](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-sql-data-warehouse.md)  
[sp_pdw_database_encryption_regenerate_system_keys](../relational-databases/system-stored-procedures/sp-pdw-database-encryption-regenerate-system-keys-sql-data-warehouse.md)  
[sp_pdw_log_user_data_masking](../relational-databases/system-stored-procedures/sp-pdw-log-user-data-masking-sql-data-warehouse.md)  
[sys.certificates](../relational-databases/system-catalog-views/sys-certificates-transact-sql.md)  
[sys.dm_pdw_nodes_database_encryption_keys](../relational-databases/system-dynamic-management-views/sys-dm-pdw-nodes-database-encryption-keys-transact-sql.md)  
  
