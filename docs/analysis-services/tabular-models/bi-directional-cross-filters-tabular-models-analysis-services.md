---
title: Двунаправленные кросс-фильтры в табличных моделях | Документы Microsoft
ms.custom: ''
ms.date: 02/21/2018
ms.prod: analysis-services
ms.prod_service: analysis-services, azure-analysis-services
ms.service: ''
ms.component: multidimensional-tabular
ms.reviewer: ''
ms.suite: pro-bi
ms.technology: ''
ms.tgt_pltfrm: ''
ms.topic: conceptual
ms.assetid: 5e810707-f58d-4581-8f99-7371fa75b6ac
caps.latest.revision: 14
author: Minewiskan
ms.author: owend
manager: kfile
ms.openlocfilehash: 07f44c1d5e92e65931f7d362b959e45d0943d65f
ms.sourcegitcommit: 2ddc0bfb3ce2f2b160e3638f1c2c237a898263f4
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/03/2018
---
# <a name="bi-directional-cross-filters-in-tabular-models"></a>Двунаправленные кросс-фильтры в табличных моделях
[!INCLUDE[ssas-appliesto-sqlas-aas](../../includes/ssas-appliesto-sqlas-aas.md)]
  Новым в SQL Server 2016 является стандартный подход по включению *двунаправленных кросс-фильтров* в табличные модели, исключающий необходимость вручную создавать обходные пути DAX для распространения контекста фильтра по связям между таблицами.  
  
 Концепцию можно разбить на две составляющих. *Кроссфильтрация* — это возможность задать контекст фильтра для таблицы на основе значений в связанной таблице, а *двунаправленность* означает передачу контекста фильтра второй связанной таблице на другой стороне связи. Само название указывает на то, что срез можно выполнить в обоих направлениях, а не только в одном.  На внутреннем уровне двусторонняя фильтрация расширяет контекст фильтра до запроса супермножества данных.  
  
 ![Службы SSAS-BIDI-1-Filteroption](../../analysis-services/tabular-models/media/ssas-bidi-1-filteroption.PNG "SSAS-BIDI-1-Filteroption")  
  
 Существует два типа кросс-фильтры: односторонних и двусторонних фильтрации. Однонаправленный — это традиционный фильтр с направлением от многих к одному в связи между исходной таблицей и таблицей измерения. Двунаправленный — это кросс-фильтр, позволяющий использовать контекст фильтра одной связи в качестве контекста фильтра для другой связи с таблицей, когда одна таблица является общей для обеих связей.  
  
 С заданными **DimDate** и **DimProduct** с внешними ключами к **FactOnlineSales**двунаправленный кросс-фильтр эквивалентен **FactOnlineSales-DimDate** и **FactOnlineSales-DimProduct** , используемым одновременно.  
  
 Двунаправленные кросс-фильтры могут использоваться как легко реализуемое решение проблемы разработки запросов "многие-ко-многим", которая вставала перед разработчиками таблиц и Power Pivot в прошлом. Если вы использовали обходной путь DAX для связей "многие-ко-многим" в табличной модели или модели Power Pivot, можно попробовать применить двунаправленный фильтр и посмотреть, поможет ли он получить желаемые результаты.  
  
 При создании двунаправленного кросс-фильтра учитывайте следующие особенности.  
  
-   Оцените необходимость включения двунаправленных фильтров.  
  
     Если двунаправленные фильтры будут включены везде, данные могут оказаться чрезмерно фильтрованными.  Кроме того, может возникнуть неоднозначность из-за создания нескольких возможных путей запроса. Чтобы избежать возникновения этих проблем, используйте сочетание однонаправленных и двунаправленных фильтров.  
  
-   Проведите инкрементное тестирование для проверки влияния каждого изменения фильтра на модель. Для инкрементного тестирования рекомендуется использовать функцию[Анализ в Excel](../../analysis-services/tabular-models/analyze-a-tabular-model-in-excel-ssas-tabular.md) . Рекомендуется периодически проводить дополнительные тесты с использованием других клиентов отчетов, чтобы исключить неожиданные результаты на более поздних этапах.  
  
> [!NOTE]  
>  Начиная с версии CTP 3.2, средства SSDT включают значение по умолчанию, которое определяет, должны ли двунаправленные кросс-фильтры применяться автоматически. При включении двунаправленных фильтров по умолчанию средства SSDT будут включать двунаправленную фильтрацию только в том случае, если в модели задан один путь запроса на протяжении всей цепочки связей между таблицами.  
  
## <a name="set-the-default"></a>Значение по умолчанию  
 Однонаправленные фильтры заданы по умолчанию. Можно изменить значение по умолчанию для всех новых проектов, создаваемых в конструкторе, или в самой модели уже существующего проекта.  
  
 На уровне проекта параметр проверяется при создании проекта. Если по умолчанию будет задан двунаправленный фильтр, это проявит себя при создании следующего проекта.  
  
1.  В SSDT выберите **Инструменты** > **Параметры** > **Табличные конструкторы служб Analysis Services** > **Параметры новых проектов**.  
  
2.  Задайте для параметра **Направление фильтрации по умолчанию** значение **Одно направление** или **Оба направления**.  
  
 Кроме того, можно изменить значение по умолчанию для модели.  
  
1.  В обозревателе решений выберите **Model.bim** > **Свойства** .  
  
2.  Задайте для параметра **Направление фильтрации по умолчанию** значение **Одно направление** или **Оба направления**.  
  
## <a name="walkthrough-an-example"></a>Пример с пошаговым руководством  
 Пример — лучший способ оценить эффект от двунаправленной кроссфильтрации. Рассмотрим следующий набор данных из [ContosoRetailDW](http://www.microsoft.com/en-us/download/details.aspx?id=18279), отражающий количество элементов и кросс-фильтры, которые создаются по умолчанию.  
  
 ![Модель служб SSAS-BIDI-2](../../analysis-services/tabular-models/media/ssas-bidi-2-model.PNG "SSAS-BIDI-2-модель")  
  
> [!NOTE]  
>  По умолчанию во время импорта данных связи между таблицами создаются в конфигурации "многие-к-одному" на основе связей внешнего и первичного ключей между исходной таблицей и соответствующими таблицами измерений.  
  
 Обратите внимание, что направление фильтрации — от таблицы измерения к исходной таблице. Реклама, продукты, даты, клиенты и география заказчиков — все это допустимые фильтры, которые успешно дают статистическую обработку мер с фактическим значением, изменяющимся в зависимости от используемых измерений.  
  
 ![службы SSAS-bidi-3-defaultrelationships](../../analysis-services/tabular-models/media/ssas-bidi-3-defaultrelationships.PNG "ssas-bidi-3-defaultrelationships")  
  
 Для этой простой схемы типа "звезда" тестирование в Excel подтверждает, что получаются хорошие срезы данных при фильтрации потоков из таблиц измерений в строках и столбцах в статистические данные, предоставляемые мерой **Суммы продаж** , расположенной в центре таблицы **FactOnlineSales** .  
  
 ![службы SSAS-bidi-4-excelSumSales](../../analysis-services/tabular-models/media/ssas-bidi-4-excelsumsales.PNG "ssas-bidi-4-excelSumSales")  
  
 Поскольку меры извлекаются из исходной таблицы, а контекст фильтра заканчивается в исходной таблице, статистические данные будут отфильтрованы правильно для этой модели. Но что произойдет, если создать меру в другом месте, например число различных элементов в таблице продуктов или клиентов или среднее значение скидки в таблице рекламной акции, и расширить существующий контекст фильтра, включив в него эту меру?  
  
 Давайте проверим это, добавив число различных элементов из **DimProducts** в сводную таблицу. Обратите внимание на повторяющиеся значения в поле **Число продуктов**. На первый взгляд это выглядит как отсутствие связи таблиц, но в нашей модели мы видим, что все связи полностью определены и активны. В этом случае повторяющиеся значения возникают из-за того, что нет фильтра даты в строках таблицы продуктов.  
  
 ![службы SSAS-bidi-5-prodcount-nofilter](../../analysis-services/tabular-models/media/ssas-bidi-5-prodcount-nofilter.png "ssas-bidi-5-prodcount-nofilter")  
  
 После добавления двунаправленного кросс-фильтра между **FactOnlineSales** и **DimProduct**строки в таблице продуктов правильно фильтруются по изготовителю и дате.  
  
 ![службы SSAS-bidi-6-prodcount-withfilter](../../analysis-services/tabular-models/media/ssas-bidi-6-prodcount-withfilter.png "ssas-bidi-6-prodcount-withfilter")  
  
## <a name="learn-step-by-step"></a>Пошаговое обучение  
 Опробовать двунаправленные кросс-фильтры можно по указаниям данного пошагового руководства. Для начала вам понадобится следующее.  
  
-   Экземпляр служб SQL Server 2016 Analysis Services, табличный режим, последний выпуск CTP  
  
-   Средства[SQL Server Data Tools для Visual Studio 2015 (SSDT)](http://go.microsoft.com/fwlink/p/?LinkID=627574), выпущенные вместе с последней версией CTP.  
  
-   [ContosoRetailDW](http://www.microsoft.com/en-us/download/details.aspx?id=18279)  
  
-   Разрешения на чтение этих данных.  
  
-   Excel (для использования с функцией "Анализ в Excel")  
  
### <a name="create-a-project"></a>Создание проекта  
  
1.  Запустите SQL Server Data Tools для Visual Studio 2015.  
  
2.  Щелкните **Файл** > **Новый** > **Проект** > **Табличная модель Analysis Services**.  
  
3.  В конструкторе табличных моделей задайте для рабочей базы данных вариант — экземпляр SQL Server 2016 Preview Analysis Services в табличном режиме.  
  
4.  Проверьте, установлен уровень совместимости модели **SQL Server 2016 RTM (1200)** или более поздней версии.  
  
     Чтобы создать проект, нажмите кнопку **ОК** .  
  
### <a name="add-data"></a>Добавление данных  
  
1.  Щелкните **Модель** > **Импорт из источника данных** > **Microsoft SQL Server**.  
  
2.  Укажите сервер, базу данных и метод проверки подлинности.  
  
3.  Выберите базу данных ContosoRetailDW.  
  
4.  Нажмите кнопку **Далее**.  
  
5.  При выборе таблицы выберите, удерживая клавишу Ctrl, следующие таблицы:  
  
    -   FactOnlineSales  
  
    -   DimCustomer  
  
    -   DimDate  
  
    -   DimGeography  
  
    -   DimPromotion  
  
     На этом этапе можно изменить имена на более удобочитаемые в этой модели.  
  
     ![службы SSAS-bidi-7-данные импорта](../../analysis-services/tabular-models/media/ssas-bidi-7-importdata.PNG "ssas-bidi-7-данные импорта")  
  
6.  Импорт данных.  
  
 Если возникли ошибки, убедитесь, что учетная запись, используемая для подключения к базе данных, имеет учетные данные SQL Server с разрешениями на чтение из хранилища данных Contoso. При удаленном подключении может потребоваться проверка конфигурации портов в брандмауэре для SQL Server.  
  
### <a name="review-default-table-relationships"></a>Просмотр связей таблицы по умолчанию  
 Переключитесь в представление схемы: **Модель** > **Модель View** > **Схема**. Количество элементов и активных связей отображаются визуально. Все связи между любыми двумя связанными таблицами строятся по принципу "один-ко-многим".  
  
 ![Модель служб SSAS-BIDI-2](../../analysis-services/tabular-models/media/ssas-bidi-2-model.PNG "SSAS-BIDI-2-модель")  
  
 Для просмотра этих же данных в табличном виде можно щелкнуть **Таблицы** > **Управление связями** .  
  
 ![службы SSAS-bidi-3-defaultrelationships](../../analysis-services/tabular-models/media/ssas-bidi-3-defaultrelationships.PNG "ssas-bidi-3-defaultrelationships")  
  
### <a name="create-measures"></a>Создание мер  
 Вам потребуется статистическая обработка, чтобы сложить суммы продаж по различным аспектам многомерных данных. В **DimProduct** можно создать меру, которая подсчитывает количество продуктов, а затем использовать ее в анализе сбыта продукции, показывающем количество продуктов, участвующих в продажах для заданного года, заданного региона или типа клиента.  
  
1.  Щелкните **Модель** > **Представление модели** > **Представление диаграммы**.  
  
2.  Щелкните **FactOnlineSales**.  
  
3.  Выберите столбец **SalesAmount** .  
  
4.  Щелкните **Столбец** > **Автосумма** > **Сумма** , чтобы создать меру для продаж.  
  
5.  Щелкните **DimProduct**.  
  
6.  Выберите **ProductKeycolumn**.  
  
7.  Щелкните **Столбец** > **Автосумма** > **DistinctCount** , чтобы создать меру для уникальных продуктов.  
  
### <a name="analyze-in-excel"></a>Анализ в Excel  
  
1.  Щелкните **Модель** > **Анализ в Excel** , чтобы объединить все данные в сводной таблице.  
  
2.  Выберите две только что созданные меры из списка полей.  
  
3.  Выберите **Продукты** > **Производитель**.  
  
4.  Выберите **Дата** > **Календарный год**.  
  
 Обратите внимание, что продажи разбиваются по году и производителю, как это и требовалось. Это происходит благодаря тому, что фильтр контекста, заданный по умолчанию между **FactOnlineSales**, **DimProduct**и **DimDate** , корректно работает для мер на стороне связи "многие".  
  
 Вместе с тем можно видеть, что число продуктов не вычисляется в том же контексте фильтра, что и продажи. Хотя число продуктов правильно фильтруется по производителю (счетчики производителей и продуктов находятся в одной таблице), фильтр даты не распространяется на число продуктов.  
  
### <a name="change-the-cross-filter"></a>Изменение кросс-фильтра  
  
1.  Вернитесь к модели и выберите **Таблицы** > **Управление связями**.  
  
2.  Измените связь между **FactOnlineSales** и **DimProduct**.  
  
     Измените направление фильтрации к обеим таблицам.  
  
3.  Сохраните параметры.  
  
4.  В книге нажмите кнопку **Обновление** для повторного чтения модели.  
  
 Теперь вы увидите, что и число продуктов, и число продаж фильтруется по одному и тому же контексту фильтра, содержащему не только производителей из **DimProducts** , но и календарный год из **DimDate**.  
  
## <a name="next-steps"></a>Следующие шаги  
 Чтобы увидеть, как работает двунаправленный кросс-фильтр в конкретной ситуации, нужно провести его практическое испытание. В некоторых случаях может оказаться, что возможностей стандартных функций недостаточно и для выполнения задачи необходимо прибегнуть к вычислениям DAX. В разделе **См. также** вы найдете несколько ссылок на дополнительные ресурсы по этой теме.  
  
 На практике с помощью кросс-фильтрации можно получить такие формы для просмотра данных, которые обычно создаются только с помощью конструкций "многие-ко-многим". Следует отметить, что двунаправленная кросс-фильтрация не является конструкцией "многие-ко-многим".  Реальная табличная конфигурации "многие-ко-многим" не поддерживается в конструкторе для табличных моделей в этом выпуске.  
  
## <a name="see-also"></a>См. также:  
 [Создание связей и управление ими в Power BI Desktop](https://support.powerbi.com/knowledgebase/articles/464155-create-and-manage-relationships-in-power-bi-desktop)   
 [Практический пример обработки простых многие manay связей в Power Pivot и табличных моделей](http://social.technet.microsoft.com/wiki/contents/articles/22202.a-practical-example-of-how-to-handle-simple-many-to-many-relationships-in-power-pivotssas-tabular-models.aspx)   
 [Разрешение связей многие ко многим, используя DAX кросс табличной фильтрации](http://blog.gbrueckl.at/2012/05/resolving-many-to-many-relationships-leveraging-dax-cross-table-filtering/)   
 [Многие многие-ко (блог SQLBI)](http://www.sqlbi.com/articles/many2many/)  
  
  
