---
title: Модели Python в SQL Server для обучения и прогнозы с помощью хранимых процедур | Документация Майкрософт
description: Внедрение кода Python в хранимые процедуры SQL Server для создания, обучения и использования модели Python с помощью классический набор данных Iris. Сохранить обученную модель в SQL Server и затем использовать его для создания прогнозируемых выходных данных.
ms.prod: sql
ms.technology: machine-learning
ms.date: 10/23/2018
ms.topic: tutorial
author: HeidiSteen
ms.author: heidist
manager: cgronlun
ms.openlocfilehash: 17b51d695a923b6db1661e6e15605a1f05d08178
ms.sourcegitcommit: 0f7cf9b7ab23df15624d27c129ab3a539e8b6457
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/09/2018
ms.locfileid: "51293160"
---
# <a name="create-train-and-use-a-python-model-with-stored-procedures-in-sql-server"></a>Создавать, обучать и использовать модели Python с хранимыми процедурами в SQL Server
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

В этом упражнении демонстрируется интеграция Python с SQL Server при добавлении [служб машинного обучения](../install/sql-machine-learning-services-windows-install.md) компонентов в экземпляр ядра СУБД. В подобном случае можно создать оболочку кода Python внутри [хранимой процедуры](../../relational-databases/stored-procedures/stored-procedures-database-engine.md) для ввода в эксплуатацию сценария для рабочих нагрузок. Возможность внедрения кода в хранимой процедуре имеет материальные выгоды, разработки, тестирования и управления обработки и анализа данных и задач машинного обучения. Он делает скрипт и модели доступны для любого приложения, который может подключиться к SQL Server.

В этом упражнении Python вы создадите и выполните две хранимые процедуры. Первый из них используется классический набор данных Iris цветок и создает модель упрощенного алгоритма Байеса для прогнозирования виды цветов ириса на основе характеристик цветок. Вторая процедура предназначена для оценки. Он вызывает модель, созданная в первой процедуре в выходной набор прогнозов. Поместив код в хранимую процедуру, следующие операции: автономной, многократно используемых и вызываемых другими хранимыми процедурами и клиентских приложений. 

Путем изучения этого учебника вы узнаете:

> [!div class="checklist"]
> * Как внедрять код Python в хранимой процедуре
> * Способ передачи входных данных для кода с помощью входных данных на хранимую процедуру
> * Как хранимые процедуры используются для ввода в эксплуатацию моделей

## <a name="prerequisites"></a>предварительные требования

Демонстрационные данные, используемые в этом упражнении [ **irissql** ](demo-data-iris-in-sql.md) базы данных.

Вам также потребуется редактор T-SQL, таких как [SQL Server Management Studio](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017).

## <a name="create-a-stored-procedure-that-generates-models"></a>Создать хранимую процедуру, которая приводит к возникновению ошибки модели

Стандартная практика при разработке SQL Server — упорядочить программируемых операций, в отдельные хранимые процедуры. На этом шаге вы создадите хранимую процедуру, которая создает модель для прогнозирования результатов. 

1. Откройте новое окно запроса в среде Management Studio, подключенных к **irissql** базы данных. 

    ```sql
    USE irissql
    GO
    ```

2. Скопируйте следующий код, чтобы создать новую хранимую процедуру. 

   При выполнении этой процедуры вызывает [sp_execute_external_script](https://docs.microsoft.com/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql) для запуска сеанса Python. 
   
   Входные данные, необходимые для кода Python, передаются как входные параметры на этой хранимой процедуры. Выходные данные будут обученной модели, основанный на Python **scikit-Узнайте** библиотеки для алгоритма машинного обучения. 

   Этот код использует [ **pickle** ](https://docs.python.org/2/library/pickle.html) для сериализации модели. Модель будет обучена с использованием данных из столбцов от 0 до 4 **iris_data** таблицы. 
   
   Параметры, вы увидите во второй части процедуры излагать входных данных и выходных данных модели. Как можно больше, необходимый выполнения кода Python в хранимую процедуру, чтобы четко определены входные и выходные данные, сопоставленные с хранимой процедуры входы и выходы, переданный во время выполнения. 

    ```sql
    CREATE PROCEDURE generate_iris_model (@trained_model varbinary(max) OUTPUT)
    AS
    BEGIN
    EXEC sp_execute_external_script @language = N'Python',
    @script = N'
    import pickle
    from sklearn.naive_bayes import GaussianNB
    GNB = GaussianNB()
    trained_model = pickle.dumps(GNB.fit(iris_data[[0,1,2,3]], iris_data[[4]]))
    '
    , @input_data_1 = N'select "Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width", "SpeciesId" from iris_data'
    , @input_data_1_name = N'iris_data'
    , @params = N'@trained_model varbinary(max) OUTPUT'
    , @trained_model = @trained_model OUTPUT;
    END;
    GO
    ```

3. Убедитесь, что эта хранимая процедура существует. 

   Если скрипт T-SQL на предыдущем шаге был выполнен без ошибок, новая хранимая процедура с именем **generate_iris_model** создается и добавляется к **irissql** базы данных. Хранимые процедуры можно найти в среде Management Studio **обозревателя объектов**в разделе **программирования**.

## <a name="execute-the-procedure-to-create-and-train-models"></a>Выполните процедуру для создания и обучения моделей

На этом шаге выполните процедуру для запуска внедренный код, создание модели обучение и сериализованные в выходных данных. Модели, сохраненные для повторного использования в SQL Server сериализуются в виде байтового потока и хранятся в столбце VARBINARY(MAX) в таблице базы данных. Когда модель создана, обучение, сериализуется и сохраняются в базе данных, может быть вызвана с другими процедурами или [ПРОГНОЗИРОВАНИЯ T-SQL](https://docs.microsoft.com/sql/t-sql/queries/predict-transact-sql) функции в оценки рабочих нагрузок.

1. Скопируйте следующий код для выполнения процедуры. Инструкции для выполнения хранимой процедуры — `EXEC` в пятой строке.

   Данном конкретном сценарии удаляет существующую модель с таким же именем («упрощенный алгоритм Байеса»), чтобы освободить место для новых, созданные путем повторного запуска ту же процедуру. Без удаления модели возникает ошибка о том, что объект уже существует. Она хранится в таблице, именуемой **iris_models**, подготовленные при создании **irissql** базы данных.

    ```sql
    DECLARE @model varbinary(max);
    DECLARE @new_model_name varchar(50)
    SET @new_model_name = 'Naive Bayes '
    SELECT @new_model_name 
    EXEC generate_iris_model @model OUTPUT;
    DELETE iris_models WHERE model_name = @new_model_name;
    INSERT INTO iris_models (model_name, model) values(@new_model_name, @model);
    GO
    ```

2. Просмотрите результаты в области вывода. Этот скрипт содержит инструкцию SELECT, показывающий, что модель существует. Другой способ получения списка моделей — `SELECT * FROM iris_models` в **irissql**.

    **Результаты**

    |   | (отсутствует имя столбца |
    |---|-----------------|
    | 1 | упрощенный алгоритм Байеса     | 


## <a name="create-and-execute-a-stored-procedure-for-generating-predictions"></a>Создание и выполнение хранимой процедуры для создания прогнозов

Теперь, когда создания, обучения и сохранить модель, перейти к следующему шагу: Создание хранимой процедуры, которая создает прогнозы. Вы будете этого вызывающий sp_execute_external_script для запуска Python и затем передать в скрипт Python, который загружает сериализованную модель, созданной в предыдущем упражнении и передает ему входных данных для оценки.

1. Запустите следующий код, чтобы создать хранимую процедуру, которая выполняет оценки. Во время выполнения этой процедуры будет загрузить двоичная модель, используйте столбцы `[1,2,3,4]` на входе и указать столбцы `[0,5,6]` как выходные данные.

    ```sql
    CREATE PROCEDURE predict_species (@model varchar(100))
    AS
    BEGIN
    DECLARE @nb_model varbinary(max) = (SELECT model FROM iris_models WHERE model_name = @model);
    EXEC sp_execute_external_script @language = N'Python', 
    @script = N'
    import pickle
    irismodel = pickle.loads(nb_model)
    species_pred = irismodel.predict(iris_data[[1,2,3,4]])
    iris_data["PredictedSpecies"] = species_pred
    OutputDataSet = iris_data[[0,5,6]] 
    print(OutputDataSet)
    '
    , @input_data_1 = N'select id, "Sepal.Length", "Sepal.Width", "Petal.Length", "Petal.Width", "SpeciesId" from iris_data'
    , @input_data_1_name = N'iris_data'
    , @params = N'@nb_model varbinary(max)'
    , @nb_model = @nb_model
    WITH RESULT SETS ( ("id" int, "SpeciesId" int, "SpeciesId.Predicted" int));
    END;
    GO
    ```

2. Выполните хранимую процедуру, предоставляя имя модели «Упрощенный алгоритм Байеса», чтобы процедура знал, какую модель для использования. 

    ```sql
    EXEC predict_species 'Naive Bayes';
    GO
    ```

    При выполнении хранимой процедуры, она возвращает Python data.frame. Эта строка T-SQL указывает схему для возвращенных результатов: `WITH RESULT SETS ( ("id" int, "SpeciesId" int, "SpeciesId.Predicted" int));`. Можно вставлять результаты в новую таблицу, или возвращать их в приложение.

    ![Результирующий набор из хранимой процедуры](media/train-score-using-python-NB-model-results.png)

    Результаты будут 150 прогнозы о виды цветов, используя цветочно характеристики в качестве входных данных. Для большинства наблюдений прогнозируемое указывает, следует соответствует фактическое виды цветов.

    В этом примере стала простой с помощью набора данных iris Python для обучения и оценки. Более типичный подход может быть связана с выполнением SQL-запрос для получения новых данных и передавать, Python в качестве `InputDataSet`. 

## <a name="conclusion"></a>Заключение

В этом упражнении вы узнали, как создавать хранимые процедуры, предназначенный для решения различных задач, где каждой хранимой процедуры используется системная хранимая процедура [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md) запустить процесс Python. Входные данные для процесса Python передаются в сценарий sp_execute_external как параметры. Переменные данных в базе данных SQL Server и самого сценария Python, передаются как входные данные.

Как правило следует только планируется использовать SSMS с великолепные кода Python или простой код Python, который возвращает выходные данные на уровне строк. В качестве средства SSMS поддерживает языки запросов как T-SQL и возвращает плоские наборы строк. Если ваш код создает visual выходные данные вида точечной диаграммы или гистограммы, вам потребуется средство или конечных пользователей приложения, который может преобразовать изображение.

Для некоторых разработчиков Python, которые используются для написания комплексный сценарий, обработку различных операций может показаться ненужной распределение задач в отдельные инструкции. Но обучения и оценки различных сценариев использования. Разделяя их, можно поместить каждую задачу по другому расписанию и области разрешений для операции.

Аналогичным образом, вы можете также использовать возникла функции SQL Server, например параллельная обработка, управление ресурсами, или путем написания скрипта для использования алгоритмов в [revoscalepy](../python/what-is-revoscalepy.md) или [MicrosoftML](https://docs.microsoft.com/machine-learning-server/python-reference/microsoftml/microsoftml-package) , Поддержка потоковой передачи и параллельного выполнения. Разделяя обучения и оценки, вы можете ориентироваться оптимизация для конкретных рабочих нагрузок.

Окончательный удобно, что процессов может быть изменено с помощью параметров. В этом упражнении кода Python для создания модели (с именем «Упрощенный алгоритм Байеса» в этом примере) был передан в качестве входных данных для вызова модели в в процессе оценки второй хранимой процедуры. В этом упражнении используется только одна модель, но вы можете представить, как параметризации модели в задачу оценки сделает этот сценарий более полезной.

## <a name="next-steps"></a>Следующие шаги

Если вы являетесь разработчиком SQL работали с Python, просмотрите действия и средства для работы с кодом Python локально, с возможностью для сдвига выполнения из локального сеанса с удаленным экземпляром SQL Server.

> [!div class="nextstepaction"]
> [Настройка рабочей станции клиента Python](../python/setup-python-client-tools-sql.md).

