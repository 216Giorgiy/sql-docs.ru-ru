---
title: "Устранение неполадок при сборе данных для машинного обучения — SQL Server"
ms.custom: 
ms.date: 06/16/2017
ms.prod: sql-server-2016
ms.reviewer: 
ms.suite: 
ms.technology:
- r-services
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- R
caps.latest.revision: 1
author: jeannt
ms.author: jeannt
manager: jhubbard
ms.translationtype: MT
ms.sourcegitcommit: 05976158e43d7dfafaf02289462d1537f5beeb36
ms.openlocfilehash: b9185b1798c638541a5228d9cbe9e675a8de3427
ms.contentlocale: ru-ru
ms.lasthandoff: 09/08/2017

---
# <a name="troubleshoot-data-collection-for-machine-learning"></a>Устранение неполадок при сборе данных для машинного обучения

Тип данных, которые следует собирать при попытке устранить проблемы с установки, настройки или производительность машинного обучения в SQL Server описаны в этой статье. Такие данные включают журналы, сообщения об ошибках и сведения о системе.

В статье описаны источники данных, которые наиболее полезны при выполнении диагностики на основе самостоятельного устранения неполадок. Сбор этих сведений также полезен при запросе технической поддержки для проблемы, связанные с функции обучения компьютера SQL Server.

**Применяется к:** служб R SQL Server 2016, SQL Server 2017 г машинного обучения службы (R и Python)

## <a name="sql-server-and-r-versions"></a>Версии SQL Server и R

Обратите внимание на то, является ли версия новой установки или обновления. Если это обновление, определите, как было выполнено:

- Какая версия обновления? 
- Была удалена старых компонентов или обновления на месте?
- Были ли изменены какие-либо параметры компонента во время обновления? 

### <a name="which-edition-of-sql-server-is-installed-and-which-version"></a>Установленной версии SQL Server, а также версию? 

SQL Server R Services впервые появился в SQL Server 2016. Предыдущие версии не поддерживают машинного обучения. Кроме того последующие пакеты обновления для выпуска 2016 включены многие исправления и улучшения. В качестве первого шага следует установка пакета обновления 1 или более поздней версии.

В SQL Server 2017 г расширенная поддержка теперь языка Python. Поддержка Python не указано в более ранних выпусках.

Если вам нужна помощь, чтобы определить, какой выпуск и версия, см. статью, который содержит список номеров построений для каждого из [версий SQL Server](https://social.technet.microsoft.com/wiki/contents/articles/783.sql-server-versions.aspx#Service_Pack_editions).

В зависимости от выпуска SQL Server, вы используете некоторые машинного обучения функциональность может быть недоступность или ограниченная.

В следующих разделах список функций компьютера обучения в выпусках Enterprise, Developer, Standard и Express.

* [Выпуски и поддерживаемых функций SQL Server](https://docs.microsoft.com/sql/sql-server/editions-and-components-of-sql-server-2016)
* [Различия в возможностях R между выпусками SQL Server](https://docs.microsoft.com/sql/advanced-analytics/r/differences-in-r-features-between-editions-of-sql-server)

### <a name="which-version-of-microsoft-r-is-installed"></a>Какие версии Microsoft R?

Как правило версии Microsoft R, которая устанавливается при выборе функции служб R и службах обучения машин определяется номер сборки SQL Server. Если выполняется обновление или исправление для SQL Server, необходимо обновить или исправить его компонентов R.

Список выпусков, а также ссылки на загружаемые файлы компонентов R см. в разделе [установить компоненты обучения компьютер без доступа к Интернету](https://docs.microsoft.com/sql/advanced-analytics/r/installing-ml-components-without-internet-access). На компьютерах с доступом в Интернет требуемая версия R идентифицировать и устанавливается автоматически.

Это возможно обновление компонентов R Server отдельно от SQL Server database engine, в процессе, называемом привязки. Таким образом версии R, используемый при выполнении кода R в SQL Server могут отличаться в зависимости от установленной версии SQL Server и на ли были перенесены сервер до последней версии R.

#### <a name="determine-the-r-version"></a>Определить версию R

Для определения версии R проще всего получить свойствам среды выполнения, выполнив инструкции из следующего:

```SQL
exec sp_execute_external_script
       @language = N'R'
       , @script = N'
# Transform R version properties to data.frame
OutputDataSet <- data.frame(
  property_name = c("R.version", "Revo.version"), 
  property_value = c(R.Version()$version.string, Revo.version$version.string),
  stringsAsFactors = FALSE)
# Retrieve properties like R.home, libPath & default packages
OutputDataSet <- rbind(OutputDataSet, data.frame(
  property_name = c("R.home", "libPaths", "defaultPackages"),
  property_value = c(R.home(), .libPaths(), paste(getOption("defaultPackages"), collapse=", ")),
  stringsAsFactors = FALSE)
)
'
WITH RESULT SETS ((PropertyName nvarchar(100), PropertyValue nvarchar(4000)));

```

> [!TIP] 
> Если R Services не работает, попробуйте выполнить только часть скрипта R из RGui.

В качестве последнего средства можно открывать файлы на сервере, чтобы определить установленную версию. Чтобы сделать это, найдите файл rlauncher.config, чтобы получить расположение среды выполнения R и текущего рабочего каталога. Рекомендуется создать и открыть копию файла, чтобы случайного изменения любого свойства.

* SQL Server 2016
  
  `C:\Program Files\Microsoft SQL Server\MSSQL13.<instance_name\MSSQL\Binn\rlauncher.config`

* SQL Server 2017
  
  `C:\Program Files\Microsoft SQL Server\MSSQL14.<instance_name>\MSSQL\Binn\rlauncher.config`

Чтобы получить версии R и RevoScaleR, откройте окно командной строки R или открыть RGui, который связан с экземпляром.

* SQL Server 2016
  
  `C:\Program Files\Microsoft SQL Server\MSSQL13.<instancename>\R_SERVICES\bin\x64\RGui.exe`

* SQL Server 2017
  
  `C:\Program Files\Microsoft SQL Server\MSSQL14.<instance_name>\R_SERVICES\bin\x64\RGui.exe`


В консоли R отображаются сведения о версии во время запуска. Например следующая версия представляет конфигурации по умолчанию для SQL Server 2017 г CTP 2.0:

    *Microsoft R Open 3.3.3*
    
    *The enhanced R distribution from Microsoft*
    
    *Microsoft packages Copyright (C) 2017 Microsoft*
    
    *Loading Microsoft R Server packages, version 9.1.0.*


### <a name="what-version-of-python-is-installed"></a>Какие версии Python?

Поддержка Python, доступны только в SQL Server 2017 г. сообщества Technology Preview (CTP) 2.0 и более поздней версии.

Существует несколько способов получить версию Python. Проще всего выполнить эту инструкцию из среды Management Studio или другого средства запросов SQL:

```SQL
-- Get Python runtime properties:
exec sp_execute_external_script
       @language = N'Python'
       , @script = N'
import sys
import pkg_resources
OutputDataSet = pandas.DataFrame(
                    {"property_name": ["Python.home", "Python.version", "Revo.version", "libpaths"],
                    "property_value": [sys.executable[:-10], sys.version, pkg_resources.get_distribution("revoscalepy").version, str(sys.path)]}
)
'
with WITH RESULT SETS (SQL keywords) ((PropertyName nvarchar(100), PropertyValue nvarchar(4000)));
```

Если службы обучения машина не запущена, можно определить установленную версию Python, просмотрев файл pythonlauncher.config. Рекомендуется создать и открыть копию файла, чтобы случайного изменения любого свойства.

1. Только для SQL Server 2017 г.:`C:\Program Files\Microsoft SQL Server\MSSQL14.<instance_name>\MSSQL\Log\ExtensibilityLog\pythonlauncher.config `
2. Получить значение для **PYTHONHOME**.
3. Получает значение в текущем рабочем каталоге.


> [!NOTE]
> После установки Python и R в SQL Server 2017 г., рабочий каталог и пул рабочих учетных записей являются общими для языков R и Python.

### <a name="are-multiple-instances-of-r-or-python-installed"></a>Несколько экземпляров R или Python установлен?

Проверьте, установлена ли более одной копии библиотек R на компьютере. Это дублирование может произойти, если:

* Во время установки выбрать службы R (в базе данных) и R Server (изолированный). 
* Установки клиента Microsoft R в дополнение к SQL Server.
* Другой набор библиотек R была установлена с помощью средства R для Visual Studio, R Studio, Microsoft R клиента или другого интерфейса IDE r..
* Компьютер содержит несколько экземпляров SQL Server и более одного экземпляра с применением машинного обучения.

Применяются те же условия Python.

Если установлено несколько библиотек или сред выполнения, убедитесь, что вы получите только ошибки, связанные с сред выполнения Python или R, которые используются экземпляром SQL Server.

## <a name="errors-and-messages"></a>Ошибки и сообщения

Ошибки, которые возникают при попытке запуска кода R могут поступать из любой из следующих источников:

- СУБД SQL Server, включая sp_execute_external_script хранимой процедуры
- Доверенная панель запуска SQL Server 
- Другие компоненты платформы расширения, включая средства запуска R и Python и вспомогательных процессов
- Поставщики, например Microsoft Open Database Connectivity (ODBC)
- Язык R

При работе со службой в первый раз, может быть трудно определить, какие сообщения получаются из службы. Корпорация Майкрософт рекомендует для сохранения не только текстовое сообщение об ошибке, но контекст, в котором показано сообщение. Обратите внимание, клиентское программное обеспечение, которую вы используете для запуска машинного обучения кода:

- Вы используете среду Management Studio? Внешнее приложение?
- Выполняется ли код R, в удаленных клиентов или непосредственно в хранимой процедуре?

### <a name="what-errors-has-sql-server-logged"></a>Какие ошибки выполнил SQL Server

Получите самые последние ОШИБОК SQL Server. Полный набор файлов журнала ошибок, состоит из файлов в папке журнала по умолчанию:

* SQL Server 2016
  
  `C:\Program Files\Microsoft SQL Server\MSSQL13.SQL2016\MSSQL\Log\ExtensibilityLog`

* SQL Server 2017
  
  `C:\Program Files\Microsoft SQL Server\MSSQL14.SQL2016\MSSQL\Log\ExtensibilityLog`

> [!NOTE] 
> Точное имя папки зависит от того, имя экземпляра.


### <a name="what-errors-were-returned-by-the-spexecuteexternalscript-command"></a>Какие ошибки, возвращенные командой sp_execute_external_script?

Получите полный текст ошибки, которые возвращаются, если таковая имеется, при выполнении команды sp_execute_external_script. 

Для предотвращения проблем R или Python из рассмотрения, можно выполнять этот скрипт, который запускает среду выполнения R или Python и передает данные и обратно.

**Для R**

```sql
exec sp_execute_external_script @language =N'R',  
@script=N'OutputDataSet<-InputDataSet',  
@input_data_1 =N'select 1 as hello'  
with result sets (([hello] int not null));  
go
```

**Для Python**

```sql
exec sp_execute_external_script @language =N'Python',  
@script=N'OutputDataSet= InputDataSet',  
@input_data_1 =N'select 1 as hello'  
with result sets (([hello] int not null));  
go
```

### <a name="what-errors-are-generated-by-the-extensibility-framework"></a>Какие ошибки создаются с помощью extensibility framework?

SQL Server создает отдельные файлы журналов для среды выполнения языка внешних скриптов. Эти ошибки не формируются языка Python или R. Они будут созданы из компонентов расширяемости в SQL Server, включая средства запуска конкретного языка и их вспомогательных процессов.

Эти журналы можно получить из следующих расположений по умолчанию.

* SQL Server 2016
  
  `C:\Program Files\Microsoft SQL Server\MSSQL13.<instance_name>\MSSQL\Log\ExtensibilityLog`

* SQL Server 2017
  
  `C:\Program Files\Microsoft SQL Server\MSSQL14.<instance_name>\MSSQL\Log\ExtensibilityLog `

> [!NOTE] 
> Точное имя папки отличается в зависимости от имени экземпляра. В зависимости от конфигурации папка может быть на другом диске.

Например следующие сообщения журнала, относящиеся к структуре расширяемости.

* *Сбой LogonUser для пользователя MSSQLSERVER01*
  
  Это может указывать учетные записи работника, которые работают внешних скриптов не может обращаться к экземпляру.

* *Не удалось выполнить InitializePhysicalUsersPool* 
  
  Это сообщение может означать, что параметры безопасности препятствуют установки создавать пул рабочих учетных записей, которые необходимы для выполнения внешних скриптов.

* *Не удалось инициализировать диспетчер контекста безопасности* 

* *Не удалось инициализировать диспетчер сеансов вспомогательных*

### <a name="are-there-any-related-system-events"></a>Существуют ли все связанные системные события?

1. Откройте средство просмотра событий Windows и поиск **системное событие** журнала для сообщений, содержащих строки *запуска*. 
2. Откройте файл ExtLaunchErrorlog и наличие строки *ErrorCode*. Ознакомьтесь с сообщением, связанной с ErrorCode.

Например следующие сообщения являются общих системных ошибок, относящихся к структуре расширяемости SQL Server: 

* *Служба панели запуска SQL Server (MSSQLSERVER) не удалось запуститься из-за следующей ошибки:<text>*

* *Служба не ответила на запрос запуска или управления в течение отведенного времени.* 

* *Время ожидания (в миллисекундах 120000) во время ожидания для службы панели запуска SQL Server (MSSQLSERVER) для подключения.* 

### <a name="did-any-components-start-and-then-crash"></a>Все компоненты запустить и затем аварийно завершить работу?

Если знаниями об отладке, файлы дампа можно использовать для анализа сбоев в панель запуска.

1. Найдите папку, содержащую журналы установки начальной загрузки для SQL Server. Например в SQL Server 2016 путь по умолчанию был C:\Program Files\Microsoft SQL Server\130\Setup Bootstrap\Log.
2. Откройте папку начальной загрузки журнала, характерное для расширяемости.
3. Если необходимо отправить запрос на техническую поддержку, добавьте все содержимое этой папки в ZIP-файл. Например C:\Program Files\Microsoft SQL Server\130\Setup Bootstrap\Log\LOG\ExtensibilityLog.
  
Точное расположение может отличаться в вашей системе, и может оказаться на диске, отличном от диска C. Убедитесь в том, что получить журналы для экземпляра, где установлен машинного обучения. 


## <a name="related-tools-and-configuration"></a>Дополнительные средства и конфигурации

В этом разделе перечислены дополнительные компоненты или поставщики, которые могут быть источника ошибок при выполнении скриптов R или Python.

### <a name="what-network-protocols-are-available"></a>Доступных сетевых протоколов?

Службы обучения машины требуются следующие сетевые протоколы для внутренней связи между компонентами расширяемости и для связи с внешними клиентами R или Python.

* Именованные каналы
* TCP/IP

Откройте диспетчер конфигурации SQL Server для определения протокола, установлен ли и, если он установлен, чтобы определить, включена ли она.

### <a name="security-configuration-and-permissions"></a>Настройки безопасности и разрешений

Для рабочих учетных записей:

1. В панели управления откройте **пользователей и групп**и найдите группу, используемую для запуска заданий внешнего скрипта. По умолчанию группа — **SQLRUserGroup**.
2. Убедитесь, что группа существует и что он содержит по крайней мере одной рабочей учетной записи.
3. В SQL Server Management Studio, выберите экземпляр, в которой будет выполняться задания R или Python, выберите **безопасности**и определить, существует ли имя входа для SQLRUserGroup.
4. Просмотреть разрешения для группы пользователей.

Для отдельных учетных записей пользователей:

1. Определите, поддерживает ли экземпляр смешанного режима проверки подлинности, только имена входа SQL или только проверку подлинности Windows. Этот параметр влияет на R или Python code требования.
2. Для каждого пользователя, которому необходимо запустить код R определите требуемый уровень разрешений для каждой базы данных, где объекты будут записаны из R, будет получить доступ к данным или будут создаваться объекты.
3. Чтобы включить выполнение скриптов, Создание ролей или добавить пользователей в следующих ролей, при необходимости:

   - Все, кроме *db_owner*: требуется EXECUTE ANY EXTERNAL SCRIPT.
   - *db_datawriter*: для записи результатов из R или Python. 
   - *db_ddladmin*: для создания новых объектов. 
   - *db_datareader*: для чтения данных, используемый в коде R или Python. 
4. Обратите внимание, изменено ли учетные записи запуска по умолчанию при установке SQL Server 2016.
5. Если пользователю нужно установить новый R-пакетов или использовать пакеты R, которые были установлены с другими пользователями, может потребоваться включить управление пакетами в экземпляре, а затем назначьте дополнительные разрешения. Дополнительные сведения см. в разделе [включить или отключить управление пакетами R](r\r-package-how-to-enable-or-disable.md).

### <a name="what-folders-are-subject-to-locking-by-antivirus-software"></a>Какие папки подлежат блокировки антивирусной программой?

Антивирусное программное обеспечение можно заблокировать папок, что запрещает установки машинного обучения, функций и выполнение скрипта успешно. Определите все папки в дереве SQL Server может быть проверка на наличие вирусов.

Тем не менее при нескольких служб или компоненты установлены на экземпляре, может быть трудно перечислить все возможные папки, которые используются в экземпляре. Например при добавлении новых функций, новых папок должно быть определены и исключен.

Кроме того некоторые возможности создавать новые папки динамически во время выполнения. Например таблицы OLTP в памяти, хранимые процедуры и функции создайте новые каталоги во время выполнения. Эти имена папок часто содержат идентификаторы GUID, предсказать нельзя. Панель запуска SQL Server доверенные создает новые рабочие каталоги для R и Python скрипты заданий.

Может оказаться невозможным исключить все папки, которые требуются процесс SQL Server и его компонентах, поэтому рекомендуется исключить все дерево каталогов экземпляра SQL Server.

### <a name="is-the-firewall-open-for-sql-server-does-the-instance-support-remote-connections"></a>Открыта брандмауэра для SQL Server? Поддерживает ли экземпляр удаленные соединения?

1. Чтобы определить, поддерживает ли SQL Server удаленные соединения, в разделе [Настройка соединения с удаленным сервером](../database-engine/configure-windows/view-or-configure-remote-server-connection-options-sql-server.md).

2. Определяет, создается ли правило брандмауэра для SQL Server. По соображениям безопасности при установке по умолчанию не возможно для удаленных клиентов R или Python для подключения к экземпляру. Дополнительные сведения см. в разделе [Устранение неполадок подключения к SQL Server](../database-engine/configure-windows/troubleshoot-connecting-to-the-sql-server-database-engine.md).

### <a name="can-you-run-r-script-outside-t-sql"></a>Можно запустить сценарий R за пределами T-SQL?

Можно попробовать запустить среду выполнения R, который связан с экземпляром SQL Server с помощью других средств R. Таким образом, можно определить, установлены ли необходимые библиотеки.

Базовой установки R включает несколько средств, которые можно использовать для запуска сценария R из командной строки, а также RGui интерактивного выполнения скриптов.

Если работает среды выполнения R, но сценарий возвращает ошибки, рекомендуется попробовать отладка скриптов в специальной среде разработки R, такие как средства R для Visual Studio.

Также рекомендуется изучить и немного измените сценарий для исправления любых проблем с типами данных, которые могут возникнуть при перемещении данных между R и компонент database engine. Дополнительные сведения см. в разделе [R библиотек и типы данных](r/r-libraries-and-data-types.md).

Кроме того можно использовать пакет sqlrutils для формирования пакета R-скриптов в формате, который является более простой в использовании как хранимую процедуру. Дополнительные сведения см. в разделе:
* [Создание хранимой процедуры для кода R с помощью пакета sqlrutils](r/generating-an-r-stored-procedure-for-r-code-using-the-sqlrutils-package.md)
* [Создание хранимой процедуры с помощью sqlrutils](r/how-to-create-a-stored-procedure-using-sqlrutils.md)

## <a name="see-also"></a>См. также:

[Устранение неполадок машинного обучения в SQL Server](machine-learning-troubleshooting-faq.md)

