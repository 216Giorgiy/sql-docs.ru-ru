---
title: "Занятие&#160;1. Подготовка данных (пошаговое руководство по обработке и анализу данных) | Microsoft Docs"
ms.custom: ""
ms.date: "03/18/2017"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "r-services"
ms.tgt_pltfrm: ""
ms.topic: "article"
applies_to: 
  - "SQL Server 2016"
dev_langs: 
  - "R"
ms.assetid: 65fd41d4-c94e-4929-a24a-20e792a86579
caps.latest.revision: 29
author: "jeannt"
ms.author: "jeannt"
manager: "jhubbard"
caps.handback.revision: 25
---
# Занятие&#160;1. Подготовка данных (пошаговое руководство по обработке и анализу данных)
Чтобы подготовиться к работе с этим пошаговым руководством, необходимо сделать следующее:

1. Скачайте данные, а также все скрипты R, используемые в руководстве. Для упрощения скачивания с GitHub предоставлен скрипт PowerShell.   

2. Установите дополнительные пакеты R на сервере и на рабочей станции R.  

3. Подготовьте среду, включая базу данных и данные, используемые для моделирования и оценки.
 
    Для этого используйте второй скрипт PowerShell, RunSQL_R_Walkthrough.ps1.
    Он настраивает базу данных и отправляет данные в указанную таблицу.  Он также создает некоторые функции и хранимые процедуры SQL, упрощающие задачи по обработке и анализу данных. 
 

## <a name="1-download-the-data-and-scripts"></a>1. Скачивание образцов данных и скриптов  
Весь код, необходимый для выполнения этого пошагового руководства, имеется в репозитории GitHub. Скрипт PowerShell можно использовать для создания локальной копии файлов.  
  
#### <a name="to-download-all-scripts-using-powershell"></a>Скачивание всех скриптов с помощью PowerShell  
  
1.  На компьютере с клиентом обработки и анализа данных откройте командную строку Windows PowerShell с правами администратора.  
  
2.  Если вы еще не запускали PowerShell в этом экземпляре или у вас нет разрешения на запуск скриптов, может произойти ошибка. В этом случае перед запуском скрипта выполните приведенную ниже команду, которая временно разрешает запуск скриптов, не меняя параметры системы по умолчанию.  
  
    ```  
    Set-ExecutionPolicy Unrestricted -Scope Process -Force  
    ```  
  
3.  Чтобы скачать файлы скриптов в локальный каталог, выполните приведенную ниже команду. Если не указать другой каталог, по умолчанию будет создана папка C:\tempR, и все файлы сохранятся в ней.  
  
    ```  
    $source = 'https://raw.githubusercontent.com/Azure/Azure-MachineLearning-DataScience/master/Misc/RSQL/Download_Scripts_R_Walkthrough.ps1'  
    $ps1_dest = "$pwd\Download_Scripts_R_Walkthrough.ps1"  
    $wc = New-Object System.Net.WebClient  
    $wc.DownloadFile($source, $ps1_dest)  
    .\Download_Scripts_R_Walkthrough.ps1 –DestDir 'C:\tempR'  
  
    ```  
  
    Если нужно сохранить файлы в другом каталоге, измените значения параметра *DestDir* и укажите папку на компьютере. Если ввести имя несуществующей папки, скрипт PowerShell автоматически создаст ее.  
  
4.  По завершении скачивания командная консоль Windows PowerShell должна выглядеть следующим образом:  
  
    ![After completion of PowerShell script](../../advanced-analytics/r-services/media/rsql-e2e-psscriptresults.PNG "After completion of PowerShell script")  
  
5.  В консоли PowerShell выполните команду `ls`, чтобы просмотреть список файлов, скачанных в каталог *DestDir*.  Список и описание файлов см. в разделе [Состав скачанных данных](#What-the-Download-Includes).
  
## <a name="2-install-required-packages"></a>2. Установка необходимых пакетов  
Для работы с этим пошаговым руководством требуется ряд библиотек R, которые по умолчанию не устанавливаются вместе с [!INCLUDE[rsql_productname](../../includes/rsql-productname-md.md)]. Эти пакеты необходимо установить как на клиентском компьютере, на котором будет разрабатываться решение, так и на сервере [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , где оно будет развертываться.  
  
### <a name="install-required-packages-on-the-client"></a>Установка необходимых пакетов на клиентском компьютере  
Скачанный скрипт R содержит команды для скачивания и установки этих пакетов.  
  
1.  В среде R откройте файл скрипта RSQL_R_Walkthrough.R.  
  
2.  Выделите и выполните следующие строки:  
  
    ```  
    # Install required R libraries for this walkthrough if they are not installed.   
  
    if (!('ggmap' %in% rownames(installed.packages()))){  
      install.packages('ggmap')  
    }  
    if (!('mapproj' %in% rownames(installed.packages()))){  
      install.packages('mapproj')  
    }  
    if (!('ROCR' %in% rownames(installed.packages()))){  
      install.packages('ROCR')  
    }  
    if (!('RODBC' %in% rownames(installed.packages()))){  
      install.packages('RODBC')  
    }  
    ```  
  
### <a name="install-required-packages-on-the-server"></a>Установка необходимых пакетов на сервере  

  
1.  На компьютере [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] откройте программу RGui.exe от имени администратора.  Если вы установили службы SQL Server R Services с настройками по умолчанию, программу RGui.exe можно найти в папке C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\R_SERVICES\bin\x64.  
  
    Либо если на компьютере [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] установлена другая среда R (например, RStudio), для выполнения команд можно использовать консоль R.  
  
2.  В командной строке R выполните следующие команды R:  
  
    ```  
    install.packages("ggmap", lib=grep("Program Files", .libPaths(), value=TRUE)[1])  
    install.packages("mapproj", lib=grep("Program Files", .libPaths(), value=TRUE)[1]) 
    install.packages("ROCR", lib=grep("Program Files", .libPaths(), value=TRUE)[1]) 
    install.packages("RODBC", lib=grep("Program Files", .libPaths(), value=TRUE)[1]) 
    ```  
  
**Примечания.**  
  
-   В этом примере используется функция R grep для поиска вектора доступных путей и нахождения пути в каталоге Program files. Дополнительные сведения см. на странице [http://www.rdocumentation.org/packages/base/functions/grep](http://www.rdocumentation.org/packages/base/functions/grep).   
  
-   Если вы считаете, что пакеты уже установлены, проверьте список установленных пакетов с помощью функции R, `installed.packages()`.  
  
-   Если вы не можете производить запись в главную библиотеку в каталоге Program Files, в клиенте можно установить библиотеку пользователя. Тем не менее при установке на компьютере SQL Server пакеты необходимо установить в библиотеке по умолчанию, используемой службами SQL Server R Services. Не используйте библиотеку пользователя. Дополнительные сведения см. в статье [Installing New R Packages on SQL Server](../../advanced-analytics/r-services/install-additional-r-packages-on-sql-server.md) (Установка новых пакетов R в SQL Server).
      

## <a name="3-run-powershell-script-runsqlrwalkthroughps1"></a>3. Запуск скрипта Powershell RunSQL_R_Walkthrough.ps1  

Этот скрипт PowerShell можно выполнять на компьютере, где вы будете создавать решение, например разрабатывать и тестировать код R. У компьютера должна быть возможность подключения к серверу [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] по протоколу именованных каналов.  
  
Скрипт выполняет следующие действия:  
  
-   проверяет установлен ли клиент SQL Native Client и программы командной строки для [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ; программы командной строки необходимы для запуска [служебной программы bcp](../../tools/bcp-utility.md), которая служит для быстрой массовой загрузки данных в таблицы SQL;    
-   подключается к указанному экземпляру [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и выполняет ряд скриптов [!INCLUDE[tsql](../../includes/tsql-md.md)] , которые настраивают базу данных и создают таблицы для модели и данных;    
-   выполняет скрипт SQL для создания нескольких хранимых процедур;    
-   загружает данные, которые вы скачали ранее, в таблицу nyctaxi_sample;    
-   перезаписывает аргументы в файле скрипта R так, чтобы использовалось указанное имя базы данных. 

### <a name="to-run-the-script"></a>Выполнение скрипта
  
1.  Откройте командную строку PowerShell от имени администратора.    
  
2.  Перейдите в папку, в которую вы скачали скрипты, и введите имя скрипта, как показано ниже. Нажмите клавишу ВВОД.  
  
    ```  
    .\RunSQL_R_Walkthrough.ps1  
    ```  
  
3.  Вы получите запросы на ввод следующих параметров:  
  
    - Имя базы данных, которую нужно создать. 
      Например, можно ввести **Tutorial** или **Taxi**.  
    - Учетные данные для запуска скрипта. Имеются две возможности:
        + Введите имя входа SQL с правами CREATE DATABASE и введите пароль SQL при последующем запросе.
        + Нажмите клавишу ВВОД, но не вводите имя, чтобы использовалось ваше собственное удостоверение Windows, а в защищенной строке введите пароль Windows... В PowerShell не поддерживается ввод другого имени пользователя Windows. 

          Если не указать допустимого пользователя, для скрипта будет по умолчанию использоваться встроенная проверка подлинности Windows.  
  
    -   Полный путь к CSV-файлу, который нужно добавить в базу данных.  
  
        Скрипт должен автоматически скачивать файл и загружать данные в базу данных, но если это ему не удается, вы всегда можете отправить данные вручную.  
  
4.  Чтобы запустить скрипт, нажмите клавишу ВВОД.  
  
## <a name="troubleshooting"></a>Устранение неполадок  
 
 Если возникли проблемы, можно выполнить все шаги или один из них вручную, используя строки скрипта PowerShell в качестве примеров. 
 

### <a name="the-powershell-script-didnt-download-the-data"></a>Скрипт PowerShell не скачал данные
  
Чтобы скачать данные вручную, щелкните приведенную ниже ссылку правой кнопкой мыши и выберите пункт **Сохранить объект как**.  
  
[http://getgoing.blob.core.windows.net/public/nyctaxi1pct.csv](http://getgoing.blob.core.windows.net/public/nyctaxi1pct.csv)  
  
Запомните путь к скачанному файлу данных и его имя. Этот путь потребуется для загрузки данных в таблицу с помощью программы **bcp**.  
  
### <a name="i-was-unable-to-download-the-data"></a>Не удалось скачать данные
Файл данных имеет большой размер. Используйте компьютер с относительно хорошим подключением к Интернету, иначе время ожидания загрузки может истечь.  

  
### <a name="could-not-connect-or-script-failed"></a>Не удалось подключиться, или выполнение скрипта завершается сбоем  
  
+ Проверьте правильность написания имени экземпляра. 
+ Проверьте всю строку подключения.    
+ В зависимости от требований сети для имени экземпляра может требоваться одно или несколько имен подсетей в качестве квалификатора.  Например, если MYSERVER не подходит, попробуйте myserver.subnet.mycompany.com.
  
### <a name="network-error-or-protocol-not-found"></a>Ошибка сети, или не найден протокол  
  
+ Проверьте, поддерживает ли экземпляр удаленные подключения.    
+ Проверьте, может ли указанный пользователь SQL подключаться к базе данных удаленно и включен ли в экземпляре протокол именованных каналов.    
+ Проверьте разрешения, назначенные учетной записи. Указанная учетная запись может не иметь разрешений на создание базы данных и отправку данных.  

### <a name="bcp-did-not-run"></a>Не удалось запустить bcp  

+ Проверьте, есть ли на компьютере [служебная программа bcp](../../tools/bcp-utility.md). bcp можно запустить из окна PowerShell или командной строки Windows.
+ Если произошла ошибка, добавьте расположение служебной программы bcp в системную переменную среды PATH и повторите попытку.  

### <a name="the-table-schema-was-created-but-there-is-no-data-in-the-table"></a>Схема таблицы создана, но в ней нет данных

Если остальная часть скрипта выполнена без проблем, можно отправить данные в таблицу вручную, вызвав программу **bcp** из командной строки следующим образом:  


 
**Использование имени входа SQL**
    
~~~~ 
bcp TutorialDB.dbo.nyctaxi_sample in c:\tempR\nyctaxi1pct.csv -t ',' -S rtestserver.contoso.com -f C:\tempR\taxiimportfmt.xml -F 2 -C "RAW" -b 200000 -U <SQL login> -P <password  
~~~~  
  
**Использование проверки подлинности Windows**  

~~~~
bcp TutorialDB.dbo.nyctaxi_sample in c:\tempR\nyctaxi1pct.csv -t ',' -S rtestserver.contoso.com -f C:\tempR\taxiimportfmt.xml -F 2 -C "RAW" -b 200000 -T 
~~~~ 
  
  
+ Ключевое слово **in** указывает направление перемещения данных.  
+ Для аргумента **-f** необходимо указать полный путь к файлу форматирования. Файл форматирования необходим при использовании параметра **in**.
+ Используйте аргументы **-u** и **-p** при запуске служебной программы bcp с именем входа SQL.
+ Если используется встроенная проверка подлинности Windows, используйте аргумент **-t**. 

  
### <a name="how-can-i-run-the-script-without-prompts"></a>Как можно выполнять скрипт без вывода запросов?  
  
Вы можете указать все параметры в одной командной строке с использованием значений, принятых в вашей среде. 
  
```  
.\RunSQL_R_Walkthrough.ps1 -server <server address> -dbname <new db name> -u <user name> -p <password> -csvfilepath <path to csv file>  
```  
  
Например, чтобы запустить скрипт, используя имя входа SQL, выполните следующую команду:  
  
```  
.\RunSQL_R_Walkthrough.ps1 -server MyServer.subnet.domain.com -dbname MyDB –u SqlUserName –p SqlUsersPassword -csvfilepath C:\temp\nyctaxi1pct.csv  
```  
  
Код в примере выполняет следующие действия.  
  
-   подключается к указанным экземпляру и базе данных с использованием учетных данных пользователя *SqlUserName*;  
-   получает данные из файла *C:\temp\nyctaxi1pct.csv*;  
-   скачивает данные в таблицу *dbo.nyctaxi_sample* базы данных *MyDB* в экземпляре [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] с именем *MyServer*.  

### <a name="the-data-loaded-but-it-contains-duplicates"></a>Данные скачаны, но содержат повторяющиеся элементы

Если таблица существует и имеет правильную схему, программа bcp продолжит выполнение, но вместо перезаписи имеющихся данных будет вставлена новая копия данных. Это приведет к тому, что данные будут повторяться.  Усеките все имеющиеся таблицы перед повторным запуском скрипта.

## <a name="what-the-download-includes"></a>Состав скачанных данных

При скачивании файлов из репозитория GitHub вы получите следующее:
+ данные в формате CSV;
+ скрипт PowerShell для подготовки среды;
+ XML-файл форматирования для импорта данных в SQL Server с помощью программы bcp;
+ несколько скриптов T-SQL;
+ весь код R, необходимый для выполнения действий, описанных в этом пошаговом руководстве.

### <a name="training-and-scoring-data"></a>Данные для обучения и данные для оценки  
Данные представляют собой представительную выборку из набора данных по работе такси в Нью-Йорке, который содержит записи о более чем 173 миллионах отдельных поездок в 2013 году, включая сведения о размере оплаты и чаевых за каждую поездку.  Дополнительные сведения о том, как собирались эти данные и как можно получить полный набор данных, см. на странице  
[http://chriswhong.com/open-data/foil_nyc_taxi/](http://chriswhong.com/open-data/foil_nyc_taxi/).  
  
Чтобы с этими данными было проще работать, команда Майкрософт по обработке и анализу данных произвела выборку приблизительно 1 % из всего набора.  Эти данные были помещены в общедоступный контейнер хранилища BLOB-объектов в Azure в формате CSV. Исходные данные представляют собой несжатый файл размером немного менее 350 МБ.  
 
### <a name="files"></a>Файлы

 
+ **RunSQL_R_Walkthrough.ps1** — этот скрипт будет запускаться в первую очередь с помощью PowerShell. Он вызывает скрипты SQL для загрузки данных в базу данных.  
    
+ **taxiimportfmt.xml** — файл определения формата, который используется служебной программой bcp для загрузки данных в базу данных.
      
+ **RSQL_R_Walkthrough.R** — это основной скрипт R, который будет использоваться на остальных занятиях для анализа данных и моделирования. Он предоставляет весь необходимый код R для изучения данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , создания модели классификации и построения графиков.   
  
### <a name="sql-scripts"></a>Скрипты SQL  
Этот скрипт PowerShell выполняет несколько скриптов [!INCLUDE[tsql](../../includes/tsql-md.md)] на сервере. В приведенной ниже таблице перечислены файлы скриптов [!INCLUDE[tsql](../../includes/tsql-md.md)].  
  
|Имя файла скрипта SQL|Действие|  
|------------------------|----------------|  
|create-db-tb-upload-data.sql|Создает базу данных и две таблицы:<br /><br /> *nyctaxi_sample:* таблица, в которой хранятся данные для обучения — выборка из набора данных по работе такси в Нью-Йорке. К таблице добавляется кластеризованный индекс columnstore для оптимизации хранения данных и производительности запросов.<br /><br /> *nyc_taxi_models:* пустая таблица, которая будет использоваться в дальнейшем для сохранения обученной модели классификации.|  
|PredictTipBatchMode.sql|Создает хранимую процедуру, которая вызывает обученную модель с целью прогнозирования меток для новых наблюдений. В качестве входного параметра она принимает запрос.|  
|PredictTipSingleMode.sql|Создает хранимую процедуру, которая вызывает обученную модель классификации с целью прогнозирования меток для новых наблюдений. Переменные новых наблюдений передаются в процедуру в виде встроенных параметров.|  
|PersistModel.sql|Создает хранимую процедуру, которая позволяет сохранять двоичное представление модели классификации в таблице базы данных.|  
|fnCalculateDistance.sql|Создает скалярную функцию SQL, которая вычисляет прямое расстояние между местами посадки и высадки.|  
|fnEngineerFeatures.sql|Создает функцию SQL с табличным значением, которая создает функции для обучения модели классификации.|  
  
Все запросы SQL, используемые в этом пошаговом руководстве, протестированы и могут выполняться "как есть" в коде R. Однако если вы хотите дополнительно поэкспериментировать с ними или разработать собственное решение с применением запросов SQL, мы рекомендуем использовать среду разработки, например [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] , для предварительного тестирования и настройки запросов перед их добавлением в код R.  
  
  
## <a name="next-lesson"></a>Следующее занятие  
[Занятие 2. Просмотр и изучение данных (пошаговое руководство по обработке и анализу данных)](../../advanced-analytics/r-services/lesson-2-view-and-explore-the-data-data-science-end-to-end-walkthrough.md)  
  
## <a name="previous-lesson"></a>Предыдущее занятие  
[Пошаговое руководство по обработке и анализу данных](../../advanced-analytics/r-services/data-science-end-to-end-walkthrough.md)  
  
  
  
