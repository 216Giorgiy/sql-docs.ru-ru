---
title: "Занятие&#160;2. Создание и выполнение скриптов R (глубокое погружение в обработку и анализ данных) | Microsoft Docs"
ms.custom: 
  - "SQL2016_New_Updated"
ms.date: "10/26/2016"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "r-services"
ms.tgt_pltfrm: ""
ms.topic: "article"
applies_to: 
  - "SQL Server 2016"
dev_langs: 
  - "R"
ms.assetid: 51e8e66f-a0a5-4e96-aa71-f5c870e6d0d4
caps.latest.revision: 18
author: "jeannt"
ms.author: "jeannt"
manager: "jhubbard"
caps.handback.revision: 18
---
# Занятие&#160;2. Создание и выполнение скриптов R (глубокое погружение в обработку и анализ данных)
Теперь, когда вы настроили источники данных и создали контексты вычисления, можно приступать к выполнению более сложных скриптов R с помощью [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  На этом занятии вы используете серверный контекст вычисления для выполнения ряда распространенных задач машинного обучения:  
  
-   визуализация данных и получение сводных статистических данных;    
-   создание модели линейной регрессии;    
-   создание модели логистической регрессии;    
-   оценка новых данных и создание гистограммы оценок.  
  
## Задание сервера в качестве контекста вычисления  
Перед выполнением любого кода на языке R необходимо указать *текущий* или *активный* контекст вычисления.  
  
1.  Чтобы активировать контекст вычисления, который вы уже определили с помощью языка R, используйте функцию *rxSetComputeContext*, как показано ниже.  
  
    ```R  
    rxSetComputeContext(sqlCompute)   
    ```  
  
    После выполнения этой инструкции все последующие вычисления будут производиться на сервере [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], указанном в параметре *sqlCompute*.  
  
  
2.  Если вы считаете, что код на языке R лучше выполнять на рабочей станции, вы можете переключить контекст вычисления обратно на локальный компьютер с помощью ключевого слова  **local** .  
  
    ```R  
    rxSetComputeContext ("local")    
    ```  
  
    Чтобы просмотреть список других ключевых слов, поддерживаемых этой функцией, в командной строке R введите `help("rxSetComputeContext")` .  
  
> [!NOTE]  
> После задания контекста вычисления он будет оставаться активным, пока вы не измените его. Однако скрипты R, которые *не могут* выполняться в контексте удаленного сервера, будут выполняться локально.  
  
## Вычисление сводных статистических данных  
Чтобы проверить правильность работы контекста вычисления, попытайтесь создать какие-нибудь сводные статистические данные с помощью источника данных *sqlFraudDS*.  Помните, что объект источника данных определяет только данные, которые вы будете использовать. Он не меняет контекст вычисления.

+ Для выполнения кода локально используйте *rxSetComputeContext* и укажите ключевое слово local.
+ Чтобы создать те же самые вычисления на сервере SQL Server, переключитесь в контекст вычисления SQL, определенный ранее.  

  
1.  Вызовите функцию *rxSummary* и передайте требуемые аргументы, такие как формула и источник данных, а также занесите результаты в переменную *sumOut*.  
  
    ```R  
    sumOut <- rxSummary(formula = ~gender + balance + numTrans + numIntlTrans + creditLine, data = sqlFraudDS)  
  
    ```  
  
    В языке R существует множество функций для получения сводных данных, однако функция *rxSummary* поддерживает выполнение в различных удаленных контекстах вычисления, например [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].  Дополнительные сведения о схожих функциях см. в подразделе о [сводках](https://msdn.microsoft.com/microsoft-r/scaler-user-guide-data-summaries) в [справочнике по функциям ScaleR](https://msdn.microsoft.com/microsoft-r/scaler/scaler).
  
2.  По завершении обработки можно вывести содержимое переменной *sumOut* на консоль.  
  
    ```R  
    sumOut  
    ```  
  
    > [!NOTE]  
    > Если вы попытаетесь вывести результаты до того, как они будут возвращены с сервера [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], может возникнуть ошибка.  
  
  
**Результаты**  
  
*Сводные статистические результаты для: ~gender + balance + numTrans +*   
 *numIntlTrans + creditLine*    
 *Данные: sqlFraudDS (RxSqlServerData Data Source)*    
 *Число допустимых наблюдений: 10000*    
 *Name  Mean    StdDev  Min Max ValidObs    MissingObs*    
 *balance       4075,0318 3926,558714            0   25626 100000*    
 *numTrans        29,1061   26,619923 0     100 10000    0           100000*    
 *numIntlTrans     4,0868    8,726757 0      60 10000    0           100000*    
 *creditLine       9,1856    9,870364 1      75 10000    0          100000 Число категорий для gender*    
 *Число категорий: 2*    
 *Число допустимых наблюдений: 10000*   
 *Число отсутствующих наблюдений: 0*    
 *gender Число*    
 *Male   6154*    
  *Female 3846*  
  
## Добавление максимального и минимального значений  
Изучив сводные статистические данные, вы получили полезную информацию, которую хотите поместить в источник данных для использования в последующих вычислениях. Например, минимальное и максимальное значения можно использовать для построения гистограмм, поэтому вы решаете добавить их в источник данных *RxSqlServerData*.  
  
К счастью, в службах [!INCLUDE[rsql_productname](../../includes/rsql-productname-md.md)] есть оптимизированные функции, которые эффективно преобразуют целочисленные данные в категориальные факторные данные.  
  
1.  Сначала создайте ряд временных переменных.  
  
    ```R  
    sumDF <- sumOut$sDataFrame   
    var <- sumDF$Name    
    ```  
  
2.  Используйте ранее созданную переменную *ccColInfo* для определения столбцов в источнике данных.  
  
    Вы также добавите несколько новых вычисляемых столбцов (*numTrans*, *numIntlTrans* и *creditLine*) в коллекцию столбцов.  
  
    ```R 
    ccColInfo <- list(
        gender = list(type = "factor",  
          levels = c("1", "2"), 
          newLevels = c("Male", "Female")), 
        cardholder = list(type = "factor",  
          levels = c("1", "2"), 
          newLevels = c("Principal", "Secondary")), 
        state = list(type = "factor", 
          levels = as.character(1:51), 
          newLevels = stateAbb), 
        balance  = list(type = "numeric"),
        numTrans = list(type = "factor", 
          levels = as.character(sumDF[var == "numTrans", "Min"]:sumDF[var == "numTrans", "Max"])),
        numIntlTrans = list(type = "factor",  
            levels = as.character(sumDF[var == "numIntlTrans", "Min"]:sumDF[var =="numIntlTrans", "Max"])),
        creditLine = list(type = "numeric")
            )
  
    ```  
  
3.  Обновив коллекцию столбцов, вы можете применить приведенную ниже инструкцию, чтобы создать обновленную версию источника данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], который был определен ранее.  
  
    ```R  
    sqlFraudDS <- RxSqlServerData(  
        connectionString = sqlConnString,   
        table = sqlFraudTable,   
        colInfo = ccColInfo,        
        rowsPerRead = sqlRowsPerRead)   
    ```  
  
    Теперь источник данных *sqlFraudDS* содержит новые столбцы, добавленные в *ccColInfo*.  
  
Эти изменения касаются только объекта источника данных в среде R; в таблицу базы данных новые данные не записываются. Однако данные, записанные в переменную *sumOut*, можно использовать для создания визуализаций и сводок. На следующем шаге вы научитесь делать это при переключении контекста вычислений. 

> [!TIP]
> Если вы не помните, какой контекст вычисления используете, выполните `rxGetComputeContext()`.  Если возвращаемым значением является `RxLocalSeq Compute Context`, используется локальный контекст вычисления.
  
## Следующий шаг  
[Визуализация данных SQL Server с помощью языка R (глубокое погружение в обработку и анализ данных)](../../advanced-analytics/r-services/visualize-sql-server-data-using-r-data-science-deep-dive.md)  
  
## Предыдущий шаг  
[Определение и использование контекстов вычисления (глубокое погружение в обработку и анализ данных)](../../advanced-analytics/r-services/define-and-use-compute-contexts-data-science-deep-dive.md)  
  
  
  
