---
title: "Создание диаграмм и графиков с помощью языка R (пошаговое руководство по обработке и анализу данных) | Microsoft Docs"
ms.custom: 
  - "SQL2016_New_Updated"
ms.date: "03/14/2017"
ms.prod: "sql-server-2016"
ms.reviewer: ""
ms.suite: ""
ms.technology: 
  - "r-services"
ms.tgt_pltfrm: ""
ms.topic: "article"
applies_to: 
  - "SQL Server 2016"
dev_langs: 
  - "R"
ms.assetid: 5f70f0a6-fd4a-410f-9f44-1605503f77ec
caps.latest.revision: 16
author: "jeannt"
ms.author: "jeannt"
manager: "jhubbard"
---
# Создание диаграмм и графиков с помощью языка R (пошаговое руководство по обработке и анализу данных)
На этом занятии вы освоите методы создания графиков и карт на основе данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] с помощью языка R.  Вы узнаете, как можно легко просматривать графики, созданные на сервере, и как передавать графические объекты на сервер.  
  
## <a name="creating-graphics"></a>Создание графиков
В службах [!INCLUDE[rsql_productname](../../includes/rsql-productname-md.md)]графические объекты, а также модели и результаты сериализуются между компьютером и контекстом вычисления [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .

Используя контекст вычислений SQL Server, вы не сможете скачать представление карты, так как большинство рабочих серверов баз данных полностью блокируют доступ к Интернету.  Поэтому для создания второго набора диаграмм вы создадите представление карты в клиенте, а затем наложите на карту точки, сохраненные в качестве атрибутов в таблице *nyctaxi_sample*.   

Для этого вы сначала создадите представление карты, вызвав службу Google Карты, а затем передадите его в контекст SQL.  
  
Такой порядок действий может быть полезен и при создании собственных приложений.   
  
### <a name="create-a-histogram"></a>Создание гистограммы  
Чтобы создать гистограмму, вы используете созданный ранее источник данных [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] и функцию `rxHistogram` , предоставляемую службами R Services.  
  
1.  Создайте первую диаграмму с помощью функции *rxHistogram*.  Функция *rxHistogram* предоставляет возможности, аналогичные возможностям пакетов R с открытым исходным кодом. Однако она может выполняться в удаленном контексте вычисления. 
  
    ```R  
    #Plot fare amount on SQL Server and return the plot  
    start.time <- proc.time()  
    rxHistogram(~fare_amount, data = inDataSource, title = "Fare Amount Histogram")  
    used.time <- proc.time() - start.time  
    print(paste("It takes CPU Time=", round(used.time[1]+used.time[2],2), " seconds, Elapsed Time=", round(used.time[3],2), " seconds to generate features.", sep=""))    
    ```         
  
2.  Изображение возвращается в графическом устройстве R вашей среды разработки.  Например, в RStudio откройте окно **Plot** (График).  В [!INCLUDE[rsql_rtvs](../../includes/rsql-rtvs-md.md)]открывается отдельное графическое окно.  
  
    ![using rxHistogram to plot fare amounts](../../advanced-analytics/r-services/media/rsql-e2e-rxhistogramresult.png "using rxHistogram to plot fare amounts")  
  
    > [!NOTE]  Так как упорядочение строк с помощью предложения TOP является недетерминированным без предложения ORDER BY, результаты могут быть другими. Мы рекомендуем поэкспериментировать с разным числом строк, чтобы получить разные графики, и обратить внимание на то, как долго возвращаются результаты в вашей среде.  Конкретно это изображение было создано с использованием приблизительно 10 000 строк данных.
  
### <a name="create-a-map-plot"></a>Создание диаграммы-карты  
В этом примере вы создадите объект диаграммы, используя экземпляр [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] в качестве контекста вычисления, а затем вернете объект диаграммы в локальный контекст вычисления для отрисовки.  
   
1.  Сначала определите функцию, создающую объект диаграммы.  

    ```R  
    mapPlot <- function(inDataSource, googMap){  
        library(ggmap)  
        library(mapproj)     
        ds <- rxImport(inDataSource)  
        p <- ggmap(googMap)+  
        geom_point(aes(x = pickup_longitude, y =pickup_latitude ), data=ds, alpha =.5,  
    color="darkred", size = 1.5)  
        return(list(myplot=p))  
    }  
    ```  
    + Пользовательская функция R *mapPlot* создает точечную диаграмму, на которой представлено количество поездок с каждого места посадки. Она использует пакеты **ggplot2** и  **ggmap** , которые уже должны быть установлены и загружены.  
    + Функция *mapPlot* принимает два аргумента: имеющийся объект данных, который вы определили ранее с помощью функции *RxSqlServerData*, и представление карты, переданное из клиента.    
    + Обратите внимание на использование переменной *ds* для загрузки данных из ранее созданного источника данных *inDataSource*.  При использовании функций R с открытым исходным кодом данные должны быть загружены в кадры данных в памяти. Это можно сделать с помощью функции *rxImport* из пакета **RevoScaleR**.  Однако эта функция выполняется в памяти в ранее определенном контексте [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] . То есть она не использует память локальной рабочей станции.  
  
2.  Далее загрузите библиотеки, необходимые для создания карт в локальной среде R.  
  
    ```R  
    library(ggmap)  
    library(mapproj)  
    gc <- geocode("Times Square", source = "google")  
    googMap <- get_googlemap(center = as.numeric(gc), zoom = 12, maptype = 'roadmap', color = 'color';    
    ```  
    + Этот код выполняется в клиенте R. Обратите внимание на повторный вызов библиотек **ggmap** и **mapproj**. Причина в том, что предыдущее определение функции выполнялось в контексте сервера и библиотеки не загружались в локальную память, теперь же операция построения диаграммы переносится обратно на рабочую станцию.  
  
    -   В переменной *gc* хранится набор координат площади Таймс-сквер в Нью-Йорке.  
  
    -   Строка, начинающаяся с *googmap*, создает карту с указанными координатами в центре.  
          
  
3.  Выполните функцию построения диаграммы и отрисуйте результаты в локальной среде R. Для этого заключите функцию построения диаграммы в функцию *rxExec*, как показано здесь.  Функция *rxExec* входит в состав пакета **RevoScaleR** и поддерживает выполнение произвольных функций R в удаленном контексте вычислений. 
  
    ```R  
    myplots <- rxExec(mapPlot, inDataSource, googMap, timesToRun = 1)  
    plot(myplots[[1]][["myplot"]]);  
  
    ```  
    + В первой строке можно увидеть, что данные карты передаются в виде аргумента (*googMap*) в функцию *mapPlot*, выполняемую удаленно. Это связано с тем, что карты были созданы в локальной среде, и их необходимо передать в функцию, чтобы создать диаграмму в контексте [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].   
  
        Обработанные данные затем сериализуются обратно в локальную среду R, чтобы их можно было просмотреть с помощью окна **Plot** в RStudio или другого графического устройства R.  
  
  
4.  Ниже приведена итоговая диаграмма с местами посадки, обозначенными на карте красными точками.  
  
    ![plotting taxi rides using a custom R function](../../advanced-analytics/r-services/media/rsql-e2e-mapplot.png "plotting taxi rides using a custom R function")  
  
## <a name="next-lesson"></a>Следующее занятие  
[Занятие 3. Создание характеристик данных (пошаговое руководство по обработке и анализу данных)](../../advanced-analytics/r-services/lesson-3-create-data-features-data-science-end-to-end-walkthrough.md)  
  
  
  
