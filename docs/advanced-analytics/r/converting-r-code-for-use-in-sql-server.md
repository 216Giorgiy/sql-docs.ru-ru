---
title: Преобразование кода R для использования в службах SQL Server Machine Learning | Документы Microsoft»
ms.prod: sql
ms.technology: machine-learning
ms.date: 04/15/2018
ms.topic: conceptual
author: HeidiSteen
ms.author: heidist
manager: cgronlun
ms.openlocfilehash: bf3d272bd4b5c1227aa8a1969727ea17f5b65596
ms.sourcegitcommit: 7a6df3fd5bea9282ecdeffa94d13ea1da6def80a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2018
ms.locfileid: "31203586"
---
# <a name="convert-r-code-for-execution-in-sql-server-in-database-instances"></a>Преобразование кода R для выполнения в экземплярах SQL Server (в базе данных)
[!INCLUDE[appliesto-ss-xxxx-xxxx-xxx-md-winonly](../../includes/appliesto-ss-xxxx-xxxx-xxx-md-winonly.md)]

В этой статье содержит высокоуровневое руководство о том, как изменить код R в SQL Server. 

При перемещении кода R из R Studio или других средах SQL Server, чаще всего код работает без дальнейших изменений: например, при простой код, такие как функции, принимающей некоторые входные данные и возвращает значение. Это также упрощает порт решений, использующих **RevoScaleR** или **MicrosoftML** пакеты, которые поддерживают выполнение в контекстах различных выполнение с минимальными изменениями.

Однако код может потребоваться существенные изменения, если какой-либо из следующих условий:

+ Используемые библиотеки R, доступ к сети или не может устанавливаться на сервере SQL Server.
+ Код выполняет отдельные вызовы к источникам данных за пределами SQL Server, например листов Excel, файлы в общих папках и других баз данных. 
+ Требуется выполнение кода в *@script* параметр [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md) и также параметризовать хранимой процедуры.
+ Исходное решение содержит несколько шагов, которые могут оказаться эффективными в рабочей среде при выполнении независимо друг от друга, такие как Подготовка данных или конструируются сравнение модели обучения, оценки или отчетов.
+ Чтобы улучшить оптимизации производительности путем изменения библиотек, с помощью параллельного выполнения или Разгрузка некоторую обработку для SQL Server. 

## <a name="step-1-plan-requirements-and-resources"></a>Шаг 1. Планирование требований и ресурсов

**Пакеты**

+ Определить, какие пакеты необходимы и убедитесь, что они работают на сервере SQL Server.
 
+ Установите пакеты заранее, в библиотеке пакета по умолчанию, используемый службами машины обучения. Библиотек пользователей не поддерживаются.

**Источники данных** 

+ Если вы собираетесь внедрения кода R в [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md), определение источников данных первичный и вторичный. 

    + **Основной** источники данных являются большие наборы данных, например обучающие данные модели или входные данные для прогнозов. Планирование для сопоставления большого набора данных входной параметр [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md).

    + **Вторичный** источники данных являются обычно небольшие наборы данных, таких как списки факторов или дополнительных группирования переменных. 
    
    В настоящее время sp_execute_external_script поддерживает только один набор данных в качестве входного параметра для хранимой процедуры. Тем не менее можно добавить несколько входов скалярные или binary.

    Вызовы хранимых процедур, предшествует EXECUTE нельзя использовать в качестве входных данных для [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md). Можно использовать запросы, представления или любой другой допустимый инструкции SELECT.

+ Определите выходные данные, что нужно. При выполнении кода R с помощью sp_execute_external_script хранимая процедура может выводить только одного кадра данных в результате. Однако также можно вывести несколько скалярных результатов, включая графики и моделей в двоичном формате, а также другие скалярные значения, производный от кода R или SQL параметров.

**Типы данных**

+ Составьте контрольный список возможных проблем с типами данных.

    Все типы данных R поддерживаются службами обучения машины SQL Server. Тем не менее [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] поддерживает разнообразные типы данных, чем R. Таким образом, выполняются некоторые неявные преобразования типов данных при отправке [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] данных R и наоборот. Может потребоваться для явного приведения или преобразования некоторых данных. 

    Значения NULL поддерживаются. Однако R использует `na` конструкция данных для представления отсутствующие значения, что похоже на значение null.

+ Рассмотрите возможность удаления зависимости от данных, который не может использоваться, например, rowid R: и GUID типов данных SQL Server не может использоваться в R и выдают сообщения об ошибках.

    Дополнительные сведения см. в разделе [библиотеки R и типы данных](../r/r-libraries-and-data-types.md).

## <a name="step-2-convert-or-repackage-code"></a>Шаг 2. Преобразовать или распаковать кода

Сколько внесения изменений в код зависит ли планируется отправить код R с удаленного клиента для запуска в контексте вычислений SQL Server, или планируется развертывание кода в рамках хранимой процедуры, которая может предоставить более высокую производительность и безопасность данных. Перенос кода в хранимой процедуре накладывает некоторые дополнительные требования. 

+ Определите первичный входные данные как SQL-запроса по возможности Избегайте перемещения данных.

+ При выполнении R в хранимые процедуры, могут проходить через несколько **скалярные** входных данных. Любые параметры, которые вы хотите использовать в выходных данных, добавить **ВЫВОДА** ключевое слово. 

    Например, следующие скалярные входные данные `@model_name` содержит имя модели, которое также выводится в каждый столбец в результатах:

    ```SQL
    EXEC sp_execute_external_script @model_name="DefaultModel" OUTPUT, @language=N'R', @script=N'R code here'
    ``` 

+ Все переменные, передаваемые в качестве параметров хранимой процедуры [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md) должна быть сопоставлена с переменным в коде R. По умолчанию переменные сопоставляются по имени.

    Все столбцы во входном наборе данных должно быть сопоставлено с переменными в R-скрипта.  Например предположим, что R-скриптов содержит формулу, похожее на следующее:

    ```R
    formula <- ArrDelay ~ CRSDepTime + DayOfWeek + CRSDepHour:DayOfWeek
    ```
    
    Если во входном наборе данных не содержит столбцы с совпадающими именами ArrDelay, CRSDepTime, DayOfWeek, CRSDepHour и DayOfWeek, возникает ошибка.

+ В некоторых случаях схему выходные данные должны быть определены заранее для результатов.

    Например, для вставки данных в таблицу, необходимо использовать **с РЕЗУЛЬТИРУЮЩЕГО НАБОРА** предложение указать схему.

    Со схемой выходных данных также является обязательным, если скрипт R использует аргумент `@parallel=1`. Дело в том, что SQL Server может распределить запрос между несколькими параллельными процессами и собирать результаты в конце. Таким образом со схемой выходных данных должно быть готово для создания параллельной обработки.
    
    В других случаях можно опустить схема результатов с помощью параметра **с RESULT SETS UNDEFINED**. Эта инструкция возвращает набор данных из сценария R без имен столбцов или указание типов данных SQL.

+ Рассмотрите возможность создания времени или отслеживания данных с помощью T-SQL, а не R.

    Например можно передать системного времени или другие сведения, используемые для аудита и хранилища, добавление вызова T-SQL, который передается в результатах, вместо создания схожих данных в R-скрипта. 

**Повысить производительность и безопасность**

+ Избегайте написания прогнозов или промежуточные результаты в файл. Вместо этого запись прогнозы в таблицу во избежание перемещения данных.

+ Запустите все запросы заранее и просмотрите планы запросов SQL Server, чтобы определить задачи, которые могут выполняться параллельно.

    Если входящий запрос может выполняться параллельно, задайте `@parallel=1` как часть аргументов [sp_execute_external_script](../../relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql.md). 

    Параллельная обработка с использованием этого параметра обычно поддерживается, если SQL Server может работать с секционированными таблицами или распределять запрос между несколькими процессами и выполнять статистическую обработку результатов в конце. Параллельная обработка с использованием этого параметра обычно не поддерживается, если для обучения моделей применяются алгоритмы, требующие считывания всех данных, или если требуется создать агрегаты.

+ Определите, нет ли в коде R действий, которые можно выполнять отдельно или более эффективно с помощью вызова отдельной хранимой процедуры. Например может получить более высокую производительность, выполняющих конструируются или извлечения компонентов отдельно и сохранение значения в таблице.

+ Найдите способы использования T-SQL, а не в коде R для вычислений с множествами.

    Например, это решение R показывает, как определяемые пользователем функции T-SQL и R можно выполнить ту же задачу разработки компонентов: [Пошаговое руководство для начала до конца обработки и анализа данных](../tutorials/walkthrough-data-science-end-to-end-walkthrough.md).

+ Если это возможно, замените стандартных функций R с **ScaleR** функции, поддерживающие распределенное выполнение. Дополнительные сведения см. в разделе [сравнения базы R и функции r. шкалы](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/revoscaler-compared-to-base-r).

+ Обратитесь к разработчику базы данных определяют способы повышения производительности с помощью функции SQL Server, таких как [оптимизированные для памяти таблицы](https://docs.microsoft.com/sql/relational-databases/in-memory-oltp/introduction-to-memory-optimized-tables), или, при наличии Enterprise Edition, [регулятора ресурсов](https://docs.microsoft.com/sql/relational-databases/resource-governor/resource-governor)).

    Дополнительные сведения см. в разделе [SQL Server оптимизации советы и рекомендации для служб аналитики](https://gallery.cortanaintelligence.com/Tutorial/SQL-Server-Optimization-Tips-and-Tricks-for-Analytics-Services)

### <a name="step-3-prepare-for-deployment"></a>Шаг 3. Подготовка к развертыванию

+ Обратитесь к администратору, чтобы установить и протестировать пакеты до развертывания кода. 

    В среде разработки возможно, необходимо установить пакеты как часть кода, но это рекомендуется использовать в производственной среде. 

    Библиотек пользователей не поддерживаются, независимо от того, с помощью хранимой процедуры или выполнения кода R в контексте вычислений SQL Server.

**Пакет кода R в хранимой процедуре**

+ Если код является довольно простым, можно внедрить в определяемой пользователем функции T-SQL без изменений, как описано в этих примерах:

    + [Создайте функцию R, работающий в rxExec](..\tutorials\deepdive-create-a-simple-simulation.md)
    + [С помощью T-SQL и R конструируются](..\tutorials\sqldev-create-data-features-using-t-sql.md)

+ Если код является более сложным, используйте пакет R **sqlrutils** для преобразования кода. Этот пакет предназначен для опытных пользователей R написать код, хорошо хранимой процедуры. 

    Первым шагом является переписывать код и R в виде одной функции с четко определенных входных и выходных данных.

    Затем с помощью **sqlrutils** пакета входы и выходы в правильном формате. **Sqlrutils** пакета создается код завершения хранимой процедуры и также могут регистрировать хранимой процедуры в базе данных. 

    Дополнительные сведения и примеры см. в разделе [SqlRUtils](../r/generating-an-r-stored-procedure-for-r-code-using-the-sqlrutils-package.md).

**Интеграция с другими рабочими процессами**

+ Используйте средства T-SQL и процессов ETL. Выполните конструируются извлечения признаков и очистка данных как часть рабочие процессы данных заранее.

    При работе в изолированной среде разработки R например [!INCLUDE[rsql_rtvs_md](../../includes/rsql-rtvs-md.md)] или RStudio, может извлечь данные на компьютере, последовательно, анализировать данные и затем записи или отображения результатов. 
    
    Тем не менее при переносе кода автономный R для SQL Server большая часть этого процесса может быть упрощена или делегировать с другими средствами SQL Server. 

+ Используйте безопасный, асинхронный визуализации стратегии.

    Часто пользователи SQL Server нет доступа к файлам на сервере и клиентских средств SQL обычно не поддерживают R графического устройства. При создании диаграммы или другие графические как часть решения, рассмотрите возможность экспорта графики как двоичные данные и сохранение в таблице или записи.

+ Перенос прогноза и количественной оценки функции в хранимых процедурах для прямого доступа приложениями.

### <a name="other-resources"></a>Другие ресурсы

Чтобы просмотреть примеры развертывание решения R в SQL Server, см. в этих примерах:

+ [Создать прогнозную модель для ski аренды бизнеса с помощью R и SQL Server](https://microsoft.github.io/sql-ml-tutorials/R/rentalprediction/)

+ [Аналитика в базе данных для разработчиков SQL](../tutorials/sqldev-in-database-r-for-sql-developers.md) показано, как сделать код R более удобным путем помещения его в хранимых процедурах

+ [Решение обработки и анализа данных и всестороннее](../tutorials/walkthrough-data-science-end-to-end-walkthrough.md) включает сравнение конструируются в T-SQL и R
