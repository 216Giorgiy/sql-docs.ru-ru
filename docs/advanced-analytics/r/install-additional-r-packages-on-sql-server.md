---
title: "Установка дополнительных пакетов R в SQL Server | Документы Microsoft"
ms.date: 01/04/2018
ms.reviewer: 
ms.suite: sql
ms.prod: machine-learning-services
ms.prod_service: machine-learning-services
ms.component: r
ms.technology: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 21456462-e58a-44c3-9d3a-68b4263575d7
caps.latest.revision: "16"
author: jeannt
ms.author: jeannt
manager: cgronlund
ms.workload: On Demand
ms.openlocfilehash: 2821983b39dcd4c301ea4b49713de0cdd3550a65
ms.sourcegitcommit: 60d0c9415630094a49d4ca9e4e18c3faa694f034
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/09/2018
---
# <a name="install-additional-r-packages-on-sql-server"></a>Установка дополнительных пакетов R в SQL Server

В этой статье описывается установка нового R-пакетов в экземпляр SQL Server, где включена машинного обучения.

**Область применения:** 
+ [!INCLUDE[sssql15-md](../../includes/sssql15-md.md)]  [!INCLUDE[rsql-productname-md](../../includes/rsql-productname-md.md)]
+ [!INCLUDE[sssql17-md](../../includes/sssql17-md.md)] [!INCLUDE[rsql-productnamenew-md](../../includes/rsql-productnamenew-md.md)]

## <a name="prerequisites"></a>предварительные требования

+ Определить версию пакета Windows: [получение правильный пакет версии и формат](#packageVersion)

+ Если сервер не имеет доступа к Интернету, необходимо загрузить исполняемые файлы Windows заранее: [загрузки ZIP-файлы](#bkmk_zipPreparation)

+ Определите зависимости пакетов. 

    - Если сервер имеет доступ к Интернету, не нужно беспокоиться о зависимостей. можно автоматически установить все необходимые пакеты.

    - Если сервер выполняет **не** доступа к Интернету, необходимо определить все зависимости и заранее, загрузить необходимые пакеты в ZIP-формате. Простой способ сделать это является использование [miniCRAN](create-a-local-package-repository-using-minicran.md) для подготовки к коллекции пакетов с помощью всех зависимостей. Затем этот репозиторий можно скопировать на сервер.

+ Проверка совместимости пакета. Пакет должен быть совместима с версией R, который работает в SQL Server.

    Кроме того проверьте, содержит ли пакет (или все пакеты, которые необходимы) функции, которые были бы заблокированы в SQL Server или с помощью политики. Например для некоторых пакетов являются низкой размеру жесткой среде SQL Server. Эти пакеты могут включать пакеты, которые доступ к сети, использующих Java и других платформ, обычно не используется в среде SQL Server или пакеты, которые требуют доступа с повышенными привилегиями файловой системы.

+ Разрешения

    Требуется административный доступ к компьютеру под управлением SQL Server.

    Кроме того для выполнения в SQL Server, необходимо установить пакетов в библиотеке по умолчанию, связанный с текущим экземпляром. Инструкции по поиску библиотеке по умолчанию см. в разделе [пакетов R, установленных с SQL Server](installing-and-managing-r-packages.md).
    
    Если вы являетесь опытным пользователем R, может быть привыкли установку пакетов из командной строки без специальных разрешений или без предварительного скачивания. Однако этот метод не работает в SQL Server. Во многих случаях SQL Server компьютеры не имеют подключение к Интернету. Кроме того, доступ к файлам сервера или внешнем хранилище может быть ограничен. Пакеты, установленные в библиотеку пользователя не может осуществляться runnign заданий R в SQL Server. 

    Если нет административного доступа к компьютеру SQL Server, найти администратором базы данных, помогающие при установке пакета.

+ Для каждого экземпляра, где необходимо использовать пакет выполните установку отдельно.

     Пакеты не могут использоваться совместно экземпляров. Можно использовать один и тот же источник сжатый ZIP-файл для установки пакета к отдельным экземплярам, но каждый экземпляр библиотеки добавляется отдельная копия пакета.

## <a name="install-packages"></a>Установить пакеты

Этот раздел содержит действия по установке пакета в следующих случаях.

+ [Установить новые пакеты на сервере с доступом в Интернет](#bkmk_rInstall)
+ [Выполнить автономную установку пакетов на сервере с **не** доступ к Интернету](#bkmk_offlineInstall)
+ [Установить пакеты в контексте вычислений SQL Server с помощью RevoScaleR](#bkmk_rAddPackage)
+ [Установить пакеты, используя инструкцию СОЗДАНИЯ ВНЕШНЕЙ БИБЛИОТЕКИ](#bkmk_createlibrary) (SQL Server 2017 г. только; другие ограничения применяются)

### <a name="bkmk_rInstall"></a>Режим сетевой установки с помощью средств r.

Можно использовать стандартные средства R, чтобы установить новые пакеты на экземпляре SQL Server 2016 или 2017 г. SQL Server. Тем не менее необходимо иметь права администратора для этого.

1.  Перейдите в папку на сервере, где установлены библиотеки R для экземпляра.

    > [!IMPORTANT] 
    > Не забудьте установить пакеты из библиотеки по умолчанию, связанный с текущим экземпляром. Никогда не устанавливать пакеты в каталоге пользователя.

    Если у вас необходимые разрешения, обратитесь к администратору базы данных и укажите список нужных пакетов.

2.  Откройте окно командной строки R от имени администратора.

    Например при использовании командной строки Windows, перейдите в каталог, где находятся RTerm.Exe или RGui.exe. 

    **Экземпляр по умолчанию**

    SQL Server 2017 г.:`C:\Program Files\MSSQL14.MSSQLSERVER\R_SERVICES\bin\x64`
    
    SQL Server 2016.`C:\Program Files\MSSQL13.MSSQLSERVER\R_SERVICES\bin\x64`

    **Именованный экземпляр**

    SQL Server 2017 г.:`C:\Program files\MSSQL14.<instanceName>\R_SERVICES\bin\x64`
    
    SQL Server 2016.`C:\Program files\MSSQL13.<instanceName>\R_SERVICES\bin\x64`

    При использовании привязки для обновления машинного обучения компоненты могли измениться путь. Всегда проверяйте путь к экземпляру, прежде чем устанавливать новые пакеты. 

3.  Выполните команду R `install.packages` для установки пакета. Например следующая инструкция устанавливает пакет популярных e1071. 

    ```R
    install.packages("e1071", lib = lib.SQL)
    ```

    Двойные кавычки необходимы для имени пакета.

4. Если указать зеркальный сайт, выберите любой сайт, удобный для вашего расположения.

5. Если целевой пакет зависит от дополнительных пакетов, установщик R автоматически загружаются зависимости и установит их.

> [!IMPORTANT]
> Для каждого экземпляра, где необходимо использовать пакет выполните установку отдельно. Пакеты не могут использоваться совместно экземпляров.

### <a name = "bkmk_offlineInstall"></a>Автономной установки с помощью средств r. 

Если пакет, который вы собираетесь установить есть зависимости, Подготовка **все** необходимые пакеты заранее.  В разделе [рекомендации по установке](#bkmk_tips) раздел для получения справки по подготовке пакетов.

> [!IMPORTANT]
>  Каждый раз, когда необходимо установить пакеты на сервере, который имеет доступ к Интернету отсутствует, очень важно заранее анализа завершения зависимостей и убедитесь, что вы загрузили все необходимые пакеты **перед** начала установки. Мы рекомендуем [miniCRAN](https://mran.microsoft.com/package/miniCRAN) для этого процесса. Этот пакет R принимает список пакетов, необходимо установить, анализирует зависимости и получает ZIP-файл. затем miniCRAN создает одного репозитория, можно скопировать на сервер.
> 
> Дополнительные сведения см. в разделе [Создать репозиторий локального пакета с помощью miniCRAN](create-a-local-package-repository-using-minicran.md)

1. Скопируйте пакет или репозитория в ZIP-формате в локальной папке или другом расположении, доступном для сервера.

2.  Найдите папку на сервере, где установлены библиотеки R для экземпляра.

    Например при использовании командной строки Windows, перейдите в каталог, где находятся RTerm.Exe или RGui.exe.

    **Экземпляр по умолчанию**

    SQL Server 2017 г.:`C:\Program Files\MSSQL14.MSSQLSERVER\R_SERVICES\bin\x64`
    
    SQL Server 2016.`C:\Program Files\MSSQL13.MSSQLSERVER\R_SERVICES\bin\x64`

    **Именованный экземпляр**

    SQL Server 2017 г.:`C:\Program files\MSSQL14.<instanceName>\R_SERVICES\bin\x64`
    
    SQL Server 2016.`C:\Program files\MSSQL13.<instanceName>\R_SERVICES\bin\x64`

3. Откройте окно командной строки R от имени администратора.

4.  Выполните команду R `install.packages` и укажите пакет или имя репозитория и расположение ZIP-файл.

    ```R
    install.packages("C:\\Temp\\Downloaded packages\\mynewpackage.zip", repos=NULL)
    ```

    Эта команда извлекает R-пакет `mynewpackage` из своего локального ZIP-файла, при условии, что копия сохранена в каталоге `C:\Temp\Downloaded packages`и устанавливает пакет на локальном компьютере. Если пакет имеет зависимости, программа установки проверяет наличие существующих пакетов в библиотеке. Если вы создали репозитории, которая включает в себя зависимости, программа установки устанавливает пакеты requireed также.

    Если необходимые пакеты не присутствуют в библиотеке экземпляра, а не удается найти в ZIP-файл, происходит сбой установки целевого пакета.

### <a name="bkmk_rAddPackage"></a>Установить пакеты R на сервере с удаленного клиента R

В последних версиях [R или сервер обучения машины](https://docs.microsoft.com/machine-learning-server/rebranding-microsoft-r-server), RevoScaleR включает функции, которые поддерживают установку новых пакетов R в контексте вычислений SQL Server. 

1. Прежде чем начать, убедитесь, что выполняются следующие условия:

    + У вашего клиента есть RevoScale 9.0.1 или более поздней версии.
    + Эквивалентной версией RevoScaleR установлен на экземпляре SQL Server.
    + [Функции пакета управления](..\r\r-package-how-to-enable-or-disable.md) включена на экземпляре.
    + Вы являетесь членом роли базы данных, который позволяет установить пакеты в общий или контекст prvate на указанном экземпляре и ddatabase.

2. Из командной строки R, определить строку соединения для экземпляра и базы данных и использовать строку подключения с [RxInSqlServer](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxinsqlserver) конструктор для создания контекста вычислений SQL Server.

    ```R
    sqlcc <- RxInSqlServer(connectionString = myConnString, shareDir = sqlShareDir, wait = sqlWait, consoleOutput = sqlConsoleOutput)
    ```
3. Создайте список пакетов, который вы хотите установить и сохраните список в строковой переменной.

    ```R
    packageList <- c("e1071", "mice")
    ```

4. Вызовите [rxInstallPackages](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxinstallpackages) и передать в контексте вычислений и строковая переменная, содержащая имена пакетов.

    ```R
    rxInstallPackages(pkgs = packageList, verbose = TRUE, computeContext = sqlcc)
    ```

    Если зависимые пакеты не требуются, они также будут установлены, при наличии подключения к Интернету.
    
    В этом примере так как не указан владелец и области, пакеты устанавливаются с использованием учетных данных пользователя, выполняющего соединение, в области по умолчанию для этого пользователя.

### <a name="bkmk_createlibrary"></a>Для установки пакетов используйте miniCRAN репозитория и создание ВНЕШНЕЙ БИБЛИОТЕКИ 

2017 г. SQL Server предоставляет новые возможности для установки и управления пакетов R, с помощью T-SQL. Тем не менее этот процесс требует, что пакет доступны как локальный ZIP-файл, а не загружает из Интернета. Выполнение инструкции завершается неудачно, если все пакеты не были заранее подготовлены.

Создание ВНЕШНЕЙ БИБЛИОТЕКИ поддерживается при следующих условиях:

+ Вы устанавливаете один пакет без зависимостей
+ Установка нескольких пакетов и пакетов с зависимостями и заранее подготовлены все пакеты. 

**Шаги**

1.  Подготовка пакета в сжатый формат, или создайте miniCRAN репозиторий, который содержит пакет и его зависимости.  

2. Скопируйте ZIP-файл или репозиторий в локальную папку на сервере.

     > [!IMPORTANT]
     > Файл, указанный как источник должен содержать целевой пакет, а также связанные необходимые пакеты.

3. Как администратор, выполните инструкцию T-SQL `CREATE EXTERNAL LIBRARY` для передачи коллекции ZIP-пакета в базе данных.

    Например следующая инструкция ссылается на miniCRAN репозиторий, который содержит randomForest пакет и его зависимости. 

    ```R
    CREATE EXTERNAL LIBRARY randomForest
    FROM (CONTENT = 'C:\Downloads\Rpackages\randomForest_4.6-12.zip')
    WITH (LANGUAGE = 'R');
    ```

    Произвольное имя нельзя использовать в инструкции CREATE. Имя внешней библиотеки должен иметь же имя, которое будет использоваться при загрузке или при вызове пакета.

4. Установите пакет или пакеты для использования с SQL Server, выполнив код внутри хранимой процедуры.
    
    ```SQL
    EXEC sp_execute_external_script
    @language =N'R',
    @script=N'
    # install randomForest and its dependencies
    library(randomForest)'
    ```

    В случае успешного выполнения **сообщений** окна следует сообщать сообщения, такие как «randomForest успешно распаковать пакет и суммы MD5 проверить» и «Завершен связанных выполнения».

    Если установка завершается неудачей, все пакеты сбой установки и последующие попытки установить пакет установки также могут завершиться ошибкой, со следующим сообщением: 

    «Ошибка в rxSqlPkgInstallPackages... Не удалось установить пакеты - проверьте подробности»

## <a name="package-installation-tips-and-frequently-asked-questions-faq"></a>Рекомендации по установке пакета и часто задаваемые вопросы (FAQ)

Этот раздел содержит различные советы и часто задаваемые вопросы, связанные с установкой пакета R на сервере SQL Server.

###  <a name="packageVersion"></a>Получите правильный пакет версии и формат

Существует несколько источников R-пакетов, самые известные — CRAN и Bioconductor. На официальном сайте для языка R (<https://www.r-project.org/>) перечислены многие такие ресурсы. Многие пакеты публикуются на портале GitHub, где можно получить исходный код. Тем не менее вам могут предоставить R-пакеты, разработанные в вашей компании.

Независимо от источника необходимо убедиться, что пакет, который вы хотите установить имеет двоичный формат для платформы Windows. В противном случае загруженного пакета нельзя запускать в среде SQL Server.

### <a name="bkmk_zipPreparation"></a>Загрузить пакет как ZIP-файл

Для установки на сервере без доступа к Интернету необходимо загрузить копию пакета в формате ZIP-файл для установки в автономном режиме. Не распаковать пакет.

Например, следующая процедура описывает, чтобы получить правильную версию [FISHalyseR](http://bioconductor.org/packages/release/bioc/html/FISHalyseR.html) пакет с сайта Bioconductor, при условии, что у компьютера есть доступ к Интернету.

1.  В списке **Package Archives** (Архивы пакетов) найдите версию **Windows binary** (Двоичный файл Windows).

2.  Щелкните правой кнопкой мыши ссылку. ZIP-файл и выберите **сохранить объект как**.

3.  Перейдите к локальной папке, где хранятся ZIP-пакеты и нажмите кнопку **Сохранить**.

    Будет создана локальная копия пакета. Если появляется ошибка загрузки, попробуйте другой зеркальный сайт.

4. После загрузки пакета архива можно установить пакет, или скопируйте ZIP-пакет на сервере, у которого нет доступа к Интернету.

> [!TIP]
> Если по ошибке устанавливается пакет вместо загрузки двоичных файлов, копия загруженный ZIP-файл сохраняется на компьютере. Следите за сообщения о состоянии пакета установки, чтобы определить расположение файла. Этот ZIP-файл можно скопировать на сервер, который не имеет доступа к Интернету.
> При загрузке пакета с помощью этого метода, зависимости пакетов, не включаются. 

Дополнительные сведения о содержимом ZIP-архива и создании R-пакет, мы рекомендуем учебником, который можно загрузить в формате PDF в сайте проекта r.: [создания пакетов R](http://cran.r-project.org/doc/contrib/Leisch-CreatingPackages.pdf).

### <a name="bkmk_packageDependencies"></a>Получение зависимостей пакета

Пакеты R часто зависят от нескольких других пакетов, некоторые из которых могут оказаться недоступными в библиотеке R по умолчанию, используемые экземпляром. Иногда пакета требуется другая версия зависимый пакет, который уже установлен.

Если вам нужно установить несколько пакетов или нужно гарантировать, что все сотрудники вашей организации возвращает правильный пакет типа и версии, мы рекомендуем использовать [miniCRAN](https://mran.microsoft.com/package/miniCRAN) пакет, чтобы создать локальный репозиторий, который можно использовать совместно среди нескольких пользователей или компьютеров. Дополнительные сведения см. в разделе [Создать репозиторий локального пакета с помощью miniCRAN](create-a-local-package-repository-using-minicran.md).

### <a name="permissions"></a>Разрешения

В этом разделе описаны разные возможности разрешения, необходимые для установки пакетов в SQL Server 2016 и 2017 г. SQL Server. Установку можно выполнить с помощью средства R или SQL Server, но немного отличаться процесс и разрешения.

-   SQL Server 2016

    В этом выпуске только администратор на компьютере можно установить пакеты в нужное место. Можно использовать стандартные средства R для установки пакетов, но необходимо запустить с правами администратора и использовать средства R, связанные с экземпляром.

-   SQL Server 2017

    Если имеется административный доступ, необходимо установить пакеты на уровне экземпляра с помощью средств R.

    Если вы являетесь владельцем базы данных, можно установить пакеты R с удаленного клиента, если определить соединение и подключитесь к экземпляру, используя RxInSqlServer.
    
    Этот выпуск включает новые функции для поддержки администрирования пакетов R или Python администраторами баз данных в будущих выпусках. Чтобы воспользоваться этой функцией, администратор базы данных сначала необходимо включить функции управления пакетами, для каждого экземпляра. После включения этой функции отдельные пользователи могут установить пакеты для конкретной базы данных, в зависимости от их роли базы данных. Дополнительные сведения см. в разделе [включить или отключить управление пакет R для SQL Server](../r/r-package-how-to-enable-or-disable.md).

> [!IMPORTANT]
> 
> Опытным пользователям R привыкли к установке пакетов в библиотеке пользователя и затем ссылаясь на пакет в эту папку как часть решения R, указав путь к файлу. Однако такой подход не поддерживается в SQL Server. Дополнительные сведения и способы решения проблем см. в разделе [использование пакетов в библиотек пользователей](packages-installed-in-user-libraries.md).

### <a name="establish-a-single-mirror-site-as-standard"></a>Установить один зеркальный сайт от стандартных

Чтобы не приходилось выбирать зеркальный сайт при добавлении каждого нового пакета, в среде разработки R можно настроить постоянное использование одного репозитория. Чтобы сделать это, измените файл глобальных параметров R, **. Rprofile**и добавьте следующую строку:

`options(repos=structure(c(CRAN="<mirror site URL>")))`

На перечисленных текущих зеркал CRAN [этот сайт](https://cran.r-project.org/mirrors.html).

Подробные сведения о настройках и других файлах, загружаемых при запуске среды выполнения R выполните следующую команду из консоли R::`?Startup`

### <a name="know-which-library-you-are-using-for-installation"></a>Узнать, какие библиотеки, которые вы используете для установки

Если ранее вы изменили среда R на компьютере перед установкой ничего, остановитесь на мгновение и убедитесь, что переменная среды R `.libPath` использует только один путь.

Этот путь должен указывать папку R_SERVICES для экземпляра. Дополнительные сведения см. в разделе [пакетов R, установленных с SQL Server](installing-and-managing-r-packages.md).

### <a name="side-by-side-installation-with-r-server"></a>Установка Side-by-side с помощью R Server

При установке Microsoft машины обучения Server (изолированный) помимо служб SQL Server Machine Learning ваш компьютер должен иметь отдельные установки служб R для каждого дубликатов средств R и библиотек.

> [!IMPORTANT]
> 
> Пакеты, установленные в библиотеку R_SERVER используются только в Microsoft R Server и будет невозможен с помощью SQL Server.
> 
> Обязательно используйте `R_SERVICES` библиотеки при установке пакетов, которые вы хотите использовать в SQL Server.

### <a name="how-to-determine-which-packages-are-already-installed"></a>Как определить, какие пакеты уже установлены?

 В разделе [пакеты R, установленных с SQL Server](installing-and-managing-r-packages.md)