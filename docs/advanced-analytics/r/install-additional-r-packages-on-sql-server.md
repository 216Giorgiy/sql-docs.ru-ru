---
title: "Установка дополнительных пакетов R в SQL Server | Документы Microsoft"
ms.date: 11/15/2017
ms.prod:
- sql-server-2016
- sql-server-2017
ms.reviewer: 
ms.suite: 
ms.technology: r-services
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 21456462-e58a-44c3-9d3a-68b4263575d7
caps.latest.revision: "16"
author: jeannt
ms.author: jeannt
manager: cgronlund
ms.workload: On Demand
ms.openlocfilehash: f8d20c5b5b687a6d9d94cd97605f294cead27215
ms.sourcegitcommit: 531d0245f4b2730fad623a7aa61df1422c255edc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/01/2017
---
# <a name="install-additional-r-packages-on-sql-server"></a>Установка дополнительных пакетов R в SQL Server

В этой статье описывается установка нового R-пакетов в экземпляр SQL Server, где включена машинного обучения.

> [!IMPORTANT]
> Процесс добавления новых пакетов отличается в зависимости от версии SQL Server выполняется и инструменты, которые вы используете. 

**Применяется к:** [!INCLUDE[sssql15-md](../../includes/sssql15-md.md)] [!INCLUDE[rsql-productname-md](../../includes/rsql-productname-md.md)] и  [!INCLUDE[sssql17-md](../../includes/sssql17-md.md)]
[!INCLUDE[rsql-productnamenew-md](../../includes/rsql-productnamenew-md.md)]

## <a name="overview-of-package-installation-process"></a>Общие сведения о процессе установки пакета

1.  Определить версию пакета Windows: [получение правильный пакет версии и формат](#packageVersion)

2.  Если сервер не имеет доступа к Интернету, загружать двоичные файлы заранее: [загрузки ZIP-файлы](#bkmk_zipPreparation)

    Не забудьте проверить наличие зависимости пакетов и получить все связанные пакеты, которые могут потребоваться при установке. Чтобы подготовить коллекцию пакеты и их зависимости, мы рекомендуем [miniCRAN пакета](#bkmk_packageDependencies).

    Если возникли ошибки загрузки или установки, попробуйте другой зеркальный сайт.

3.  Способ установки пакета зависит от используемой версии SQL Server и ли сервер имеет доступ к Интернету. Ниже приведены рекомендованные процедуры.

    **Пакет установки для SQL Server 2016**
    
    1. Специалист по анализу данных предоставляет пакеты, необходимые для проекта или команды. Используйте [miniCRAN](create-a-local-package-repository-using-minicran.md) для подготовки к коллекции пакетов с помощью их зависимости.

    2. Администратор базы данных устанавливает пакеты в библиотеке экземпляра, с помощью средства R.

    **Пакет установки для SQL Server 2017 г.**

    1. Администратор базы данных позволяет управлять пакета на экземпляре и добавление пользователей к новой роли пакетов управления.

    2. Специалист по анализу данных предоставляет пакеты, необходимые для проекта или команды. Используйте [miniCRAN](create-a-local-package-repository-using-minicran.md) для подготовки к коллекции пакетов с помощью их зависимости.

    3. Чтобы загрузить пакет, к экземпляру SQL Server, используя инструкцию СОЗДАНИЯ ВНЕШНЕЙ БИБЛИОТЕКИ.
    
    4. После добавления пакета на экземпляре, любой пользователь с соответствующими разрешениями можно установить пакеты в базу данных, в котором выполняются сценарии R, путем вызова кода R из `sp_execute_external_script`.
    
    5. Пользователи с соответствующими разрешениями можно также установить или найти пакеты из удаленного клиента R, с помощью новой функции RevoScaleR для пакета управления.

## <a name="install-new-packages"></a>Установить новые пакеты

В этом разделе содержатся подробные процедуры для сценариев установки пакета ключей. Выберите лучший способ, в зависимости от:

- Версия SQL Server с помощью

- Того, владелец единственного экземпляра или пытаетесь управлять пакетами для нескольких пользователей, используя роли базы данных.

- Является ли вы устанавливаете один пакет или несколько пакетов с зависимостями

**Используйте пакет управления SQL Server**

Если экземпляр поддерживает функции управления пакетами, T-SQL или обычные средства R можно использовать.

-  Пакет передачи R в SQL Server, где пакета управления и пакет на основе ролей доступ включен. Затем пользователь устанавливает пакет с помощью T-SQL.

    [Установка пакетов с помощью СОЗДАНИЯ ВНЕШНЕЙ БИБЛИОТЕКИ](#bkmk_sqlInstall)

- Используйте удаленный клиент R для добавления новых пакетов на сервере. Требуется SQL Server 2017 г. Пакет управления должна быть включена на сервере. 

    [Использовать R для установки пакетов на сервере, если включено управление пакетами](#bkmk_rAddPackage)

- Подготовьте библиотеки пакета для использования с СОЗДАНИЯ ВНЕШНЕГО БИБЛИОТЕКА, которая содержит несколько пакетов, а также их зависимости.

    [Для установки нескольких пакетов из репозитория miniCRAN](#bkmk_minicran)

**Использовать обычные средства R**

При использовании более ранней версии служб SQL Server R, выполните следующие действия для установки пакетов с помощью стандартных средств R. При необходимости используйте miniCRAN для подготовки к установке коллекцию пакетов.

-  Установите пакет R в библиотеке экземпляр по умолчанию, с помощью средств R. Требуется административный доступ.

    [Установить пакеты в библиотеке экземпляра с помощью средств r.](#bkmk_rInstall)

- Создание общего набора пакеты поддержки для упрощения установки нескольких пакетов и их зависимостей.

    [Создать репозиторий пакетов с помощью miniCRAN](create-a-local-package-repository-using-minicran.md)

### <a name="bkmk_sqlInstall"></a>Установка пакетов с помощью средств SQL Server

1. Убедитесь, что компонент управления внешней библиотеки в 2017 г. SQL Server была включена на экземпляре.

    [Как включить или отключить управление пакетами](r-package-how-to-enable-or-disable.md)

2. Подключиться к серверу, используя учетную запись, имеющую разрешения на установку нового пакетов, с помощью одной из ролей базы данных поддерживается, описанные в этом разделе: [R пакета управления для SQL Server](r-package-management-for-sql-server-r-services.md)

3.  Скопируйте ZIP-файл, содержащий пакет R, который требуется установить в папку на компьютере сервера, такие как ваш **пользователей** или **документов** папки. Не удается добавить пакет с сетевого диска или из папки на клиентском компьютере. При использовании miniCRAN для создания репозитория пакетов из скопируйте репозитория пакетов в полном объеме любые локальную папку на сервере: то есть не на сетевом диске.

    Если нет доступа к папкам на сервере, можно передать содержимое пакета в двоичном формате. В разделе [создать ВНЕШНЮЮ БИБЛИОТЕКУ](https://docs.microsoft.com/sql/t-sql/statements/create-external-library-transact-sql) в качестве примера.

4.  Из базы данных, в которой вы хотите использовать пакет, запустите [создать ВНЕШНЮЮ БИБЛИОТЕКУ](https://docs.microsoft.com/sql/t-sql/statements/create-external-library-transact-sql) инструкции.

    В этом примере предполагается, что ваша учетная запись имеет разрешение на загрузить новые пакеты на сервер и установите их **общего** области в базе данных.

    Следующая инструкция добавляет версии [zoo](https://cran.r-project.org/web/packages/zoo/index.html) пакета в текущем контексте базы данных, из локальной общей папкой.

    ```SQL
    CREATE EXTERNAL LIBRARY zoo
    FROM (CONTENT = 'C:\Temp\RPackages\zoo_1.8-0.zip')
    WITH (LANGUAGE = 'R');
    ```

    При подключении, используя учетную запись владельца базы данных (членом роли dbo), пакет доступен в **общего** область: то есть, его можно установить любой пользователь, являющийся членом из `rpkgs-users` роли.

    При загрузке пакета, используя учетную запись, можно получить доступ только **закрытый** области, пакет можно установить только путем.

4.  Для установки пакета в библиотеку R по умолчанию, используемые экземпляром, запускать `library()` команды в хранимой процедуре sp_execute_external_script.

    ```SQL
    EXEC sp_execute_external_script
    @language =N'R',
    @script=N'
    # load the binaries in zoo
    library(zoo)'
    ```

    В случае успешного выполнения **сообщений** окна следует сообщать сообщения, такие как «успешно распаковать пакет «zoo» и проверить суммы MD5». Если требуемый пакет уже установлен, в процессе установки затем присоединяет и загружает требуемый пакет.

    > [!NOTE]
    > Если требуемый пакет недоступен, возвращается ошибка: «не найден пакет называется \<required_package\>». 
    > 
    > Чтобы избежать ошибок, рекомендуется заранее проверка зависимостей пакета или использовать для сбора всех необходимых пакетов в один ZIP-файл перед запуском miniCRAN `CREATE EXTERNAL LIBRARY`.

### <a name="bkmk_rAddPackage"></a>Использовать R для установки пакетов на сервере, если включено управление пакетами

Если управление пакетами в экземпляре уже включена, можно установить новый R-пакеты с удаленного клиента R, с помощью функции RevoScaleR для пакета управления.

1. Прежде чем начать, убедитесь, что выполняются следующие условия:

    + Используйте последнюю версию клиента Microsoft R, которая содержит обновления для RevoScale.
    + Пакет управления включен для экземпляра и базы данных.
    + Разрешение для одной из ролей базы данных управления.

2. Список пакетов, которые требуется установить в строковой переменной.

    ```R
    packageList <- c("e1071")
    ```
    
3. Определить строку соединения для экземпляра и базы данных, где включена пакета управления и использовать строку подключения для создания контекста вычислений SQL Server.

    ```R
    sqlcc <- RxInSqlServer(connectionString = myConnString, shareDir = sqlShareDir, wait = sqlWait, consoleOutput = sqlConsoleOutput)
    ```

4. Вызовите `rxInstallPackages` и передать в контексте вычислений и строковая переменная, содержащая имена пакетов.

    ```R
    rxInstallPackages(pkgs = packageList, verbose = TRUE, computeContext = sqlcc)
    ```

    Если зависимые пакеты не требуются, они также загружаются.
    
    В этом примере, так как владелец пакета и область не была указана, пакет устанавливается с использованием учетных данных пользователя, выполняющего соединение и установки пакетов с помощью области по умолчанию для этого пользователя.

### <a name="bkmk_rInstall"></a>Установить пакеты в библиотеке экземпляра с помощью средств r.

Средства R можно использовать для установки новых пакетов на SQL Server 2016 и 2017 г. SQL Server. Тем не менее необходимо иметь права администратора для этого.

1.  Если сервер не имеет доступа к Интернету, загрузите пакеты заранее.

    Корпорация Майкрософт рекомендует использование репозитория пакетов для подготовки к коллекции пакетов в автономном режиме. Дополнительные сведения см. в разделе [Создать репозиторий локального пакета с помощью miniCRAN](create-a-local-package-repository-using-minicran.md).

2.  Перейдите в папку на сервере, где установлены библиотеки R для экземпляра.

    > [!IMPORTANT] 
    > Не забудьте установить пакеты из библиотеки по умолчанию, связанный с текущим экземпляром. Никогда не устанавливать пакеты в каталоге пользователя. Инструкции по поиску библиотеке по умолчанию см. в разделе [пакетов R, установленных с SQL Server](installing-and-managing-r-packages.md).

    Для каждого экземпляра, в котором выполняется пакет новую установку пакета. Пакеты не могут использоваться совместно экземпляров.

4.  Откройте окно командной строки R от имени администратора.

    Например при использовании командной строки Windows, перейдите в каталог, где находятся файлы RTerm.Exe или RGui.exe. 

    **Экземпляр по умолчанию**

    SQL Server 2017 г.:`C:\Program Files\MSSQL14.MSSQLSERVER\R_SERVICES\bin\x64`
    
    SQL Server 2016.`C:\Program Files\MSSQL13.MSSQLSERVER\R_SERVICES\bin\x64`

    **Именованный экземпляр**

    SQL Server 2017 г.:`C:\Program files\MSSQL14.<instanceName>\R_SERVICES\bin\x64`
    
    SQL Server 2016.`C:\Program files\MSSQL13.<instanceName>\R_SERVICES\bin\x64`

5.  Выполните команду R `install.packages` для установки пакета.

    Синтаксис зависит от источника пакета из Интернета или локальный ZIP-файл. 

    **Установите пакет с помощью подключения к Интернету**

    Например следующая инструкция устанавливает пакет популярных e1071. Двойные кавычки всегда обязательны для имени пакета.

    ```R
    install.packages("e1071", lib = lib.SQL)
    ```

    Если указать зеркальный сайт, выберите любой сайт, удобный для вашего расположения.

    Если целевой пакет зависит от дополнительных пакетов, установщик R автоматически загружаются зависимости и установит их.

    **Установить пакет вручную или на компьютере без доступа к Интернету**

    Если пакет, который планируется установить, имеет зависимости, получите необходимые пакеты заранее и добавьте их в папку с другими ZIP-файлами пакетов. В разделе [рекомендации по установке](#bkmk_tips) раздел для получения справки по подготовке пакетов.

    В командной строке R введите следующую команду, чтобы указать путь и имя пакета для установки:

    ```R
    install.packages("C:\\Temp\\Downloaded packages\\mynewpackage.zip", repos=NULL)
    ```

    Эта команда извлекает один пакет R из своего локального ZIP-файла, при условии, что копия сохранена в каталоге `C:\Temp\Downloaded packages`и устанавливает пакет (с его зависимостями) в библиотеке R на локальном компьютере.

### <a name="bkmk_minicran"></a>Для установки нескольких пакетов из репозитория miniCRAN

Процесс установки пакетов из репозитория miniCRAN аналогична установке пакета в один ZIP-файл. Однако вместо передачи отдельного пакета в сжатый формат, miniCRAN репозитория содержит целевой пакет, а также связанные необходимые пакеты.

1.  Подготовьте хранилище miniCRAN и скопируйте ZIP-файл в локальную папку на сервере.

2.  Если вы используете T-SQL, администратор должен запустить инструкцию T-SQL `CREATE EXTERNAL LIBRARY` для передачи коллекции ZIP-пакета в базе данных.

    Например следующая инструкция ссылается на miniCRAN репозиторий, который содержит randomForest пакет и его зависимости.

    ```R
    CREATE EXTERNAL LIBRARY randomForest
    FROM (CONTENT = 'C:\Downloads\Rpackages\randomForest_4.6-12.zip')
    WITH (LANGUAGE = 'R');
    ```

3. Для установки пакетов для использования с SQL Server, выполните следующую команду в рамках кода R в хранимой процедуре.
    
    ```SQL
    EXEC sp_execute_external_script
    @language =N'R',
    @script=N'
    # install randomForest and its dependencies
    library(randomForest)'
    ```

    В случае успешного выполнения **сообщений** окна следует сообщать сообщения, такие как «randomForest успешно распаковать пакет и суммы MD5 проверить» и «Завершен связанных выполнения».

## <a name="package-installation-tips"></a>Рекомендации по установке пакета

Этот раздел содержит различные советы и образцы кода, связанные с установкой пакета R на сервере SQL Server. 

###  <a name="packageVersion"></a>Получите правильный пакет версии и формат

Существует несколько источников R-пакетов, самые известные — CRAN и Bioconductor. На официальном сайте для языка R (<https://www.r-project.org/>) перечислены многие такие ресурсы. Многие пакеты публикуются на портале GitHub, где можно получить исходный код. Тем не менее вам могут предоставить R-пакеты, разработанные в вашей компании.

Независимо от источника необходимо убедиться, что пакет, который вы хотите установить имеет двоичный формат для платформы Windows. В противном случае загруженного пакета нельзя запускать в среде SQL Server.

Перед загрузкой, необходимо также проверить, совместим ли пакет в версии R, который работает в SQL Server.

### <a name="bkmk_zipPreparation"></a>Загрузить пакет как ZIP-файл

Для установки на сервере без доступа к Интернету Загрузите копию пакета в формате ZIP-файл для установки в автономном режиме. Не распаковать пакет.

Например, следующая процедура описывает, чтобы получить правильную версию [FISHalyseR](http://bioconductor.org/packages/release/bioc/html/FISHalyseR.html) пакет с сайта Bioconductor, при условии, что у компьютера есть доступ к Интернету.

1.  В списке **Package Archives** (Архивы пакетов) найдите версию **Windows binary** (Двоичный файл Windows).

2.  Щелкните правой кнопкой мыши ссылку. ZIP-файл и выберите **сохранить объект как**.

3.  Перейдите к локальной папке, где хранятся ZIP-пакеты и нажмите кнопку **Сохранить**.

Будет создана локальная копия пакета. Затем можно установить пакет или скопировать ZIP-пакет на сервер, который не имеет доступа к Интернету.

Дополнительные сведения о содержимом ZIP-архива и создании R-пакет, мы рекомендуем учебником, который можно загрузить в формате PDF в сайте проекта r.: [создания пакетов R](http://cran.r-project.org/doc/contrib/Leisch-CreatingPackages.pdf).

### <a name="bkmk_packageDependencies"></a>Получение зависимостей пакета

Пакеты R часто зависят от нескольких других пакетов, некоторые из которых могут оказаться недоступными в библиотеке R по умолчанию, используемые экземпляром. Или иногда пакета требуется другая версия зависимый пакет, который уже установлен.

Если вам нужно установить несколько пакетов или нужно гарантировать, что все сотрудники вашей организации возвращает правильный пакет типа и версии, рекомендуется использовать пакет miniCRAN для создания локального репозитория, который может совместно использоваться несколько пользователей или компьютеров. Дополнительные сведения см. в разделе [Создать репозиторий локального пакета с помощью miniCRAN](create-a-local-package-repository-using-minicran.md).

### <a name="permissions"></a>Permissions

Если вы являетесь опытным пользователем R, может быть привыкли установку пакетов из командной строки без специальных разрешений или без предварительного скачивания. Однако большинство серверов нет подключения к Интернету. Кроме того, доступ к файловым ресурсам общего доступа или хранения может быть ограничен.

В этом разделе описаны разные возможности разрешения, необходимые для установки пакетов в SQL Server 2016 и 2017 г. SQl Server. Установку можно выполнить с помощью средства R или SQL Server, но немного отличаться процесс и разрешения.

-   SQL Server 2016

    В этом выпуске только администратор на компьютере можно установить пакеты в нужное место. Можно использовать стандартные средства R для установки пакетов, но необходимо запустить с правами администратора и использовать средства R, связанные с экземпляром.

-   SQL Server 2017

    Этот выпуск предоставляет новые возможности, позволяющие администратору базы данных делегировать пакет установки для пользователей. Администратор базы данных необходимо включить функции управления пакетами, для каждого экземпляра. После включения этой функции администратор базы данных можно использовать роли базы данных для предоставления отдельным пользователям возможность при необходимости установить пакеты или совместно использовать пакеты отдельно для каждой базы данных.

    Дополнительные сведения см. в разделе [R пакета управления для SQL Server](r-package-management-for-sql-server-r-services.md).


> [!IMPORTANT]
> 
> Опытным пользователям R привыкли к установке пакетов в библиотеке пользователя и затем ссылаясь на пакет в эту папку как часть решения R, указав путь к файлу. Однако такой подход не поддерживается в SQL Server. Дополнительные сведения и способы решения проблем см. в разделе [использование пакетов в библиотек пользователей](packages-installed-in-user-libraries.md).

### <a name="comparing-package-management-methods"></a>Сравнение методов пакета управления

В этом разделе сравниваются возможные способы установки пакета и перечислены некоторые дополнительные соображения и рекомендации помогут определить стратегию соответствующего пакета управления и установки.

#### <a name="using-sql-server-package-management-features"></a>С помощью функции управления пакетами SQL Server

При включении управления пакетами установки пакета для конкретной базы данных. Если необходимо использовать пакет во всех базах данных, где включена R-сценария, придется установить его в каждой базе данных.

Тем не менее так как SQL Server управляет данными о каждом пользователе, имеет право на использование пакетов, проще скопировать сведения о пользователях и пакетов между базами данных. Также можно легко перестроить набор работы пакетов для одного или нескольких пользователей, при восстановлении базы данных или при перемещении между экземплярами.

С помощью T-SQL и функции управления пакетами в 2017 г. SQL Server является предпочтительным, если у вас есть несколько пользователей базы данных, установку и запуск пакетов R.

Эта функция доступна с SQL Server 2017 г.

#### <a name="using-r-tools-to-install-packages-for-the-sql-server-instance"></a>С помощью средства R для установки пакетов для экземпляра SQL Server

При использовании этого метода, пакеты, установленные для экземпляра доступны в любой базе данных. Тем не менее поскольку прямо в файловую систему установлены пакеты, они должна управляться за пределами SQL Server. Пакеты не резервного копирования или восстановления. Кроме того администратор базы данных должен сведения об использовании средств R.

Тем не менее это решение работает один простой, если вы являетесь единственным владельцем базы данных.

#### <a name="managing-multiple-packages-and-multiple-versions-of-the-same-package"></a>Управление несколькими пакетами и несколько версий одного пакета

Если необходимо выполнить автономную установку пакетов R, Настройка в локальном хранилище с помощью [miniCRAN](https://mran.revolutionanalytics.com/package/miniCRAN/) позволяет совместно использовать пакеты и управление версиями доступен для использования в организации.

#### <a name="establish-a-single-mirror-site-as-standard"></a>Установить один зеркальный сайт от стандартных

Чтобы не приходилось выбирать зеркальный сайт при добавлении каждого нового пакета, в среде разработки R можно настроить постоянное использование одного репозитория. Чтобы сделать это, измените файл глобальных параметров R, **. Rprofile**и добавьте следующую строку:

`options(repos=structure(c(CRAN="<mirror site URL>")))`

На перечисленных текущих зеркал CRAN [этот сайт](https://cran.r-project.org/mirrors.html).

Подробные сведения о настройках и других файлах, загружаемых при запуске среды выполнения R выполните следующую команду из консоли R::`?Startup`

#### <a name="know-which-library-you-are-using-for-installation"></a>Узнать, какие библиотеки, которые вы используете для установки

Если ранее вы изменили среда R на компьютере перед установкой ничего, остановитесь на мгновение и убедитесь, что переменная среды R `.libPath` использует только один путь.

Этот путь должен указывать папку R_SERVICES для экземпляра. Дополнительные сведения см. в разделе [пакетов R, установленных с SQL Server](installing-and-managing-r-packages.md).

#### <a name="side-by-side-installation-with-r-server"></a>Установка Side-by-side с помощью R Server

При установке Microsoft машины обучения Server (изолированный) помимо служб SQL Server Machine Learning ваш компьютер должен иметь отдельные установки служб R для каждого оба дубликатов средств R и библиотек.

> [!IMPORTANT]
> 
> Пакеты, установленные в библиотеку R_SERVER используются только в Microsoft R Server и будет невозможен с помощью SQL Server.
> 
> Обязательно используйте `R_SERVICES` библиотеки при установке пакетов, которые вы хотите использовать в SQL Server.
